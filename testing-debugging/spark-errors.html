

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Understanding and Handling Spark Errors &#8212; Spark at the ONS</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=5b4479735964841361fd" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=5b4479735964841361fd" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../_static/accessibility.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=5b4479735964841361fd" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd" />
  <script src="../_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=5b4479735964841361fd"></script>

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/tabs.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-95MGHSRD0S"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-95MGHSRD0S');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'testing-debugging/spark-errors';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Unit Testing in Spark" href="unit-testing.html" />
    <link rel="prev" title="Data binning" href="../spark-analysis/bin-continuous-variable.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="Spark at the ONS - Home"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="Spark at the ONS - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    Introduction
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Spark overview</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../spark-overview/spark-start.html">Getting Started with Spark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-overview/when-to-use-spark.html">When To Use Spark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-overview/spark-session-guidance.html">Guidance on Spark Sessions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-overview/example-spark-sessions.html">Example Spark Sessions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-overview/spark-defaults.html">Configuration Hierarchy and <code class="docutils literal notranslate"><span class="pre">spark-defaults.conf</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-overview/data-types.html">Data Types in Spark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-overview/creating-dataframes.html">Creating DataFrames Manually</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-overview/reading-and-writing-data-spark.html">Reading and Writing Data in Spark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-overview/data-storage.html">Data Storage</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction to PySpark</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../pyspark-intro/pyspark-intro.html">Introduction to PySpark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pyspark-intro/returning-data.html">Returning Data from Cluster to Driver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pyspark-intro/f-col.html">Reference columns by name: <code class="docutils literal notranslate"><span class="pre">F.col()</span></code></a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction to sparklyr</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../sparklyr-intro/sparklyr-intro.html">Introduction to sparklyr</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sparklyr-intro/sparklyr-functions.html">Using Spark functions in sparklyr</a></li>

</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Spark functions</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../spark-functions/union-dataframes-with-different-columns.html">Union two DataFrames with different columns</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-functions/padding.html">Add leading zeros with <code class="docutils literal notranslate"><span class="pre">lpad()</span></code></a></li>

<li class="toctree-l1"><a class="reference internal" href="../spark-functions/sampling.html">Sampling: an overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-functions/pivot-tables.html">Pivot tables in Spark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-functions/rounding.html">Rounding differences in Python, R and Spark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-functions/window-functions.html">Window Functions in Spark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-functions/cross-joins.html">Cross Joins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-functions/arrays.html">Arrays Functions in PySpark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-functions/writing-data.html">Writing Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-functions/job-description-notebook.html">Set Spark Job Description</a></li>




</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Understanding and Optimising Spark</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../spark-concepts/optimisation-tips.html">Ideas for optimising Spark code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-concepts/spark-application-and-ui.html">Spark Application and UI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-concepts/shuffling.html">Shuffling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-concepts/join-concepts.html">Optimising Joins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-concepts/salted-joins.html">Salted Joins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-concepts/partitions.html">Managing Partitions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-concepts/persistence.html">Persisting in Spark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-concepts/cache.html">Caching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-concepts/checkpoint-staging.html">Checkpoints and Staging Tables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-concepts/garbage-collection.html">Garbage Collection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-concepts/df-order.html">Spark DataFrames Are Not Ordered</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-concepts/exercises.html">Exercises</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Analysis in Spark</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../spark-analysis/logistic-regression.html">Logistic Regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-analysis/visualisation.html">Spark and Visualisation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-analysis/bin-continuous-variable.html">Data binning</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Testing and Debugging</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Understanding and Handling Spark Errors</a></li>
<li class="toctree-l1"><a class="reference internal" href="unit-testing.html">Unit Testing in Spark</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Ancillary Topics</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../ancillary-topics/module-imports.html">Naming Conflicts in Module Imports</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ancillary-topics/pydoop.html">Pydoop: HDFS to pandas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ancillary-topics/creating-a-SQL-view-in-HDFS.html">Creating a SQL view in HDFS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ancillary-topics/pandas-udfs.html">Pandas UDFs</a></li>
</ul>

        </div>
    </nav></div>
            <div class="bd-sidebar__bottom">
                <!-- To handle the deprecated key -->
                
                <div class="navbar_extra_footer">
                <div>
        <p>Book version 2022.6</p>
    </div>
    
                </div>
                
            </div>
        </div>
        <div id="rtd-footer-container"></div>
    </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/best-practice-and-impact/ons-spark" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/best-practice-and-impact/ons-spark/issues/new?title=Issue%20on%20page%20%2Ftesting-debugging/spark-errors.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/testing-debugging/spark-errors.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Understanding and Handling Spark Errors</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#practical-tips-for-error-handling-in-spark">Practical tips for error handling in Spark</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-recap-of-python-and-r-errors">A recap of Python and R errors</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-spark-error-missing-file">Example Spark error: missing file</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#understanding-errors-summary-of-key-points">Understanding Errors: Summary of key points</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#handling-exceptions-in-spark">Handling exceptions in Spark</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#what-is-error-handling-and-why-use-it">What is error handling and why use it?</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#how-to-handle-spark-errors">How to handle Spark errors</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#error-handling-examples">Error Handling Examples</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-1-no-spark-session">Example 1: No Spark session</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-2-handle-multiple-errors-in-a-function">Example 2: Handle multiple errors in a function</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-3-capture-and-ignore-the-error">Example 3: Capture and ignore the error</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#clean-up-options">Clean up options</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#further-resources">Further Resources</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section id="understanding-and-handling-spark-errors">
<h1>Understanding and Handling Spark Errors<a class="headerlink" href="#understanding-and-handling-spark-errors" title="Permalink to this heading">#</a></h1>
<p>Spark errors can be very long, often with redundant information and can appear intimidating at first. However, if you know which parts of the error message to look at you will often be able to resolve it. Sometimes you may want to handle errors programmatically, enabling you to simplify the output of an error message, or to continue the code execution in some circumstances.</p>
<p>Errors can be rendered differently depending on the software you are using to write code, e.g. CDSW will generally give you long passages of red text whereas Jupyter notebooks have code highlighting. This example uses the CDSW error messages as this is the most commonly used tool to write code at the ONS. The general principles are the same regardless of IDE used to write code.</p>
<p>There are some examples of errors given here but the intention of this article is to help you debug errors for yourself rather than being a list of all potential problems that you may encounter. We focus on error messages that are caused by Spark code.</p>
<section id="practical-tips-for-error-handling-in-spark">
<h2>Practical tips for error handling in Spark<a class="headerlink" href="#practical-tips-for-error-handling-in-spark" title="Permalink to this heading">#</a></h2>
<p>Spark error messages can be long, but the most important principle is that <strong>the first line returned is the most important</strong>. This first line gives a description of the error, put there by the package developers. The output when you get an error will often be larger than the length of the screen and so you may have to scroll up to find this. The examples in the next sections show some PySpark and sparklyr errors.</p>
<p>The most likely cause of an error is your code being incorrect in some way. Use the information given on the first line of the error message to try and resolve it. In many cases this will give you enough information to help diagnose and attempt to resolve the situation. If you are still struggling, try using a search engine; <a class="reference external" href="https://stackoverflow.com/">Stack Overflow</a> will often be the first result and whatever error you have you are very unlikely to be the first person to have encountered it. If you are still stuck, then consulting your colleagues is often a good next step.</p>
<p>Remember that Spark uses the concept of lazy evaluation, which means that your error might be elsewhere in the code to where you think it is, since the plan will only be executed upon calling an action. If you suspect this is the case, try and put an action earlier in the code and see if it runs. Repeat this process until you have found the line of code which causes the error. With more experience of coding in Spark you will come to know which areas of your code could cause potential issues</p>
<p>Errors which appear to be related to memory are important to mention here. The first solution should <strong>not</strong> be just to increase the amount of memory; instead see if other solutions can work, for instance breaking the lineage with <a class="reference internal" href="../raw-notebooks/checkpoint-staging/checkpoint-staging.html"><span class="doc std std-doc">checkpointing or staging tables</span></a>. See the <a class="reference internal" href="../spark-concepts/optimisation-tips.html"><span class="doc std std-doc">Ideas for optimising Spark code</span></a> in the first instance. Increasing the memory should be the last resort.</p>
<p>Occasionally your error may be because of a software or hardware issue with the Spark cluster rather than your code. It is worth resetting as much as possible, e.g. if you are using a Docker container then close and reopen a session. If there are still issues then raise a ticket with your organisations IT support department.</p>
<p>If you are struggling to get started with Spark then ensure that you have read the <a class="reference internal" href="../spark-overview/spark-start.html"><span class="doc std std-doc">Getting Started with Spark</span></a> article; in particular, ensure that your environment variables are set correctly.</p>
<section id="a-recap-of-python-and-r-errors">
<h3>A recap of Python and R errors<a class="headerlink" href="#a-recap-of-python-and-r-errors" title="Permalink to this heading">#</a></h3>
<details>
<summary><b>Python Errors</b></summary>
<p>PySpark errors are just a variation of Python errors and are structured the same way, so it is worth looking at the documentation for <a class="reference external" href="https://docs.python.org/3/tutorial/errors.html">errors</a> and the <a class="reference external" href="https://docs.python.org/3/library/exceptions.html#bltin-exceptions">base exceptions</a>.</p>
<p>Some PySpark errors are fundamentally Python coding issues, not PySpark. An example is where you try and use a variable that you have not defined, for instance, when creating a new DataFrame without a valid Spark session:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-0-UHl0aG9u" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-0-UHl0aG9u" name="UHl0aG9u" role="tab" tabindex="0">Python</button></div><div aria-labelledby="tab-0-UHl0aG9u" class="sphinx-tabs-panel code-tab group-tab" id="panel-0-UHl0aG9u" name="UHl0aG9u" role="tabpanel" tabindex="0"><div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span><span class="p">,</span> <span class="n">functions</span> <span class="k">as</span> <span class="n">F</span>

<span class="n">data</span> <span class="o">=</span> <span class="p">[[</span><span class="s2">&quot;Cat&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;Dog&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">]]</span>
<span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;animal&quot;</span><span class="p">,</span> <span class="s2">&quot;count&quot;</span><span class="p">]</span>

<span class="n">animal_df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-1-UHl0aG9uIE91dHB1dA==" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-1-UHl0aG9uIE91dHB1dA==" name="UHl0aG9uIE91dHB1dA==" role="tab" tabindex="0">Python Output</button></div><div aria-labelledby="tab-1-UHl0aG9uIE91dHB1dA==" class="sphinx-tabs-panel code-tab group-tab" id="panel-1-UHl0aG9uIE91dHB1dA==" name="UHl0aG9uIE91dHB1dA==" role="tabpanel" tabindex="0"><div class="highlight-plaintext notranslate"><div class="highlight"><pre><span></span>NameError: name &#39;spark&#39; is not defined
NameError                                 Traceback (most recent call last)
in engine
----&gt; 1 animal_df = spark.createDataFrame(data, columns)

NameError: name &#39;spark&#39; is not defined
</pre></div>
</div>
</div></div>
<p>The error message on the first line here is clear: <code class="docutils literal notranslate"><span class="pre">name</span> <span class="pre">'spark'</span> <span class="pre">is</span> <span class="pre">not</span> <span class="pre">defined</span></code>, which is enough information to resolve the problem: we need to start a Spark session.</p>
<p>This error has two parts, the error message and the stack trace. The stack trace tells us the specific line where the error occurred, but this can be long when using nested functions and packages. Generally you will only want to look at the stack trace if you cannot understand the error from the error message or want to locate the line of code which needs changing.</p>
</details>
<details>
<summary><b>R Errors</b></summary>
<p>sparklyr errors are just a variation of base R errors and are structured the same way. Some sparklyr errors are fundamentally R coding issues, not sparklyr. An example is where you try and use a variable that you have not defined, for instance, when creating a new sparklyr DataFrame without first setting <code class="docutils literal notranslate"><span class="pre">sc</span></code> to be the Spark session:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-2-Ug==" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-2-Ug==" name="Ug==" role="tab" tabindex="0">R</button></div><div aria-labelledby="tab-2-Ug==" class="sphinx-tabs-panel code-tab group-tab" id="panel-2-Ug==" name="Ug==" role="tabpanel" tabindex="0"><div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">library</span><span class="p">(</span><span class="n">sparklyr</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">dplyr</span><span class="p">)</span>

<span class="c1"># Create a base R DataFrame</span>
<span class="n">animal_df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">data.frame</span><span class="p">(</span>
<span class="w">        </span><span class="n">animal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;Cat&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Dog&quot;</span><span class="p">),</span>
<span class="w">        </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">10</span><span class="p">,</span><span class="w"> </span><span class="m">5</span><span class="p">),</span>
<span class="w">        </span><span class="n">stringsAsFactors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span>

<span class="c1"># Copy base R DataFrame to the Spark cluster</span>
<span class="n">animal_sdf</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">sdf_copy_to</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span><span class="w"> </span><span class="n">animal_df</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-3-UiBPdXRwdXQ=" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-3-UiBPdXRwdXQ=" name="UiBPdXRwdXQ=" role="tab" tabindex="0">R Output</button></div><div aria-labelledby="tab-3-UiBPdXRwdXQ=" class="sphinx-tabs-panel code-tab group-tab" id="panel-3-UiBPdXRwdXQ=" name="UiBPdXRwdXQ=" role="tabpanel" tabindex="0"><div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">Error</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nf">sdf_copy_to</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span><span class="w"> </span><span class="n">animal_df</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">object</span><span class="w"> </span><span class="s">&#39;sc&#39;</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">found</span>
</pre></div>
</div>
</div></div>
<p>The error message here is easy to understand: <code class="docutils literal notranslate"><span class="pre">sc</span></code>, the Spark connection object, has not been defined. To resolve this, we just have to start a Spark session. Not all base R errors are as easy to debug as this, but they will generally be much shorter than Spark specific errors.</p>
</details>
</section>
<section id="example-spark-error-missing-file">
<h3>Example Spark error: missing file<a class="headerlink" href="#example-spark-error-missing-file" title="Permalink to this heading">#</a></h3>
<p>When using Spark, sometimes errors from other languages that the code is compiled into can be raised. You may see messages about Scala and Java errors. Do not be overwhelmed, just locate the error message on the first line rather than being distracted. An example is reading a file that does not exist.</p>
<details>
<summary><b>Python Example</b></summary>
<p>For more details on why Python error messages can be so long, especially with Spark, you may want to read the documentation on <a class="reference external" href="https://docs.python.org/3/tutorial/errors.html#exception-chaining">Exception Chaining</a>.</p>
<p>Try using <a class="reference external" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.DataFrameReader.parquet.html"><code class="docutils literal notranslate"><span class="pre">spark.read.parquet()</span></code></a> with an incorrect file path:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-4-UHl0aG9u" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-4-UHl0aG9u" name="UHl0aG9u" role="tab" tabindex="0">Python</button></div><div aria-labelledby="tab-4-UHl0aG9u" class="sphinx-tabs-panel code-tab group-tab" id="panel-4-UHl0aG9u" name="UHl0aG9u" role="tabpanel" tabindex="0"><div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span> <span class="o">=</span> <span class="p">(</span><span class="n">SparkSession</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">master</span><span class="p">(</span><span class="s2">&quot;local[2]&quot;</span><span class="p">)</span>
         <span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&quot;errors&quot;</span><span class="p">)</span>
         <span class="o">.</span><span class="n">getOrCreate</span><span class="p">())</span>

<span class="n">file_path</span> <span class="o">=</span> <span class="s2">&quot;this/is_not/a/file_path.parquet&quot;</span>

<span class="n">no_df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">parquet</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-5-VHJ1bmNhdGVkIFB5dGhvbiBPdXRwdXQ=" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-5-VHJ1bmNhdGVkIFB5dGhvbiBPdXRwdXQ=" name="VHJ1bmNhdGVkIFB5dGhvbiBPdXRwdXQ=" role="tab" tabindex="0">Truncated Python Output</button></div><div aria-labelledby="tab-5-VHJ1bmNhdGVkIFB5dGhvbiBPdXRwdXQ=" class="sphinx-tabs-panel code-tab group-tab" id="panel-5-VHJ1bmNhdGVkIFB5dGhvbiBPdXRwdXQ=" name="VHJ1bmNhdGVkIFB5dGhvbiBPdXRwdXQ=" role="tabpanel" tabindex="0"><div class="highlight-plaintext notranslate"><div class="highlight"><pre><span></span>AnalysisException: &#39;Path does not exist: hdfs://.../this/is_not/a/file_path.parquet;&#39;
Py4JJavaError                             Traceback (most recent call last)
...
</pre></div>
</div>
</div></div>
<p>The full error message is not given here as it is very long and some of it is platform specific, so try running this code in your own Spark session. You will see a long error message that has raised both a <a class="reference external" href="https://www.py4j.org/py4j_java_protocol.html"><code class="docutils literal notranslate"><span class="pre">Py4JJavaError</span></code></a> and an <a class="reference external" href="https://spark.apache.org/docs/3.0.0-preview/api/python/_modules/pyspark/sql/utils.html"><code class="docutils literal notranslate"><span class="pre">AnalysisException</span></code></a>. The <code class="docutils literal notranslate"><span class="pre">Py4JJavaError</span></code> is caused by Spark and has become an <code class="docutils literal notranslate"><span class="pre">AnalysisException</span></code> in Python.</p>
<p>We can ignore everything else apart from the first line as this contains enough information to resolve the error:</p>
<p><code class="docutils literal notranslate"><span class="pre">AnalysisException:</span> <span class="pre">'Path</span> <span class="pre">does</span> <span class="pre">not</span> <span class="pre">exist:</span> <span class="pre">hdfs://.../this/is_not/a/file_path.parquet;'</span></code></p>
<p>The code will work if the <code class="docutils literal notranslate"><span class="pre">file_path</span></code> is correct; this can be confirmed with <code class="docutils literal notranslate"><span class="pre">.show()</span></code>:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-6-UHl0aG9u" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-6-UHl0aG9u" name="UHl0aG9u" role="tab" tabindex="0">Python</button></div><div aria-labelledby="tab-6-UHl0aG9u" class="sphinx-tabs-panel code-tab group-tab" id="panel-6-UHl0aG9u" name="UHl0aG9u" role="tabpanel" tabindex="0"><div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">yaml</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;ons-spark/config.yaml&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    
<span class="n">file_path</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;rescue_path&quot;</span><span class="p">]</span>

<span class="n">rescue</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">parquet</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
<span class="n">rescue</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;incident_number&quot;</span><span class="p">,</span> <span class="s2">&quot;animal_group&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-7-UHl0aG9uIE91dHB1dA==" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-7-UHl0aG9uIE91dHB1dA==" name="UHl0aG9uIE91dHB1dA==" role="tab" tabindex="0">Python Output</button></div><div aria-labelledby="tab-7-UHl0aG9uIE91dHB1dA==" class="sphinx-tabs-panel code-tab group-tab" id="panel-7-UHl0aG9uIE91dHB1dA==" name="UHl0aG9uIE91dHB1dA==" role="tabpanel" tabindex="0"><div class="highlight-plaintext notranslate"><div class="highlight"><pre><span></span>+---------------+------------+
|incident_number|animal_group|
+---------------+------------+
|       80771131|         Cat|
|      141817141|       Horse|
|143166-22102016|        Bird|
+---------------+------------+
only showing top 3 rows
</pre></div>
</div>
</div></div>
</details>
<details>
<summary><b>R Example</b></summary>
<p>Try using <a class="reference external" href="https://spark.rstudio.com/packages/sparklyr/latest/reference/spark_read_parquet.html"><code class="docutils literal notranslate"><span class="pre">spark_read_parquet()</span></code></a> with an incorrect file path:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-8-Ug==" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-8-Ug==" name="Ug==" role="tab" tabindex="0">R</button></div><div aria-labelledby="tab-8-Ug==" class="sphinx-tabs-panel code-tab group-tab" id="panel-8-Ug==" name="Ug==" role="tabpanel" tabindex="0"><div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">spark_connect</span><span class="p">(</span>
<span class="w">    </span><span class="n">master</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;local[2]&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="n">app_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;errors&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">spark_config</span><span class="p">())</span>

<span class="n">file_path</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s">&quot;this/is_not/a/file_path.parquet&quot;</span>
<span class="n">no_df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">spark_read_parquet</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span><span class="w"> </span><span class="n">path</span><span class="o">=</span><span class="n">file_path</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-9-VHJ1bmNhdGVkIFIgT3V0cHV0" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-9-VHJ1bmNhdGVkIFIgT3V0cHV0" name="VHJ1bmNhdGVkIFIgT3V0cHV0" role="tab" tabindex="0">Truncated R Output</button></div><div aria-labelledby="tab-9-VHJ1bmNhdGVkIFIgT3V0cHV0" class="sphinx-tabs-panel code-tab group-tab" id="panel-9-VHJ1bmNhdGVkIFIgT3V0cHV0" name="VHJ1bmNhdGVkIFIgT3V0cHV0" role="tabpanel" tabindex="0"><div class="highlight-plaintext notranslate"><div class="highlight"><pre><span></span>Error: org.apache.spark.sql.AnalysisException: Path does not exist: hdfs://.../this/is_not/a/file_path.parquet;
...
</pre></div>
</div>
</div></div>
<p>The full error message is not given here as it is very long and some of it is platform specific, so try running this code in your own Spark session. Although both <code class="docutils literal notranslate"><span class="pre">java</span></code> and <code class="docutils literal notranslate"><span class="pre">scala</span></code> are mentioned in the error, ignore this and look at the first line as this contains enough information to resolve the error:</p>
<p><code class="docutils literal notranslate"><span class="pre">Error:</span> <span class="pre">org.apache.spark.sql.AnalysisException:</span> <span class="pre">Path</span> <span class="pre">does</span> <span class="pre">not</span> <span class="pre">exist:</span> <span class="pre">hdfs://.../this/is_not/a/file_path.parquet;</span></code></p>
<p>The code will work if the <code class="docutils literal notranslate"><span class="pre">file_path</span></code> is correct; this can be confirmed with <code class="docutils literal notranslate"><span class="pre">glimpse()</span></code>:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-10-Ug==" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-10-Ug==" name="Ug==" role="tab" tabindex="0">R</button></div><div aria-labelledby="tab-10-Ug==" class="sphinx-tabs-panel code-tab group-tab" id="panel-10-Ug==" name="Ug==" role="tabpanel" tabindex="0"><div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">rescue</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">spark_read_parquet</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span><span class="w"> </span><span class="n">path</span><span class="o">=</span><span class="n">config</span><span class="o">$</span><span class="n">rescue_path</span><span class="p">)</span>

<span class="n">rescue</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">    </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">select</span><span class="p">(</span><span class="n">incident_number</span><span class="p">,</span><span class="w"> </span><span class="n">animal_group</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">    </span><span class="n">pillar</span><span class="o">::</span><span class="nf">glimpse</span><span class="p">()</span>
</pre></div>
</div>
</div></div>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-11-UiBPdXRwdXQ=" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-11-UiBPdXRwdXQ=" name="UiBPdXRwdXQ=" role="tab" tabindex="0">R Output</button></div><div aria-labelledby="tab-11-UiBPdXRwdXQ=" class="sphinx-tabs-panel code-tab group-tab" id="panel-11-UiBPdXRwdXQ=" name="UiBPdXRwdXQ=" role="tabpanel" tabindex="0"><div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">Rows</span><span class="o">:</span><span class="w"> </span><span class="o">??</span>
<span class="n">Columns</span><span class="o">:</span><span class="w"> </span><span class="m">2</span>
<span class="n">Database</span><span class="o">:</span><span class="w"> </span><span class="n">spark_connection</span>
<span class="o">$</span><span class="w"> </span><span class="n">incident_number</span><span class="w"> </span><span class="o">&lt;</span><span class="n">chr</span><span class="o">&gt;</span><span class="w"> </span><span class="s">&quot;80771131&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;141817141&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;143166-22102016&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;43051141&quot;</span>â€¦
<span class="o">$</span><span class="w"> </span><span class="n">animal_group</span><span class="w">    </span><span class="o">&lt;</span><span class="n">chr</span><span class="o">&gt;</span><span class="w"> </span><span class="s">&quot;Cat&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Horse&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Bird&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Cat&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Dog&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Deer&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Deer&quot;</span><span class="p">,</span><span class="w"> </span>â€¦
</pre></div>
</div>
</div></div>
</details>
</section>
<section id="understanding-errors-summary-of-key-points">
<h3>Understanding Errors: Summary of key points<a class="headerlink" href="#understanding-errors-summary-of-key-points" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>Spark error messages can be long, but most of the output can be ignored</p></li>
<li><p><strong>Look at the first line</strong>; this is the error message and will often give you all the information you need</p></li>
<li><p>The stack trace tells you where the error occurred but can be very long and can be misleading in some circumstances</p></li>
<li><p>Error messages can contain information about errors in other languages such as Java and Scala, but these can mostly be ignored</p></li>
</ul>
</section>
</section>
<section id="handling-exceptions-in-spark">
<h2>Handling exceptions in Spark<a class="headerlink" href="#handling-exceptions-in-spark" title="Permalink to this heading">#</a></h2>
<p>When there is an error with Spark code, the code execution will be interrupted and will display an error message. In many cases this will be desirable, giving you chance to fix the error and then restart the script. You can however use error handling to print out a more useful error message. Sometimes you may want to handle the error and then let the code continue.</p>
<p>It is recommend to read the sections above on understanding errors first, especially if you are new to error handling in Python or base R.</p>
<p>The most important principle for handling errors is to look at the first line of the code. This will tell you the exception type and it is this that needs to be handled. The examples here use error outputs from CDSW; they may look different in other editors.</p>
<p>Error handling can be a tricky concept and can actually make understanding errors more difficult if implemented incorrectly, so you may want to get more experience before trying some of the ideas in this section.</p>
<section id="what-is-error-handling-and-why-use-it">
<h3>What is error handling and why use it?<a class="headerlink" href="#what-is-error-handling-and-why-use-it" title="Permalink to this heading">#</a></h3>
<p>You will often have lots of errors when developing your code and these can be put in two categories: <em>syntax errors</em> and <em>runtime errors</em>. A <em>syntax error</em> is where the code has been written incorrectly, e.g. a missing comma, and has to be fixed before the code will compile. A <em>runtime error</em> is where the code compiles and starts running, but then gets interrupted and an error message is displayed, e.g. trying to divide by zero or non-existent file trying to be read in. We saw some examples in the the section above. Only <em>runtime errors</em> can be handled.</p>
<p>We saw that Spark errors are often long and hard to read. You can use error handling to test if a block of code returns a certain type of error and instead return a clearer error message. This can save time when debugging.</p>
<p>You can also set the code to continue after an error, rather than being interrupted. You may want to do this if the error is not critical to the end result. If you do this it is a good idea to print a warning with the <code class="docutils literal notranslate"><span class="pre">print()</span></code> statement or use logging, e.g. using the <a class="reference external" href="https://docs.python.org/3/library/logging.html">Python logger</a>.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<ul class="simple">
<li><p>Just because the code runs does not mean it gives the desired results, so make sure you always test your code!</p></li>
<li><p>It is useful to know how to handle errors, but do not overuse it. Remember that errors do occur for a reason and you do <strong>not</strong> usually need to try and catch every circumstance where the code might fail.</p></li>
</ul>
</div>
</section>
<section id="how-to-handle-spark-errors">
<h3>How to handle Spark errors<a class="headerlink" href="#how-to-handle-spark-errors" title="Permalink to this heading">#</a></h3>
<details>
<summary><b>Handling Errors in PySpark</b></summary>
<p>PySpark errors can be handled in the usual Python way, with a <code class="docutils literal notranslate"><span class="pre">try</span></code>/<code class="docutils literal notranslate"><span class="pre">except</span></code> block. Python contains some base exceptions that do not need to be imported, e.g. <code class="docutils literal notranslate"><span class="pre">NameError</span></code> and <code class="docutils literal notranslate"><span class="pre">ZeroDivisionError</span></code>. Package authors sometimes create custom exceptions which need to be imported to be handled; for PySpark errors you will likely need to import <code class="docutils literal notranslate"><span class="pre">AnalysisException</span></code> from <code class="docutils literal notranslate"><span class="pre">pyspark.sql.utils</span></code> and potentially <code class="docutils literal notranslate"><span class="pre">Py4JJavaError</span></code> from <code class="docutils literal notranslate"><span class="pre">py4j.protocol</span></code>:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-12-UHl0aG9u" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-12-UHl0aG9u" name="UHl0aG9u" role="tab" tabindex="0">Python</button></div><div aria-labelledby="tab-12-UHl0aG9u" class="sphinx-tabs-panel code-tab group-tab" id="panel-12-UHl0aG9u" name="UHl0aG9u" role="tabpanel" tabindex="0"><div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">py4j.protocol</span> <span class="kn">import</span> <span class="n">Py4JJavaError</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.utils</span> <span class="kn">import</span> <span class="n">AnalysisException</span>
</pre></div>
</div>
</div></div>
</details>
<details>
<summary><b>Handling Errors in sparklyr</b></summary>
<p>Unlike Python (and many other languages), R uses a function for error handling, <code class="docutils literal notranslate"><span class="pre">tryCatch()</span></code>. sparklyr errors are still R errors, and so can be handled with <code class="docutils literal notranslate"><span class="pre">tryCatch()</span></code>. Error handling functionality is contained in base R, so there is no need to reference other packages. <a class="reference external" href="https://adv-r.hadley.nz/">Advanced R</a> has more details on <a class="reference external" href="https://adv-r.hadley.nz/conditions.html#handling-conditions"><code class="docutils literal notranslate"><span class="pre">tryCatch()</span></code></a></p>
<p>Although error handling in this way is unconventional if you are used to other languages, one advantage is that you will often use functions when coding anyway and it becomes natural to assign <code class="docutils literal notranslate"><span class="pre">tryCatch()</span></code> to a custom function.</p>
</details>
</section>
</section>
<section id="error-handling-examples">
<h2>Error Handling Examples<a class="headerlink" href="#error-handling-examples" title="Permalink to this heading">#</a></h2>
<section id="example-1-no-spark-session">
<h3>Example 1: No Spark session<a class="headerlink" href="#example-1-no-spark-session" title="Permalink to this heading">#</a></h3>
<p>A simple example of error handling is ensuring that we have a running Spark session. If want to run this code yourself, restart your container or console entirely before looking at this section.</p>
<details>
<summary><b>Python Example</b></summary>
<p>Recall the <code class="docutils literal notranslate"><span class="pre">NameError</span></code> from earlier:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-13-UHl0aG9u" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-13-UHl0aG9u" name="UHl0aG9u" role="tab" tabindex="0">Python</button></div><div aria-labelledby="tab-13-UHl0aG9u" class="sphinx-tabs-panel code-tab group-tab" id="panel-13-UHl0aG9u" name="UHl0aG9u" role="tabpanel" tabindex="0"><div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span><span class="p">,</span> <span class="n">functions</span> <span class="k">as</span> <span class="n">F</span>

<span class="n">data</span> <span class="o">=</span> <span class="p">[[</span><span class="s2">&quot;Cat&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;Dog&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">]]</span>
<span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;animal&quot;</span><span class="p">,</span> <span class="s2">&quot;count&quot;</span><span class="p">]</span>

<span class="n">animal_df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-14-UHl0aG9uIE91dHB1dA==" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-14-UHl0aG9uIE91dHB1dA==" name="UHl0aG9uIE91dHB1dA==" role="tab" tabindex="0">Python Output</button></div><div aria-labelledby="tab-14-UHl0aG9uIE91dHB1dA==" class="sphinx-tabs-panel code-tab group-tab" id="panel-14-UHl0aG9uIE91dHB1dA==" name="UHl0aG9uIE91dHB1dA==" role="tabpanel" tabindex="0"><div class="highlight-plaintext notranslate"><div class="highlight"><pre><span></span>NameError: name &#39;spark&#39; is not defined
NameError                                 Traceback (most recent call last)
in engine
----&gt; 1 animal_df = spark.createDataFrame(data, columns)

NameError: name &#39;spark&#39; is not defined
</pre></div>
</div>
</div></div>
<p>We can handle this exception and give a more useful error message.</p>
<p>In Python you can test for specific error types and the content of the error message. This ensures that we capture only the error which we want and others can be raised as usual.</p>
<p>In this example, first test for <code class="docutils literal notranslate"><span class="pre">NameError</span></code> and then check that the error message is <code class="docutils literal notranslate"><span class="pre">&quot;name</span> <span class="pre">'spark'</span> <span class="pre">is</span> <span class="pre">not</span> <span class="pre">defined&quot;</span></code>.</p>
<p>The syntax here is worth explaining:</p>
<ul class="simple">
<li><p>The code within the <code class="docutils literal notranslate"><span class="pre">try:</span></code> block has active error handing. Code outside this will not have any errors handled.</p></li>
<li><p>If a <code class="docutils literal notranslate"><span class="pre">NameError</span></code> is raised, it will be handled. Other errors will be raised as usual.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">e</span></code> is the error message object; to test the content of the message convert it to a string with <code class="docutils literal notranslate"><span class="pre">str(e)</span></code></p></li>
<li><p>Within the <code class="docutils literal notranslate"><span class="pre">except:</span></code> block <code class="docutils literal notranslate"><span class="pre">str(e)</span></code> is tested and if it is <code class="docutils literal notranslate"><span class="pre">&quot;name</span> <span class="pre">'spark'</span> <span class="pre">is</span> <span class="pre">not</span> <span class="pre">defined&quot;</span></code>, a <code class="docutils literal notranslate"><span class="pre">NameError</span></code> is raised but with a custom error message that is more useful than the default</p></li>
<li><p>Raising the error <code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">None</span></code> prevents <a class="reference external" href="https://docs.python.org/3/tutorial/errors.html#exception-chaining">exception chaining</a> and reduces the amount of output</p></li>
<li><p>If the error message is not <code class="docutils literal notranslate"><span class="pre">&quot;name</span> <span class="pre">'spark'</span> <span class="pre">is</span> <span class="pre">not</span> <span class="pre">defined&quot;</span></code> then the exception is raised as usual</p></li>
</ul>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-15-UHl0aG9u" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-15-UHl0aG9u" name="UHl0aG9u" role="tab" tabindex="0">Python</button></div><div aria-labelledby="tab-15-UHl0aG9u" class="sphinx-tabs-panel code-tab group-tab" id="panel-15-UHl0aG9u" name="UHl0aG9u" role="tabpanel" tabindex="0"><div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">animal_df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="p">)</span>
    <span class="n">animal_df</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="k">except</span> <span class="ne">NameError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;name &#39;spark&#39; is not defined&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s2">&quot;No running Spark session. Start one before creating a DataFrame&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span>
</pre></div>
</div>
</div></div>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-16-UHl0aG9uIE91dHB1dA==" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-16-UHl0aG9uIE91dHB1dA==" name="UHl0aG9uIE91dHB1dA==" role="tab" tabindex="0">Python Output</button></div><div aria-labelledby="tab-16-UHl0aG9uIE91dHB1dA==" class="sphinx-tabs-panel code-tab group-tab" id="panel-16-UHl0aG9uIE91dHB1dA==" name="UHl0aG9uIE91dHB1dA==" role="tabpanel" tabindex="0"><div class="highlight-plaintext notranslate"><div class="highlight"><pre><span></span>NameError: No running Spark session. Start one before creating a DataFrame
NameError                Traceback (most recent call last)
in engine
      4 except NameError as e:
      5     if str(e) == &quot;name &#39;spark&#39; is not defined&quot;:
----&gt; 6         raise NameError(&quot;No running Spark session. Start one before creating a DataFrame&quot;) from None
      7     else:
      8         raise

NameError: No running Spark session. Start one before creating a DataFrame
</pre></div>
</div>
</div></div>
<p>This error message is more useful than the previous one as we know exactly what to do to get the code to run correctly: start a Spark session and run the code again:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-17-UHl0aG9u" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-17-UHl0aG9u" name="UHl0aG9u" role="tab" tabindex="0">Python</button></div><div aria-labelledby="tab-17-UHl0aG9u" class="sphinx-tabs-panel code-tab group-tab" id="panel-17-UHl0aG9u" name="UHl0aG9u" role="tabpanel" tabindex="0"><div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span> <span class="o">=</span> <span class="p">(</span><span class="n">SparkSession</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">master</span><span class="p">(</span><span class="s2">&quot;local[2]&quot;</span><span class="p">)</span>
         <span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&quot;errors&quot;</span><span class="p">)</span>
         <span class="o">.</span><span class="n">getOrCreate</span><span class="p">())</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">animal_df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="p">)</span>
    <span class="n">animal_df</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="k">except</span> <span class="ne">NameError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;name &#39;spark&#39; is not defined&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s2">&quot;No running Spark session. Start one before creating a DataFrame&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span>
</pre></div>
</div>
</div></div>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-18-UHl0aG9uIE91dHB1dA==" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-18-UHl0aG9uIE91dHB1dA==" name="UHl0aG9uIE91dHB1dA==" role="tab" tabindex="0">Python Output</button></div><div aria-labelledby="tab-18-UHl0aG9uIE91dHB1dA==" class="sphinx-tabs-panel code-tab group-tab" id="panel-18-UHl0aG9uIE91dHB1dA==" name="UHl0aG9uIE91dHB1dA==" role="tabpanel" tabindex="0"><div class="highlight-plaintext notranslate"><div class="highlight"><pre><span></span>+------+-----+
|animal|count|
+------+-----+
|   Cat|   10|
|   Dog|    5|
+------+-----+
</pre></div>
</div>
</div></div>
<p>As there are no errors in the <code class="docutils literal notranslate"><span class="pre">try</span></code> block the <code class="docutils literal notranslate"><span class="pre">except</span></code> block is ignored here and the desired result is displayed.</p>
</details>
<details>
<summary><b>R Example</b></summary>
<p>Recall the <code class="docutils literal notranslate"><span class="pre">object</span> <span class="pre">'sc'</span> <span class="pre">not</span> <span class="pre">found</span></code> error from earlier:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-19-Ug==" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-19-Ug==" name="Ug==" role="tab" tabindex="0">R</button></div><div aria-labelledby="tab-19-Ug==" class="sphinx-tabs-panel code-tab group-tab" id="panel-19-Ug==" name="Ug==" role="tabpanel" tabindex="0"><div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">library</span><span class="p">(</span><span class="n">sparklyr</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">dplyr</span><span class="p">)</span>

<span class="c1"># Create a base R DataFrame</span>
<span class="n">animal_df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">data.frame</span><span class="p">(</span>
<span class="w">        </span><span class="n">animal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;Cat&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Dog&quot;</span><span class="p">),</span>
<span class="w">        </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">10</span><span class="p">,</span><span class="w"> </span><span class="m">5</span><span class="p">),</span>
<span class="w">        </span><span class="n">stringsAsFactors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span>

<span class="c1"># Copy base R DataFrame to the Spark cluster</span>
<span class="n">animal_sdf</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">sdf_copy_to</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span><span class="w"> </span><span class="n">animal_df</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-20-UiBPdXRwdXQ=" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-20-UiBPdXRwdXQ=" name="UiBPdXRwdXQ=" role="tab" tabindex="0">R Output</button></div><div aria-labelledby="tab-20-UiBPdXRwdXQ=" class="sphinx-tabs-panel code-tab group-tab" id="panel-20-UiBPdXRwdXQ=" name="UiBPdXRwdXQ=" role="tabpanel" tabindex="0"><div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">Error</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nf">sdf_copy_to</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span><span class="w"> </span><span class="n">animal_df</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">object</span><span class="w"> </span><span class="s">&#39;sc&#39;</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">found</span>
</pre></div>
</div>
</div></div>
<p>We can handle this exception and give a more useful error message.</p>
<p>In R you can test for the content of the error message. This ensures that we capture only the specific error which we want and others can be raised as usual. In this example, see if the error message contains <code class="docutils literal notranslate"><span class="pre">object</span> <span class="pre">'sc'</span> <span class="pre">not</span> <span class="pre">found</span></code>.</p>
<p>The syntax here is worth explaining:</p>
<ul class="simple">
<li><p>The expression to test and the error handling code are both contained within the <code class="docutils literal notranslate"><span class="pre">tryCatch()</span></code> statement; code outside this will not have any errors handled.</p></li>
<li><p>Code assigned to <code class="docutils literal notranslate"><span class="pre">expr</span></code> will be attempted to run</p></li>
<li><p>If there is no error, the rest of the code continues as usual</p></li>
<li><p>If an error is raised, the <code class="docutils literal notranslate"><span class="pre">error</span></code> function is called, with the error message <code class="docutils literal notranslate"><span class="pre">e</span></code> as an input</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">grepl()</span></code> is used to test if <code class="docutils literal notranslate"><span class="pre">&quot;AnalysisException:</span> <span class="pre">Path</span> <span class="pre">does</span> <span class="pre">not</span> <span class="pre">exist&quot;</span></code> is within <code class="docutils literal notranslate"><span class="pre">e</span></code>; if it is, then an error is raised with a custom error message that is more useful than the default</p></li>
<li><p>If the message is anything else, <code class="docutils literal notranslate"><span class="pre">stop(e)</span></code> will be called, which raises an error with <code class="docutils literal notranslate"><span class="pre">e</span></code> as the message</p></li>
</ul>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-21-Ug==" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-21-Ug==" name="Ug==" role="tab" tabindex="0">R</button></div><div aria-labelledby="tab-21-Ug==" class="sphinx-tabs-panel code-tab group-tab" id="panel-21-Ug==" name="Ug==" role="tabpanel" tabindex="0"><div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">tryCatch</span><span class="p">(</span>
<span class="w">    </span><span class="n">expr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1"># Copy base R DataFrame to the Spark cluster</span>
<span class="w">        </span><span class="n">animal_sdf</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">sdf_copy_to</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span><span class="w"> </span><span class="n">animal_df</span><span class="p">)</span>
<span class="w">        </span><span class="c1"># Preview data</span>
<span class="w">        </span><span class="n">pillar</span><span class="o">::</span><span class="nf">glimpse</span><span class="p">(</span><span class="n">animal_sdf</span><span class="p">)</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">e</span><span class="p">){</span>
<span class="w">        </span><span class="c1"># Test to see if the error message contains `object &#39;sc&#39; not found`</span>
<span class="w">        </span><span class="nf">if</span><span class="p">(</span><span class="nf">grepl</span><span class="p">(</span><span class="s">&quot;object &#39;sc&#39; not found&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="n">fixed</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)){</span>
<span class="w">            </span><span class="c1"># Raise error with custom message if true</span>
<span class="w">            </span><span class="nf">stop</span><span class="p">(</span><span class="s">&quot;No running Spark session. Start one before creating a sparklyr DataFrame&quot;</span><span class="p">)</span><span class="w">            </span>
<span class="w">        </span><span class="p">}</span><span class="n">else</span><span class="p">{</span>
<span class="w">            </span><span class="c1"># Raise error without modification</span>
<span class="w">            </span><span class="nf">stop</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">})</span>
</pre></div>
</div>
</div></div>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-22-UiBPdXRwdXQ=" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-22-UiBPdXRwdXQ=" name="UiBPdXRwdXQ=" role="tab" tabindex="0">R Output</button></div><div aria-labelledby="tab-22-UiBPdXRwdXQ=" class="sphinx-tabs-panel code-tab group-tab" id="panel-22-UiBPdXRwdXQ=" name="UiBPdXRwdXQ=" role="tabpanel" tabindex="0"><div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">Error</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">value</span><span class="p">[[</span><span class="m">3L</span><span class="p">]](</span><span class="n">cond</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span>
<span class="w">  </span><span class="n">No</span><span class="w"> </span><span class="n">running</span><span class="w"> </span><span class="n">Spark</span><span class="w"> </span><span class="n">session.</span><span class="w"> </span><span class="n">Start</span><span class="w"> </span><span class="n">one</span><span class="w"> </span><span class="n">before</span><span class="w"> </span><span class="n">creating</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">sparklyr</span><span class="w"> </span><span class="n">DataFrame</span>
</pre></div>
</div>
</div></div>
<p>This error message is more useful than the previous one as we know exactly what to do to get the code to run correctly: start a Spark session and run the code again:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-23-Ug==" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-23-Ug==" name="Ug==" role="tab" tabindex="0">R</button></div><div aria-labelledby="tab-23-Ug==" class="sphinx-tabs-panel code-tab group-tab" id="panel-23-Ug==" name="Ug==" role="tabpanel" tabindex="0"><div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Start Spark session</span>
<span class="n">sc</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">spark_connect</span><span class="p">(</span>
<span class="w">  </span><span class="n">master</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;local[2]&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="n">app_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;errors&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">spark_config</span><span class="p">())</span>

<span class="nf">tryCatch</span><span class="p">(</span>
<span class="w">    </span><span class="n">expr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1"># Copy base R DataFrame to the Spark cluster</span>
<span class="w">        </span><span class="n">animal_sdf</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">sdf_copy_to</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span><span class="w"> </span><span class="n">animal_df</span><span class="p">)</span>
<span class="w">        </span><span class="c1"># Preview data</span>
<span class="w">        </span><span class="n">pillar</span><span class="o">::</span><span class="nf">glimpse</span><span class="p">(</span><span class="n">animal_sdf</span><span class="p">)</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">e</span><span class="p">){</span>
<span class="w">        </span><span class="c1"># Test to see if the error message contains `object &#39;sc&#39; not found`</span>
<span class="w">        </span><span class="nf">if</span><span class="p">(</span><span class="nf">grepl</span><span class="p">(</span><span class="s">&quot;object &#39;sc&#39; not found&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="n">fixed</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)){</span>
<span class="w">            </span><span class="c1"># Raise error with custom message if true</span>
<span class="w">            </span><span class="nf">stop</span><span class="p">(</span><span class="s">&quot;No running Spark session. Start one before creating a sparklyr DataFrame&quot;</span><span class="p">)</span><span class="w">            </span>
<span class="w">        </span><span class="p">}</span><span class="n">else</span><span class="p">{</span>
<span class="w">            </span><span class="c1"># Raise error without modification</span>
<span class="w">            </span><span class="nf">stop</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">})</span>
</pre></div>
</div>
</div></div>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-24-UiBPdXRwdXQ=" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-24-UiBPdXRwdXQ=" name="UiBPdXRwdXQ=" role="tab" tabindex="0">R Output</button></div><div aria-labelledby="tab-24-UiBPdXRwdXQ=" class="sphinx-tabs-panel code-tab group-tab" id="panel-24-UiBPdXRwdXQ=" name="UiBPdXRwdXQ=" role="tabpanel" tabindex="0"><div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">Rows</span><span class="o">:</span><span class="w"> </span><span class="o">??</span>
<span class="n">Columns</span><span class="o">:</span><span class="w"> </span><span class="m">2</span>
<span class="n">Database</span><span class="o">:</span><span class="w"> </span><span class="n">spark_connection</span>
<span class="o">$</span><span class="w"> </span><span class="n">animal</span><span class="w"> </span><span class="o">&lt;</span><span class="n">chr</span><span class="o">&gt;</span><span class="w"> </span><span class="s">&quot;Cat&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Dog&quot;</span>
<span class="o">$</span><span class="w"> </span><span class="n">count</span><span class="w">  </span><span class="o">&lt;</span><span class="n">dbl</span><span class="o">&gt;</span><span class="w"> </span><span class="m">10</span><span class="p">,</span><span class="w"> </span><span class="m">5</span>
</pre></div>
</div>
</div></div>
<p>As there are no errors in <code class="docutils literal notranslate"><span class="pre">expr</span></code> the <code class="docutils literal notranslate"><span class="pre">error</span></code> statement is ignored here and the desired result is displayed.</p>
</details>
</section>
<section id="example-2-handle-multiple-errors-in-a-function">
<h3>Example 2: Handle multiple errors in a function<a class="headerlink" href="#example-2-handle-multiple-errors-in-a-function" title="Permalink to this heading">#</a></h3>
<p>This example shows how functions can be used to handle errors.</p>
<details>
<summary><b>Python Example</b></summary>
<p>We have started to see how useful <code class="docutils literal notranslate"><span class="pre">try</span></code>/<code class="docutils literal notranslate"><span class="pre">except</span></code> blocks can be, but it adds extra lines of code which interrupt the flow for the reader. As such it is a good idea to wrap error handling in functions. You should document why you are choosing to handle the error and the docstring of a function is a natural place to do this.</p>
<p>As an example, define a wrapper function for <a class="reference external" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.DataFrameReader.csv.html"><code class="docutils literal notranslate"><span class="pre">spark.read.csv</span></code></a> which reads a CSV file from HDFS. This can handle two types of errors:</p>
<ul class="simple">
<li><p>If the Spark context has been stopped, it will return a custom error message that is much shorter and descriptive</p></li>
<li><p>If the path does not exist the same error message will be returned but raised <code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">None</span></code> to shorten the stack trace</p></li>
</ul>
<p>Only the first error which is hit at runtime will be returned. Logically this makes sense: the code could logically have multiple problems but the execution will halt at the first, meaning the rest can go undetected until the first is fixed.</p>
<p>This function uses some Python string methods to test for error message equality: <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str.find"><code class="docutils literal notranslate"><span class="pre">str.find()</span></code></a> and slicing strings with <code class="docutils literal notranslate"><span class="pre">[:]</span></code>.</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-25-UHl0aG9u" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-25-UHl0aG9u" name="UHl0aG9u" role="tab" tabindex="0">Python</button></div><div aria-labelledby="tab-25-UHl0aG9u" class="sphinx-tabs-panel code-tab group-tab" id="panel-25-UHl0aG9u" name="UHl0aG9u" role="tabpanel" tabindex="0"><div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">py4j.protocol</span> <span class="kn">import</span> <span class="n">Py4JJavaError</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.utils</span> <span class="kn">import</span> <span class="n">AnalysisException</span>

<span class="k">def</span> <span class="nf">read_csv_handle_exceptions</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read a CSV from HDFS and return a Spark DF</span>
<span class="sd">    </span>
<span class="sd">    Custom exceptions will be raised for trying to read the CSV from a stopped</span>
<span class="sd">        Spark context and if the path does not exist.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        file_path (string): path of CSV on HDFS</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        spark DataFrame</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inferSchema</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">Py4JJavaError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Uses str(e).find() to search for specific text within the error</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;java.lang.IllegalStateException: Cannot call methods on a stopped SparkContext&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Use ... from None to ignore the stack trace in the output</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Spark session has been stopped. Please start a new Spark session.&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Raise an exception if the error message is anything else</span>
            <span class="k">raise</span>
    <span class="k">except</span> <span class="n">AnalysisException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># See if the first 21 characters are the error we want to capture</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)[:</span><span class="mi">21</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&#39;Path does not exist:&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="kn">from</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span>
</pre></div>
</div>
</div></div>
<p>Stop the Spark session and try to read in a CSV:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-26-UHl0aG9u" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-26-UHl0aG9u" name="UHl0aG9u" role="tab" tabindex="0">Python</button></div><div aria-labelledby="tab-26-UHl0aG9u" class="sphinx-tabs-panel code-tab group-tab" id="panel-26-UHl0aG9u" name="UHl0aG9u" role="tabpanel" tabindex="0"><div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
<span class="n">no_df</span> <span class="o">=</span> <span class="n">read_csv_handle_exceptions</span><span class="p">(</span><span class="s2">&quot;this/is_not/a/file_path.csv&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-27-UHl0aG9uIE91dHB1dA==" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-27-UHl0aG9uIE91dHB1dA==" name="UHl0aG9uIE91dHB1dA==" role="tab" tabindex="0">Python Output</button></div><div aria-labelledby="tab-27-UHl0aG9uIE91dHB1dA==" class="sphinx-tabs-panel code-tab group-tab" id="panel-27-UHl0aG9uIE91dHB1dA==" name="UHl0aG9uIE91dHB1dA==" role="tabpanel" tabindex="0"><div class="highlight-plaintext notranslate"><div class="highlight"><pre><span></span>Exception: &#39;Path does not exist: hdfs://.../this/is_not/a/file_path.csv;&#39;
Exception                                 Traceback (most recent call last)
in engine
----&gt; 1 df = read_csv_handle_exceptions(&quot;this/is_not/a/file_path.csv&quot;)

&lt;ipython-input-1-394f508cffc3&gt; in read_csv_handle_exceptions(file_path)
     13         # See if the first 21 characters are the error we want to capture
     14         if str(e)[:21] == &quot;&#39;Path does not exist:&quot;:
---&gt; 15             raise Exception(e) from None
     16         else:
     17             raise

Exception: &#39;Path does not exist: hdfs://.../this/is_not/a/file_path.csv;&#39;
</pre></div>
</div>
</div></div>
<p>Fix the path; this will give the other error:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-28-UHl0aG9u" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-28-UHl0aG9u" name="UHl0aG9u" role="tab" tabindex="0">Python</button></div><div aria-labelledby="tab-28-UHl0aG9u" class="sphinx-tabs-panel code-tab group-tab" id="panel-28-UHl0aG9u" name="UHl0aG9u" role="tabpanel" tabindex="0"><div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">yaml</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;ons-spark/config.yaml&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    
<span class="n">rescue_path_csv</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;rescue_path_csv&quot;</span><span class="p">]</span>
<span class="n">rescue</span> <span class="o">=</span> <span class="n">read_csv_handle_exceptions</span><span class="p">(</span><span class="n">rescue_path_csv</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-29-UHl0aG9uIE91dHB1dA==" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-29-UHl0aG9uIE91dHB1dA==" name="UHl0aG9uIE91dHB1dA==" role="tab" tabindex="0">Python Output</button></div><div aria-labelledby="tab-29-UHl0aG9uIE91dHB1dA==" class="sphinx-tabs-panel code-tab group-tab" id="panel-29-UHl0aG9uIE91dHB1dA==" name="UHl0aG9uIE91dHB1dA==" role="tabpanel" tabindex="0"><div class="highlight-plaintext notranslate"><div class="highlight"><pre><span></span>Exception: Spark session has been stopped. Please start a new Spark session.
Exception                                 Traceback (most recent call last)
in engine
----&gt; 1 rescue = read_csv_handle_exceptions(rescue_path_csv)

&lt;ipython-input-1-de3ee93967c9&gt; in read_csv_handle_exceptions(file_path)
     17         if str(e).find(&quot;java.lang.IllegalStateException: Cannot call methods on a stopped SparkContext&quot;) &gt; -1:
     18             # Use ... from None to ignore the stack trace in the output
---&gt; 19             raise Exception(&quot;Spark session has been stopped. Please start a new Spark session.&quot;) from None
     20         else:
     21             # Raise an exception if the error message is anything else

Exception: Spark session has been stopped. Please start a new Spark session.
</pre></div>
</div>
</div></div>
<p>Correct both errors by starting a Spark session and reading the correct path:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-30-UHl0aG9u" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-30-UHl0aG9u" name="UHl0aG9u" role="tab" tabindex="0">Python</button></div><div aria-labelledby="tab-30-UHl0aG9u" class="sphinx-tabs-panel code-tab group-tab" id="panel-30-UHl0aG9u" name="UHl0aG9u" role="tabpanel" tabindex="0"><div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span> <span class="o">=</span> <span class="p">(</span><span class="n">SparkSession</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">master</span><span class="p">(</span><span class="s2">&quot;local[2]&quot;</span><span class="p">)</span>
         <span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&quot;errors&quot;</span><span class="p">)</span>
         <span class="o">.</span><span class="n">getOrCreate</span><span class="p">())</span>

<span class="n">rescue</span> <span class="o">=</span> <span class="n">read_csv_handle_exceptions</span><span class="p">(</span><span class="n">rescue_path_csv</span><span class="p">)</span>
<span class="n">rescue</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;IncidentNumber&quot;</span><span class="p">,</span> <span class="s2">&quot;AnimalGroupParent&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-31-UHl0aG9uIE91dHB1dA==" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-31-UHl0aG9uIE91dHB1dA==" name="UHl0aG9uIE91dHB1dA==" role="tab" tabindex="0">Python Output</button></div><div aria-labelledby="tab-31-UHl0aG9uIE91dHB1dA==" class="sphinx-tabs-panel code-tab group-tab" id="panel-31-UHl0aG9uIE91dHB1dA==" name="UHl0aG9uIE91dHB1dA==" role="tabpanel" tabindex="0"><div class="highlight-plaintext notranslate"><div class="highlight"><pre><span></span>+--------------+-----------------+
|IncidentNumber|AnimalGroupParent|
+--------------+-----------------+
|        139091|              Dog|
|        275091|              Fox|
|       2075091|              Dog|
+--------------+-----------------+
only showing top 3 rows
</pre></div>
</div>
</div></div>
<p>A better way of writing this function would be to add <code class="docutils literal notranslate"><span class="pre">spark</span></code> as a parameter to the function:</p>
<p><code class="docutils literal notranslate"><span class="pre">def</span> <span class="pre">read_csv_handle_exceptions(spark,</span> <span class="pre">file_path):</span></code></p>
<p>Writing the code in this way prompts for a Spark session and so should lead to fewer user errors when writing the code.</p>
</details>
<details>
<summary><b>R Example</b></summary>
<p>We have started to see how useful the <code class="docutils literal notranslate"><span class="pre">tryCatch()</span></code> function is, but it adds extra lines of code which interrupt the flow for the reader. It is easy to assign a <code class="docutils literal notranslate"><span class="pre">tryCatch()</span></code> function to a custom function and this will make your code neater. You should document why you are choosing to handle the error in your code.</p>
<p>As an example, define a wrapper function for <a class="reference external" href="https://spark.rstudio.com/packages/sparklyr/latest/reference/spark_read_csv.html"><code class="docutils literal notranslate"><span class="pre">spark_read_csv()</span></code></a> which reads a CSV file from HDFS. This can handle two types of errors:</p>
<ul class="simple">
<li><p>If the Spark context has been stopped, it will return a custom error message that is much shorter and descriptive</p></li>
<li><p>If the path does not exist the default error message will be returned</p></li>
</ul>
<p>Only the first error which is hit at runtime will be returned. Logically
this makes sense: the code could logically have multiple problems but
the execution will halt at the first, meaning the rest can go undetected
until the first is fixed.</p>
<p>This function uses <code class="docutils literal notranslate"><span class="pre">grepl()</span></code> to test if the error message contains a
specific string:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-32-Ug==" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-32-Ug==" name="Ug==" role="tab" tabindex="0">R</button></div><div aria-labelledby="tab-32-Ug==" class="sphinx-tabs-panel code-tab group-tab" id="panel-32-Ug==" name="Ug==" role="tabpanel" tabindex="0"><div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">read_csv_handle_exceptions</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">file_path</span><span class="p">){</span>
<span class="w">    </span><span class="nf">tryCatch</span><span class="p">(</span>
<span class="w">        </span><span class="n">expr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1"># Read a CSV file from HDFS</span>
<span class="w">            </span><span class="n">sdf</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">spark_read_csv</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span>
<span class="w">                                            </span><span class="n">file_path</span><span class="p">,</span>
<span class="w">                                            </span><span class="n">header</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span>
<span class="w">                                            </span><span class="n">infer_schema</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span>
<span class="w">            </span><span class="nf">return</span><span class="p">(</span><span class="n">sdf</span><span class="p">)</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">e</span><span class="p">){</span>
<span class="w">            </span><span class="c1"># See if the error is invalid connection and return custom error message if true</span>
<span class="w">            </span><span class="nf">if</span><span class="p">(</span><span class="nf">grepl</span><span class="p">(</span><span class="s">&quot;invalid connection&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="n">fixed</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)){</span>
<span class="w">                </span><span class="nf">stop</span><span class="p">(</span><span class="s">&quot;No running Spark session. Start one before creating a sparklyr DataFrame&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="c1"># See if the file path is valid; if not, return custom error message</span>
<span class="w">            </span><span class="p">}</span><span class="n">else</span><span class="w"> </span><span class="nf">if</span><span class="p">(</span><span class="nf">grepl</span><span class="p">(</span><span class="s">&quot;AnalysisException: Path does not exist&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="n">fixed</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)){</span>
<span class="w">                </span><span class="nf">stop</span><span class="p">(</span><span class="nf">paste</span><span class="p">(</span><span class="s">&quot;File path:&quot;</span><span class="p">,</span>
<span class="w">                           </span><span class="n">file_path</span><span class="p">,</span>
<span class="w">                           </span><span class="s">&quot;does not exist. Please supply a valid file path.&quot;</span><span class="p">,</span>
<span class="w">                           </span><span class="n">sep</span><span class="o">=</span><span class="s">&quot; &quot;</span><span class="p">))</span>
<span class="w">            </span><span class="c1"># If the error message is neither of these, return the original error</span>
<span class="w">            </span><span class="p">}</span><span class="n">else</span><span class="p">{</span><span class="nf">stop</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
<span class="w">        </span><span class="p">})</span>
<span class="p">}</span>
</pre></div>
</div>
</div></div>
<p>Stop the Spark session and try to read in a CSV:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-33-Ug==" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-33-Ug==" name="Ug==" role="tab" tabindex="0">R</button></div><div aria-labelledby="tab-33-Ug==" class="sphinx-tabs-panel code-tab group-tab" id="panel-33-Ug==" name="Ug==" role="tabpanel" tabindex="0"><div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">spark_disconnect</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span>
<span class="n">file_path</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s">&quot;this/is_not/a/file_path.csv&quot;</span>
<span class="n">no_sdf</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">read_csv_handle_exceptions</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-34-UiBPdXRwdXQ=" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-34-UiBPdXRwdXQ=" name="UiBPdXRwdXQ=" role="tab" tabindex="0">R Output</button></div><div aria-labelledby="tab-34-UiBPdXRwdXQ=" class="sphinx-tabs-panel code-tab group-tab" id="panel-34-UiBPdXRwdXQ=" name="UiBPdXRwdXQ=" role="tabpanel" tabindex="0"><div class="highlight-plaintext notranslate"><div class="highlight"><pre><span></span>Error in value[[3L]](cond) : 
  No running Spark session. Start one before creating a sparklyr DataFrame
</pre></div>
</div>
</div></div>
<p>Start a Spark session and try the function again; this will give the
other error:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-35-Ug==" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-35-Ug==" name="Ug==" role="tab" tabindex="0">R</button></div><div aria-labelledby="tab-35-Ug==" class="sphinx-tabs-panel code-tab group-tab" id="panel-35-Ug==" name="Ug==" role="tabpanel" tabindex="0"><div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">spark_connect</span><span class="p">(</span>
<span class="w">  </span><span class="n">master</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;local[2]&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="n">app_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;errors&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">spark_config</span><span class="p">())</span>
<span class="w">        </span>
<span class="n">no_sdf</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">read_csv_handle_exceptions</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-36-UiBPdXRwdXQ=" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-36-UiBPdXRwdXQ=" name="UiBPdXRwdXQ=" role="tab" tabindex="0">R Output</button></div><div aria-labelledby="tab-36-UiBPdXRwdXQ=" class="sphinx-tabs-panel code-tab group-tab" id="panel-36-UiBPdXRwdXQ=" name="UiBPdXRwdXQ=" role="tabpanel" tabindex="0"><div class="highlight-plaintext notranslate"><div class="highlight"><pre><span></span>Error in value[[3L]](cond) : 
  File path: this/is_not/a/file_path.csv does not exist. Please supply a valid file path
</pre></div>
</div>
</div></div>
<p>Run without errors by supplying a correct path:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-37-Ug==" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-37-Ug==" name="Ug==" role="tab" tabindex="0">R</button></div><div aria-labelledby="tab-37-Ug==" class="sphinx-tabs-panel code-tab group-tab" id="panel-37-Ug==" name="Ug==" role="tabpanel" tabindex="0"><div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">config</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">yaml</span><span class="o">::</span><span class="nf">yaml.load_file</span><span class="p">(</span><span class="s">&quot;ons-spark/config.yaml&quot;</span><span class="p">)</span>

<span class="n">rescue</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">read_csv_handle_exceptions</span><span class="p">(</span><span class="n">config</span><span class="o">$</span><span class="n">rescue_path_csv</span><span class="p">)</span>
<span class="n">rescue</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">    </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">select</span><span class="p">(</span><span class="n">IncidentNumber</span><span class="p">,</span><span class="w"> </span><span class="n">AnimalGroupParent</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">    </span><span class="n">pillar</span><span class="o">::</span><span class="nf">glimpse</span><span class="p">()</span>
</pre></div>
</div>
</div></div>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-38-UiBPdXRwdXQ=" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-38-UiBPdXRwdXQ=" name="UiBPdXRwdXQ=" role="tab" tabindex="0">R Output</button></div><div aria-labelledby="tab-38-UiBPdXRwdXQ=" class="sphinx-tabs-panel code-tab group-tab" id="panel-38-UiBPdXRwdXQ=" name="UiBPdXRwdXQ=" role="tabpanel" tabindex="0"><div class="highlight-plaintext notranslate"><div class="highlight"><pre><span></span>Rows: ??
Columns: 2
Database: spark_connection
$ IncidentNumber    &lt;chr&gt; &quot;139091&quot;, &quot;275091&quot;, &quot;2075091&quot;, &quot;2872091&quot;, &quot;3553091&quot;,â€¦
$ AnimalGroupParent &lt;chr&gt; &quot;Dog&quot;, &quot;Fox&quot;, &quot;Dog&quot;, &quot;Horse&quot;, &quot;Rabbit&quot;, &quot;Unknown - Hâ€¦
</pre></div>
</div>
</div></div>
<p>A better way of writing this function would be to add <code class="docutils literal notranslate"><span class="pre">sc</span></code> as a
parameter to the function:</p>
<p><code class="docutils literal notranslate"><span class="pre">read_csv_handle_exceptions</span> <span class="pre">&lt;-</span> <span class="pre">function(sc,</span> <span class="pre">file_path)</span></code></p>
<p>Writing the code in this way prompts for a Spark session and so should
lead to fewer user errors when writing the code.</p>
</details>
</section>
<section id="example-3-capture-and-ignore-the-error">
<h3>Example 3: Capture and ignore the error<a class="headerlink" href="#example-3-capture-and-ignore-the-error" title="Permalink to this heading">#</a></h3>
<p>Another option is to capture the error and ignore it. Generally you will only want to do this in limited circumstances when you are ignoring errors that you expect, and even then it is better to anticipate them using logic. After all, the code returned an error for a reason!</p>
<p>This example counts the number of distinct values in a column, returning <code class="docutils literal notranslate"><span class="pre">0</span></code> and printing a message if the column does not exist.</p>
<details>
<summary><b>Python Example</b></summary>
<p>Define a Python function in the usual way:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-39-UHl0aG9u" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-39-UHl0aG9u" name="UHl0aG9u" role="tab" tabindex="0">Python</button></div><div aria-labelledby="tab-39-UHl0aG9u" class="sphinx-tabs-panel code-tab group-tab" id="panel-39-UHl0aG9u" name="UHl0aG9u" role="tabpanel" tabindex="0"><div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">distinct_count</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">input_column</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the number of unique values of a specified column in a Spark DF.</span>
<span class="sd">    </span>
<span class="sd">    Will return an error if input_column is not in df</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        df (spark DataFrame): input DataFrame</span>
<span class="sd">        input_column (string): name of a column in df for which the distinct count is required</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        int: Count of unique values in input_column</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">input_column</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">AnalysisException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Derive an expected error</span>
        <span class="n">expected_error_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;cannot resolve &#39;`</span><span class="si">{</span><span class="n">input_column</span><span class="si">}</span><span class="s2">`&#39; given input columns&quot;</span>
        <span class="c1"># Test if the error contains the expected_error_str</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">expected_error_str</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Print a message and continue</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Column `</span><span class="si">{</span><span class="n">input_column</span><span class="si">}</span><span class="s2">` does not exist. Returning `0`&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Raise an error otherwise</span>
            <span class="k">raise</span>
</pre></div>
</div>
</div></div>
<p>Try one column which exists and one which does not:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-40-UHl0aG9u" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-40-UHl0aG9u" name="UHl0aG9u" role="tab" tabindex="0">Python</button></div><div aria-labelledby="tab-40-UHl0aG9u" class="sphinx-tabs-panel code-tab group-tab" id="panel-40-UHl0aG9u" name="UHl0aG9u" role="tabpanel" tabindex="0"><div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">rescue_path</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;rescue_path&quot;</span><span class="p">]</span>
<span class="n">rescue</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">parquet</span><span class="p">(</span><span class="n">rescue_path</span><span class="p">)</span>

<span class="n">distinct_count</span><span class="p">(</span><span class="n">rescue</span><span class="p">,</span> <span class="s2">&quot;incident_number&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-41-UHl0aG9uIE91dHB1dA==" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-41-UHl0aG9uIE91dHB1dA==" name="UHl0aG9uIE91dHB1dA==" role="tab" tabindex="0">Python Output</button></div><div aria-labelledby="tab-41-UHl0aG9uIE91dHB1dA==" class="sphinx-tabs-panel code-tab group-tab" id="panel-41-UHl0aG9uIE91dHB1dA==" name="UHl0aG9uIE91dHB1dA==" role="tabpanel" tabindex="0"><div class="highlight-plaintext notranslate"><div class="highlight"><pre><span></span>5898
</pre></div>
</div>
</div></div>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-42-UHl0aG9u" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-42-UHl0aG9u" name="UHl0aG9u" role="tab" tabindex="0">Python</button></div><div aria-labelledby="tab-42-UHl0aG9u" class="sphinx-tabs-panel code-tab group-tab" id="panel-42-UHl0aG9u" name="UHl0aG9u" role="tabpanel" tabindex="0"><div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">distinct_count</span><span class="p">(</span><span class="n">rescue</span><span class="p">,</span> <span class="s2">&quot;column_that_does_not_exist&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-43-UHl0aG9uIE91dHB1dA==" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-43-UHl0aG9uIE91dHB1dA==" name="UHl0aG9uIE91dHB1dA==" role="tab" tabindex="0">Python Output</button></div><div aria-labelledby="tab-43-UHl0aG9uIE91dHB1dA==" class="sphinx-tabs-panel code-tab group-tab" id="panel-43-UHl0aG9uIE91dHB1dA==" name="UHl0aG9uIE91dHB1dA==" role="tabpanel" tabindex="0"><div class="highlight-plaintext notranslate"><div class="highlight"><pre><span></span>Column `column_that_does_not_exist` does not exist. Returning `0`
0
</pre></div>
</div>
</div></div>
<p>A better way would be to avoid the error in the first place by checking if the column exists before the <a class="reference external" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.DataFrame.distinct.html"><code class="docutils literal notranslate"><span class="pre">.distinct()</span></code></a>:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-44-UHl0aG9u" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-44-UHl0aG9u" name="UHl0aG9u" role="tab" tabindex="0">Python</button></div><div aria-labelledby="tab-44-UHl0aG9u" class="sphinx-tabs-panel code-tab group-tab" id="panel-44-UHl0aG9u" name="UHl0aG9u" role="tabpanel" tabindex="0"><div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">distinct_count</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">input_column</span><span class="p">):</span>
    <span class="c1"># Test if column exists</span>
    <span class="k">if</span> <span class="n">input_column</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">input_column</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="c1"># Return 0 and print message if it does not exist</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Column `</span><span class="si">{</span><span class="n">input_column</span><span class="si">}</span><span class="s2">` does not exist. Returning `0`&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span>
        
<span class="n">distinct_count</span><span class="p">(</span><span class="n">rescue</span><span class="p">,</span> <span class="s2">&quot;column_that_does_not_exist&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-45-UHl0aG9uIE91dHB1dA==" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-45-UHl0aG9uIE91dHB1dA==" name="UHl0aG9uIE91dHB1dA==" role="tab" tabindex="0">Python Output</button></div><div aria-labelledby="tab-45-UHl0aG9uIE91dHB1dA==" class="sphinx-tabs-panel code-tab group-tab" id="panel-45-UHl0aG9uIE91dHB1dA==" name="UHl0aG9uIE91dHB1dA==" role="tabpanel" tabindex="0"><div class="highlight-plaintext notranslate"><div class="highlight"><pre><span></span>Column `column_that_does_not_exist` does not exist. Returning `0`
0
</pre></div>
</div>
</div></div>
</details>
<details>
<summary><b>R Example</b></summary>
<p>Define an R function in the usual way:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-46-Ug==" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-46-Ug==" name="Ug==" role="tab" tabindex="0">R</button></div><div aria-labelledby="tab-46-Ug==" class="sphinx-tabs-panel code-tab group-tab" id="panel-46-Ug==" name="Ug==" role="tabpanel" tabindex="0"><div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">distinct_count</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">sdf</span><span class="p">,</span><span class="w"> </span><span class="n">input_column</span><span class="p">){</span>
<span class="w">    </span><span class="nf">tryCatch</span><span class="p">(</span>
<span class="w">        </span><span class="n">expr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1"># Get the distinct count of input_column</span>
<span class="w">            </span><span class="nf">return</span><span class="p">(</span>
<span class="w">                </span><span class="n">sdf</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">                    </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">select</span><span class="p">(</span><span class="nf">all_of</span><span class="p">(</span><span class="n">input_column</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">                    </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">distinct</span><span class="p">()</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">                    </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">sdf_nrow</span><span class="p">()</span>
<span class="w">            </span><span class="p">)},</span>
<span class="w">        </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">e</span><span class="p">){</span>
<span class="w">            </span><span class="c1"># If the column does not exist, return 0 and print out a message</span>
<span class="w">            </span><span class="c1">#    rather than raise an exception</span>
<span class="w">            </span><span class="nf">if</span><span class="p">(</span><span class="nf">grepl</span><span class="p">(</span><span class="s">&quot;Can&#39;t subset columns that don&#39;t exist&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="n">fixed</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)){</span>
<span class="w">                </span><span class="nf">print</span><span class="p">(</span><span class="nf">paste</span><span class="p">(</span><span class="s">&quot;Column&quot;</span><span class="p">,</span>
<span class="w">                            </span><span class="n">input_column</span><span class="p">,</span>
<span class="w">                            </span><span class="s">&quot;does not exist. Returning `0`&quot;</span><span class="p">,</span>
<span class="w">                           </span><span class="n">sep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="p">))</span>
<span class="w">                </span><span class="nf">return</span><span class="p">(</span><span class="m">0</span><span class="p">)</span>
<span class="w">            </span><span class="c1"># If the error is anything else, return the original error message</span>
<span class="w">            </span><span class="p">}</span><span class="n">else</span><span class="p">{</span><span class="nf">stop</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span><span class="w">            </span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div></div>
<p>Try one column which exists and one which does not:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-47-Ug==" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-47-Ug==" name="Ug==" role="tab" tabindex="0">R</button></div><div aria-labelledby="tab-47-Ug==" class="sphinx-tabs-panel code-tab group-tab" id="panel-47-Ug==" name="Ug==" role="tabpanel" tabindex="0"><div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">incident_count</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">distinct_count</span><span class="p">(</span><span class="n">rescue</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;IncidentNumber&quot;</span><span class="p">)</span>
<span class="n">incident_count</span>
</pre></div>
</div>
</div></div>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-48-UiBPdXRwdXQ=" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-48-UiBPdXRwdXQ=" name="UiBPdXRwdXQ=" role="tab" tabindex="0">R Output</button></div><div aria-labelledby="tab-48-UiBPdXRwdXQ=" class="sphinx-tabs-panel code-tab group-tab" id="panel-48-UiBPdXRwdXQ=" name="UiBPdXRwdXQ=" role="tabpanel" tabindex="0"><div class="highlight-plaintext notranslate"><div class="highlight"><pre><span></span>[1] 5898
</pre></div>
</div>
</div></div>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-49-Ug==" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-49-Ug==" name="Ug==" role="tab" tabindex="0">R</button></div><div aria-labelledby="tab-49-Ug==" class="sphinx-tabs-panel code-tab group-tab" id="panel-49-Ug==" name="Ug==" role="tabpanel" tabindex="0"><div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">zero_count</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">distinct_count</span><span class="p">(</span><span class="n">rescue</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;column_that_does_not_exist&quot;</span><span class="p">)</span>
<span class="n">zero_count</span><span class="w">  </span>
</pre></div>
</div>
</div></div>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-50-UiBPdXRwdXQ=" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-50-UiBPdXRwdXQ=" name="UiBPdXRwdXQ=" role="tab" tabindex="0">R Output</button></div><div aria-labelledby="tab-50-UiBPdXRwdXQ=" class="sphinx-tabs-panel code-tab group-tab" id="panel-50-UiBPdXRwdXQ=" name="UiBPdXRwdXQ=" role="tabpanel" tabindex="0"><div class="highlight-plaintext notranslate"><div class="highlight"><pre><span></span>[1] &quot;Column column_that_does_not_exist does not exist. Returning `0`&quot;
[1] 0
</pre></div>
</div>
</div></div>
<p>A better way would be to avoid the error in the first place by checking if the column exists:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-51-Ug==" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-51-Ug==" name="Ug==" role="tab" tabindex="0">R</button></div><div aria-labelledby="tab-51-Ug==" class="sphinx-tabs-panel code-tab group-tab" id="panel-51-Ug==" name="Ug==" role="tabpanel" tabindex="0"><div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">distinct_count</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">sdf</span><span class="p">,</span><span class="w"> </span><span class="n">input_column</span><span class="p">){</span>
<span class="w">    </span><span class="n">col_names</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sdf</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="nf">colnames</span><span class="p">()</span>
<span class="w">    </span><span class="c1"># See if the column exists</span>
<span class="w">    </span><span class="nf">if</span><span class="p">(</span><span class="n">input_column</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="n">col_names</span><span class="p">){</span>
<span class="w">        </span><span class="nf">return</span><span class="p">(</span>
<span class="w">                </span><span class="c1"># Get the distinct count of input_column</span>
<span class="w">                </span><span class="n">sdf</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">                    </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">select</span><span class="p">(</span><span class="nf">all_of</span><span class="p">(</span><span class="n">input_column</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">                    </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">distinct</span><span class="p">()</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">                    </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">sdf_nrow</span><span class="p">()</span>
<span class="w">            </span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span><span class="n">else</span><span class="p">{</span>
<span class="w">        </span><span class="c1"># If the column does not exist, return 0 and print out a message</span>
<span class="w">        </span><span class="nf">print</span><span class="p">(</span><span class="nf">paste</span><span class="p">(</span><span class="s">&quot;Column&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="n">input_column</span><span class="p">,</span>
<span class="w">                    </span><span class="s">&quot;does not exist. Returning `0`&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="n">sep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="p">))</span>
<span class="w">        </span><span class="nf">return</span><span class="p">(</span><span class="m">0</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">zero_count</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">distinct_count</span><span class="p">(</span><span class="n">rescue</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;column_that_does_not_exist&quot;</span><span class="p">)</span>
<span class="n">zero_count</span>
</pre></div>
</div>
</div></div>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-52-UiBPdXRwdXQ=" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-52-UiBPdXRwdXQ=" name="UiBPdXRwdXQ=" role="tab" tabindex="0">R Output</button></div><div aria-labelledby="tab-52-UiBPdXRwdXQ=" class="sphinx-tabs-panel code-tab group-tab" id="panel-52-UiBPdXRwdXQ=" name="UiBPdXRwdXQ=" role="tabpanel" tabindex="0"><div class="highlight-plaintext notranslate"><div class="highlight"><pre><span></span>[1] &quot;Column column_that_does_not_exist does not exist. Returning `0`&quot;
[1] 0
</pre></div>
</div>
</div></div>
</details>
</section>
</section>
<section id="clean-up-options">
<h2>Clean up options<a class="headerlink" href="#clean-up-options" title="Permalink to this heading">#</a></h2>
<p>It is worth briefly mentioning the <code class="docutils literal notranslate"><span class="pre">finally</span></code> clause which exists in both Python and R.</p>
<p>In Python, <code class="docutils literal notranslate"><span class="pre">finally</span></code> is added at the end of a <code class="docutils literal notranslate"><span class="pre">try</span></code>/<code class="docutils literal notranslate"><span class="pre">except</span></code> block. This is where clean up code which will always be ran regardless of the outcome of the <code class="docutils literal notranslate"><span class="pre">try</span></code>/<code class="docutils literal notranslate"><span class="pre">except</span></code>. See <a class="reference external" href="https://docs.python.org/3/tutorial/errors.html#defining-clean-up-actions">Defining Clean Up Action</a> for more information.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">tryCatch()</span></code> function in R has two other options:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">warning</span></code>: Used to handle warnings; the usage is the same as <code class="docutils literal notranslate"><span class="pre">error</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">finally</span></code>: This is code that will be ran regardless of any errors, often used for clean up if needed</p></li>
</ul>
</section>
<section id="further-resources">
<h2>Further Resources<a class="headerlink" href="#further-resources" title="Permalink to this heading">#</a></h2>
<p>Spark at the ONS Articles:</p>
<ul class="simple">
<li><p><a class="reference internal" href="../raw-notebooks/checkpoint-staging/checkpoint-staging.html"><span class="doc std std-doc">Checkpointing and Staging Tables</span></a></p></li>
<li><p><a class="reference internal" href="../spark-concepts/optimisation-tips.html"><span class="doc std std-doc">Ideas for optimising Spark code</span></a></p></li>
<li><p><a class="reference internal" href="../spark-overview/spark-start.html"><span class="doc std std-doc">Getting Started with Spark</span></a></p></li>
</ul>
<p>PySpark Documentation:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.DataFrameReader.parquet.html"><code class="docutils literal notranslate"><span class="pre">spark.read.parquet()</span></code></a></p></li>
<li><p><a class="reference external" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.DataFrameReader.csv.html"><code class="docutils literal notranslate"><span class="pre">spark.read.csv</span></code></a></p></li>
<li><p><a class="reference external" href="https://spark.apache.org/docs/3.0.0-preview/api/python/_modules/pyspark/sql/utils.html"><code class="docutils literal notranslate"><span class="pre">pyspark.sql.utils</span></code></a>: source code for <code class="docutils literal notranslate"><span class="pre">AnalysisException</span></code></p></li>
<li><p><a class="reference external" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.DataFrame.distinct.html"><code class="docutils literal notranslate"><span class="pre">.distinct()</span></code></a></p></li>
</ul>
<p>Python Documentation:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://docs.python.org/3/tutorial/errors.html">Errors</a></p></li>
<li><p><a class="reference external" href="https://docs.python.org/3/library/exceptions.html#bltin-exceptions">Base Exceptions</a></p></li>
<li><p><a class="reference external" href="https://docs.python.org/3/tutorial/errors.html#exception-chaining">Exception Chaining</a></p></li>
<li><p><a class="reference external" href="https://docs.python.org/3/library/logging.html">Logging</a></p></li>
<li><p><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str.find"><code class="docutils literal notranslate"><span class="pre">str.find()</span></code></a></p></li>
</ul>
<p>sparklyr and tidyverse Documentation:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://spark.rstudio.com/packages/sparklyr/latest/reference/spark_read_parquet.html"><code class="docutils literal notranslate"><span class="pre">spark_read_parquet()</span></code></a></p></li>
<li><p><a class="reference external" href="https://spark.rstudio.com/packages/sparklyr/latest/reference/spark_read_csv.html"><code class="docutils literal notranslate"><span class="pre">spark_read_csv()</span></code></a></p></li>
<li><p><a class="reference external" href="https://adv-r.hadley.nz/">Advanced R</a></p>
<ul>
<li><p><a class="reference external" href="https://adv-r.hadley.nz/conditions.html#handling-conditions">Handling Conditions</a></p></li>
</ul>
</li>
</ul>
<p>Other Links:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://stackoverflow.com/">Stack Overflow</a></p></li>
<li><p><a class="reference external" href="https://www.py4j.org/py4j_java_protocol.html">Py4J Protocol</a>: Details of Py4J Protocal errors</p></li>
</ul>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./testing-debugging"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../spark-analysis/bin-continuous-variable.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Data binning</p>
      </div>
    </a>
    <a class="right-next"
       href="unit-testing.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Unit Testing in Spark</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#practical-tips-for-error-handling-in-spark">Practical tips for error handling in Spark</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-recap-of-python-and-r-errors">A recap of Python and R errors</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-spark-error-missing-file">Example Spark error: missing file</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#understanding-errors-summary-of-key-points">Understanding Errors: Summary of key points</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#handling-exceptions-in-spark">Handling exceptions in Spark</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#what-is-error-handling-and-why-use-it">What is error handling and why use it?</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#how-to-handle-spark-errors">How to handle Spark errors</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#error-handling-examples">Error Handling Examples</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-1-no-spark-session">Example 1: No Spark session</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-2-handle-multiple-errors-in-a-function">Example 2: Handle multiple errors in a function</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-3-capture-and-ignore-the-error">Example 3: Capture and ignore the error</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#clean-up-options">Clean up options</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#further-resources">Further Resources</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Analysis Standards and Pipelines in Quality and Improvement, Office for National Statistics
</p>

  </div>
  
  <div class="footer-item">
    

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=5b4479735964841361fd"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>