

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Logistic Regression &#8212; Spark at the ONS</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=5b4479735964841361fd" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=5b4479735964841361fd" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../_static/accessibility.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=5b4479735964841361fd" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd" />
  <script src="../_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=5b4479735964841361fd"></script>

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/tabs.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-95MGHSRD0S"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-95MGHSRD0S');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'spark-analysis/logistic-regression';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Spark and Visualisation" href="visualisation.html" />
    <link rel="prev" title="Interpolation in Spark" href="interpolation.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="Spark at the ONS - Home"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="Spark at the ONS - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    Introduction
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Spark overview</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../spark-overview/spark-start.html">Getting Started with Spark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-overview/when-to-use-spark.html">When To Use Spark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-overview/spark-session-guidance.html">Guidance on Spark Sessions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-overview/example-spark-sessions.html">Example Spark Sessions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-overview/spark-defaults.html">Configuration Hierarchy and <code class="docutils literal notranslate"><span class="pre">spark-defaults.conf</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-overview/data-types.html">Data Types in Spark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-overview/creating-dataframes.html">Creating DataFrames Manually</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-overview/reading-and-writing-data-spark.html">Reading and Writing Data in Spark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-overview/data-storage.html">Data Storage</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction to PySpark</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../pyspark-intro/pyspark-intro.html">Introduction to PySpark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pyspark-intro/returning-data.html">Returning Data from Cluster to Driver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pyspark-intro/f-col.html">Reference columns by name: <code class="docutils literal notranslate"><span class="pre">F.col()</span></code></a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction to sparklyr</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../sparklyr-intro/sparklyr-intro.html">Introduction to sparklyr</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sparklyr-intro/sparklyr-functions.html">Using Spark functions in sparklyr</a></li>

</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Spark functions</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../spark-functions/union-dataframes-with-different-columns.html">Union two DataFrames with different columns</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-functions/padding.html">Add leading zeros with <code class="docutils literal notranslate"><span class="pre">lpad()</span></code></a></li>

<li class="toctree-l1"><a class="reference internal" href="../spark-functions/sampling.html">Sampling: an overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-functions/pivot-tables.html">Pivot tables in Spark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-functions/rounding.html">Rounding differences in Python, R and Spark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-functions/window-functions.html">Window Functions in Spark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-functions/cross-joins.html">Cross Joins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-functions/arrays.html">Arrays Functions in PySpark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-functions/date-functions.html">Date functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-functions/writing-data.html">Writing Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-functions/job-description-notebook.html">Set Spark Job Description</a></li>




<li class="toctree-l1"><a class="reference internal" href="../spark-functions/median.html">Median in Spark</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Understanding and Optimising Spark</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../spark-concepts/optimisation-tips.html">Ideas for optimising Spark code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-concepts/spark-application-and-ui.html">Spark Application and UI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-concepts/groups-not-loops.html">Groups not Loops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-concepts/shuffling.html">Shuffling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-concepts/join-concepts.html">Optimising Joins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-concepts/salted-joins.html">Salted Joins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-concepts/partitions.html">Managing Partitions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-concepts/persistence.html">Persisting in Spark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-concepts/cache.html">Caching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-concepts/checkpoint-staging.html">Checkpoints and Staging Tables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-concepts/garbage-collection.html">Garbage Collection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-concepts/df-order.html">Spark DataFrames Are Not Ordered</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-concepts/exercises.html">Exercises</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Analysis in Spark</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="big-data-workflow.html">Big data workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="interpolation.html">Interpolation in Spark</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Logistic Regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="visualisation.html">Spark and Visualisation</a></li>
<li class="toctree-l1"><a class="reference internal" href="flags.html">Flags in Spark</a></li>
<li class="toctree-l1"><a class="reference internal" href="bin-continuous-variable.html">Data binning</a></li>
<li class="toctree-l1"><a class="reference internal" href="cramer_v.html">Calculating Cramér’s V from a Spark DataFrame</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Testing and Debugging</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../testing-debugging/spark-errors.html">Understanding and Handling Spark Errors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../testing-debugging/unit-testing.html">Unit Testing in Spark</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Ancillary Topics</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../ancillary-topics/module-imports.html">Naming Conflicts in Module Imports</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ancillary-topics/pydoop.html">Pydoop: HDFS to pandas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ancillary-topics/creating-a-SQL-view-in-HDFS.html">Creating a SQL view in HDFS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ancillary-topics/pandas-udfs.html">Pandas UDFs</a></li>
</ul>

        </div>
    </nav></div>
            <div class="bd-sidebar__bottom">
                <!-- To handle the deprecated key -->
                
                <div class="navbar_extra_footer">
                <div>
        <p>Book version 2022.6</p>
    </div>
    
                </div>
                
            </div>
        </div>
        <div id="rtd-footer-container"></div>
    </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/best-practice-and-impact/ons-spark" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/best-practice-and-impact/ons-spark/issues/new?title=Issue%20on%20page%20%2Fspark-analysis/logistic-regression.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/spark-analysis/logistic-regression.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Logistic Regression</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#preparing-the-data">Preparing the data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#missing-values">Missing values</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#running-a-logistic-regression-model">Running a logistic regression model</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#inferential-analysis">Inferential Analysis</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#things-to-watch-out-for">Things to watch out for</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#singularity-issue">Singularity issue</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#selecting-reference-categories">Selecting reference categories</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#multicollinearity">Multicollinearity</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#spark-ml-pipelines">Spark ML Pipelines</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-the-pipeline">Creating the Pipeline</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#further-resources">Further resources</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#acknowledgements">Acknowledgements</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="logistic-regression">
<h1>Logistic Regression<a class="headerlink" href="#logistic-regression" title="Permalink to this heading">#</a></h1>
<p>Logistic regression is often used in both predictive and inferential analysis. A logistic
regression model is trained on a dataset to learn how certain
independent variables relate to the probability of a binary outcome
occurring. The model is then applied to cases where the independent
variables are known but the outcome is unknown, and the probability of
the outcome occurring can be estimated.</p>
<p>This article shows how to use the <code class="docutils literal notranslate"><span class="pre">Spark</span> <span class="pre">ML</span></code> functions to generate a
logistic regression model in PySpark and sparklyr, including a
discussion of the steps necessary to prepare the data and potential
issues to consider. We will also show how to access standard errors and
confidence intervals for inferential analysis and how to assemble these steps into a pipeline.</p>
<section id="preparing-the-data">
<h2>Preparing the data<a class="headerlink" href="#preparing-the-data" title="Permalink to this heading">#</a></h2>
<p>We will be using the <code class="docutils literal notranslate"><span class="pre">Spark</span> <span class="pre">ML</span></code> functions <code class="docutils literal notranslate"><span class="pre">GeneralizedLinearRegression</span></code>/<code class="docutils literal notranslate"><span class="pre">ml_generalised_linear_regression</span></code>. The syntax used to call these
functions is somewhat similar to logistic regression functions in python or R.
However, there may be some additional steps to take in preparing the data
before the model can be run successfully.</p>
<p>We can read the data in as follows:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-0-UHl0aG9u" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-0-UHl0aG9u" name="UHl0aG9u" role="tab" tabindex="0">Python</button><button aria-controls="panel-0-Ug==" aria-selected="false" class="sphinx-tabs-tab code-tab group-tab" id="tab-0-Ug==" name="Ug==" role="tab" tabindex="-1">R</button></div><div aria-labelledby="tab-0-UHl0aG9u" class="sphinx-tabs-panel code-tab group-tab" id="panel-0-UHl0aG9u" name="UHl0aG9u" role="tabpanel" tabindex="0"><div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="c1">#import packages</span>

<span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
<span class="kn">import</span> <span class="nn">pyspark.sql.functions</span> <span class="k">as</span> <span class="nn">F</span>
<span class="kn">import</span> <span class="nn">yaml</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="c1">#local session </span>
<span class="n">spark</span> <span class="o">=</span> <span class="p">(</span><span class="n">SparkSession</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">master</span><span class="p">(</span><span class="s2">&quot;local[2]&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&quot;logistic-regression&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getOrCreate</span><span class="p">())</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;../../../config.yaml&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

<span class="c1"># Set the data path</span>
<span class="n">rescue_path_parquet</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;rescue_clean_path&quot;</span><span class="p">]</span>

<span class="c1"># Read in the data</span>
<span class="n">rescue</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">parquet</span><span class="p">(</span><span class="n">rescue_path_parquet</span><span class="p">)</span>

<span class="n">rescue</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">toPandas</span><span class="p">()</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-0-Ug==" class="sphinx-tabs-panel code-tab group-tab" hidden="true" id="panel-0-Ug==" name="Ug==" role="tabpanel" tabindex="0"><div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">library</span><span class="p">(</span><span class="n">sparklyr</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">dplyr</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">broom</span><span class="p">)</span>

<span class="c1"># set up spark session</span>
<span class="n">sc</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">spark_connect</span><span class="p">(</span>
<span class="w">  </span><span class="n">master</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;local[2]&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="n">app_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;logistic-regression&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">spark_config</span><span class="p">())</span>

<span class="c1"># check connection is open</span>
<span class="n">sparklyr</span><span class="o">::</span><span class="nf">spark_connection_is_open</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span>

<span class="n">config</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">yaml</span><span class="o">::</span><span class="nf">yaml.load_file</span><span class="p">(</span><span class="s">&quot;ons-spark/config.yaml&quot;</span><span class="p">)</span>

<span class="c1"># read in data</span>
<span class="n">rescue</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">spark_read_parquet</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="o">$</span><span class="n">rescue_clean_path</span><span class="p">)</span>

<span class="c1"># preview data</span>
<span class="n">dplyr</span><span class="o">::</span><span class="nf">glimpse</span><span class="p">(</span><span class="n">rescue</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
<p>Let’s say we want to use the <code class="docutils literal notranslate"><span class="pre">rescue</span></code> data to build a logistic regression model that predicts whether an animal is a cat or not. We need to create a new column for our target variable, <code class="docutils literal notranslate"><span class="pre">is_cat</span></code> which takes the value “1” if an animal is a cat, or “0” if it is not a cat.</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-1-UHl0aG9u" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-1-UHl0aG9u" name="UHl0aG9u" role="tab" tabindex="0">Python</button><button aria-controls="panel-1-Ug==" aria-selected="false" class="sphinx-tabs-tab code-tab group-tab" id="tab-1-Ug==" name="Ug==" role="tab" tabindex="-1">R</button></div><div aria-labelledby="tab-1-UHl0aG9u" class="sphinx-tabs-panel code-tab group-tab" id="panel-1-UHl0aG9u" name="UHl0aG9u" role="tabpanel" tabindex="0"><div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create is_cat column to contain target variable and select relevant predictors</span>
<span class="n">rescue_cat</span> <span class="o">=</span> <span class="n">rescue</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;is_cat&#39;</span><span class="p">,</span> 
                               <span class="n">F</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;animal_group&#39;</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;Cat&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                               <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;typeofincident&quot;</span><span class="p">,</span> 
                              <span class="s2">&quot;engine_count&quot;</span><span class="p">,</span> 
                              <span class="s2">&quot;job_hours&quot;</span><span class="p">,</span> 
                              <span class="s2">&quot;hourly_cost&quot;</span><span class="p">,</span> 
                              <span class="s2">&quot;total_cost&quot;</span><span class="p">,</span> 
                              <span class="s2">&quot;originofcall&quot;</span><span class="p">,</span> 
                              <span class="s2">&quot;propertycategory&quot;</span><span class="p">,</span>
                              <span class="s2">&quot;specialservicetypecategory&quot;</span><span class="p">,</span>
                              <span class="s2">&quot;incident_duration&quot;</span><span class="p">,</span>
                              <span class="s2">&quot;is_cat&quot;</span><span class="p">)</span>

<span class="c1"># Check created column</span>
<span class="n">rescue_cat</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">toPandas</span><span class="p">()</span>

<span class="c1"># Check data types</span>
<span class="n">rescue_cat</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-1-Ug==" class="sphinx-tabs-panel code-tab group-tab" hidden="true" id="panel-1-Ug==" name="Ug==" role="tabpanel" tabindex="0"><div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create is_cat column to contain target variable and select relevant predictors</span>
<span class="n">rescue_cat</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rescue</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span>
<span class="w">  </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">mutate</span><span class="p">(</span><span class="n">is_cat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">ifelse</span><span class="p">(</span><span class="n">animal_group</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;Cat&quot;</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span>
<span class="w">  </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">select</span><span class="p">(</span><span class="n">typeofincident</span><span class="p">,</span><span class="w"> </span>
<span class="w">                   </span><span class="n">engine_count</span><span class="p">,</span><span class="w"> </span>
<span class="w">                   </span><span class="n">job_hours</span><span class="p">,</span><span class="w"> </span>
<span class="w">                   </span><span class="n">hourly_cost</span><span class="p">,</span><span class="w"> </span>
<span class="w">                   </span><span class="n">total_cost</span><span class="p">,</span><span class="w"> </span>
<span class="w">                   </span><span class="n">originofcall</span><span class="p">,</span><span class="w"> </span>
<span class="w">                   </span><span class="n">propertycategory</span><span class="p">,</span>
<span class="w">                   </span><span class="n">specialservicetypecategory</span><span class="p">,</span>
<span class="w">                   </span><span class="n">incident_duration</span><span class="p">,</span>
<span class="w">                   </span><span class="n">is_cat</span><span class="p">)</span>

<span class="n">dplyr</span><span class="o">::</span><span class="nf">glimpse</span><span class="p">(</span><span class="n">rescue_cat</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
<p>Examining the dataset with <code class="docutils literal notranslate"><span class="pre">printSchema</span></code>/<code class="docutils literal notranslate"><span class="pre">glimpse()</span></code>, we can see that some of the columns we have selected (such as <code class="docutils literal notranslate"><span class="pre">engine_count</span></code>) are of the type “character” when they should be numeric. We can convert all of these to numeric values by running the following:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-2-UHl0aG9u" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-2-UHl0aG9u" name="UHl0aG9u" role="tab" tabindex="0">Python</button><button aria-controls="panel-2-Ug==" aria-selected="false" class="sphinx-tabs-tab code-tab group-tab" id="tab-2-Ug==" name="Ug==" role="tab" tabindex="-1">R</button></div><div aria-labelledby="tab-2-UHl0aG9u" class="sphinx-tabs-panel code-tab group-tab" id="panel-2-UHl0aG9u" name="UHl0aG9u" role="tabpanel" tabindex="0"><div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="c1"># Convert engine_count, job_hours, hourly_cost, total_cost and incident_duration columns to numeric</span>
<span class="n">rescue_cat</span> <span class="o">=</span> <span class="p">(</span>
  <span class="n">rescue_cat</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;engine_count&quot;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;engine_count&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s2">&quot;double&quot;</span><span class="p">))</span>
            <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;job_hours&quot;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;job_hours&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s2">&quot;double&quot;</span><span class="p">))</span>
            <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;hourly_cost&quot;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;hourly_cost&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s2">&quot;double&quot;</span><span class="p">))</span>
            <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;total_cost&quot;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;total_cost&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s2">&quot;double&quot;</span><span class="p">))</span>
            <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;incident_duration&quot;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;incident_duration&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s2">&quot;double&quot;</span><span class="p">)))</span>


<span class="c1"># Check data types are now correct</span>
<span class="n">rescue_cat</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-2-Ug==" class="sphinx-tabs-panel code-tab group-tab" hidden="true" id="panel-2-Ug==" name="Ug==" role="tabpanel" tabindex="0"><div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Convert engine_count, job_hours, hourly_cost, total_cost and incident_duration columns to numeric</span>
<span class="n">rescue_cat</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rescue_cat</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span>
<span class="n">dplyr</span><span class="o">::</span><span class="nf">mutate</span><span class="p">(</span><span class="nf">across</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="n">engine_count</span><span class="o">:</span><span class="n">total_cost</span><span class="p">,</span><span class="w"> </span><span class="n">incident_duration</span><span class="p">),</span><span class="w"> </span>
<span class="w">                    </span><span class="o">~</span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">.</span><span class="p">)))</span>

<span class="c1"># Check data types are now correct</span>
<span class="n">dplyr</span><span class="o">::</span><span class="nf">glimpse</span><span class="p">(</span><span class="n">rescue_cat</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
<section id="missing-values">
<h3>Missing values<a class="headerlink" href="#missing-values" title="Permalink to this heading">#</a></h3>
<p>You may already be familiar with functions such as <code class="docutils literal notranslate"><span class="pre">LogisticRegression</span></code> or <code class="docutils literal notranslate"><span class="pre">glm</span></code> for performing
logistic regression in python and R. Some of these commonly used functions are quite
user-friendly and will automatically account for issues such as missing
values in the data. However, the <code class="docutils literal notranslate"><span class="pre">Spark</span> <span class="pre">ML</span></code> functions in
PySpark and sparklyr require the user to correct for these issues before running
the regression functions.</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-3-UHl0aG9u" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-3-UHl0aG9u" name="UHl0aG9u" role="tab" tabindex="0">Python</button><button aria-controls="panel-3-Ug==" aria-selected="false" class="sphinx-tabs-tab code-tab group-tab" id="tab-3-Ug==" name="Ug==" role="tab" tabindex="-1">R</button></div><div aria-labelledby="tab-3-UHl0aG9u" class="sphinx-tabs-panel code-tab group-tab" id="panel-3-UHl0aG9u" name="UHl0aG9u" role="tabpanel" tabindex="0"><div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get the count of missing values for each column</span>
<span class="n">missing_summary</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">rescue_cat</span>
    <span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">F</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">isNull</span><span class="p">()</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s2">&quot;int&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">rescue_cat</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span>
<span class="p">)</span>

<span class="c1"># Show the summary</span>
<span class="n">missing_summary</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

<span class="c1"># We can see that these are all on the same rows by filtering for NAs in one of the columns:</span>
<span class="n">rescue_cat</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">rescue_cat</span><span class="o">.</span><span class="n">total_cost</span><span class="o">.</span><span class="n">isNull</span><span class="p">())</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">38</span><span class="p">)</span><span class="o">.</span><span class="n">toPandas</span><span class="p">()</span>

<span class="c1"># For simplicity, we will just filter out these rows:</span>
<span class="n">rescue_cat</span> <span class="o">=</span> <span class="n">rescue_cat</span><span class="o">.</span><span class="n">na</span><span class="o">.</span><span class="n">drop</span><span class="p">()</span>

<span class="c1"># Double check we have no nulls left:</span>
<span class="n">missing_summary</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">rescue_cat</span>
    <span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">F</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">isNull</span><span class="p">()</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s2">&quot;int&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">rescue_cat</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span>
    <span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-3-Ug==" class="sphinx-tabs-panel code-tab group-tab" hidden="true" id="panel-3-Ug==" name="Ug==" role="tabpanel" tabindex="0"><div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get the number of NAs in the dataset by column</span>
<span class="n">rescue_cat</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">summarise_all</span><span class="p">(</span><span class="o">~</span><span class="nf">sum</span><span class="p">(</span><span class="nf">as.integer</span><span class="p">(</span><span class="nf">is.na</span><span class="p">(</span><span class="n">.</span><span class="p">))))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span>
<span class="w">  </span><span class="nf">print</span><span class="p">(</span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">Inf</span><span class="p">)</span>

<span class="c1"># There are 38 missing values in 4 of the columns </span>
<span class="c1"># We can see that these are all on the same rows by filtering for NAs in one of the columns:</span>
<span class="n">rescue_cat</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">filter</span><span class="p">(</span><span class="nf">is.na</span><span class="p">(</span><span class="n">total_cost</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="nf">print</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="m">38</span><span class="p">)</span>

<span class="c1"># For simplicity, we will just filter out these rows:</span>
<span class="n">rescue_cat</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rescue_cat</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">filter</span><span class="p">(</span><span class="o">!</span><span class="nf">is.na</span><span class="p">(</span><span class="n">total_cost</span><span class="p">))</span><span class="w"> </span>

<span class="c1"># Double check we have no NAs left: </span>
<span class="n">rescue_cat</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">summarise_all</span><span class="p">(</span><span class="o">~</span><span class="nf">sum</span><span class="p">(</span><span class="nf">as.integer</span><span class="p">(</span><span class="nf">is.na</span><span class="p">(</span><span class="n">.</span><span class="p">))))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span>
<span class="w">  </span><span class="nf">print</span><span class="p">(</span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">Inf</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
<p>Now we have dealt with incorrect data types and missing values, we are
ready to run our logistic regression.</p>
</section>
</section>
<section id="running-a-logistic-regression-model">
<h2>Running a logistic regression model<a class="headerlink" href="#running-a-logistic-regression-model" title="Permalink to this heading">#</a></h2>
<p>When running a logistic regression model in sparklyr using <code class="docutils literal notranslate"><span class="pre">ml_generalised_linear_regression</span></code>, it is sufficient to prepare the data and deal with missing values as shown above before running the model. The function will automatically encode categorical variables without user input.</p>
<p>However, using the <code class="docutils literal notranslate"><span class="pre">Spark</span> <span class="pre">ML</span></code> functions for logistic regression in PySpark requires the user to encode any categorical variables in the dataset so they can be represented numerically before running the regression model. Typically this is done using a method called <strong>one-hot encoding</strong>. One category is selected as the reference category and new columns are created in the data for each of the other
categories, assigning a 1 or 0 for each row depending on whether that
entry belongs to that category or not.</p>
<p>This is done implicitly by the <code class="docutils literal notranslate"><span class="pre">ml_generalised_linear_regression</span></code> function in sparklyr, but in PySpark we will need to make use of the <code class="docutils literal notranslate"><span class="pre">StringIndexer</span></code> and <code class="docutils literal notranslate"><span class="pre">OneHotEncoderEstimator</span></code> feature transformers to prepare the data first. Additionally, running the regression model in PySpark requires us to assemble all of the predictor variables into a single <code class="docutils literal notranslate"><span class="pre">features</span></code> column using the <code class="docutils literal notranslate"><span class="pre">VectorAssembler</span></code> feature transformer.</p>
<p>Note that in Spark 3.X, the <code class="docutils literal notranslate"><span class="pre">OneHotEncoderEstimator</span></code> feature transformer in PySpark has been renamed <code class="docutils literal notranslate"><span class="pre">OneHotEncoder</span></code>, so the PySpark code below will need to be amended accordingly.</p>
<details>
<summary><b>Python Example</b></summary>
<p>First, we will need to encode the categorical variables. This can be done in two stages. The first uses the <code class="docutils literal notranslate"><span class="pre">StringIndexer</span></code> feature transformer to convert each categorical column into numeric data. It assigns a numerical index to each unique category. By default, it will choose the most frequent category in the data to label first (starting from 0). The next most frequent category will be assigned 1, then 2, and so on.</p>
<p>Note that the <code class="docutils literal notranslate"><span class="pre">StringIndexer</span></code> does not support multiple input columns so we will have to apply it to each category individually.</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-4-UHl0aG9u" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-4-UHl0aG9u" name="UHl0aG9u" role="tab" tabindex="0">Python</button><button aria-controls="panel-4-UHl0aG9uIG91dHB1dA==" aria-selected="false" class="sphinx-tabs-tab code-tab group-tab" id="tab-4-UHl0aG9uIG91dHB1dA==" name="UHl0aG9uIG91dHB1dA==" role="tab" tabindex="-1">Python output</button></div><div aria-labelledby="tab-4-UHl0aG9u" class="sphinx-tabs-panel code-tab group-tab" id="panel-4-UHl0aG9u" name="UHl0aG9u" role="tabpanel" tabindex="0"><div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="c1"># Importing the required libraries - replace OneHotEncoderEstimator with OneHotEncoder if using Spark &gt;= 3.0</span>
<span class="kn">from</span> <span class="nn">pyspark.ml.feature</span> <span class="kn">import</span> <span class="n">VectorAssembler</span><span class="p">,</span> <span class="n">StringIndexer</span><span class="p">,</span> <span class="n">OneHotEncoderEstimator</span>

<span class="c1">## First we call the StringIndexer separately for each categorical variable</span>

<span class="c1"># Indexing the specialservicetypecategory column</span>
<span class="n">serviceIdx</span> <span class="o">=</span> <span class="n">StringIndexer</span><span class="p">(</span><span class="n">inputCol</span><span class="o">=</span><span class="s1">&#39;specialservicetypecategory&#39;</span><span class="p">,</span>
                               <span class="n">outputCol</span><span class="o">=</span><span class="s1">&#39;serviceIndex&#39;</span><span class="p">)</span>

<span class="c1"># Indexing the originofcallcolumn</span>
<span class="n">callIdx</span> <span class="o">=</span> <span class="n">StringIndexer</span><span class="p">(</span><span class="n">inputCol</span><span class="o">=</span><span class="s1">&#39;originofcall&#39;</span><span class="p">,</span>
                               <span class="n">outputCol</span><span class="o">=</span><span class="s1">&#39;callIndex&#39;</span><span class="p">)</span>

<span class="c1"># Indexing the propertycategory column</span>
<span class="n">propertyIdx</span> <span class="o">=</span> <span class="n">StringIndexer</span><span class="p">(</span><span class="n">inputCol</span><span class="o">=</span><span class="s1">&#39;propertycategory&#39;</span><span class="p">,</span>
                               <span class="n">outputCol</span><span class="o">=</span><span class="s1">&#39;propertyIndex&#39;</span><span class="p">)</span>
                               
<span class="c1"># Apply indexing to each column one by one</span>

<span class="n">rescue_cat_indexed</span> <span class="o">=</span> <span class="n">serviceIdx</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">rescue_cat</span><span class="p">)</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">rescue_cat</span><span class="p">)</span>
<span class="n">rescue_cat_indexed</span> <span class="o">=</span> <span class="n">callIdx</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">rescue_cat_indexed</span><span class="p">)</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">rescue_cat_indexed</span><span class="p">)</span>
<span class="n">rescue_cat_indexed</span> <span class="o">=</span> <span class="n">propertyIdx</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">rescue_cat_indexed</span><span class="p">)</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">rescue_cat_indexed</span><span class="p">)</span>

<span class="c1"># Check that this has worked correctly</span>
<span class="n">rescue_cat_indexed</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;is_cat&#39;</span><span class="p">,</span> <span class="s1">&#39;specialservicetypecategory&#39;</span><span class="p">,</span> <span class="s1">&#39;originofcall&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;propertycategory&#39;</span><span class="p">,</span> <span class="s1">&#39;serviceIndex&#39;</span><span class="p">,</span> <span class="s1">&#39;callIndex&#39;</span><span class="p">,</span> 
                          <span class="s1">&#39;propertyIndex&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-4-UHl0aG9uIG91dHB1dA==" class="sphinx-tabs-panel code-tab group-tab" hidden="true" id="panel-4-UHl0aG9uIG91dHB1dA==" name="UHl0aG9uIG91dHB1dA==" role="tabpanel" tabindex="0"><div class="highlight-plaintext notranslate"><div class="highlight"><pre><span></span>+------+-------------------------------+------------------+-----------------+------------+---------+-------------+
|is_cat|specialservicetypecategory     |originofcall      |propertycategory |serviceIndex|callIndex|propertyIndex|
+------+-------------------------------+------------------+-----------------+------------+---------+-------------+
|0     |Other Animal Assistance        |Person (land Line)|Dwelling         |0.0         |1.0      |0.0          |
|0     |Other Animal Assistance        |Person (land Line)|Outdoor Structure|0.0         |1.0      |3.0          |
|0     |Animal Rescue From Below Ground|Person (mobile)   |Outdoor Structure|2.0         |0.0      |3.0          |
|0     |Animal Rescue From Water       |Person (mobile)   |Non Residential  |3.0         |0.0      |2.0          |
|0     |Other Animal Assistance        |Person (mobile)   |Dwelling         |0.0         |0.0      |0.0          |
|0     |Other Animal Assistance        |Person (land Line)|Dwelling         |0.0         |1.0      |0.0          |
|0     |Other Animal Assistance        |Person (land Line)|Outdoor          |0.0         |1.0      |1.0          |
|0     |Animal Rescue From Water       |Person (mobile)   |Outdoor          |3.0         |0.0      |1.0          |
|0     |Animal Rescue From Height      |Person (land Line)|Dwelling         |1.0         |1.0      |0.0          |
|0     |Animal Rescue From Water       |Person (mobile)   |Outdoor          |3.0         |0.0      |1.0          |
+------+-------------------------------+------------------+-----------------+------------+---------+-------------+
</pre></div>
</div>
</div></div>
<p>Next we use <code class="docutils literal notranslate"><span class="pre">OneHotEncoderEstimator</span></code> to perform one-hot encoding. This converts each of the categories we have applied the <code class="docutils literal notranslate"><span class="pre">StringIndexer</span></code> to into a vector that indicates which category the record belongs to.</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-5-UHl0aG9u" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-5-UHl0aG9u" name="UHl0aG9u" role="tab" tabindex="0">Python</button><button aria-controls="panel-5-UHl0aG9uIG91dHB1dA==" aria-selected="false" class="sphinx-tabs-tab code-tab group-tab" id="tab-5-UHl0aG9uIG91dHB1dA==" name="UHl0aG9uIG91dHB1dA==" role="tab" tabindex="-1">Python output</button></div><div aria-labelledby="tab-5-UHl0aG9u" class="sphinx-tabs-panel code-tab group-tab" id="panel-5-UHl0aG9u" name="UHl0aG9u" role="tabpanel" tabindex="0"><div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="c1"># Apply OneHotEncoderEstimator to each categorical column simultaneously</span>
<span class="c1"># Replace OneHotEncoderEstimator with OneHotEncoder if using Spark &gt;= 3.0</span>
<span class="n">encoder</span> <span class="o">=</span> <span class="n">OneHotEncoderEstimator</span><span class="p">(</span><span class="n">inputCols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;serviceIndex&#39;</span><span class="p">,</span> <span class="s1">&#39;callIndex&#39;</span><span class="p">,</span> <span class="s1">&#39;propertyIndex&#39;</span><span class="p">],</span> 
                                 <span class="n">outputCols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;serviceVec&#39;</span><span class="p">,</span> <span class="s1">&#39;callVec&#39;</span><span class="p">,</span> <span class="s1">&#39;propertyVec&#39;</span><span class="p">])</span>

<span class="n">rescue_cat_ohe</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">rescue_cat_indexed</span><span class="p">)</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">rescue_cat_indexed</span><span class="p">)</span>

<span class="c1"># Check that this has worked correctly </span>
<span class="n">rescue_cat_ohe</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;is_cat&#39;</span><span class="p">,</span> <span class="s1">&#39;specialservicetypecategory&#39;</span><span class="p">,</span> <span class="s1">&#39;originofcall&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;propertycategory&#39;</span><span class="p">,</span> <span class="s1">&#39;serviceVec&#39;</span><span class="p">,</span> <span class="s1">&#39;callVec&#39;</span><span class="p">,</span> 
                          <span class="s1">&#39;propertyVec&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-5-UHl0aG9uIG91dHB1dA==" class="sphinx-tabs-panel code-tab group-tab" hidden="true" id="panel-5-UHl0aG9uIG91dHB1dA==" name="UHl0aG9uIG91dHB1dA==" role="tabpanel" tabindex="0"><div class="highlight-plaintext notranslate"><div class="highlight"><pre><span></span>+------+-------------------------------+------------------+-----------------+-------------+-------------+-------------+
|is_cat|specialservicetypecategory     |originofcall      |propertycategory |serviceVec   |callVec      |propertyVec  |
+------+-------------------------------+------------------+-----------------+-------------+-------------+-------------+
|0     |Other Animal Assistance        |Person (land Line)|Dwelling         |(3,[0],[1.0])|(7,[1],[1.0])|(6,[0],[1.0])|
|0     |Other Animal Assistance        |Person (land Line)|Outdoor Structure|(3,[0],[1.0])|(7,[1],[1.0])|(6,[3],[1.0])|
|0     |Animal Rescue From Below Ground|Person (mobile)   |Outdoor Structure|(3,[2],[1.0])|(7,[0],[1.0])|(6,[3],[1.0])|
|0     |Animal Rescue From Water       |Person (mobile)   |Non Residential  |(3,[],[])    |(7,[0],[1.0])|(6,[2],[1.0])|
|0     |Other Animal Assistance        |Person (mobile)   |Dwelling         |(3,[0],[1.0])|(7,[0],[1.0])|(6,[0],[1.0])|
|0     |Other Animal Assistance        |Person (land Line)|Dwelling         |(3,[0],[1.0])|(7,[1],[1.0])|(6,[0],[1.0])|
|0     |Other Animal Assistance        |Person (land Line)|Outdoor          |(3,[0],[1.0])|(7,[1],[1.0])|(6,[1],[1.0])|
|0     |Animal Rescue From Water       |Person (mobile)   |Outdoor          |(3,[],[])    |(7,[0],[1.0])|(6,[1],[1.0])|
|0     |Animal Rescue From Height      |Person (land Line)|Dwelling         |(3,[1],[1.0])|(7,[1],[1.0])|(6,[0],[1.0])|
|0     |Animal Rescue From Water       |Person (mobile)   |Outdoor          |(3,[],[])    |(7,[0],[1.0])|(6,[1],[1.0])|
+------+-------------------------------+------------------+-----------------+-------------+-------------+-------------+
</pre></div>
</div>
</div></div>
<p>The format of the vectors generated by the one-hot encoders can be difficult to understand at first glance as it is not as intuitive as simply creating new columns for categories and assigning a 1 or 0 to indicate which category they belong to. The one-hot encoder feature transformer essentially maps the column indices we generated with the string indexer to a column of binary vectors.</p>
<p>Each vector has three elements. The first gives the number of categories in the encoded variable, minus one (the reference category). The second element gives the index of the category the entry belongs to, as generated previously with the string indexer. This is empty (“[]”) if the entry belongs to the reference category. The final element holds the binary value that indicates whether the entry belongs to the index column specified by the first two elements of the vector. As a result, this third element is always “1.0” unless the entry belongs to the reference category, in which case it is empty (“[]”).</p>
<p>As an example, let’s take a closer look at the first and fourth entries for <code class="docutils literal notranslate"><span class="pre">serviceVec</span></code> in the output table shown above. The first number in the vector for both entries is “3” since this is equal to the number of categories in the <code class="docutils literal notranslate"><span class="pre">specialservicetypecategory</span></code> column minus the reference category. In this case, the reference category is <code class="docutils literal notranslate"><span class="pre">Animal</span> <span class="pre">Rescue</span> <span class="pre">From</span> <span class="pre">Water</span></code> and the other categories have been assigned an index of 0 (<code class="docutils literal notranslate"><span class="pre">Other</span> <span class="pre">Animal</span> <span class="pre">Assistance</span></code>), 1 (<code class="docutils literal notranslate"><span class="pre">Animal</span> <span class="pre">Rescue</span> <span class="pre">From</span> <span class="pre">Height</span></code>), or 2 (<code class="docutils literal notranslate"><span class="pre">Animal</span> <span class="pre">Rescue</span> <span class="pre">From</span> <span class="pre">Below</span> <span class="pre">Ground</span></code>) by the string indexer. Therefore, the top row has a <code class="docutils literal notranslate"><span class="pre">serviceVec</span></code> of (3,[0], [1.0]). This means it belongs to the 0th index of the <code class="docutils literal notranslate"><span class="pre">specialservicetypecategory</span></code> column, <code class="docutils literal notranslate"><span class="pre">Other</span> <span class="pre">Animal</span> <span class="pre">Assistance</span></code>. The fourth row on the other hand is assigned (3,[],[]), where the final two elements of the vector are empty since it belongs to the reference category rather than any of our indexed categories. Further information can be found in the <a class="reference external" href="https://spark.apache.org/docs/2.3.0/api/python/pyspark.ml.html#pyspark.ml.feature.OneHotEncoder"><code class="docutils literal notranslate"><span class="pre">OneHotEncoder</span></code> documentation</a>.</p>
<p>Then, we need to vectorise all our predictors into a new column called “features” which will be our input/features class. We must also rename our target variable column, “is_cat” to “label”:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-6-UHl0aG9u" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-6-UHl0aG9u" name="UHl0aG9u" role="tab" tabindex="0">Python</button></div><div aria-labelledby="tab-6-UHl0aG9u" class="sphinx-tabs-panel code-tab group-tab" id="panel-6-UHl0aG9u" name="UHl0aG9u" role="tabpanel" tabindex="0"><div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="c1"># Call &#39;VectorAssembler&#39; to vectorise all predictor columns in dataset</span>
<span class="n">assembler</span> <span class="o">=</span> <span class="n">VectorAssembler</span><span class="p">(</span><span class="n">inputCols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;engine_count&#39;</span><span class="p">,</span> <span class="s1">&#39;job_hours&#39;</span><span class="p">,</span> <span class="s1">&#39;hourly_cost&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;callVec&#39;</span><span class="p">,</span> <span class="s1">&#39;propertyVec&#39;</span><span class="p">,</span> <span class="s1">&#39;serviceVec&#39;</span><span class="p">],</span>
                            <span class="n">outputCol</span> <span class="o">=</span> <span class="s2">&quot;features&quot;</span><span class="p">)</span>
 
<span class="c1"># Apply vectorisation                                      </span>
<span class="n">rescue_cat_vectorised</span> <span class="o">=</span> <span class="n">assembler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">rescue_cat_ohe</span><span class="p">)</span>

<span class="c1"># Rename &quot;is_cat&quot; target variable column to &quot;label&quot; ready to pass to the regression model</span>
<span class="n">rescue_cat_final</span> <span class="o">=</span> <span class="n">rescue_cat_vectorised</span><span class="o">.</span><span class="n">withColumnRenamed</span><span class="p">(</span><span class="s2">&quot;is_cat&quot;</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="s2">&quot;features&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
<p>We will use the <code class="docutils literal notranslate"><span class="pre">GeneralizedLinearRegression</span></code> <code class="docutils literal notranslate"><span class="pre">pyspark.ml</span></code> function to carry out our regression. The model can be imported and set up like so:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-7-UHl0aG9u" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-7-UHl0aG9u" name="UHl0aG9u" role="tab" tabindex="0">Python</button></div><div aria-labelledby="tab-7-UHl0aG9u" class="sphinx-tabs-panel code-tab group-tab" id="panel-7-UHl0aG9u" name="UHl0aG9u" role="tabpanel" tabindex="0"><div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import GeneralizedLinearRegression</span>
<span class="kn">from</span> <span class="nn">pyspark.ml.regression</span> <span class="kn">import</span> <span class="n">GeneralizedLinearRegression</span>

<span class="c1"># Define model - specify family and link as shown for logistic regression</span>
<span class="n">glr</span> <span class="o">=</span> <span class="n">GeneralizedLinearRegression</span><span class="p">(</span><span class="n">family</span><span class="o">=</span><span class="s2">&quot;binomial&quot;</span><span class="p">,</span> <span class="n">link</span><span class="o">=</span><span class="s2">&quot;logit&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
<p>Once this has been done we can run the model like so:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-8-UHl0aG9u" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-8-UHl0aG9u" name="UHl0aG9u" role="tab" tabindex="0">Python</button><button aria-controls="panel-8-UHl0aG9uIG91dHB1dA==" aria-selected="false" class="sphinx-tabs-tab code-tab group-tab" id="tab-8-UHl0aG9uIG91dHB1dA==" name="UHl0aG9uIG91dHB1dA==" role="tab" tabindex="-1">Python output</button></div><div aria-labelledby="tab-8-UHl0aG9u" class="sphinx-tabs-panel code-tab group-tab" id="panel-8-UHl0aG9u" name="UHl0aG9u" role="tabpanel" tabindex="0"><div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run model</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">glr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">rescue_cat_final</span><span class="p">)</span>

<span class="c1"># Get model results</span>
<span class="n">model_output</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">rescue_cat_final</span><span class="p">)</span>
<span class="n">model_output</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-8-UHl0aG9uIG91dHB1dA==" class="sphinx-tabs-panel code-tab group-tab" hidden="true" id="panel-8-UHl0aG9uIG91dHB1dA==" name="UHl0aG9uIG91dHB1dA==" role="tabpanel" tabindex="0"><div class="highlight-plaintext notranslate"><div class="highlight"><pre><span></span>+-----+--------------------+-------------------+
|label|            features|         prediction|
+-----+--------------------+-------------------+
|    0|(19,[0,1,2,5],[1....|  0.583734005921554|
|    0|(19,[0,1,2,5,11],...|0.25588401926913557|
|    0|(19,[0,1,2,11,18]...| 0.3199019536753837|
|    0|(19,[0,1,2,14,16]...| 0.1586171547926693|
|    0|(19,[0,1,2],[1.0,...|   0.55724909555173|
|    0|(19,[0,1,2,5],[1....| 0.5898814716386075|
|    0|(19,[0,1,2,5,12],...| 0.4056895632592243|
|    0|(19,[0,1,2,12,16]...|0.18097012233391097|
|    0|(19,[0,1,2,5,17],...| 0.6870145858037447|
|    0|(19,[0,1,2,12,16]...|0.18097012233391097|
+-----+--------------------+-------------------+
</pre></div>
</div>
</div></div>
</details>
<details>
<summary><b>R Example</b></summary>
We can run a logistic regression model in `sparklyr` by using the `ml_logistic_regression` function:
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-9-Ug==" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-9-Ug==" name="Ug==" role="tab" tabindex="0">R</button></div><div aria-labelledby="tab-9-Ug==" class="sphinx-tabs-panel code-tab group-tab" id="panel-9-Ug==" name="Ug==" role="tabpanel" tabindex="0"><div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run the model</span>
<span class="n">glm_out</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">ml_logistic_regression</span><span class="p">(</span><span class="n">rescue_cat</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                            </span><span class="n">formula</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;is_cat ~ engine_count + job_hours + hourly_cost + originofcall + propertycategory + specialservicetypecategory&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
<p>Where we have specified the variables to be used in the regression using
the formula syntax
<code class="docutils literal notranslate"><span class="pre">target</span> <span class="pre">variable</span> <span class="pre">~</span> <span class="pre">predictor1</span> <span class="pre">+</span> <span class="pre">predictor2</span> <span class="pre">+</span> <span class="pre">predictor3</span> <span class="pre">+...</span></code>.</p>
<p>Model predictions can be accessed using <code class="docutils literal notranslate"><span class="pre">ml_predict</span></code>:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-10-Ug==" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-10-Ug==" name="Ug==" role="tab" tabindex="0">R</button></div><div aria-labelledby="tab-10-Ug==" class="sphinx-tabs-panel code-tab group-tab" id="panel-10-Ug==" name="Ug==" role="tabpanel" tabindex="0"><div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get model predictions</span>
<span class="n">sparklyr</span><span class="o">::</span><span class="nf">ml_predict</span><span class="p">(</span><span class="n">glm_out</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span>
<span class="w">  </span><span class="nf">print</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">20</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">Inf</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
</details>
</details>
</section>
<section id="inferential-analysis">
<h2>Inferential Analysis<a class="headerlink" href="#inferential-analysis" title="Permalink to this heading">#</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">Spark</span> <span class="pre">ML</span></code> functions available in PySpark and sparklyr were largely developed
with predictive analysis in mind. This means that they have been built
primarily to specify a regression model and retrieve the prediction (as we have done above), with little information in between.</p>
<p>When conducting analysis at ONS, we are often not interested in
predicting unknown outcomes, but instead understanding the relationship
between the independent variables and the probability of the outcome.
This is what is referred to as <em>inferential analysis</em> in this section.</p>
<details>
<summary><b>Python Example</b></summary>
The regression coefficients from the model above can be accessed by applying the `summary` method:
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-11-UHl0aG9u" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-11-UHl0aG9u" name="UHl0aG9u" role="tab" tabindex="0">Python</button><button aria-controls="panel-11-UHl0aG9uIG91dHB1dA==" aria-selected="false" class="sphinx-tabs-tab code-tab group-tab" id="tab-11-UHl0aG9uIG91dHB1dA==" name="UHl0aG9uIG91dHB1dA==" role="tab" tabindex="-1">Python output</button></div><div aria-labelledby="tab-11-UHl0aG9u" class="sphinx-tabs-panel code-tab group-tab" id="panel-11-UHl0aG9u" name="UHl0aG9u" role="tabpanel" tabindex="0"><div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get model summary</span>
<span class="n">summary</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">summary</span>

<span class="c1"># Show summary</span>
<span class="n">summary</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-11-UHl0aG9uIG91dHB1dA==" class="sphinx-tabs-panel code-tab group-tab" hidden="true" id="panel-11-UHl0aG9uIG91dHB1dA==" name="UHl0aG9uIG91dHB1dA==" role="tabpanel" tabindex="0"><div class="highlight-plaintext notranslate"><div class="highlight"><pre><span></span>Coefficients:
             Feature Estimate   Std Error T Value P Value
         (Intercept) -20.7632  32614.1522 -0.0006  0.9995
        engine_count  -0.6127      0.2744 -2.2328  0.0256
           job_hours  -0.0254      0.0609 -0.4160  0.6774
         hourly_cost  -0.0007      0.0010 -0.7110  0.4771
callVec_Person (m...  21.5650  32614.1521  0.0007  0.9995
callVec_Person (l...  21.6985  32614.1521  0.0007  0.9995
      callVec_Police  20.6004  32614.1521  0.0006  0.9995
   callVec_Other Frs  20.8927  32614.1521  0.0006  0.9995
callVec_Person (r...  22.2337  32614.1522  0.0007  0.9995
   callVec_Ambulance  21.4983  32614.1522  0.0007  0.9995
   callVec_Not Known  -3.4161 357614.2975  0.0000  1.0000
propertyVec_Dwelling  -0.7497      1.4258 -0.5258  0.5990
 propertyVec_Outdoor  -1.4950      1.4245 -1.0495  0.2939
propertyVec_Non R...  -1.6538      1.4277 -1.1584  0.2467
propertyVec_Outdo...  -2.1807      1.4295 -1.5255  0.1271
propertyVec_Road ...  -0.5467      1.4325 -0.3817  0.7027
propertyVec_Other...  -1.0217      1.4957 -0.6831  0.4945
serviceVec_Other ...   0.9945      0.1600  6.2153  0.0000
serviceVec_Animal...   1.4172      0.1602  8.8450  0.0000
serviceVec_Animal...   1.4412      0.1765  8.1644  0.0000

(Dispersion parameter for binomial family taken to be 1.0000)
    Null deviance: 8123.3546 on 5840 degrees of freedom
Residual deviance: 7534.9047 on 5840 degrees of freedom
AIC: 7574.9047
</pre></div>
</div>
</div></div>
<p>This provides the regression coefficents, standard errors, t-values and p-values for each feature variable. Unfortunately, we have not yet found or built functionality in PySpark to calculate exact confidence intervals. Instead, we can approximate the 95% confidence intervals by multiplying the standard errors by 1.96 and
subtract or add this to the estimate. As PySpark regression functions
are only necessary on datasets with a large number of observations, this
approximation is sufficient. To make it clear which confidence intervals correspond to which features, the example below also shows how to reconstruct the summary above into a Pandas dataframe that also contains the confidence intervals:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-12-UHl0aG9u" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-12-UHl0aG9u" name="UHl0aG9u" role="tab" tabindex="0">Python</button><button aria-controls="panel-12-UHl0aG9uIG91dHB1dA==" aria-selected="false" class="sphinx-tabs-tab code-tab group-tab" id="tab-12-UHl0aG9uIG91dHB1dA==" name="UHl0aG9uIG91dHB1dA==" role="tab" tabindex="-1">Python output</button></div><div aria-labelledby="tab-12-UHl0aG9u" class="sphinx-tabs-panel code-tab group-tab" id="panel-12-UHl0aG9u" name="UHl0aG9u" role="tabpanel" tabindex="0"><div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get model output</span>
<span class="n">model_output</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">rescue_cat_final</span><span class="p">)</span>

<span class="c1"># Get feature names from the model output metadata</span>
<span class="c1"># Numeric and binary (categorical) metadata are accessed separately</span>
<span class="n">numeric_metadata</span> <span class="o">=</span> <span class="n">model_output</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;features&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">schema</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ml_attr&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;attrs&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;numeric&#39;</span><span class="p">)</span>
<span class="n">binary_metadata</span> <span class="o">=</span> <span class="n">model_output</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;features&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">schema</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ml_attr&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;attrs&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;binary&#39;</span><span class="p">)</span>

<span class="c1"># Merge the numeric and binary metadata lists to get all the feature names</span>
<span class="n">merge_list</span> <span class="o">=</span> <span class="n">numeric_metadata</span> <span class="o">+</span> <span class="n">binary_metadata</span>

<span class="c1"># Convert the feature name list to a Pandas dataframe</span>
<span class="n">full_summary</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">merge_list</span><span class="p">)</span>

<span class="c1"># Get the regression coefficients from the model</span>
<span class="n">full_summary</span><span class="p">[</span><span class="s1">&#39;coefficients&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">coefficients</span>

<span class="c1"># The intercept coefficient needs to be added in separately since it is not part of the features metadata</span>
<span class="c1"># Define a new row for the intercept coefficient and get value from model</span>
<span class="n">intercept</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="s1">&#39;intercept&#39;</span><span class="p">,</span> <span class="s1">&#39;coefficients&#39;</span><span class="p">:</span><span class="n">model</span><span class="o">.</span><span class="n">intercept</span><span class="p">},</span> <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="c1"># Add new row to the top of the full_summary dataframe</span>
<span class="n">full_summary</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">intercept</span><span class="p">,</span><span class="n">full_summary</span><span class="o">.</span><span class="n">loc</span><span class="p">[:]])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Add standard errors, t-values and p-values from summary into the full_summary dataframe:</span>
<span class="n">full_summary</span><span class="p">[</span><span class="s1">&#39;std_error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">coefficientStandardErrors</span>
<span class="n">full_summary</span><span class="p">[</span><span class="s1">&#39;tvalues&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">tValues</span>
<span class="n">full_summary</span><span class="p">[</span><span class="s1">&#39;pvalues&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">pValues</span>

<span class="c1"># Manually calculate upper and lower confidence bounds and add into dataframe</span>
<span class="n">full_summary</span><span class="p">[</span><span class="s1">&#39;upper_ci&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">full_summary</span><span class="p">[</span><span class="s1">&#39;coefficients&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.96</span><span class="o">*</span><span class="n">full_summary</span><span class="p">[</span><span class="s1">&#39;std_error&#39;</span><span class="p">])</span>
<span class="n">full_summary</span><span class="p">[</span><span class="s1">&#39;lower_ci&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">full_summary</span><span class="p">[</span><span class="s1">&#39;coefficients&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="mf">1.96</span><span class="o">*</span><span class="n">full_summary</span><span class="p">[</span><span class="s1">&#39;std_error&#39;</span><span class="p">])</span>

<span class="c1"># View final model summary</span>
<span class="n">full_summary</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-12-UHl0aG9uIG91dHB1dA==" class="sphinx-tabs-panel code-tab group-tab" hidden="true" id="panel-12-UHl0aG9uIG91dHB1dA==" name="UHl0aG9uIG91dHB1dA==" role="tabpanel" tabindex="0"><div class="highlight-plaintext notranslate"><div class="highlight"><pre><span></span>+--------------------+--------------------+--------------------+--------------------+--------------------+
|        coefficients|                name|           std_error|            upper_ci|            lower_ci|
+--------------------+--------------------+--------------------+--------------------+--------------------+
|  -20.76315794220359|           intercept| 0.27439316549994924| -20.225347337823692|  -21.30096854658349|
| -0.6126597088756062|        engine_count| 0.06094715323603125| -0.4932032885329849| -0.7321161292182274|
|-0.02535446471650...|           job_hours|9.849412286060397E-4|-0.02342397990843...|-0.02728494952457...|
|-7.00320718006152...|         hourly_cost|  32614.152138273617|   63923.73749069557|  -63923.73889133701|
|  21.564985360322606|callVec_Person (m...|  32614.152138267178|  63945.303176363996|  -63902.17320564335|
|  21.698455740278735|callVec_Person (l...|  32614.152138983158|   63945.43664814726|  -63902.03973666671|
|  20.600364205759604|      callVec_Police|  32614.152140241928|   63944.33855907994|  -63903.13783066841|
|  20.892709637911356|   callVec_Other Frs|  32614.152175598574|  63944.630973811116|  -63902.84555453529|
|  22.233733221849175|callVec_Person (r...|  32614.152169036308|   63945.97198453301|  -63901.50451808931|
|  21.498270939707652|   callVec_Ambulance|  357614.29750958865|   700945.5213897334|   -700902.524847854|
| -3.4160743924617485|   callVec_Not Known|  1.4258405211911767| -0.6214269709270424|  -6.210721813996455|
| -0.7497311089148078|propertyVec_Dwelling|  1.4244757580406757|   2.042241376844917|  -3.541703594674532|
| -1.4950200776261042| propertyVec_Outdoor|   1.427681376841273|   1.303235420982791|     -4.293275576235|
| -1.6537847767513523|propertyVec_Non R...|   1.429491891458024|  1.1480193305063746|  -4.455588884009079|
|  -2.180679137292761|propertyVec_Outdo...|  1.4324909069707645|  0.6270030403699374|   -4.98836131495546|
| -0.5467487331523708|propertyVec_Road ...|  1.4957287012548774|  2.3848795213071887| -3.4783769876119304|
|  -1.021736081307061|propertyVec_Other...| 0.16000819858088014|  -0.708120012088536|  -1.335352150525586|
|  0.9945046772301863|serviceVec_Other ...| 0.16022944175306697|  1.3085543830661976|   0.680454971394175|
|   1.417228201233249|serviceVec_Animal...| 0.17652526948223632|  1.7632177294184324|  1.0712386730480659|
|  1.4412252563902246|serviceVec_Animal...|   32614.15217162583|   63925.17948164301|  -63922.29703113023|
+--------------------+--------------------+--------------------+--------------------+--------------------+
</pre></div>
</div>
</div></div>
</details>
<details>
<summary><b>R Example</b></summary>
The regression coefficients from the model above can be displayed by
using the `tidy` function from the `broom` package:
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-13-Ug==" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-13-Ug==" name="Ug==" role="tab" tabindex="0">R</button><button aria-controls="panel-13-UiBvdXRwdXQ=" aria-selected="false" class="sphinx-tabs-tab code-tab group-tab" id="tab-13-UiBvdXRwdXQ=" name="UiBvdXRwdXQ=" role="tab" tabindex="-1">R output</button></div><div aria-labelledby="tab-13-Ug==" class="sphinx-tabs-panel code-tab group-tab" id="panel-13-Ug==" name="Ug==" role="tabpanel" tabindex="0"><div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run the model</span>
<span class="n">glm_out</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">ml_logistic_regression</span><span class="p">(</span><span class="n">rescue_cat</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                            </span><span class="n">formula</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;is_cat ~ engine_count + job_hours + hourly_cost + originofcall + propertycategory + specialservicetypecategory&quot;</span><span class="p">)</span>

<span class="c1"># View coefficients</span>
<span class="n">broom</span><span class="o">::</span><span class="nf">tidy</span><span class="p">(</span><span class="n">glm_out</span><span class="p">)</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-13-UiBvdXRwdXQ=" class="sphinx-tabs-panel code-tab group-tab" hidden="true" id="panel-13-UiBvdXRwdXQ=" name="UiBvdXRwdXQ=" role="tabpanel" tabindex="0"><div class="highlight-plaintext notranslate"><div class="highlight"><pre><span></span># A tibble: 20 × 2
   features                                                   coefficients
   &lt;chr&gt;                                                             &lt;dbl&gt;
 1 (Intercept)                                                   -0.124   
 2 engine_count                                                  -0.619   
 3 job_hours                                                     -0.0250  
 4 hourly_cost                                                   -0.000731
 5 originofcall_Person (mobile)                                   1.25    
 6 originofcall_Person (land Line)                                1.38    
 7 originofcall_Police                                            0.280   
 8 originofcall_Other Frs                                         0.573   
 9 originofcall_Person (running Call)                             1.91    
10 originofcall_Ambulance                                         1.18    
11 originofcall_Not Known                                       -11.3     
12 propertycategory_Dwelling                                     -1.05    
13 propertycategory_Outdoor                                      -1.80    
14 propertycategory_Non Residential                              -1.96    
15 propertycategory_Outdoor Structure                            -2.49    
16 propertycategory_Road Vehicle                                 -0.851   
17 propertycategory_Other Residential                            -1.33    
18 specialservicetypecategory_Other Animal Assistance             0.995   
19 specialservicetypecategory_Animal Rescue From Height           1.42    
20 specialservicetypecategory_Animal Rescue From Below Ground     1.44    
</pre></div>
</div>
</div></div>
<p>This does not provide a lot of information. The <code class="docutils literal notranslate"><span class="pre">ml_logistic_regression</span></code>
function only produces regression coefficients and does not produce
standard errors. This means that confidence intervals cannot be
calculated.</p>
<p>Instead, we must use the function <code class="docutils literal notranslate"><span class="pre">ml_generalised_linear_regression</span></code>.
Here, we need to specify the <code class="docutils literal notranslate"><span class="pre">family</span></code> and <code class="docutils literal notranslate"><span class="pre">link</span></code> arguments as “binomial”
and “logit” respectively in order to run a logistic regression model
that produces standard errors.</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-14-Ug==" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-14-Ug==" name="Ug==" role="tab" tabindex="0">R</button><button aria-controls="panel-14-UiBvdXRwdXQ=" aria-selected="false" class="sphinx-tabs-tab code-tab group-tab" id="tab-14-UiBvdXRwdXQ=" name="UiBvdXRwdXQ=" role="tab" tabindex="-1">R output</button></div><div aria-labelledby="tab-14-Ug==" class="sphinx-tabs-panel code-tab group-tab" id="panel-14-Ug==" name="Ug==" role="tabpanel" tabindex="0"><div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run model with ml_generalized_linear_regression</span>
<span class="n">glm_out</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">ml_generalized_linear_regression</span><span class="p">(</span><span class="n">rescue_cat</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                            </span><span class="n">formula</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;is_cat ~ engine_count + job_hours + hourly_cost + originofcall + propertycategory + specialservicetypecategory&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                            </span><span class="n">family</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;binomial&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                            </span><span class="n">link</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;logit&quot;</span><span class="p">)</span>

<span class="c1"># View a tibble of coefficients, std. error, p-values</span>
<span class="n">broom</span><span class="o">::</span><span class="nf">tidy</span><span class="p">(</span><span class="n">glm_out</span><span class="p">)</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-14-UiBvdXRwdXQ=" class="sphinx-tabs-panel code-tab group-tab" hidden="true" id="panel-14-UiBvdXRwdXQ=" name="UiBvdXRwdXQ=" role="tabpanel" tabindex="0"><div class="highlight-plaintext notranslate"><div class="highlight"><pre><span></span># A tibble: 20 × 5
   term                                    estimate std.error statistic  p.value
   &lt;chr&gt;                                      &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
 1 (Intercept)                             -2.08e+1   3.26e+4  -6.37e-4 9.99e- 1
 2 engine_count                            -6.13e-1   2.74e-1  -2.23e+0 2.56e- 2
 3 job_hours                               -2.54e-2   6.09e-2  -4.16e-1 6.77e- 1
 4 hourly_cost                             -7.00e-4   9.85e-4  -7.11e-1 4.77e- 1
 5 originofcall_Person (mobile)             2.16e+1   3.26e+4   6.61e-4 9.99e- 1
 6 originofcall_Person (land Line)          2.17e+1   3.26e+4   6.65e-4 9.99e- 1
 7 originofcall_Police                      2.06e+1   3.26e+4   6.32e-4 9.99e- 1
 8 originofcall_Other Frs                   2.09e+1   3.26e+4   6.41e-4 9.99e- 1
 9 originofcall_Person (running Call)       2.22e+1   3.26e+4   6.82e-4 9.99e- 1
10 originofcall_Ambulance                   2.15e+1   3.26e+4   6.59e-4 9.99e- 1
11 originofcall_Not Known                  -3.42e+0   3.58e+5  -9.55e-6 1.00e+ 0
12 propertycategory_Dwelling               -7.50e-1   1.43e+0  -5.26e-1 5.99e- 1
13 propertycategory_Outdoor                -1.50e+0   1.42e+0  -1.05e+0 2.94e- 1
14 propertycategory_Non Residential        -1.65e+0   1.43e+0  -1.16e+0 2.47e- 1
15 propertycategory_Outdoor Structure      -2.18e+0   1.43e+0  -1.53e+0 1.27e- 1
16 propertycategory_Road Vehicle           -5.47e-1   1.43e+0  -3.82e-1 7.03e- 1
17 propertycategory_Other Residential      -1.02e+0   1.50e+0  -6.83e-1 4.95e- 1
18 specialservicetypecategory_Other Anima…  9.95e-1   1.60e-1   6.22e+0 5.12e-10
19 specialservicetypecategory_Animal Resc…  1.42e+0   1.60e-1   8.84e+0 0       
20 specialservicetypecategory_Animal Resc…  1.44e+0   1.77e-1   8.16e+0 4.44e-16
</pre></div>
</div>
</div></div>
<p>Individual statistics of interest can also be accessed directly using
<code class="docutils literal notranslate"><span class="pre">ml_summary</span></code>. For example, to get the standard errors:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-15-Ug==" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-15-Ug==" name="Ug==" role="tab" tabindex="0">R</button><button aria-controls="panel-15-UiBvdXRwdXQ=" aria-selected="false" class="sphinx-tabs-tab code-tab group-tab" id="tab-15-UiBvdXRwdXQ=" name="UiBvdXRwdXQ=" role="tab" tabindex="-1">R output</button></div><div aria-labelledby="tab-15-Ug==" class="sphinx-tabs-panel code-tab group-tab" id="panel-15-Ug==" name="Ug==" role="tabpanel" tabindex="0"><div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">glm_out</span><span class="o">$</span><span class="n">summary</span><span class="o">$</span><span class="nf">coefficient_standard_errors</span><span class="p">()</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-15-UiBvdXRwdXQ=" class="sphinx-tabs-panel code-tab group-tab" hidden="true" id="panel-15-UiBvdXRwdXQ=" name="UiBvdXRwdXQ=" role="tabpanel" tabindex="0"><div class="highlight-plaintext notranslate"><div class="highlight"><pre><span></span> [1] 3.261415e+04 2.743932e-01 6.094715e-02 9.849412e-04 3.261415e+04
 [6] 3.261415e+04 3.261415e+04 3.261415e+04 3.261415e+04 3.261415e+04
[11] 3.576143e+05 1.425841e+00 1.424476e+00 1.427681e+00 1.429492e+00
[16] 1.432491e+00 1.495729e+00 1.600082e-01 1.602294e-01 1.765253e-01
</pre></div>
</div>
</div></div>
<p>Other statistics can also be accessed individually in this way by
replacing “coefficient_standard_errors” with the statistic of interest
from the list below:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-16-bWxfc3VtbWFyeSBvcHRpb25z" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-16-bWxfc3VtbWFyeSBvcHRpb25z" name="bWxfc3VtbWFyeSBvcHRpb25z" role="tab" tabindex="0">ml_summary options</button></div><div aria-labelledby="tab-16-bWxfc3VtbWFyeSBvcHRpb25z" class="sphinx-tabs-panel code-tab group-tab" id="panel-16-bWxfc3VtbWFyeSBvcHRpb25z" name="bWxfc3VtbWFyeSBvcHRpb25z" role="tabpanel" tabindex="0"><div class="highlight-plaintext notranslate"><div class="highlight"><pre><span></span>GeneralizedLinearRegressionTrainingSummary 
Access the following via `$` or `ml_summary()`. 
- aic() 
- degrees_of_freedom() 
- deviance() 
- dispersion() 
- null_deviance() 
- num_instances() 
- prediction_col 
- predictions 
- rank 
- residual_degree_of_freedom() 
- residual_degree_of_freedom_null() 
- residuals() 
- coefficient_standard_errors() 
- num_iterations 
- solver 
- p_values() 
- t_values()
</pre></div>
</div>
</div></div>
<p>Unfortunately, we have not yet found or built functionality in sparkylr
to calculate exact confidence intervals. Instead, we can approximate the
95% confidence intervals by multiplying the standard errors by 1.96 and
subtract or add this to the estimate. As sparklyr regression functions
are only necessary on datasets with a large number of observations, this
approximation is sufficient.</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-17-Ug==" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-17-Ug==" name="Ug==" role="tab" tabindex="0">R</button><button aria-controls="panel-17-UiBvdXRwdXQ=" aria-selected="false" class="sphinx-tabs-tab code-tab group-tab" id="tab-17-UiBvdXRwdXQ=" name="UiBvdXRwdXQ=" role="tab" tabindex="-1">R output</button></div><div aria-labelledby="tab-17-Ug==" class="sphinx-tabs-panel code-tab group-tab" id="panel-17-Ug==" name="Ug==" role="tabpanel" tabindex="0"><div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">broom</span><span class="o">::</span><span class="nf">tidy</span><span class="p">(</span><span class="n">glm_out</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">mutate</span><span class="p">(</span><span class="n">lower_ci</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">estimate</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="m">1.96</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">std.error</span><span class="p">),</span>
<span class="w">                </span><span class="n">upper_ci</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">estimate</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="m">1.96</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">std.error</span><span class="p">))</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-17-UiBvdXRwdXQ=" class="sphinx-tabs-panel code-tab group-tab" hidden="true" id="panel-17-UiBvdXRwdXQ=" name="UiBvdXRwdXQ=" role="tabpanel" tabindex="0"><div class="highlight-plaintext notranslate"><div class="highlight"><pre><span></span># A tibble: 20 × 7
   term                  estimate std.error statistic  p.value lower_ci upper_ci
   &lt;chr&gt;                    &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
 1 (Intercept)           -2.08e+1   3.26e+4  -6.37e-4 9.99e- 1 -6.39e+4  6.39e+4
 2 engine_count          -6.13e-1   2.74e-1  -2.23e+0 2.56e- 2 -1.15e+0 -7.48e-2
 3 job_hours             -2.54e-2   6.09e-2  -4.16e-1 6.77e- 1 -1.45e-1  9.41e-2
 4 hourly_cost           -7.00e-4   9.85e-4  -7.11e-1 4.77e- 1 -2.63e-3  1.23e-3
 5 originofcall_Person …  2.16e+1   3.26e+4   6.61e-4 9.99e- 1 -6.39e+4  6.39e+4
 6 originofcall_Person …  2.17e+1   3.26e+4   6.65e-4 9.99e- 1 -6.39e+4  6.39e+4
 7 originofcall_Police    2.06e+1   3.26e+4   6.32e-4 9.99e- 1 -6.39e+4  6.39e+4
 8 originofcall_Other F…  2.09e+1   3.26e+4   6.41e-4 9.99e- 1 -6.39e+4  6.39e+4
 9 originofcall_Person …  2.22e+1   3.26e+4   6.82e-4 9.99e- 1 -6.39e+4  6.39e+4
10 originofcall_Ambulan…  2.15e+1   3.26e+4   6.59e-4 9.99e- 1 -6.39e+4  6.39e+4
11 originofcall_Not Kno… -3.42e+0   3.58e+5  -9.55e-6 1.00e+ 0 -7.01e+5  7.01e+5
12 propertycategory_Dwe… -7.50e-1   1.43e+0  -5.26e-1 5.99e- 1 -3.54e+0  2.04e+0
13 propertycategory_Out… -1.50e+0   1.42e+0  -1.05e+0 2.94e- 1 -4.29e+0  1.30e+0
14 propertycategory_Non… -1.65e+0   1.43e+0  -1.16e+0 2.47e- 1 -4.45e+0  1.14e+0
15 propertycategory_Out… -2.18e+0   1.43e+0  -1.53e+0 1.27e- 1 -4.98e+0  6.21e-1
16 propertycategory_Roa… -5.47e-1   1.43e+0  -3.82e-1 7.03e- 1 -3.35e+0  2.26e+0
17 propertycategory_Oth… -1.02e+0   1.50e+0  -6.83e-1 4.95e- 1 -3.95e+0  1.91e+0
18 specialservicetypeca…  9.95e-1   1.60e-1   6.22e+0 5.12e-10  6.81e-1  1.31e+0
19 specialservicetypeca…  1.42e+0   1.60e-1   8.84e+0 0         1.10e+0  1.73e+0
20 specialservicetypeca…  1.44e+0   1.77e-1   8.16e+0 4.44e-16  1.10e+0  1.79e+0
</pre></div>
</div>
</div></div>
</details>
</section>
<section id="things-to-watch-out-for">
<h2>Things to watch out for<a class="headerlink" href="#things-to-watch-out-for" title="Permalink to this heading">#</a></h2>
<section id="singularity-issue">
<h3>Singularity issue<a class="headerlink" href="#singularity-issue" title="Permalink to this heading">#</a></h3>
<p>Some functions for carrying out logistic regression, such as <code class="docutils literal notranslate"><span class="pre">glm</span></code> when using R, are able to detect when a predictor in the model only takes a singular value and drop these columns from the analysis. However, the equivalent functions in PySpark and sparklyr do not have this functionality, so we need to be careful to check that variables included in the model take
more than one value in order to avoid errors.</p>
<details>
<summary><b>Python Example</b></summary>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-18-UHl0aG9u" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-18-UHl0aG9u" name="UHl0aG9u" role="tab" tabindex="0">Python</button></div><div aria-labelledby="tab-18-UHl0aG9u" class="sphinx-tabs-panel code-tab group-tab" id="panel-18-UHl0aG9u" name="UHl0aG9u" role="tabpanel" tabindex="0"><div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="c1"># Add the `typeofincident` categorical column into analysis </span>
<span class="c1"># Setup column indexing</span>
<span class="n">incidentIdx</span> <span class="o">=</span> <span class="n">StringIndexer</span><span class="p">(</span><span class="n">inputCol</span><span class="o">=</span><span class="s1">&#39;typeofincident&#39;</span><span class="p">,</span>
                               <span class="n">outputCol</span><span class="o">=</span><span class="s1">&#39;incidentIndex&#39;</span><span class="p">)</span>

<span class="c1"># Call the string indexer </span>
<span class="n">rescue_cat_singular_indexed</span> <span class="o">=</span> <span class="n">incidentIdx</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">rescue_cat_indexed</span><span class="p">)</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">rescue_cat_indexed</span><span class="p">)</span>

<span class="c1"># Setup one-hot encoding</span>
<span class="n">encoder_singular</span> <span class="o">=</span> <span class="n">OneHotEncoderEstimator</span><span class="p">(</span><span class="n">inputCols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;incidentIndex&#39;</span><span class="p">],</span> 
                                 <span class="n">outputCols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;incidentVec&#39;</span><span class="p">])</span>
                      
<span class="c1"># The following returns an error &quot;The input column incidentIndex should have at least two distinct values&quot;:</span>
<span class="n">rescue_cat_singular_ohe</span> <span class="o">=</span> <span class="n">encoder_singular</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">rescue_cat_singular_indexed</span><span class="p">)</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">rescue_cat_singular_indexed</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
<p>Running the code above will produce an error since the <code class="docutils literal notranslate"><span class="pre">typeofincident</span></code>
column only contains one value, <code class="docutils literal notranslate"><span class="pre">Special</span> <span class="pre">Service</span></code>. The regression model
will not run unless <code class="docutils literal notranslate"><span class="pre">typeofincident</span></code> is removed from the formula.</p>
<p>Similarly, a column with a singular numeric value will also fail. Although instead of returning an error at the encoding stage, the model will run but be unable to return a summary:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-19-UHl0aG9u" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-19-UHl0aG9u" name="UHl0aG9u" role="tab" tabindex="0">Python</button><button aria-controls="panel-19-UHl0aG9uIG91dHB1dA==" aria-selected="false" class="sphinx-tabs-tab code-tab group-tab" id="tab-19-UHl0aG9uIG91dHB1dA==" name="UHl0aG9uIG91dHB1dA==" role="tab" tabindex="-1">Python output</button></div><div aria-labelledby="tab-19-UHl0aG9u" class="sphinx-tabs-panel code-tab group-tab" id="panel-19-UHl0aG9u" name="UHl0aG9u" role="tabpanel" tabindex="0"><div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="c1"># Convert typeofincident column into numeric value</span>
<span class="n">rescue_cat_singular</span> <span class="o">=</span> <span class="n">rescue_cat_ohe</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;typeofincident&#39;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;typeofincident&#39;</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;Special Service&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                               <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

<span class="c1"># Setup the vectorassembler to include this variable in the features column</span>
<span class="n">assembler</span> <span class="o">=</span> <span class="n">VectorAssembler</span><span class="p">(</span><span class="n">inputCols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;typeofincident&#39;</span><span class="p">,</span> <span class="s1">&#39;engine_count&#39;</span><span class="p">,</span> <span class="s1">&#39;job_hours&#39;</span><span class="p">,</span> <span class="s1">&#39;hourly_cost&#39;</span><span class="p">,</span> 
                                       <span class="s1">&#39;callVec&#39;</span><span class="p">,</span> <span class="s1">&#39;propertyVec&#39;</span><span class="p">,</span> <span class="s1">&#39;serviceVec&#39;</span><span class="p">],</span> 
                           <span class="n">outputCol</span> <span class="o">=</span> <span class="s2">&quot;features&quot;</span><span class="p">)</span>

<span class="n">rescue_cat_vectorised_sing</span> <span class="o">=</span> <span class="n">assembler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">rescue_cat_singular</span><span class="p">)</span>


<span class="n">rescue_cat_final_sing</span> <span class="o">=</span> <span class="n">rescue_cat_vectorised_sing</span><span class="o">.</span><span class="n">withColumnRenamed</span><span class="p">(</span><span class="s2">&quot;is_cat&quot;</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="s2">&quot;features&quot;</span><span class="p">)</span>

<span class="c1"># Run the model</span>
<span class="n">model_sing</span> <span class="o">=</span> <span class="n">glr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">rescue_cat_final_sing</span><span class="p">)</span>

<span class="c1"># Return model summary (will give an error)</span>
<span class="n">summary_sing</span> <span class="o">=</span> <span class="n">model_sing</span><span class="o">.</span><span class="n">summary</span>

<span class="n">summary_sing</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-19-UHl0aG9uIG91dHB1dA==" class="sphinx-tabs-panel code-tab group-tab" hidden="true" id="panel-19-UHl0aG9uIG91dHB1dA==" name="UHl0aG9uIG91dHB1dA==" role="tabpanel" tabindex="0"><div class="highlight-plaintext notranslate"><div class="highlight"><pre><span></span>Py4JJavaError: An error occurred while calling o1777.toString.
: java.lang.UnsupportedOperationException: No summary available for this GeneralizedLinearRegressionModel
	at org.apache.spark.ml.regression.GeneralizedLinearRegressionTrainingSummary.toString(GeneralizedLinearRegression.scala:1571)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:498)
	at py4j.reflection.MethodInvoker.invoke(MethodInvoker.java:244)
	at py4j.reflection.ReflectionEngine.invoke(ReflectionEngine.java:357)
	at py4j.Gateway.invoke(Gateway.java:282)
	at py4j.commands.AbstractCommand.invokeMethod(AbstractCommand.java:132)
	at py4j.commands.CallCommand.execute(CallCommand.java:79)
	at py4j.GatewayConnection.run(GatewayConnection.java:238)
	at java.lang.Thread.run(Thread.java:745)
</pre></div>
</div>
</div></div>
</details>
<details>
<summary><b>R Example</b></summary>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-20-Ug==" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-20-Ug==" name="Ug==" role="tab" tabindex="0">R</button></div><div aria-labelledby="tab-20-Ug==" class="sphinx-tabs-panel code-tab group-tab" id="panel-20-Ug==" name="Ug==" role="tabpanel" tabindex="0"><div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">glm_singular</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">ml_generalized_linear_regression</span><span class="p">(</span><span class="n">rescue_cat</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                                 </span><span class="n">formula</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;is_cat ~ typeofincident + engine_count + job_hours + hourly_cost + originofcall + propertycategory + specialservicetypecategory&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                                 </span><span class="n">family</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;binomial&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                                 </span><span class="n">link</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;logit&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
<p>Running the code above will produce an error since the <code class="docutils literal notranslate"><span class="pre">typeofincident</span></code>
column only contains one value, <code class="docutils literal notranslate"><span class="pre">Special</span> <span class="pre">Service</span></code>. The regression model
will not run unless <code class="docutils literal notranslate"><span class="pre">typeofincident</span></code> is removed from the formula.</p>
</details>
</section>
<section id="selecting-reference-categories">
<h3>Selecting reference categories<a class="headerlink" href="#selecting-reference-categories" title="Permalink to this heading">#</a></h3>
<p>When including categorical variables as independent variables in a
regression, one of the categories must act as the reference category.
The coefficients for all other categories are relative to the reference
category.</p>
<p>By default, the <code class="docutils literal notranslate"><span class="pre">OneHotEncoderEstimator</span></code>/<code class="docutils literal notranslate"><span class="pre">ml_generalized_linear_regression</span></code> functions will select the least common category as the reference category before applying one-hot encoding to the categories so that they can be
represented as a binary numerical value. For example, <code class="docutils literal notranslate"><span class="pre">specialservicetypecategory</span></code> has four unique values: Animal
Rescue From Below Ground, Animal Rescue From Height, Animal Rescue From
Water, and Other Animal Assistance.</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-21-UHl0aG9u" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-21-UHl0aG9u" name="UHl0aG9u" role="tab" tabindex="0">Python</button><button aria-controls="panel-21-Ug==" aria-selected="false" class="sphinx-tabs-tab code-tab group-tab" id="tab-21-Ug==" name="Ug==" role="tab" tabindex="-1">R</button></div><div aria-labelledby="tab-21-UHl0aG9u" class="sphinx-tabs-panel code-tab group-tab" id="panel-21-UHl0aG9u" name="UHl0aG9u" role="tabpanel" tabindex="0"><div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">rescue_cat</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&quot;specialservicetypecategory&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-21-Ug==" class="sphinx-tabs-panel code-tab group-tab" hidden="true" id="panel-21-Ug==" name="Ug==" role="tabpanel" tabindex="0"><div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">rescue_cat</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span>
<span class="w">  </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">count</span><span class="p">(</span><span class="n">specialservicetypecategory</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span>
<span class="w">  </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">arrange</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-22-UHl0aG9uIG91dHB1dA==" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-22-UHl0aG9uIG91dHB1dA==" name="UHl0aG9uIG91dHB1dA==" role="tab" tabindex="0">Python output</button><button aria-controls="panel-22-UiBvdXRwdXQ=" aria-selected="false" class="sphinx-tabs-tab code-tab group-tab" id="tab-22-UiBvdXRwdXQ=" name="UiBvdXRwdXQ=" role="tab" tabindex="-1">R output</button></div><div aria-labelledby="tab-22-UHl0aG9uIG91dHB1dA==" class="sphinx-tabs-panel code-tab group-tab" id="panel-22-UHl0aG9uIG91dHB1dA==" name="UHl0aG9uIG91dHB1dA==" role="tabpanel" tabindex="0"><div class="highlight-plaintext notranslate"><div class="highlight"><pre><span></span>+-------------------------------+-----+
|specialservicetypecategory     |count|
+-------------------------------+-----+
|Animal Rescue From Water       |343  |
|Animal Rescue From Below Ground|593  |
|Animal Rescue From Height      |2123 |
|Other Animal Assistance        |2801 |
+-------------------------------+-----+
</pre></div>
</div>
</div><div aria-labelledby="tab-22-UiBvdXRwdXQ=" class="sphinx-tabs-panel code-tab group-tab" hidden="true" id="panel-22-UiBvdXRwdXQ=" name="UiBvdXRwdXQ=" role="tabpanel" tabindex="0"><div class="highlight-plaintext notranslate"><div class="highlight"><pre><span></span># Source:     spark&lt;?&gt; [?? x 2]
# Ordered by: n
  specialservicetypecategory          n
  &lt;chr&gt;                           &lt;dbl&gt;
1 Animal Rescue From Water          343
2 Animal Rescue From Below Ground   593
3 Animal Rescue From Height        2123
4 Other Animal Assistance          2801
</pre></div>
</div>
</div></div>
<p>Since there are only 343 instances of “Animal Rescue From Water” in the data, this has been automatically selected as the reference category in the example above. Regression coefficients in the previous section are therefore shown relative
to the to the “Animal Rescue From Water” reference category.</p>
<p>Selecting a reference category can be particularly useful for
inferential analysis. For example, in the <code class="docutils literal notranslate"><span class="pre">rescue_cat</span></code> dataset, we might want to
select “Other Animal Assistance” as our reference category instead
because it is the largest special service type and could serve as a
useful reference point.</p>
<details>
<summary><b>Python Example</b></summary>
<p>To do this, we can make use of the additional <code class="docutils literal notranslate"><span class="pre">stringOrderType</span></code> argument for the <code class="docutils literal notranslate"><span class="pre">StringIndexer</span></code> function we used previously to index our categorical variables. This allows us to specify the indexing order. By default, this argument is set to <code class="docutils literal notranslate"><span class="pre">frequencyDesc</span></code>, so “Animal Rescue From Water” would be ordered last and is subsequently dropped by the <code class="docutils literal notranslate"><span class="pre">OneHotEncoderEstimator</span></code> function and set as the reference category. If we want “Other Animal Assistance” to be dropped instead, we need to ensure it is placed last in the indexing order. In this case, specifying <code class="docutils literal notranslate"><span class="pre">stringOrderType</span> <span class="pre">=</span> <span class="pre">frequencyAsc</span></code> would be sufficient to achieve this. However, to keep this example as general as possible, a convenient way of ensuring any chosen reference category is ordered last is to add an appropriate prefix to it, such as “000_”, and order the categories in descending alphabetical order (<code class="docutils literal notranslate"><span class="pre">alphabetDesc</span></code>):</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-23-UHl0aG9u" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-23-UHl0aG9u" name="UHl0aG9u" role="tab" tabindex="0">Python</button></div><div aria-labelledby="tab-23-UHl0aG9u" class="sphinx-tabs-panel code-tab group-tab" id="panel-23-UHl0aG9u" name="UHl0aG9u" role="tabpanel" tabindex="0"><div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="c1"># Add &quot;000_&quot; prefix to selected reference categories</span>

<span class="n">rescue_cat_reindex</span> <span class="o">=</span> <span class="p">(</span><span class="n">rescue_cat</span>
                      <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;specialservicetypecategory&#39;</span><span class="p">,</span> 
                                       <span class="n">F</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;specialservicetypecategory&#39;</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;Other Animal Assistance&quot;</span><span class="p">,</span> <span class="s2">&quot;000_Other Animal Assistance&quot;</span><span class="p">)</span>
                                       <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;specialservicetypecategory&#39;</span><span class="p">)))</span>
                      <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;originofcall&#39;</span><span class="p">,</span> 
                                       <span class="n">F</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;originofcall&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;Person (mobile)&quot;</span><span class="p">,</span> <span class="s2">&quot;000_Person (mobile)&quot;</span><span class="p">)</span>
                                       <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;originofcall&#39;</span><span class="p">)))</span>
                      <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;propertycategory&#39;</span><span class="p">,</span> 
                                       <span class="n">F</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;propertycategory&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;Dwelling&quot;</span><span class="p">,</span> <span class="s2">&quot;000_Dwelling&quot;</span><span class="p">)</span>
                                       <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;propertycategory&#39;</span><span class="p">))))</span>

<span class="c1"># Check prefix additions </span>
<span class="n">rescue_cat_reindex</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;specialservicetypecategory&#39;</span><span class="p">,</span> <span class="s1">&#39;originofcall&#39;</span><span class="p">,</span> <span class="s1">&#39;propertycategory&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>

<span class="c1"># Use stringOrderType argument of StringIndexer</span>

<span class="c1"># Re-indexing the specialservicetypecategory column</span>
<span class="n">serviceIdx</span> <span class="o">=</span> <span class="n">StringIndexer</span><span class="p">(</span><span class="n">inputCol</span><span class="o">=</span><span class="s1">&#39;specialservicetypecategory&#39;</span><span class="p">,</span>
                               <span class="n">outputCol</span><span class="o">=</span><span class="s1">&#39;serviceIndex&#39;</span><span class="p">,</span> 
                               <span class="n">stringOrderType</span> <span class="o">=</span> <span class="s2">&quot;alphabetDesc&quot;</span><span class="p">)</span>

<span class="c1"># Indexing the originofcallcolumn</span>
<span class="n">callIdx</span> <span class="o">=</span> <span class="n">StringIndexer</span><span class="p">(</span><span class="n">inputCol</span><span class="o">=</span><span class="s1">&#39;originofcall&#39;</span><span class="p">,</span>
                               <span class="n">outputCol</span><span class="o">=</span><span class="s1">&#39;callIndex&#39;</span><span class="p">,</span>
                               <span class="n">stringOrderType</span> <span class="o">=</span> <span class="s2">&quot;alphabetDesc&quot;</span><span class="p">)</span>

<span class="c1"># Indexing the propertycategory column</span>
<span class="n">propertyIdx</span> <span class="o">=</span> <span class="n">StringIndexer</span><span class="p">(</span><span class="n">inputCol</span><span class="o">=</span><span class="s1">&#39;propertycategory&#39;</span><span class="p">,</span>
                               <span class="n">outputCol</span><span class="o">=</span><span class="s1">&#39;propertyIndex&#39;</span><span class="p">,</span> 
                               <span class="n">stringOrderType</span> <span class="o">=</span> <span class="s2">&quot;alphabetDesc&quot;</span><span class="p">)</span>

<span class="c1"># Call indexing for each column one by one</span>

<span class="n">rescue_cat_indexed</span> <span class="o">=</span> <span class="n">serviceIdx</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">rescue_cat_reindex</span><span class="p">)</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">rescue_cat_reindex</span><span class="p">)</span>
<span class="n">rescue_cat_indexed</span> <span class="o">=</span> <span class="n">callIdx</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">rescue_cat_indexed</span><span class="p">)</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">rescue_cat_indexed</span><span class="p">)</span>
<span class="n">rescue_cat_indexed</span> <span class="o">=</span> <span class="n">propertyIdx</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">rescue_cat_indexed</span><span class="p">)</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">rescue_cat_indexed</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
<p>Once this is done we can run the regression again and get the
coefficients relative to the chosen reference categories:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-24-UHl0aG9u" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-24-UHl0aG9u" name="UHl0aG9u" role="tab" tabindex="0">Python</button><button aria-controls="panel-24-UHl0aG9uIG91dHB1dA==" aria-selected="false" class="sphinx-tabs-tab code-tab group-tab" id="tab-24-UHl0aG9uIG91dHB1dA==" name="UHl0aG9uIG91dHB1dA==" role="tab" tabindex="-1">Python output</button></div><div aria-labelledby="tab-24-UHl0aG9u" class="sphinx-tabs-panel code-tab group-tab" id="panel-24-UHl0aG9u" name="UHl0aG9u" role="tabpanel" tabindex="0"><div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="c1"># Encode re-indexed columns</span>
<span class="n">encoder</span> <span class="o">=</span> <span class="n">OneHotEncoderEstimator</span><span class="p">(</span><span class="n">inputCols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;serviceIndex&#39;</span><span class="p">,</span> <span class="s1">&#39;callIndex&#39;</span><span class="p">,</span> <span class="s1">&#39;propertyIndex&#39;</span><span class="p">],</span> 
                                 <span class="n">outputCols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;serviceVec&#39;</span><span class="p">,</span> <span class="s1">&#39;callVec&#39;</span><span class="p">,</span> <span class="s1">&#39;propertyVec&#39;</span><span class="p">])</span>

<span class="n">rescue_cat_ohe</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">rescue_cat_indexed</span><span class="p">)</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">rescue_cat_indexed</span><span class="p">)</span>


<span class="c1"># Vectorize all our predictors into a new column called &quot;features&quot; </span>

<span class="n">assembler</span> <span class="o">=</span> <span class="n">VectorAssembler</span><span class="p">(</span><span class="n">inputCols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;engine_count&#39;</span><span class="p">,</span> <span class="s1">&#39;job_hours&#39;</span><span class="p">,</span> <span class="s1">&#39;hourly_cost&#39;</span><span class="p">,</span> 
                                       <span class="s1">&#39;callVec&#39;</span><span class="p">,</span> <span class="s1">&#39;propertyVec&#39;</span><span class="p">,</span> <span class="s1">&#39;serviceVec&#39;</span><span class="p">],</span> 
                           <span class="n">outputCol</span> <span class="o">=</span> <span class="s2">&quot;features&quot;</span><span class="p">)</span>

<span class="n">rescue_cat_vectorised</span> <span class="o">=</span> <span class="n">assembler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">rescue_cat_ohe</span><span class="p">)</span>

<span class="c1"># Rename target variable &quot;is_cat&quot; to &quot;label&quot; ready to run regression model</span>
<span class="n">rescue_cat_final</span> <span class="o">=</span> <span class="n">rescue_cat_vectorised</span><span class="o">.</span><span class="n">withColumnRenamed</span><span class="p">(</span><span class="s2">&quot;is_cat&quot;</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="s2">&quot;features&quot;</span><span class="p">)</span>

<span class="c1"># Run the model again</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">glr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">rescue_cat_final</span><span class="p">)</span>

<span class="c1"># Show summary</span>
<span class="n">model</span><span class="o">.</span><span class="n">summary</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-24-UHl0aG9uIG91dHB1dA==" class="sphinx-tabs-panel code-tab group-tab" hidden="true" id="panel-24-UHl0aG9uIG91dHB1dA==" name="UHl0aG9uIG91dHB1dA==" role="tabpanel" tabindex="0"><div class="highlight-plaintext notranslate"><div class="highlight"><pre><span></span>Coefficients:
             Feature Estimate   Std Error  T Value P Value
         (Intercept)   1.0466      0.3855   2.7150  0.0066
        engine_count  -0.6127      0.2744  -2.2328  0.0256
           job_hours  -0.0254      0.0609  -0.4160  0.6774
         hourly_cost  -0.0007      0.0010  -0.7110  0.4771
      callVec_Police  -0.9646      0.2259  -4.2704  0.0000
callVec_Person (r...   0.6687      1.5616   0.4282  0.6685
callVec_Person (l...   0.1335      0.0573   2.3311  0.0197
   callVec_Other Frs  -0.6723      0.3661  -1.8365  0.0663
   callVec_Not Known -24.9811 356123.9993  -0.0001  0.9999
  callVec_Coastguard -26.0473 356123.9993  -0.0001  0.9999
   callVec_Ambulance  -0.0667      1.4188  -0.0470  0.9625
propertyVec_Road ...   0.2030      0.1470   1.3807  0.1674
propertyVec_Outdo...  -1.4309      0.1159 -12.3498  0.0000
 propertyVec_Outdoor  -0.7453      0.0680 -10.9546  0.0000
propertyVec_Other...  -0.2720      0.4562  -0.5962  0.5511
propertyVec_Non R...  -0.9041      0.0922  -9.8075  0.0000
    propertyVec_Boat   0.7497      1.4258   0.5258  0.5990
serviceVec_Animal...  -0.9945      0.1600  -6.2153  0.0000
serviceVec_Animal...   0.4227      0.0614   6.8856  0.0000
serviceVec_Animal...   0.4467      0.0959   4.6581  0.0000

(Dispersion parameter for binomial family taken to be 1.0000)
    Null deviance: 8123.3546 on 5840 degrees of freedom
Residual deviance: 7534.9047 on 5840 degrees of freedom
AIC: 7574.9047
</pre></div>
</div>
</div></div>
</details>
<details>
<summary><b>R Example</b></summary>
<p>To do this, we can make use of the one-hot encoding concept and two of
<code class="docutils literal notranslate"><span class="pre">sparklyr</span></code>’s <strong>Feature Transformers</strong>; <code class="docutils literal notranslate"><span class="pre">ft_string_indexer</span></code> and <code class="docutils literal notranslate"><span class="pre">ft_one_hot_encoder</span></code>. These have limited functionality, so we must first manipulate it such that the reference category will be ordered last when using <code class="docutils literal notranslate"><span class="pre">ft_string_indexer</span></code>, to ensure that the category ordered last is dropped when applying <code class="docutils literal notranslate"><span class="pre">ft_one_hot_encoder</span></code>. A convenient way of doing this is to order the categories in <em>descending alphabetical</em> order and ensuring that our chosen category will be ordered last by adding an appropriate prefix to it. For example, adding
<code class="docutils literal notranslate"><span class="pre">000_</span></code>:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-25-Ug==" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-25-Ug==" name="Ug==" role="tab" tabindex="0">R</button></div><div aria-labelledby="tab-25-Ug==" class="sphinx-tabs-panel code-tab group-tab" id="panel-25-Ug==" name="Ug==" role="tabpanel" tabindex="0"><div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">rescue_cat_ohe</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rescue_cat</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">mutate</span><span class="p">(</span><span class="n">specialservicetypecategory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">ifelse</span><span class="p">(</span><span class="n">specialservicetypecategory</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;Other Animal Assistance&quot;</span><span class="p">,</span>
<span class="w">                                                    </span><span class="s">&quot;000_Other Animal Assistance&quot;</span><span class="p">,</span>
<span class="w">                                                    </span><span class="n">specialservicetypecategory</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">ft_string_indexer</span><span class="p">(</span><span class="n">input_col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;specialservicetypecategory&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">                              </span><span class="n">output_col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;specialservicetypecategory_idx&quot;</span><span class="p">,</span>
<span class="w">                              </span><span class="n">string_order_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;alphabetDesc&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">ft_one_hot_encoder</span><span class="p">(</span><span class="n">input_cols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;specialservicetypecategory_idx&quot;</span><span class="p">),</span><span class="w"> </span>
<span class="w">                               </span><span class="n">output_cols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;specialservicetypecategory_ohe&quot;</span><span class="p">),</span><span class="w"> </span>
<span class="w">                               </span><span class="n">drop_last</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">sdf_separate_column</span><span class="p">(</span><span class="n">column</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;specialservicetypecategory_ohe&quot;</span><span class="p">,</span>
<span class="w">                                </span><span class="n">into</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;specialservicetypecategory_Animal Rescue From Water&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                         </span><span class="s">&quot;specialservicetypecategory_Animal Rescue From Below Ground&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                         </span><span class="s">&quot;specialservicetypecategory_Animal Rescue From Height&quot;</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span>
<span class="w">  </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">select</span><span class="p">(</span><span class="o">-</span><span class="nf">ends_with</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;_ohe&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;_idx&quot;</span><span class="p">)),</span>
<span class="w">                   </span><span class="o">-</span><span class="n">specialservicetypecategory</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
<p><code class="docutils literal notranslate"><span class="pre">sdf_separate_column</span></code> has been used to separate encoded variables into
individual columns and the intermediate columns with “_ohe” and “_idx”
suffixes have been dropped once the process is complete. This can be
repeated for every categorical variable as desired.</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-26-Ug==" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-26-Ug==" name="Ug==" role="tab" tabindex="0">R</button></div><div aria-labelledby="tab-26-Ug==" class="sphinx-tabs-panel code-tab group-tab" id="panel-26-Ug==" name="Ug==" role="tabpanel" tabindex="0"><div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># originofcall</span>
<span class="n">rescue_cat_ohe</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rescue_cat_ohe</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">mutate</span><span class="p">(</span><span class="n">originofcall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">ifelse</span><span class="p">(</span><span class="n">originofcall</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;Person (mobile)&quot;</span><span class="p">,</span>
<span class="w">                                      </span><span class="s">&quot;000_Person (mobile)&quot;</span><span class="p">,</span>
<span class="w">                                      </span><span class="n">originofcall</span><span class="w"> </span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">ft_string_indexer</span><span class="p">(</span><span class="n">input_col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;originofcall&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">                              </span><span class="n">output_col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;originofcall_idx&quot;</span><span class="p">,</span>
<span class="w">                              </span><span class="n">string_order_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;alphabetDesc&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">ft_one_hot_encoder</span><span class="p">(</span><span class="n">input_cols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;originofcall_idx&quot;</span><span class="p">),</span><span class="w"> </span>
<span class="w">                               </span><span class="n">output_cols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;originofcall_ohe&quot;</span><span class="p">),</span><span class="w"> </span>
<span class="w">                               </span><span class="n">drop_last</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">sdf_separate_column</span><span class="p">(</span><span class="n">column</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;originofcall_ohe&quot;</span><span class="p">,</span>
<span class="w">                                </span><span class="n">into</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;originofcall_Ambulance&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                         </span><span class="s">&quot;originofcall_Police&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                         </span><span class="s">&quot;originofcall_Coastguard&quot;</span><span class="p">,</span>
<span class="w">                                         </span><span class="s">&quot;originofcall_Person (land line)&quot;</span><span class="p">,</span>
<span class="w">                                         </span><span class="s">&quot;originofcall_Not Known&quot;</span><span class="p">,</span>
<span class="w">                                         </span><span class="s">&quot;originofcall_Person (running Call)&quot;</span><span class="p">,</span>
<span class="w">                                         </span><span class="s">&quot;originofcall_Other Frs&quot;</span><span class="p">))</span><span class="w"> </span>
<span class="c1"># propertycategory</span>
<span class="n">rescue_cat_ohe</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rescue_cat_ohe</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">mutate</span><span class="p">(</span><span class="n">propertycategory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">ifelse</span><span class="p">(</span><span class="n">propertycategory</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;Dwelling&quot;</span><span class="p">,</span>
<span class="w">                                          </span><span class="s">&quot;000_Dwelling&quot;</span><span class="p">,</span>
<span class="w">                                          </span><span class="n">propertycategory</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">ft_string_indexer</span><span class="p">(</span><span class="n">input_col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;propertycategory&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">                              </span><span class="n">output_col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;propertycategory_idx&quot;</span><span class="p">,</span>
<span class="w">                              </span><span class="n">string_order_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;alphabetDesc&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">ft_one_hot_encoder</span><span class="p">(</span><span class="n">input_cols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;propertycategory_idx&quot;</span><span class="p">),</span><span class="w"> </span>
<span class="w">                               </span><span class="n">output_cols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;propertycategory_ohe&quot;</span><span class="p">),</span><span class="w"> </span>
<span class="w">                               </span><span class="n">drop_last</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">sdf_separate_column</span><span class="p">(</span><span class="n">column</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;propertycategory_ohe&quot;</span><span class="p">,</span>
<span class="w">                                </span><span class="n">into</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;propertycategory_Outdoor&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                         </span><span class="s">&quot;propertycategory_Road Vehicle&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                         </span><span class="s">&quot;propertycategory_Non Residential&quot;</span><span class="p">,</span>
<span class="w">                                         </span><span class="s">&quot;propertycategory_Boat&quot;</span><span class="p">,</span>
<span class="w">                                         </span><span class="s">&quot;propertycategory_Outdoor Structure&quot;</span><span class="p">,</span>
<span class="w">                                         </span><span class="s">&quot;propertycategory_Other Residential&quot;</span><span class="p">))</span>


<span class="c1"># remove _idx and _ohe intermediate columns and original data columns</span>
<span class="c1"># also remove `typeofincident` to avoid singularity error</span>
<span class="n">rescue_cat_ohe</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rescue_cat_ohe</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span>
<span class="w">  </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">select</span><span class="p">(</span><span class="o">-</span><span class="nf">ends_with</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;_ohe&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;_idx&quot;</span><span class="p">)),</span>
<span class="w">                   </span><span class="o">-</span><span class="n">originofcall</span><span class="p">,</span>
<span class="w">                   </span><span class="o">-</span><span class="n">propertycategory</span><span class="p">,</span>
<span class="w">                   </span><span class="o">-</span><span class="n">typeofincident</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
<p>Once this is done we can run the regression again and get the
coefficients relative to the chosen reference categories:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-27-Ug==" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-27-Ug==" name="Ug==" role="tab" tabindex="0">R</button><button aria-controls="panel-27-UiBvdXRwdXQ=" aria-selected="false" class="sphinx-tabs-tab code-tab group-tab" id="tab-27-UiBvdXRwdXQ=" name="UiBvdXRwdXQ=" role="tab" tabindex="-1">R output</button></div><div aria-labelledby="tab-27-Ug==" class="sphinx-tabs-panel code-tab group-tab" id="panel-27-Ug==" name="Ug==" role="tabpanel" tabindex="0"><div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run regression with one-hot encoded variables with chosen reference categories</span>
<span class="n">glm_ohe</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">ml_generalized_linear_regression</span><span class="p">(</span><span class="n">rescue_cat_ohe</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                                      </span><span class="n">formula</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;is_cat ~ .&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                                      </span><span class="n">family</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;binomial&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                                      </span><span class="n">link</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;logit&quot;</span><span class="p">)</span>

<span class="c1"># Get coefficients and confidence intervals</span>
<span class="n">broom</span><span class="o">::</span><span class="nf">tidy</span><span class="p">(</span><span class="n">glm_ohe</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">mutate</span><span class="p">(</span><span class="n">lower_ci</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">estimate</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="m">1.96</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">std.error</span><span class="p">),</span>
<span class="w">                </span><span class="n">upper_ci</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">estimate</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="m">1.96</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">std.error</span><span class="p">))</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-27-UiBvdXRwdXQ=" class="sphinx-tabs-panel code-tab group-tab" hidden="true" id="panel-27-UiBvdXRwdXQ=" name="UiBvdXRwdXQ=" role="tabpanel" tabindex="0"><div class="highlight-plaintext notranslate"><div class="highlight"><pre><span></span># A tibble: 20 × 7
term                  estimate std.error statistic  p.value lower_ci upper_ci
&lt;chr&gt;                    &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
  1 (Intercept)            1.05e+0   3.85e-1   2.71e+0 6.63e- 3  2.91e-1  1.80e+0
2 engine_count          -6.13e-1   2.74e-1  -2.23e+0 2.56e- 2 -1.15e+0 -7.48e-2
3 job_hours             -2.54e-2   6.09e-2  -4.16e-1 6.77e- 1 -1.45e-1  9.41e-2
4 hourly_cost           -7.00e-4   9.85e-4  -7.11e-1 4.77e- 1 -2.63e-3  1.23e-3
5 specialservicetypeca… -9.95e-1   1.60e-1  -6.22e+0 5.12e-10 -1.31e+0 -6.81e-1
6 specialservicetypeca…  4.23e-1   6.14e-2   6.89e+0 5.76e-12  3.02e-1  5.43e-1
7 specialservicetypeca…  4.47e-1   9.59e-2   4.66e+0 3.19e- 6  2.59e-1  6.35e-1
8 originofcall_Ambulan… -9.65e-1   2.26e-1  -4.27e+0 1.95e- 5 -1.41e+0 -5.22e-1
9 originofcall_Police    6.69e-1   1.56e+0   4.28e-1 6.68e- 1 -2.39e+0  3.73e+0
10 originofcall_Coastgu…  1.33e-1   5.73e-2   2.33e+0 1.97e- 2  2.12e-2  2.46e-1
11 originofcall_Person … -6.72e-1   3.66e-1  -1.84e+0 6.63e- 2 -1.39e+0  4.52e-2
12 originofcall_Not Kno… -2.50e+1   3.56e+5  -7.01e-5 1.00e+ 0 -6.98e+5  6.98e+5
13 originofcall_Person … -2.60e+1   3.56e+5  -7.31e-5 1.00e+ 0 -6.98e+5  6.98e+5
14 originofcall_Other F… -6.67e-2   1.42e+0  -4.70e-2 9.62e- 1 -2.85e+0  2.71e+0
15 propertycategory_Out…  2.03e-1   1.47e-1   1.38e+0 1.67e- 1 -8.52e-2  4.91e-1
16 propertycategory_Roa… -1.43e+0   1.16e-1  -1.23e+1 0        -1.66e+0 -1.20e+0
17 propertycategory_Non… -7.45e-1   6.80e-2  -1.10e+1 0        -8.79e-1 -6.12e-1
18 propertycategory_Boat -2.72e-1   4.56e-1  -5.96e-1 5.51e- 1 -1.17e+0  6.22e-1
19 propertycategory_Out… -9.04e-1   9.22e-2  -9.81e+0 0        -1.08e+0 -7.23e-1
20 propertycategory_Oth…  7.50e-1   1.43e+0   5.26e-1 5.99e- 1 -2.04e+0  3.54e+0
</pre></div>
</div>
</div></div>
</details>
</section>
<section id="multicollinearity">
<h3>Multicollinearity<a class="headerlink" href="#multicollinearity" title="Permalink to this heading">#</a></h3>
<p>A key assumption of linear and logistic regression models is that the feature columns are independent of one another. Including features that correlate with each other in the model is a clear violation of this assumption, so we need to identify these and remove them to get a valid result.</p>
<p>A useful way of identifying these variables is to generate a correlation matrix of all the the features in the model. This can be done using the <code class="docutils literal notranslate"><span class="pre">corr</span></code> function from the ml subpackage <code class="docutils literal notranslate"><span class="pre">pyspark.ml.stat</span></code> in PySpark, or the <code class="docutils literal notranslate"><span class="pre">ml_corr</span></code> function in sparklyr.</p>
<p>In PySpark, note that the correlation function is only applicable to a vector and not to a dataframe. We will therefore have to apply it to the “features” column of the <code class="docutils literal notranslate"><span class="pre">rescue_cat_final</span></code> dataset produced after the indexing, encoding and vector assembly stages of the model setup.</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-28-UHl0aG9u" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-28-UHl0aG9u" name="UHl0aG9u" role="tab" tabindex="0">Python</button><button aria-controls="panel-28-Ug==" aria-selected="false" class="sphinx-tabs-tab code-tab group-tab" id="tab-28-Ug==" name="Ug==" role="tab" tabindex="-1">R</button></div><div aria-labelledby="tab-28-UHl0aG9u" class="sphinx-tabs-panel code-tab group-tab" id="panel-28-UHl0aG9u" name="UHl0aG9u" role="tabpanel" tabindex="0"><div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.ml.stat</span> <span class="kn">import</span> <span class="n">Correlation</span>

<span class="c1"># Select feature column vector</span>
<span class="n">features_vector</span> <span class="o">=</span> <span class="n">rescue_cat_final</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;features&quot;</span><span class="p">)</span>

<span class="c1"># Generate correlation matrix</span>
<span class="n">matrix</span> <span class="o">=</span> <span class="n">Correlation</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">features_vector</span><span class="p">,</span> <span class="s2">&quot;features&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># Convert matrix into a useful format</span>
<span class="n">corr_matrix</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">toArray</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> 

<span class="c1"># Get list of features to assign to matrix columns and indices</span>
<span class="n">features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">merge_list</span><span class="p">)[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

<span class="c1"># Final correlation matrix</span>
<span class="n">corr_matrix_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">corr_matrix</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">features</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">features</span><span class="p">)</span> 

<span class="n">corr_matrix_df</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-28-Ug==" class="sphinx-tabs-panel code-tab group-tab" hidden="true" id="panel-28-Ug==" name="Ug==" role="tabpanel" tabindex="0"><div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get feature column names</span>
<span class="n">features</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rescue_cat_ohe</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="nf">select</span><span class="p">(</span><span class="o">-</span><span class="n">is_cat</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="nf">colnames</span><span class="p">()</span>

<span class="c1"># Generate correlation matrix  </span>
<span class="nf">ml_corr</span><span class="p">(</span><span class="n">rescue_cat_ohe</span><span class="p">,</span><span class="w"> </span><span class="n">columns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">features</span><span class="p">,</span><span class="w"> </span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;pearson&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="nf">print</span><span class="p">()</span>
</pre></div>
</div>
</div></div>
<p>Looking closely at the <code class="docutils literal notranslate"><span class="pre">total_cost</span></code> column, we can see that there is very strong correlation between that column and <code class="docutils literal notranslate"><span class="pre">job_hours</span></code>, with a correlation coefficient very close to 1. Additionally, there is quite strong correlation between the <code class="docutils literal notranslate"><span class="pre">total_cost</span></code> column and the <code class="docutils literal notranslate"><span class="pre">engine_count</span></code> column, as well as a moderate correlation with both <code class="docutils literal notranslate"><span class="pre">hourly_cost</span></code> and the “Animal Rescue From Water” category in the <code class="docutils literal notranslate"><span class="pre">specialservicetypecategory</span></code> column. This is to be expected, since if we take a closer look at <code class="docutils literal notranslate"><span class="pre">total_cost</span></code> we can see it always takes a value that is equal to
<code class="docutils literal notranslate"><span class="pre">hourly_cost</span></code> multiplied by <code class="docutils literal notranslate"><span class="pre">job_hours</span></code>.</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-29-UHl0aG9u" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-29-UHl0aG9u" name="UHl0aG9u" role="tab" tabindex="0">Python</button><button aria-controls="panel-29-Ug==" aria-selected="false" class="sphinx-tabs-tab code-tab group-tab" id="tab-29-Ug==" name="Ug==" role="tab" tabindex="-1">R</button></div><div aria-labelledby="tab-29-UHl0aG9u" class="sphinx-tabs-panel code-tab group-tab" id="panel-29-UHl0aG9u" name="UHl0aG9u" role="tabpanel" tabindex="0"><div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">rescue_cat</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;job_hours&quot;</span><span class="p">,</span> <span class="s2">&quot;hourly_cost&quot;</span><span class="p">,</span> <span class="s2">&quot;total_cost&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s2">&quot;job_hours&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span><span class="o">.</span><span class="n">toPandas</span><span class="p">()</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-29-Ug==" class="sphinx-tabs-panel code-tab group-tab" hidden="true" id="panel-29-Ug==" name="Ug==" role="tabpanel" tabindex="0"><div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">rescue_cat</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">select</span><span class="p">(</span><span class="n">job_hours</span><span class="p">,</span>
<span class="w">                   </span><span class="n">hourly_cost</span><span class="p">,</span>
<span class="w">                   </span><span class="n">total_cost</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">arrange</span><span class="p">(</span><span class="nf">desc</span><span class="p">(</span><span class="n">job_hours</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="nf">print</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">30</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-30-UHl0aG9uIG91dHB1dA==" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-30-UHl0aG9uIG91dHB1dA==" name="UHl0aG9uIG91dHB1dA==" role="tab" tabindex="0">Python output</button><button aria-controls="panel-30-UiBvdXRwdXQ=" aria-selected="false" class="sphinx-tabs-tab code-tab group-tab" id="tab-30-UiBvdXRwdXQ=" name="UiBvdXRwdXQ=" role="tab" tabindex="-1">R output</button></div><div aria-labelledby="tab-30-UHl0aG9uIG91dHB1dA==" class="sphinx-tabs-panel code-tab group-tab" id="panel-30-UHl0aG9uIG91dHB1dA==" name="UHl0aG9uIG91dHB1dA==" role="tabpanel" tabindex="0"><div class="highlight-plaintext notranslate"><div class="highlight"><pre><span></span>	job_hours	hourly_cost	total_cost
0	12.0	326.0	3912.0
1	12.0	290.0	3480.0
2	10.0	298.0	2980.0
3	9.0	260.0	2340.0
4	9.0	260.0	2340.0
5	9.0	260.0	2340.0
6	9.0	295.0	2655.0
7	8.0	260.0	2080.0
8	8.0	333.0	2664.0
9	7.0	328.0	2296.0
10	7.0	260.0	1820.0
11	7.0	290.0	2030.0
12	7.0	260.0	1820.0
13	7.0	290.0	2030.0
14	7.0	295.0	2065.0
15	7.0	326.0	2282.0
16	6.0	298.0	1788.0
17	6.0	260.0	1560.0
18	6.0	333.0	1998.0
19	6.0	260.0	1560.0
20	6.0	298.0	1788.0
21	5.0	260.0	1300.0
22	5.0	260.0	1300.0
23	5.0	260.0	1300.0
24	5.0	260.0	1300.0
25	5.0	260.0	1300.0
26	5.0	255.0	1275.0
27	5.0	260.0	1300.0
28	5.0	260.0	1300.0
29	5.0	260.0	1300.0
</pre></div>
</div>
</div><div aria-labelledby="tab-30-UiBvdXRwdXQ=" class="sphinx-tabs-panel code-tab group-tab" hidden="true" id="panel-30-UiBvdXRwdXQ=" name="UiBvdXRwdXQ=" role="tabpanel" tabindex="0"><div class="highlight-plaintext notranslate"><div class="highlight"><pre><span></span># Source:     spark&lt;?&gt; [?? x 3]
# Ordered by: desc(job_hours)
   job_hours hourly_cost total_cost
       &lt;dbl&gt;       &lt;dbl&gt;      &lt;dbl&gt;
 1        12         326       3912
 2        12         290       3480
 3        10         298       2980
 4         9         260       2340
 5         9         260       2340
 6         9         260       2340
 7         9         295       2655
 8         8         260       2080
 9         8         333       2664
10         7         328       2296
11         7         260       1820
12         7         290       2030
13         7         260       1820
14         7         290       2030
15         7         295       2065
16         7         326       2282
17         6         298       1788
18         6         260       1560
19         6         333       1998
20         6         260       1560
21         6         298       1788
22         5         260       1300
23         5         295       1475
24         5         260       1300
25         5         255       1275
26         5         260       1300
27         5         260       1300
28         5         260       1300
29         5         260       1300
30         5         260       1300
</pre></div>
</div>
</div></div>
<p>Therefore, we need to drop this feature from our model since it is not independent of other variables. You may also want to remove other variables from the model based on the correlation matrix. For example, there is also quite high correlation between the <code class="docutils literal notranslate"><span class="pre">job_hours</span></code> column and several other features. Deciding on which features to remove from your model may require some experimentation, but in general, a correlation coefficient of &gt;0.7 among two or more predictors indicates multicollinearity and some of these should be removed from the model to ensure validity.</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-31-UHl0aG9uIG91dHB1dA==" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-31-UHl0aG9uIG91dHB1dA==" name="UHl0aG9uIG91dHB1dA==" role="tab" tabindex="0">Python output</button><button aria-controls="panel-31-UiBvdXRwdXQ=" aria-selected="false" class="sphinx-tabs-tab code-tab group-tab" id="tab-31-UiBvdXRwdXQ=" name="UiBvdXRwdXQ=" role="tab" tabindex="-1">R output</button></div><div aria-labelledby="tab-31-UHl0aG9uIG91dHB1dA==" class="sphinx-tabs-panel code-tab group-tab" id="panel-31-UHl0aG9uIG91dHB1dA==" name="UHl0aG9uIG91dHB1dA==" role="tabpanel" tabindex="0"><div class="highlight-plaintext notranslate"><div class="highlight"><pre><span></span>Coefficients:
             Feature Estimate   Std Error  T Value P Value
         (Intercept)   1.0885      0.3722   2.9246  0.0034
        engine_count  -0.6804      0.2214  -3.0729  0.0021
         hourly_cost  -0.0007      0.0010  -0.7175  0.4730
      callVec_Police  -0.9668      0.2257  -4.2829  0.0000
callVec_Person (r...   0.6470      1.5530   0.4166  0.6770
callVec_Person (l...   0.1338      0.0572   2.3375  0.0194
   callVec_Other Frs  -0.6789      0.3657  -1.8565  0.0634
   callVec_Not Known -25.0264 356123.9993  -0.0001  0.9999
  callVec_Coastguard -26.0423 356123.9993  -0.0001  0.9999
   callVec_Ambulance  -0.0626      1.4188  -0.0441  0.9648
propertyVec_Road ...   0.2017      0.1470   1.3720  0.1701
propertyVec_Outdo...  -1.4310      0.1159 -12.3504  0.0000
 propertyVec_Outdoor  -0.7482      0.0677 -11.0556  0.0000
propertyVec_Other...  -0.2765      0.4561  -0.6062  0.5444
propertyVec_Non R...  -0.9055      0.0921  -9.8298  0.0000
    propertyVec_Boat   0.7267      1.4248   0.5100  0.6100
serviceVec_Animal...  -0.9946      0.1600  -6.2167  0.0000
serviceVec_Animal...   0.4235      0.0614   6.9004  0.0000
serviceVec_Animal...   0.4458      0.0959   4.6498  0.0000

(Dispersion parameter for binomial family taken to be 1.0000)
    Null deviance: 8123.3546 on 5841 degrees of freedom
Residual deviance: 7535.0784 on 5841 degrees of freedom
</pre></div>
</div>
</div><div aria-labelledby="tab-31-UiBvdXRwdXQ=" class="sphinx-tabs-panel code-tab group-tab" hidden="true" id="panel-31-UiBvdXRwdXQ=" name="UiBvdXRwdXQ=" role="tabpanel" tabindex="0"><div class="highlight-plaintext notranslate"><div class="highlight"><pre><span></span># A tibble: 19 × 7
   term                  estimate std.error statistic  p.value lower_ci upper_ci
   &lt;chr&gt;                    &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
 1 (Intercept)            1.09e+0   3.72e-1   2.92e+0 3.45e- 3  3.59e-1  1.82e+0
 2 engine_count          -6.80e-1   2.21e-1  -3.07e+0 2.12e- 3 -1.11e+0 -2.46e-1
 3 hourly_cost           -7.07e-4   9.85e-4  -7.18e-1 4.73e- 1 -2.64e-3  1.22e-3
 4 specialservicetypeca… -9.95e-1   1.60e-1  -6.22e+0 5.08e-10 -1.31e+0 -6.81e-1
 5 specialservicetypeca…  4.23e-1   6.14e-2   6.90e+0 5.18e-12  3.03e-1  5.44e-1
 6 specialservicetypeca…  4.46e-1   9.59e-2   4.65e+0 3.32e- 6  2.58e-1  6.34e-1
 7 originofcall_Ambulan… -9.67e-1   2.26e-1  -4.28e+0 1.85e- 5 -1.41e+0 -5.24e-1
 8 originofcall_Police    6.47e-1   1.55e+0   4.17e-1 6.77e- 1 -2.40e+0  3.69e+0
 9 originofcall_Coastgu…  1.34e-1   5.72e-2   2.34e+0 1.94e- 2  2.16e-2  2.46e-1
10 originofcall_Person … -6.79e-1   3.66e-1  -1.86e+0 6.34e- 2 -1.40e+0  3.79e-2
11 originofcall_Not Kno… -2.50e+1   3.56e+5  -7.03e-5 1.00e+ 0 -6.98e+5  6.98e+5
12 originofcall_Person … -2.60e+1   3.56e+5  -7.31e-5 1.00e+ 0 -6.98e+5  6.98e+5
13 originofcall_Other F… -6.26e-2   1.42e+0  -4.41e-2 9.65e- 1 -2.84e+0  2.72e+0
14 propertycategory_Out…  2.02e-1   1.47e-1   1.37e+0 1.70e- 1 -8.64e-2  4.90e-1
15 propertycategory_Roa… -1.43e+0   1.16e-1  -1.24e+1 0        -1.66e+0 -1.20e+0
16 propertycategory_Non… -7.48e-1   6.77e-2  -1.11e+1 0        -8.81e-1 -6.16e-1
17 propertycategory_Boat -2.77e-1   4.56e-1  -6.06e-1 5.44e- 1 -1.17e+0  6.17e-1
18 propertycategory_Out… -9.05e-1   9.21e-2  -9.83e+0 0        -1.09e+0 -7.25e-1
19 propertycategory_Oth…  7.27e-1   1.42e+0   5.10e-1 6.10e- 1 -2.07e+0  3.52e+0
</pre></div>
</div>
</div></div>
</section>
</section>
<section id="spark-ml-pipelines">
<h2>Spark ML Pipelines<a class="headerlink" href="#spark-ml-pipelines" title="Permalink to this heading">#</a></h2>
<p>We can also combine all of the analysis steps outlined above into a single workflow using Spark’s ML Pipelines. Data manipulation, feature transformation and modelling can be rewritten into a <code class="docutils literal notranslate"><span class="pre">pipeline</span></code>/<code class="docutils literal notranslate"><span class="pre">ml_pipeline()</span></code> object and saved.</p>
<p>The output of this in sparklyr is in Scala code, meaning that it can be added to scheduled Spark ML jobs without any dependencies in R. However, it should be noted that we have not yet found a simple way of generating a summary coefficient table as shown in the sections above when using a pipeline for analysis. Although coefficients, p-values etc. can be obtained it is difficult to map these to the corresponding features for inferential analysis. As a result, pipelines for logistic regression in sparklyr are currently best used for predictive analysis only.</p>
<p>PySpark pipelines do not have this problem and we can access the coefficients in a similar way to that shown above even when using a pipeline for analysis.</p>
<details>
<summary><b>Python Example</b></summary>
<p>As shown above, we need to prepare the data, index categorical variables, encode them, assemble features into a single vector column and run the regression to perform our analysis. The data preparation step can be done before setting up the pipeline (in this case we will re-use the <code class="docutils literal notranslate"><span class="pre">rescue_cat_reindex</span></code> dataframe from the Selecting reference categories section of this guide as a shortcut), so our pipeline steps will be as follows:</p>
<ol class="arabic simple">
<li><p>String indexer for <code class="docutils literal notranslate"><span class="pre">specialservicetypecategory</span></code></p></li>
<li><p>String indexer for <code class="docutils literal notranslate"><span class="pre">originofcall</span></code></p></li>
<li><p>String indexer for <code class="docutils literal notranslate"><span class="pre">propertycategory</span></code></p></li>
<li><p>One hot encoder for <code class="docutils literal notranslate"><span class="pre">specialservicetypecategory</span></code>, <code class="docutils literal notranslate"><span class="pre">originofcall</span></code>and <code class="docutils literal notranslate"><span class="pre">propertycategory</span></code></p></li>
<li><p>Vector assembler to generate a single <code class="docutils literal notranslate"><span class="pre">features</span></code> column that contains a vector of features</p></li>
<li><p>Logistic regression model</p></li>
</ol>
<p>We will define each of these steps first to assemble the pipeline:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-32-UHl0aG9u" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-32-UHl0aG9u" name="UHl0aG9u" role="tab" tabindex="0">Python</button></div><div aria-labelledby="tab-32-UHl0aG9u" class="sphinx-tabs-panel code-tab group-tab" id="panel-32-UHl0aG9u" name="UHl0aG9u" role="tabpanel" tabindex="0"><div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.ml</span> <span class="kn">import</span> <span class="n">Pipeline</span>

<span class="c1"># Rename &quot;is_cat&quot; to &quot;label&quot; before setting up pipeline stages</span>
<span class="n">rescue_cat_reindex</span> <span class="o">=</span> <span class="n">rescue_cat_reindex</span><span class="o">.</span><span class="n">withColumnRenamed</span><span class="p">(</span><span class="s2">&quot;is_cat&quot;</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">)</span>

<span class="c1"># 1. Indexing the specialservicetypecategory column</span>
<span class="n">serviceIdx</span> <span class="o">=</span> <span class="n">StringIndexer</span><span class="p">(</span><span class="n">inputCol</span><span class="o">=</span><span class="s1">&#39;specialservicetypecategory&#39;</span><span class="p">,</span>
                               <span class="n">outputCol</span><span class="o">=</span><span class="s1">&#39;serviceIndex&#39;</span><span class="p">,</span> 
                               <span class="n">stringOrderType</span> <span class="o">=</span> <span class="s2">&quot;alphabetDesc&quot;</span><span class="p">)</span>

<span class="c1"># 2. Indexing the originofcall column</span>
<span class="n">callIdx</span> <span class="o">=</span> <span class="n">StringIndexer</span><span class="p">(</span><span class="n">inputCol</span><span class="o">=</span><span class="s1">&#39;originofcall&#39;</span><span class="p">,</span>
                               <span class="n">outputCol</span><span class="o">=</span><span class="s1">&#39;callIndex&#39;</span><span class="p">,</span>
                               <span class="n">stringOrderType</span> <span class="o">=</span> <span class="s2">&quot;alphabetDesc&quot;</span><span class="p">)</span>

<span class="c1"># 3. Indexing the propertycategory column</span>
<span class="n">propertyIdx</span> <span class="o">=</span> <span class="n">StringIndexer</span><span class="p">(</span><span class="n">inputCol</span><span class="o">=</span><span class="s1">&#39;propertycategory&#39;</span><span class="p">,</span>
                               <span class="n">outputCol</span><span class="o">=</span><span class="s1">&#39;propertyIndex&#39;</span><span class="p">,</span> 
                               <span class="n">stringOrderType</span> <span class="o">=</span> <span class="s2">&quot;alphabetDesc&quot;</span><span class="p">)</span>

<span class="c1"># 4. One-hot encoding</span>
<span class="n">encoder</span> <span class="o">=</span> <span class="n">OneHotEncoderEstimator</span><span class="p">(</span><span class="n">inputCols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;serviceIndex&#39;</span><span class="p">,</span> <span class="s1">&#39;callIndex&#39;</span><span class="p">,</span> <span class="s1">&#39;propertyIndex&#39;</span><span class="p">],</span> 
                                 <span class="n">outputCols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;serviceVec&#39;</span><span class="p">,</span> <span class="s1">&#39;callVec&#39;</span><span class="p">,</span> <span class="s1">&#39;propertyVec&#39;</span><span class="p">])</span>

<span class="c1"># 5. Vector assembler</span>
<span class="n">assembler</span> <span class="o">=</span> <span class="n">VectorAssembler</span><span class="p">(</span><span class="n">inputCols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;engine_count&#39;</span><span class="p">,</span> <span class="s1">&#39;hourly_cost&#39;</span><span class="p">,</span> 
                                       <span class="s1">&#39;callVec&#39;</span><span class="p">,</span> <span class="s1">&#39;propertyVec&#39;</span><span class="p">,</span> <span class="s1">&#39;serviceVec&#39;</span><span class="p">],</span> 
                           <span class="n">outputCol</span> <span class="o">=</span> <span class="s2">&quot;features&quot;</span><span class="p">)</span>

<span class="c1"># 6. Regression model</span>
<span class="n">glr</span> <span class="o">=</span> <span class="n">GeneralizedLinearRegression</span><span class="p">(</span><span class="n">family</span><span class="o">=</span><span class="s2">&quot;binomial&quot;</span><span class="p">,</span> <span class="n">link</span><span class="o">=</span><span class="s2">&quot;logit&quot;</span><span class="p">)</span>

<span class="c1"># Creating the pipeline</span>
<span class="n">pipe</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">stages</span><span class="o">=</span><span class="p">[</span><span class="n">serviceIdx</span><span class="p">,</span> <span class="n">callIdx</span><span class="p">,</span> <span class="n">propertyIdx</span><span class="p">,</span>
                        <span class="n">encoder</span><span class="p">,</span> <span class="n">assembler</span><span class="p">,</span> <span class="n">glr</span><span class="p">])</span>
                        
<span class="c1"># View the pipeline stages</span>
<span class="n">pipe</span><span class="o">.</span><span class="n">getStages</span><span class="p">()</span>
</pre></div>
</div>
</div></div>
<p>The pipeline can be fitted to the <code class="docutils literal notranslate"><span class="pre">rescue_cat_reindex</span></code> dataset by fitting the model (<code class="docutils literal notranslate"><span class="pre">fit</span></code>) and predictions can be accessed using <code class="docutils literal notranslate"><span class="pre">transform</span></code>:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-33-UHl0aG9u" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-33-UHl0aG9u" name="UHl0aG9u" role="tab" tabindex="0">Python</button></div><div aria-labelledby="tab-33-UHl0aG9u" class="sphinx-tabs-panel code-tab group-tab" id="panel-33-UHl0aG9u" name="UHl0aG9u" role="tabpanel" tabindex="0"><div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">fit_model</span> <span class="o">=</span> <span class="n">pipe</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">rescue_cat_reindex</span><span class="p">)</span>

<span class="c1"># Save model results</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">fit_model</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">rescue_cat_reindex</span><span class="p">)</span>
  
<span class="c1"># Showing the results</span>
<span class="n">results</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div></div>
<p>To get the summary table with regression coefficients, we will need to access the regression model stage of the pipeline directly using <code class="docutils literal notranslate"><span class="pre">stages</span></code>:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-34-UHl0aG9u" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-34-UHl0aG9u" name="UHl0aG9u" role="tab" tabindex="0">Python</button><button aria-controls="panel-34-UHl0aG9uIG91dHB1dA==" aria-selected="false" class="sphinx-tabs-tab code-tab group-tab" id="tab-34-UHl0aG9uIG91dHB1dA==" name="UHl0aG9uIG91dHB1dA==" role="tab" tabindex="-1">Python output</button></div><div aria-labelledby="tab-34-UHl0aG9u" class="sphinx-tabs-panel code-tab group-tab" id="panel-34-UHl0aG9u" name="UHl0aG9u" role="tabpanel" tabindex="0"><div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get coefficients summary table</span>
<span class="n">summary</span> <span class="o">=</span> <span class="n">fit_model</span><span class="o">.</span><span class="n">stages</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">summary</span>

<span class="n">summary</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-34-UHl0aG9uIG91dHB1dA==" class="sphinx-tabs-panel code-tab group-tab" hidden="true" id="panel-34-UHl0aG9uIG91dHB1dA==" name="UHl0aG9uIG91dHB1dA==" role="tabpanel" tabindex="0"><div class="highlight-plaintext notranslate"><div class="highlight"><pre><span></span>Coefficients:
             Feature Estimate   Std Error  T Value P Value
         (Intercept)   1.0885      0.3722   2.9246  0.0034
        engine_count  -0.6804      0.2214  -3.0729  0.0021
         hourly_cost  -0.0007      0.0010  -0.7175  0.4730
      callVec_Police  -0.9668      0.2257  -4.2829  0.0000
callVec_Person (r...   0.6470      1.5530   0.4166  0.6770
callVec_Person (l...   0.1338      0.0572   2.3375  0.0194
   callVec_Other Frs  -0.6789      0.3657  -1.8565  0.0634
   callVec_Not Known -25.0264 356123.9993  -0.0001  0.9999
  callVec_Coastguard -26.0423 356123.9993  -0.0001  0.9999
   callVec_Ambulance  -0.0626      1.4188  -0.0441  0.9648
propertyVec_Road ...   0.2017      0.1470   1.3720  0.1701
propertyVec_Outdo...  -1.4310      0.1159 -12.3504  0.0000
 propertyVec_Outdoor  -0.7482      0.0677 -11.0556  0.0000
propertyVec_Other...  -0.2765      0.4561  -0.6062  0.5444
propertyVec_Non R...  -0.9055      0.0921  -9.8298  0.0000
    propertyVec_Boat   0.7267      1.4248   0.5100  0.6100
serviceVec_Animal...  -0.9946      0.1600  -6.2167  0.0000
serviceVec_Animal...   0.4235      0.0614   6.9004  0.0000
serviceVec_Animal...   0.4458      0.0959   4.6498  0.0000

(Dispersion parameter for binomial family taken to be 1.0000)
    Null deviance: 8123.3546 on 5841 degrees of freedom
Residual deviance: 7535.0784 on 5841 degrees of freedom
AIC: 7573.0784
</pre></div>
</div>
</div></div>
<p>The confidence intervals can then be calculated and the summary can be converted into a pandas dataframe as shown in the “Inferential Analysis” section if desired.</p>
<p>You can save a pipeline or pipeline model using the <code class="docutils literal notranslate"><span class="pre">.write().overwrite().save</span></code> command:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-35-UHl0aG9u" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-35-UHl0aG9u" name="UHl0aG9u" role="tab" tabindex="0">Python</button></div><div aria-labelledby="tab-35-UHl0aG9u" class="sphinx-tabs-panel code-tab group-tab" id="panel-35-UHl0aG9u" name="UHl0aG9u" role="tabpanel" tabindex="0"><div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="c1"># Save pipeline</span>

<span class="n">pipe</span><span class="o">.</span><span class="n">write</span><span class="p">()</span><span class="o">.</span><span class="n">overwrite</span><span class="p">()</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;rescue_pipeline&quot;</span><span class="p">)</span>

<span class="c1"># Save the pipeline model</span>

<span class="n">fit_model</span><span class="o">.</span><span class="n">write</span><span class="p">()</span><span class="o">.</span><span class="n">overwrite</span><span class="p">()</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;rescue_model&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
<p>They can then be re-loaded using the <code class="docutils literal notranslate"><span class="pre">load()</span></code> command and the re-loaded model can be used to re-fit new data with the same model by supplying the name of the new spark dataframe you wish to fit.</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-36-UHl0aG9u" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-36-UHl0aG9u" name="UHl0aG9u" role="tab" tabindex="0">Python</button></div><div aria-labelledby="tab-36-UHl0aG9u" class="sphinx-tabs-panel code-tab group-tab" id="panel-36-UHl0aG9u" name="UHl0aG9u" role="tabpanel" tabindex="0"><div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load saved pipeline</span>
<span class="n">reloaded_pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;rescue_pipeline&quot;</span><span class="p">)</span>

<span class="c1"># Re-fit to a subset of rescue data as an example of how pipelines can be re-used</span>
<span class="n">new_model</span> <span class="o">=</span> <span class="n">reloaded_pipeline</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">rescue_cat_reindex</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">withReplacement</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">fraction</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">seed</span> <span class="o">=</span> <span class="mi">99</span><span class="p">))</span>
                      
<span class="c1"># View new model summary</span>
<span class="n">new_model</span><span class="o">.</span><span class="n">stages</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">summary</span>
</pre></div>
</div>
</div></div>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-37-UHl0aG9u" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-37-UHl0aG9u" name="UHl0aG9u" role="tab" tabindex="0">Python</button></div><div aria-labelledby="tab-37-UHl0aG9u" class="sphinx-tabs-panel code-tab group-tab" id="panel-37-UHl0aG9u" name="UHl0aG9u" role="tabpanel" tabindex="0"><div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="c1"># Close the spark session</span>
<span class="n">spark</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</pre></div>
</div>
</div></div>
</details>
<details>
<summary><b>R Example</b></summary>
<p>As above, we still need to generate the <code class="docutils literal notranslate"><span class="pre">is_cat</span></code> column from the original data, select our predictors and remove missing values. In order to select our reference categories we can also add the “000_” prefix to these categories at this stage. All of this data preparation can later be called in the pipeline in a single step using the <code class="docutils literal notranslate"><span class="pre">ft_dplyr_transformer</span></code> feature transformer. This function converts <code class="docutils literal notranslate"><span class="pre">dplyr</span></code> code into a SQL feature transformer that can then be used in a pipeline. We will set up the transformation as follows:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-38-Ug==" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-38-Ug==" name="Ug==" role="tab" tabindex="0">R</button></div><div aria-labelledby="tab-38-Ug==" class="sphinx-tabs-panel code-tab group-tab" id="panel-38-Ug==" name="Ug==" role="tabpanel" tabindex="0"><div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">rescue_cat</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rescue</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span>
<span class="c1"># generate is_cat column</span>
<span class="w">  </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">mutate</span><span class="p">(</span><span class="n">is_cat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">ifelse</span><span class="p">(</span><span class="n">animal_group</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;Cat&quot;</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span>
<span class="w">  </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">select</span><span class="p">(</span><span class="n">engine_count</span><span class="p">,</span><span class="w"> </span>
<span class="w">                   </span><span class="n">hourly_cost</span><span class="p">,</span><span class="w"> </span>
<span class="w">                   </span><span class="n">originofcall</span><span class="p">,</span><span class="w"> </span>
<span class="w">                   </span><span class="n">propertycategory</span><span class="p">,</span>
<span class="w">                   </span><span class="n">specialservicetypecategory</span><span class="p">,</span>
<span class="w">                   </span><span class="n">is_cat</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="c1"># ensure numeric columns have the correct type</span>
<span class="w">  </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">mutate</span><span class="p">(</span><span class="nf">across</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="n">engine_count</span><span class="p">,</span><span class="w"> </span><span class="n">hourly_cost</span><span class="p">),</span><span class="w"> </span>
<span class="w">                   </span><span class="o">~</span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">.</span><span class="p">)))</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="c1"># remove missing values</span>
<span class="w">  </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">filter</span><span class="p">(</span><span class="o">!</span><span class="nf">is.na</span><span class="p">(</span><span class="n">engine_count</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="c1"># select reference categories and ensure they will be ordered last by the indexer</span>
<span class="w">  </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">mutate</span><span class="p">(</span><span class="n">specialservicetypecategory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">ifelse</span><span class="p">(</span><span class="n">specialservicetypecategory</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;Other Animal Assistance&quot;</span><span class="p">,</span>
<span class="w">                         </span><span class="s">&quot;000_Other Animal Assistance&quot;</span><span class="p">,</span>
<span class="w">                         </span><span class="n">specialservicetypecategory</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">mutate</span><span class="p">(</span><span class="n">originofcall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">ifelse</span><span class="p">(</span><span class="n">originofcall</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;Person (mobile)&quot;</span><span class="p">,</span>
<span class="w">                         </span><span class="s">&quot;000_Person (mobile)&quot;</span><span class="p">,</span>
<span class="w">                          </span><span class="n">originofcall</span><span class="w"> </span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">mutate</span><span class="p">(</span><span class="n">propertycategory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">ifelse</span><span class="p">(</span><span class="n">propertycategory</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;Dwelling&quot;</span><span class="p">,</span>
<span class="w">                         </span><span class="s">&quot;000_Dwelling&quot;</span><span class="p">,</span>
<span class="w">                         </span><span class="n">propertycategory</span><span class="p">))</span>
</pre></div>
</div>
</div></div>
<p>The resulting pipeline stage is produced from the <code class="docutils literal notranslate"><span class="pre">dplyr</span></code> code:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-39-Ug==" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-39-Ug==" name="Ug==" role="tab" tabindex="0">R</button><button aria-controls="panel-39-UiBvdXRwdXQ=" aria-selected="false" class="sphinx-tabs-tab code-tab group-tab" id="tab-39-UiBvdXRwdXQ=" name="UiBvdXRwdXQ=" role="tab" tabindex="-1">R output</button></div><div aria-labelledby="tab-39-Ug==" class="sphinx-tabs-panel code-tab group-tab" id="panel-39-Ug==" name="Ug==" role="tabpanel" tabindex="0"><div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">ft_dplyr_transformer</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span><span class="w"> </span><span class="n">rescue_cat</span><span class="p">)</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-39-UiBvdXRwdXQ=" class="sphinx-tabs-panel code-tab group-tab" hidden="true" id="panel-39-UiBvdXRwdXQ=" name="UiBvdXRwdXQ=" role="tabpanel" tabindex="0"><div class="highlight-plaintext notranslate"><div class="highlight"><pre><span></span>SQLTransformer (Transformer)
&lt;dplyr_transformer__694d2090_c856_4d4a_a9f5_e5320b158e38&gt; 
 (Parameters -- Column Names)
</pre></div>
</div>
</div></div>
<section id="creating-the-pipeline">
<h3>Creating the Pipeline<a class="headerlink" href="#creating-the-pipeline" title="Permalink to this heading">#</a></h3>
<p>Our sparklyr pipeline will have a total of 9 steps:</p>
<ol class="arabic simple">
<li><p>SQL transformer - resulting from the <code class="docutils literal notranslate"><span class="pre">ft_dplyr_transformer()</span></code> transformation</p></li>
<li><p>String indexer for <code class="docutils literal notranslate"><span class="pre">specialservicetypecategory</span></code></p></li>
<li><p>String indexer for <code class="docutils literal notranslate"><span class="pre">originofcall</span></code></p></li>
<li><p>String indexer for <code class="docutils literal notranslate"><span class="pre">propertycategory</span></code></p></li>
<li><p>One hot encoder for <code class="docutils literal notranslate"><span class="pre">specialservicetypecategory</span></code></p></li>
<li><p>One hot encoder for <code class="docutils literal notranslate"><span class="pre">originofcall</span></code></p></li>
<li><p>One hot encoder for <code class="docutils literal notranslate"><span class="pre">propertycategory</span></code></p></li>
<li><p>Vector assembler - to generate a single <code class="docutils literal notranslate"><span class="pre">features</span></code> column that contains a vector of feature values (<code class="docutils literal notranslate"><span class="pre">ft_vector_assembler()</span></code>)</p></li>
<li><p>Logistic regression model</p></li>
</ol>
<p>Unfortunately, in Spark 2.x there is no way of combining multiple string indexers or one hot encoders for different columns, so we need a pipeline step for each column we need to index and encode. For Spark 3.x the <code class="docutils literal notranslate"><span class="pre">ft_one_hot_encoder_estimator()</span></code> function can be used in the place of <code class="docutils literal notranslate"><span class="pre">ft_one_hot_encoder()</span></code> which allows the selection of multiple columns. See <a class="reference external" href="https://search.r-project.org/CRAN/refmans/sparklyr/html/ft_one_hot_encoder_estimator.html">here</a> for further details.</p>
<p>The pipeline can be constructed as follows:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-40-Ug==" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-40-Ug==" name="Ug==" role="tab" tabindex="0">R</button></div><div aria-labelledby="tab-40-Ug==" class="sphinx-tabs-panel code-tab group-tab" id="panel-40-Ug==" name="Ug==" role="tabpanel" tabindex="0"><div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">rescue_pipeline</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">ml_pipeline</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">ft_dplyr_transformer</span><span class="p">(</span><span class="n">rescue_cat</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">ft_string_indexer</span><span class="p">(</span><span class="n">input_col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;specialservicetypecategory&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">                    </span><span class="n">output_col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;specialservicetypecategory_idx&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="n">string_order_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;alphabetDesc&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span>
<span class="w">  </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">ft_string_indexer</span><span class="p">(</span><span class="n">input_col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;originofcall&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">                    </span><span class="n">output_col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;originofcall_idx&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="n">string_order_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;alphabetDesc&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">ft_string_indexer</span><span class="p">(</span><span class="n">input_col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;propertycategory&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">                    </span><span class="n">output_col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;propertycategory_idx&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="n">string_order_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;alphabetDesc&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">ft_one_hot_encoder</span><span class="p">(</span><span class="n">input_cols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;specialservicetypecategory_idx&quot;</span><span class="p">),</span><span class="w"> </span>
<span class="w">                     </span><span class="n">output_cols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;specialservicetypecategory_ohe&quot;</span><span class="p">),</span><span class="w"> </span>
<span class="w">                     </span><span class="n">drop_last</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">ft_one_hot_encoder</span><span class="p">(</span><span class="n">input_cols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;originofcall_idx&quot;</span><span class="p">),</span><span class="w"> </span>
<span class="w">                     </span><span class="n">output_cols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;originofcall_ohe&quot;</span><span class="p">),</span><span class="w"> </span>
<span class="w">                     </span><span class="n">drop_last</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">ft_one_hot_encoder</span><span class="p">(</span><span class="n">input_cols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;propertycategory_idx&quot;</span><span class="p">),</span><span class="w"> </span>
<span class="w">                     </span><span class="n">output_cols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;propertycategory_ohe&quot;</span><span class="p">),</span><span class="w"> </span>
<span class="w">                     </span><span class="n">drop_last</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">  </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">ft_vector_assembler</span><span class="p">(</span><span class="n">input_cols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;engine_count&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;hourly_cost&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;originofcall_ohe&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;propertycategory_ohe&quot;</span><span class="p">,</span>
<span class="w">                                              </span><span class="s">&quot;specialservicetypecategory_ohe&quot;</span><span class="p">),</span><span class="w"> </span>
<span class="w">                                </span><span class="n">output_col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;features&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="nf">ml_generalized_linear_regression</span><span class="p">(</span><span class="n">features_col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;features&quot;</span><span class="p">,</span>
<span class="w">                                   </span><span class="n">label_col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;is_cat&quot;</span><span class="p">,</span>
<span class="w">                                   </span><span class="n">family</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;binomial&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                   </span><span class="n">link</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;logit&quot;</span><span class="p">)</span><span class="w"> </span>
<span class="w">                                   </span>
<span class="c1"># View the pipeline</span>
<span class="n">rescue_pipeline</span>
</pre></div>
</div>
</div></div>
<p>The pipeline can be fitted to the <code class="docutils literal notranslate"><span class="pre">rescue</span></code> dataset by applying <code class="docutils literal notranslate"><span class="pre">ml_fit()</span></code> and predictions can be accessed using <code class="docutils literal notranslate"><span class="pre">ml_transform()</span></code>.</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-41-Ug==" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-41-Ug==" name="Ug==" role="tab" tabindex="0">R</button></div><div aria-labelledby="tab-41-Ug==" class="sphinx-tabs-panel code-tab group-tab" id="panel-41-Ug==" name="Ug==" role="tabpanel" tabindex="0"><div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fit the pipeline </span>
<span class="n">fitted_pipeline</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">ml_fit</span><span class="p">(</span><span class="n">rescue_pipeline</span><span class="p">,</span><span class="w"> </span><span class="n">rescue</span><span class="p">)</span>

<span class="c1"># View the fitted pipeline - notice output now shows model coeffiecients</span>
<span class="n">fitted_pipeline</span>

<span class="c1"># Get predictions</span>
<span class="n">predictions</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">ml_transform</span><span class="p">(</span><span class="n">fitted_pipeline</span><span class="p">,</span><span class="w"> </span><span class="n">rescue</span><span class="p">)</span><span class="w"> </span>
</pre></div>
</div>
</div></div>
<p>It is possible to generate a list of model coefficents, p-values etc. using the <code class="docutils literal notranslate"><span class="pre">ml_stage</span></code> function to access the logistic regression stage of the model, combined with <code class="docutils literal notranslate"><span class="pre">ml_summary</span></code> as we did before. However, it is not easy to map the coefficients back to the feature that they correspond to.</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-42-Ug==" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-42-Ug==" name="Ug==" role="tab" tabindex="0">R</button><button aria-controls="panel-42-UiBvdXRwdXQ=" aria-selected="false" class="sphinx-tabs-tab code-tab group-tab" id="tab-42-UiBvdXRwdXQ=" name="UiBvdXRwdXQ=" role="tab" tabindex="-1">R output</button></div><div aria-labelledby="tab-42-Ug==" class="sphinx-tabs-panel code-tab group-tab" id="panel-42-Ug==" name="Ug==" role="tabpanel" tabindex="0"><div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Access the logistic regression stage of the pipeline</span>
<span class="n">model_details</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">ml_stage</span><span class="p">(</span><span class="n">fitted_pipeline</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;generalized_linear_regression&#39;</span><span class="p">)</span>

<span class="c1"># Get coefficients and summary statistics from model</span>
<span class="n">summary</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">tibble</span><span class="p">(</span><span class="n">coefficients</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">model_details</span><span class="o">$</span><span class="n">intercept</span><span class="p">,</span><span class="w"> </span><span class="n">model_details</span><span class="o">$</span><span class="n">coefficients</span><span class="p">),</span><span class="w"> </span>
<span class="w">                  </span><span class="n">std_errors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model_details</span><span class="o">$</span><span class="n">summary</span><span class="o">$</span><span class="nf">coefficient_standard_errors</span><span class="p">(),</span><span class="w"> </span>
<span class="w">                  </span><span class="n">p_values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model_details</span><span class="o">$</span><span class="n">summary</span><span class="o">$</span><span class="nf">p_values</span><span class="p">())</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">mutate</span><span class="p">(</span><span class="n">lower_ci</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">coefficients</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="m">1.96</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">std_errors</span><span class="p">),</span>
<span class="w">                </span><span class="n">upper_ci</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">coefficients</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="m">1.96</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">std_errors</span><span class="p">))</span>
<span class="w">                </span>
<span class="c1"># View the summary</span>
<span class="n">summary</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-42-UiBvdXRwdXQ=" class="sphinx-tabs-panel code-tab group-tab" hidden="true" id="panel-42-UiBvdXRwdXQ=" name="UiBvdXRwdXQ=" role="tabpanel" tabindex="0"><div class="highlight-plaintext notranslate"><div class="highlight"><pre><span></span># A tibble: 19 × 5
   coefficients    std_errors p_values      lower_ci     upper_ci
          &lt;dbl&gt;         &lt;dbl&gt;    &lt;dbl&gt;         &lt;dbl&gt;        &lt;dbl&gt;
 1     1.09          0.372    3.45e- 3       0.359        1.82   
 2    -0.680         0.221    2.12e- 3      -1.11        -0.246  
 3    -0.000707      0.000985 4.73e- 1      -0.00264      0.00122
 4    -0.967         0.226    1.85e- 5      -1.41        -0.524  
 5     0.647         1.55     6.77e- 1      -2.40         3.69   
 6     0.134         0.0572   1.94e- 2       0.0216       0.246  
 7    -0.679         0.366    6.34e- 2      -1.40         0.0379 
 8   -25.0      356124.       1.00e+ 0 -698028.      697978.     
 9   -26.0      356124.       1.00e+ 0 -698029.      697977.     
10    -0.0626        1.42     9.65e- 1      -2.84         2.72   
11     0.202         0.147    1.70e- 1      -0.0864       0.490  
12    -1.43          0.116    0             -1.66        -1.20   
13    -0.748         0.0677   0             -0.881       -0.616  
14    -0.277         0.456    5.44e- 1      -1.17         0.617  
15    -0.905         0.0921   0             -1.09        -0.725  
16     0.727         1.42     6.10e- 1      -2.07         3.52   
17    -0.995         0.160    5.08e-10      -1.31        -0.681  
18     0.423         0.0614   5.18e-12       0.303        0.544  
19     0.446         0.0959   3.32e- 6       0.258        0.634  
</pre></div>
</div>
</div></div>
<p>You can save a pipeline or pipeline model using the <code class="docutils literal notranslate"><span class="pre">ml_save</span></code> command:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-43-Ug==" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-43-Ug==" name="Ug==" role="tab" tabindex="0">R</button></div><div aria-labelledby="tab-43-Ug==" class="sphinx-tabs-panel code-tab group-tab" id="panel-43-Ug==" name="Ug==" role="tabpanel" tabindex="0"><div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Save pipeline</span>
<span class="nf">ml_save</span><span class="p">(</span>
<span class="w">  </span><span class="n">rescue_pipeline</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;rescue_pipeline&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="n">overwrite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span>
<span class="p">)</span>

<span class="c1"># Save pipeline model</span>
<span class="nf">ml_save</span><span class="p">(</span>
<span class="w">  </span><span class="n">fitted_pipeline</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;rescue_model&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="n">overwrite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span>
<span class="p">)</span>
</pre></div>
</div>
</div></div>
<p>They can then be re-loaded using the <code class="docutils literal notranslate"><span class="pre">ml_load()</span></code> command and the re-loaded model can be used to re-fit new data with the same model by supplying the name of the new spark dataframe you wish to fit.</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-44-Ug==" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-44-Ug==" name="Ug==" role="tab" tabindex="0">R</button></div><div aria-labelledby="tab-44-Ug==" class="sphinx-tabs-panel code-tab group-tab" id="panel-44-Ug==" name="Ug==" role="tabpanel" tabindex="0"><div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Reload our saved pipeline</span>
<span class="n">reloaded_pipeline</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">ml_load</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;rescue_pipeline&quot;</span><span class="p">)</span>

<span class="c1"># Re-fit to a subset of rescue data as an example of how pipelines can be re-used</span>
<span class="n">new_model</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">ml_fit</span><span class="p">(</span><span class="n">reloaded_pipeline</span><span class="p">,</span><span class="w"> </span><span class="nf">sample_frac</span><span class="p">(</span><span class="n">rescue</span><span class="p">,</span><span class="w"> </span><span class="m">0.1</span><span class="p">))</span>
</pre></div>
</div>
</div></div>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-45-Ug==" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-45-Ug==" name="Ug==" role="tab" tabindex="0">R</button></div><div aria-labelledby="tab-45-Ug==" class="sphinx-tabs-panel code-tab group-tab" id="panel-45-Ug==" name="Ug==" role="tabpanel" tabindex="0"><div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Close the spark session</span>
<span class="nf">spark_disconnect</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
</details>
</section>
</section>
<section id="further-resources">
<h2>Further resources<a class="headerlink" href="#further-resources" title="Permalink to this heading">#</a></h2>
<p><strong>PySpark references and documentation:</strong></p>
<ul class="simple">
<li><p><a class="reference external" href="https://spark.apache.org/docs/2.3.0/api/python/pyspark.ml.html"><code class="docutils literal notranslate"><span class="pre">pyspark.ml</span></code> package</a></p></li>
<li><p><a class="reference external" href="https://spark.apache.org/docs/2.3.0/api/python/pyspark.ml.html#pyspark.ml.regression.GeneralizedLinearRegression"><code class="docutils literal notranslate"><span class="pre">GeneralizedLinearRegression</span></code></a></p></li>
<li><p><a class="reference external" href="https://spark.apache.org/docs/2.3.0/api/python/pyspark.ml.html#pyspark.ml.stat.Correlation"><code class="docutils literal notranslate"><span class="pre">Correlation</span></code></a></p></li>
<li><p><a class="reference external" href="https://spark.apache.org/docs/2.3.0/api/python/pyspark.ml.html#pyspark.ml.Pipeline"><code class="docutils literal notranslate"><span class="pre">Pipeline</span></code></a></p></li>
<li><p><a class="reference external" href="https://spark.apache.org/docs/2.3.0/api/python/pyspark.ml.html#pyspark.ml.feature.StringIndexer"><code class="docutils literal notranslate"><span class="pre">StringIndexer</span></code></a></p></li>
<li><p><a class="reference external" href="https://spark.apache.org/docs/2.3.0/api/python/pyspark.ml.html#pyspark.ml.feature.OneHotEncoder"><code class="docutils literal notranslate"><span class="pre">OneHotEncoder</span></code></a></p></li>
<li><p><a class="reference external" href="https://spark.apache.org/docs/2.3.0/api/python/pyspark.ml.html#pyspark.ml.feature.VectorAssembler"><code class="docutils literal notranslate"><span class="pre">VectorAssembler</span></code></a></p></li>
</ul>
<p><strong>Sparklyr references and documentation:</strong></p>
<ul class="simple">
<li><p><a class="reference external" href="https://spark.rstudio.com/guides/mlib.html">Spark Machine Learning Library</a></p></li>
<li><p><a class="reference external" href="https://spark.rstudio.com/packages/sparklyr/latest/reference/#spark-machine-learning">Reference - Spark Machine Learning</a></p></li>
<li><p><a class="reference external" href="https://spark.rstudio.com/guides/pipelines.html">Spark ML Pipelines</a></p></li>
<li><p><a class="reference external" href="https://broom.tidymodels.org/"><code class="docutils literal notranslate"><span class="pre">broom</span></code> documentation</a></p></li>
<li><p><a class="reference external" href="https://www.rdocumentation.org/packages/sparklyr/versions/1.8.2/topics/ml_generalized_linear_regression"><code class="docutils literal notranslate"><span class="pre">ml_generalized_linear_regression()</span></code></a></p></li>
<li><p><a class="reference external" href="https://www.rdocumentation.org/packages/sparklyr/versions/0.4/topics/ml_logistic_regression"><code class="docutils literal notranslate"><span class="pre">ml_logistic_regression</span></code></a></p></li>
</ul>
<section id="acknowledgements">
<h3>Acknowledgements<a class="headerlink" href="#acknowledgements" title="Permalink to this heading">#</a></h3>
<p>Thanks to Ted Dolby for providing guidance on logistic regression in sparklyr which was adapted to produce this page.</p>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./spark-analysis"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="interpolation.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Interpolation in Spark</p>
      </div>
    </a>
    <a class="right-next"
       href="visualisation.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Spark and Visualisation</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#preparing-the-data">Preparing the data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#missing-values">Missing values</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#running-a-logistic-regression-model">Running a logistic regression model</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#inferential-analysis">Inferential Analysis</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#things-to-watch-out-for">Things to watch out for</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#singularity-issue">Singularity issue</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#selecting-reference-categories">Selecting reference categories</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#multicollinearity">Multicollinearity</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#spark-ml-pipelines">Spark ML Pipelines</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-the-pipeline">Creating the Pipeline</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#further-resources">Further resources</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#acknowledgements">Acknowledgements</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Analysis Standards and Pipelines in Quality and Improvement, Office for National Statistics
</p>

  </div>
  
  <div class="footer-item">
    

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=5b4479735964841361fd"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>