

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>&lt;no title&gt; &#8212; Spark at the ONS</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=5b4479735964841361fd" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=5b4479735964841361fd" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/accessibility.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=5b4479735964841361fd" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd" />
  <script src="../../_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=5b4479735964841361fd"></script>

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-95MGHSRD0S"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-95MGHSRD0S');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'raw-notebooks/logistic-regression/logistic-regression';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/logo.png" class="logo__image only-light" alt="Spark at the ONS - Home"/>
    <script>document.write(`<img src="../../_static/logo.png" class="logo__image only-dark" alt="Spark at the ONS - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../intro.html">
                    Introduction
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Spark overview</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../spark-overview/spark-start.html">Getting Started with Spark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-overview/when-to-use-spark.html">When To Use Spark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-overview/spark-session-guidance.html">Guidance on Spark Sessions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-overview/example-spark-sessions.html">Example Spark Sessions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-overview/spark-defaults.html">Configuration Hierarchy and <code class="docutils literal notranslate"><span class="pre">spark-defaults.conf</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-overview/data-types.html">Data Types in Spark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-overview/creating-dataframes.html">Creating DataFrames Manually</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-overview/reading-and-writing-data-spark.html">Reading and Writing Data in Spark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-overview/data-storage.html">Data Storage</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction to PySpark</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../pyspark-intro/pyspark-intro.html">Introduction to PySpark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyspark-intro/returning-data.html">Returning Data from Cluster to Driver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyspark-intro/f-col.html">Reference columns by name: <code class="docutils literal notranslate"><span class="pre">F.col()</span></code></a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction to sparklyr</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../sparklyr-intro/sparklyr-intro.html">Introduction to sparklyr</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sparklyr-intro/sparklyr-functions.html">Using Spark functions in sparklyr</a></li>

</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Spark functions</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../spark-functions/union-dataframes-with-different-columns.html">Union two DataFrames with different columns</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-functions/padding.html">Add leading zeros with <code class="docutils literal notranslate"><span class="pre">lpad()</span></code></a></li>

<li class="toctree-l1"><a class="reference internal" href="../../spark-functions/sampling.html">Sampling: an overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-functions/pivot-tables.html">Pivot tables in Spark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-functions/rounding.html">Rounding differences in Python, R and Spark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-functions/window-functions.html">Window Functions in Spark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-functions/cross-joins.html">Cross Joins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-functions/arrays.html">Arrays Functions in PySpark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-functions/date-functions.html">Date functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-functions/writing-data.html">Writing Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-functions/job-description-notebook.html">Set Spark Job Description</a></li>




<li class="toctree-l1"><a class="reference internal" href="../../spark-functions/median.html">Median in Spark</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Understanding and Optimising Spark</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../spark-concepts/optimisation-tips.html">Ideas for optimising Spark code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-concepts/spark-application-and-ui.html">Spark Application and UI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-concepts/groups-not-loops.html">Groups not Loops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-concepts/shuffling.html">Shuffling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-concepts/join-concepts.html">Optimising Joins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-concepts/salted-joins.html">Salted Joins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-concepts/partitions.html">Managing Partitions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-concepts/persistence.html">Persisting in Spark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-concepts/cache.html">Caching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-concepts/checkpoint-staging.html">Checkpoints and Staging Tables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-concepts/garbage-collection.html">Garbage Collection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-concepts/df-order.html">Spark DataFrames Are Not Ordered</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-concepts/exercises.html">Exercises</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Analysis in Spark</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../spark-analysis/big-data-workflow.html">Big data workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-analysis/interpolation.html">Interpolation in Spark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-analysis/logistic-regression.html">Logistic Regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-analysis/visualisation.html">Spark and Visualisation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-analysis/flags.html">Flags in Spark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-analysis/bin-continuous-variable.html">Data binning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-analysis/cramer_v.html">Calculating Cramér’s V from a Spark DataFrame</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Testing and Debugging</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../testing-debugging/spark-errors.html">Understanding and Handling Spark Errors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing-debugging/unit-testing.html">Unit Testing in Spark</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Ancillary Topics</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../ancillary-topics/module-imports.html">Naming Conflicts in Module Imports</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ancillary-topics/pydoop.html">Pydoop: HDFS to pandas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ancillary-topics/creating-a-SQL-view-in-HDFS.html">Creating a SQL view in HDFS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ancillary-topics/pandas-udfs.html">Pandas UDFs</a></li>
</ul>

        </div>
    </nav></div>
            <div class="bd-sidebar__bottom">
                <!-- To handle the deprecated key -->
                
                <div class="navbar_extra_footer">
                <div>
        <p>Book version 2022.6</p>
    </div>
    
                </div>
                
            </div>
        </div>
        <div id="rtd-footer-container"></div>
    </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/best-practice-and-impact/ons-spark" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/best-practice-and-impact/ons-spark/issues/new?title=Issue%20on%20page%20%2Fraw-notebooks/logistic-regression/logistic-regression.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/raw-notebooks/logistic-regression/logistic-regression.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1><no title></h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="simple visible nav section-nav flex-column">
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span> 
<span class="c1">#import packages</span>

<span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
<span class="kn">import</span> <span class="nn">pyspark.sql.functions</span> <span class="k">as</span> <span class="nn">F</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="c1">#local session </span>
<span class="n">spark</span> <span class="o">=</span> <span class="p">(</span><span class="n">SparkSession</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">master</span><span class="p">(</span><span class="s2">&quot;local[2]&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&quot;logistic-regression&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getOrCreate</span><span class="p">())</span>

<span class="c1"># Set the data path</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;../../config.yaml&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

<span class="n">rescue_path_parquet</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;rescue_clean_path&quot;</span><span class="p">]</span>
<span class="c1"># Read in the data</span>
<span class="n">rescue</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">parquet</span><span class="p">(</span><span class="n">rescue_path_parquet</span><span class="p">)</span>

<span class="n">rescue</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">toPandas</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style>
    .dataframe thead tr:only-child th {
        text-align: right;
    }

    .dataframe thead th {
        text-align: left;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>incident_number</th>
      <th>datetimeofcall</th>
      <th>cal_year</th>
      <th>finyear</th>
      <th>typeofincident</th>
      <th>engine_count</th>
      <th>job_hours</th>
      <th>hourly_cost</th>
      <th>total_cost</th>
      <th>finaldescription</th>
      <th>...</th>
      <th>originofcall</th>
      <th>propertytype</th>
      <th>propertycategory</th>
      <th>specialservicetypecategory</th>
      <th>specialservicetype</th>
      <th>ward</th>
      <th>borough</th>
      <th>stngroundname</th>
      <th>postcodedistrict</th>
      <th>incident_duration</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>139091</td>
      <td>01/01/2009 03:01</td>
      <td>2009</td>
      <td>2008/09</td>
      <td>Special Service</td>
      <td>1.0</td>
      <td>2.0</td>
      <td>255</td>
      <td>510.0</td>
      <td>Dog With Jaw Trapped In Magazine Rack,b15</td>
      <td>...</td>
      <td>Person (land Line)</td>
      <td>House - Single Occupancy</td>
      <td>Dwelling</td>
      <td>Other Animal Assistance</td>
      <td>Animal Assistance Involving Livestock - Other ...</td>
      <td>Crystal Palace &amp; Upper Norwood</td>
      <td>Croydon</td>
      <td>Norbury</td>
      <td>Se19</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>275091</td>
      <td>01/01/2009 08:51</td>
      <td>2009</td>
      <td>2008/09</td>
      <td>Special Service</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>255</td>
      <td>255.0</td>
      <td>Assist Rspca With Fox Trapped,b15</td>
      <td>...</td>
      <td>Person (land Line)</td>
      <td>Railings</td>
      <td>Outdoor Structure</td>
      <td>Other Animal Assistance</td>
      <td>Animal Assistance Involving Livestock - Other ...</td>
      <td>Woodside</td>
      <td>Croydon</td>
      <td>Woodside</td>
      <td>Se25</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2075091</td>
      <td>04/01/2009 10:07</td>
      <td>2009</td>
      <td>2008/09</td>
      <td>Special Service</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>255</td>
      <td>255.0</td>
      <td>Dog Caught In Drain,b15</td>
      <td>...</td>
      <td>Person (mobile)</td>
      <td>Pipe Or Drain</td>
      <td>Outdoor Structure</td>
      <td>Animal Rescue From Below Ground</td>
      <td>Animal Rescue From Below Ground - Domestic Pet</td>
      <td>Carshalton Central</td>
      <td>Sutton</td>
      <td>Wallington</td>
      <td>Sm5</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2872091</td>
      <td>05/01/2009 12:27</td>
      <td>2009</td>
      <td>2008/09</td>
      <td>Special Service</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>255</td>
      <td>255.0</td>
      <td>Horse Trapped In Lake,j17</td>
      <td>...</td>
      <td>Person (mobile)</td>
      <td>Intensive Farming Sheds (chickens, Pigs Etc)</td>
      <td>Non Residential</td>
      <td>Animal Rescue From Water</td>
      <td>Animal Rescue From Water - Farm Animal</td>
      <td>Harefield</td>
      <td>Hillingdon</td>
      <td>Ruislip</td>
      <td>Ub9</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>3553091</td>
      <td>06/01/2009 15:23</td>
      <td>2009</td>
      <td>2008/09</td>
      <td>Special Service</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>255</td>
      <td>255.0</td>
      <td>Rabbit Trapped Under Sofa,b15</td>
      <td>...</td>
      <td>Person (mobile)</td>
      <td>House - Single Occupancy</td>
      <td>Dwelling</td>
      <td>Other Animal Assistance</td>
      <td>Animal Assistance Involving Livestock - Other ...</td>
      <td>Gooshays</td>
      <td>Havering</td>
      <td>Harold Hill</td>
      <td>Rm3</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 21 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rescue_path_parquet</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;file:////home/cdsw/ons-spark/ons-spark/data/rescue_clean.parquet&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create is_cat column to contain target variable and select relevant predictors</span>
<span class="n">rescue_cat</span> <span class="o">=</span> <span class="n">rescue</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;is_cat&#39;</span><span class="p">,</span> 
                               <span class="n">F</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;animal_group&#39;</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;Cat&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                               <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;typeofincident&quot;</span><span class="p">,</span> 
                              <span class="s2">&quot;engine_count&quot;</span><span class="p">,</span> 
                              <span class="s2">&quot;job_hours&quot;</span><span class="p">,</span> 
                              <span class="s2">&quot;hourly_cost&quot;</span><span class="p">,</span> 
                              <span class="s2">&quot;total_cost&quot;</span><span class="p">,</span> 
                              <span class="s2">&quot;originofcall&quot;</span><span class="p">,</span> 
                              <span class="s2">&quot;propertycategory&quot;</span><span class="p">,</span>
                              <span class="s2">&quot;specialservicetypecategory&quot;</span><span class="p">,</span>
                              <span class="s2">&quot;incident_duration&quot;</span><span class="p">,</span>
                              <span class="s2">&quot;is_cat&quot;</span><span class="p">)</span>

<span class="c1"># Check created column</span>
<span class="n">rescue_cat</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">toPandas</span><span class="p">()</span>

<span class="c1"># Check data types</span>
<span class="n">rescue_cat</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>root
 |-- typeofincident: string (nullable = true)
 |-- engine_count: string (nullable = true)
 |-- job_hours: string (nullable = true)
 |-- hourly_cost: string (nullable = true)
 |-- total_cost: string (nullable = true)
 |-- originofcall: string (nullable = true)
 |-- propertycategory: string (nullable = true)
 |-- specialservicetypecategory: string (nullable = true)
 |-- incident_duration: string (nullable = true)
 |-- is_cat: integer (nullable = false)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Convert engine_count, job_hours, hourly_cost, total_cost and incident_duration columns to numeric</span>
<span class="n">rescue_cat</span> <span class="o">=</span> <span class="p">(</span>
  <span class="n">rescue_cat</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;engine_count&quot;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;engine_count&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s2">&quot;double&quot;</span><span class="p">))</span>
            <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;job_hours&quot;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;job_hours&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s2">&quot;double&quot;</span><span class="p">))</span>
            <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;hourly_cost&quot;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;hourly_cost&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s2">&quot;double&quot;</span><span class="p">))</span>
            <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;total_cost&quot;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;total_cost&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s2">&quot;double&quot;</span><span class="p">))</span>
            <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;incident_duration&quot;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;incident_duration&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s2">&quot;double&quot;</span><span class="p">)))</span>


<span class="c1"># Check data types are now correct</span>
<span class="n">rescue_cat</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>root
 |-- typeofincident: string (nullable = true)
 |-- engine_count: double (nullable = true)
 |-- job_hours: double (nullable = true)
 |-- hourly_cost: double (nullable = true)
 |-- total_cost: double (nullable = true)
 |-- originofcall: string (nullable = true)
 |-- propertycategory: string (nullable = true)
 |-- specialservicetypecategory: string (nullable = true)
 |-- incident_duration: double (nullable = true)
 |-- is_cat: integer (nullable = false)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get the count of missing values for each column</span>
<span class="n">missing_summary</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">rescue_cat</span>
    <span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">F</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">isNull</span><span class="p">()</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s2">&quot;int&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">rescue_cat</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span>
<span class="p">)</span>

<span class="c1"># Show the summary</span>
<span class="n">missing_summary</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

<span class="c1"># We can see that these are all on the same rows by filtering for NAs in one of the columns:</span>
<span class="n">rescue_cat</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">rescue_cat</span><span class="o">.</span><span class="n">total_cost</span><span class="o">.</span><span class="n">isNull</span><span class="p">())</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">38</span><span class="p">)</span><span class="o">.</span><span class="n">toPandas</span><span class="p">()</span>

<span class="c1"># For simplicity, we will just filter out these rows:</span>
<span class="n">rescue_cat</span> <span class="o">=</span> <span class="n">rescue_cat</span><span class="o">.</span><span class="n">na</span><span class="o">.</span><span class="n">drop</span><span class="p">()</span>

<span class="c1"># Double check we have no nulls left:</span>
<span class="n">missing_summary</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">rescue_cat</span>
    <span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">F</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">isNull</span><span class="p">()</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s2">&quot;int&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">rescue_cat</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span>
    <span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0-------------------------
 typeofincident             | 0   
 engine_count               | 38  
 job_hours                  | 38  
 hourly_cost                | 0   
 total_cost                 | 38  
 originofcall               | 0   
 propertycategory           | 0   
 specialservicetypecategory | 0   
 incident_duration          | 38  
 is_cat                     | 0   

-RECORD 0-------------------------
 typeofincident             | 0   
 engine_count               | 0   
 job_hours                  | 0   
 hourly_cost                | 0   
 total_cost                 | 0   
 originofcall               | 0   
 propertycategory           | 0   
 specialservicetypecategory | 0   
 incident_duration          | 0   
 is_cat                     | 0   
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Importing the required libraries - replace OneHotEncoderEstimator with OneHotEncoder if using Spark &gt;= 3.0</span>
<span class="kn">from</span> <span class="nn">pyspark.ml.feature</span> <span class="kn">import</span> <span class="n">VectorAssembler</span><span class="p">,</span> <span class="n">StringIndexer</span><span class="p">,</span> <span class="n">OneHotEncoderEstimator</span>

<span class="c1">## First we call the StringIndexer separately for each categorical variable</span>

<span class="c1"># Indexing the specialservicetypecategory column</span>
<span class="n">serviceIdx</span> <span class="o">=</span> <span class="n">StringIndexer</span><span class="p">(</span><span class="n">inputCol</span><span class="o">=</span><span class="s1">&#39;specialservicetypecategory&#39;</span><span class="p">,</span>
                               <span class="n">outputCol</span><span class="o">=</span><span class="s1">&#39;serviceIndex&#39;</span><span class="p">)</span>

<span class="c1"># Indexing the originofcallcolumn</span>
<span class="n">callIdx</span> <span class="o">=</span> <span class="n">StringIndexer</span><span class="p">(</span><span class="n">inputCol</span><span class="o">=</span><span class="s1">&#39;originofcall&#39;</span><span class="p">,</span>
                               <span class="n">outputCol</span><span class="o">=</span><span class="s1">&#39;callIndex&#39;</span><span class="p">)</span>

<span class="c1"># Indexing the propertycategory column</span>
<span class="n">propertyIdx</span> <span class="o">=</span> <span class="n">StringIndexer</span><span class="p">(</span><span class="n">inputCol</span><span class="o">=</span><span class="s1">&#39;propertycategory&#39;</span><span class="p">,</span>
                               <span class="n">outputCol</span><span class="o">=</span><span class="s1">&#39;propertyIndex&#39;</span><span class="p">)</span>
                               
<span class="c1"># Apply indexing to each column one by one</span>

<span class="n">rescue_cat_indexed</span> <span class="o">=</span> <span class="n">serviceIdx</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">rescue_cat</span><span class="p">)</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">rescue_cat</span><span class="p">)</span>
<span class="n">rescue_cat_indexed</span> <span class="o">=</span> <span class="n">callIdx</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">rescue_cat_indexed</span><span class="p">)</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">rescue_cat_indexed</span><span class="p">)</span>
<span class="n">rescue_cat_indexed</span> <span class="o">=</span> <span class="n">propertyIdx</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">rescue_cat_indexed</span><span class="p">)</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">rescue_cat_indexed</span><span class="p">)</span>

<span class="c1"># Check that this has worked correctly</span>
<span class="n">rescue_cat_indexed</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;is_cat&#39;</span><span class="p">,</span> <span class="s1">&#39;specialservicetypecategory&#39;</span><span class="p">,</span> <span class="s1">&#39;originofcall&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;propertycategory&#39;</span><span class="p">,</span> <span class="s1">&#39;serviceIndex&#39;</span><span class="p">,</span> <span class="s1">&#39;callIndex&#39;</span><span class="p">,</span> 
                          <span class="s1">&#39;propertyIndex&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>+------+-------------------------------+------------------+-----------------+------------+---------+-------------+
|is_cat|specialservicetypecategory     |originofcall      |propertycategory |serviceIndex|callIndex|propertyIndex|
+------+-------------------------------+------------------+-----------------+------------+---------+-------------+
|0     |Other Animal Assistance        |Person (land Line)|Dwelling         |0.0         |1.0      |0.0          |
|0     |Other Animal Assistance        |Person (land Line)|Outdoor Structure|0.0         |1.0      |3.0          |
|0     |Animal Rescue From Below Ground|Person (mobile)   |Outdoor Structure|2.0         |0.0      |3.0          |
|0     |Animal Rescue From Water       |Person (mobile)   |Non Residential  |3.0         |0.0      |2.0          |
|0     |Other Animal Assistance        |Person (mobile)   |Dwelling         |0.0         |0.0      |0.0          |
|0     |Other Animal Assistance        |Person (land Line)|Dwelling         |0.0         |1.0      |0.0          |
|0     |Other Animal Assistance        |Person (land Line)|Outdoor          |0.0         |1.0      |1.0          |
|0     |Animal Rescue From Water       |Person (mobile)   |Outdoor          |3.0         |0.0      |1.0          |
|0     |Animal Rescue From Height      |Person (land Line)|Dwelling         |1.0         |1.0      |0.0          |
|0     |Animal Rescue From Water       |Person (mobile)   |Outdoor          |3.0         |0.0      |1.0          |
+------+-------------------------------+------------------+-----------------+------------+---------+-------------+
only showing top 10 rows
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Apply OneHotEncoderEstimator to each categorical column simultaneously</span>
<span class="c1"># Replace OneHotEncoderEstimator with OneHotEncoder if using Spark &gt;= 3.0</span>
<span class="n">encoder</span> <span class="o">=</span> <span class="n">OneHotEncoderEstimator</span><span class="p">(</span><span class="n">inputCols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;serviceIndex&#39;</span><span class="p">,</span> <span class="s1">&#39;callIndex&#39;</span><span class="p">,</span> <span class="s1">&#39;propertyIndex&#39;</span><span class="p">],</span> 
                                 <span class="n">outputCols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;serviceVec&#39;</span><span class="p">,</span> <span class="s1">&#39;callVec&#39;</span><span class="p">,</span> <span class="s1">&#39;propertyVec&#39;</span><span class="p">])</span>

<span class="n">rescue_cat_ohe</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">rescue_cat_indexed</span><span class="p">)</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">rescue_cat_indexed</span><span class="p">)</span>

<span class="c1"># Check that this has worked correctly </span>
<span class="n">rescue_cat_ohe</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;is_cat&#39;</span><span class="p">,</span> <span class="s1">&#39;specialservicetypecategory&#39;</span><span class="p">,</span> <span class="s1">&#39;originofcall&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;propertycategory&#39;</span><span class="p">,</span> <span class="s1">&#39;serviceVec&#39;</span><span class="p">,</span> <span class="s1">&#39;callVec&#39;</span><span class="p">,</span> 
                          <span class="s1">&#39;propertyVec&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>+------+-------------------------------+------------------+-----------------+-------------+-------------+-------------+
|is_cat|specialservicetypecategory     |originofcall      |propertycategory |serviceVec   |callVec      |propertyVec  |
+------+-------------------------------+------------------+-----------------+-------------+-------------+-------------+
|0     |Other Animal Assistance        |Person (land Line)|Dwelling         |(3,[0],[1.0])|(7,[1],[1.0])|(6,[0],[1.0])|
|0     |Other Animal Assistance        |Person (land Line)|Outdoor Structure|(3,[0],[1.0])|(7,[1],[1.0])|(6,[3],[1.0])|
|0     |Animal Rescue From Below Ground|Person (mobile)   |Outdoor Structure|(3,[2],[1.0])|(7,[0],[1.0])|(6,[3],[1.0])|
|0     |Animal Rescue From Water       |Person (mobile)   |Non Residential  |(3,[],[])    |(7,[0],[1.0])|(6,[2],[1.0])|
|0     |Other Animal Assistance        |Person (mobile)   |Dwelling         |(3,[0],[1.0])|(7,[0],[1.0])|(6,[0],[1.0])|
|0     |Other Animal Assistance        |Person (land Line)|Dwelling         |(3,[0],[1.0])|(7,[1],[1.0])|(6,[0],[1.0])|
|0     |Other Animal Assistance        |Person (land Line)|Outdoor          |(3,[0],[1.0])|(7,[1],[1.0])|(6,[1],[1.0])|
|0     |Animal Rescue From Water       |Person (mobile)   |Outdoor          |(3,[],[])    |(7,[0],[1.0])|(6,[1],[1.0])|
|0     |Animal Rescue From Height      |Person (land Line)|Dwelling         |(3,[1],[1.0])|(7,[1],[1.0])|(6,[0],[1.0])|
|0     |Animal Rescue From Water       |Person (mobile)   |Outdoor          |(3,[],[])    |(7,[0],[1.0])|(6,[1],[1.0])|
+------+-------------------------------+------------------+-----------------+-------------+-------------+-------------+
only showing top 10 rows
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Call &#39;VectorAssembler&#39; to vectorise all predictor columns in dataset</span>
<span class="n">assembler</span> <span class="o">=</span> <span class="n">VectorAssembler</span><span class="p">(</span><span class="n">inputCols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;engine_count&#39;</span><span class="p">,</span> <span class="s1">&#39;job_hours&#39;</span><span class="p">,</span> <span class="s1">&#39;hourly_cost&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;callVec&#39;</span><span class="p">,</span> <span class="s1">&#39;propertyVec&#39;</span><span class="p">,</span> <span class="s1">&#39;serviceVec&#39;</span><span class="p">],</span>
                            <span class="n">outputCol</span> <span class="o">=</span> <span class="s2">&quot;features&quot;</span><span class="p">)</span>
 
<span class="c1"># Apply vectorisation                                      </span>
<span class="n">rescue_cat_vectorised</span> <span class="o">=</span> <span class="n">assembler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">rescue_cat_ohe</span><span class="p">)</span>

<span class="c1"># Rename &quot;is_cat&quot; target variable column to &quot;label&quot; ready to pass to the regression model</span>
<span class="n">rescue_cat_final</span> <span class="o">=</span> <span class="n">rescue_cat_vectorised</span><span class="o">.</span><span class="n">withColumnRenamed</span><span class="p">(</span><span class="s2">&quot;is_cat&quot;</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="s2">&quot;features&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import GeneralizedLinearRegression</span>
<span class="kn">from</span> <span class="nn">pyspark.ml.regression</span> <span class="kn">import</span> <span class="n">GeneralizedLinearRegression</span>

<span class="c1"># Define model - specify family and link as shown for logistic regression</span>
<span class="n">glr</span> <span class="o">=</span> <span class="n">GeneralizedLinearRegression</span><span class="p">(</span><span class="n">family</span><span class="o">=</span><span class="s2">&quot;binomial&quot;</span><span class="p">,</span> <span class="n">link</span><span class="o">=</span><span class="s2">&quot;logit&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run model</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">glr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">rescue_cat_final</span><span class="p">)</span>

<span class="c1"># Get model results</span>
<span class="n">model_output</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">rescue_cat_final</span><span class="p">)</span>
<span class="n">model_output</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>+-----+--------------------+-------------------+
|label|            features|         prediction|
+-----+--------------------+-------------------+
|    0|(19,[0,1,2,4,10,1...| 0.5837340059218253|
|    0|(19,[0,1,2,4,13,1...| 0.2558840192691791|
|    0|(19,[0,1,2,3,13,1...|0.31990195367533936|
|    0|(19,[0,1,2,3,12],...|0.15861715479284585|
|    0|(19,[0,1,2,3,10,1...|  0.557249095551789|
|    0|(19,[0,1,2,4,10,1...| 0.5898814716386804|
|    0|(19,[0,1,2,4,11,1...| 0.4056895632593727|
|    0|(19,[0,1,2,3,11],...| 0.1809701223341755|
|    0|(19,[0,1,2,4,10,1...| 0.6870145858037298|
|    0|(19,[0,1,2,3,11],...| 0.1809701223341755|
+-----+--------------------+-------------------+
only showing top 10 rows
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get model summary</span>
<span class="n">summary</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">summary</span>

<span class="c1"># Show summary</span>
<span class="n">summary</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Coefficients:
             Feature Estimate   Std Error T Value P Value
         (Intercept) -20.7632  32614.1522 -0.0006  0.9995
        engine_count  -0.6127      0.2744 -2.2328  0.0256
           job_hours  -0.0254      0.0609 -0.4160  0.6774
         hourly_cost  -0.0007      0.0010 -0.7110  0.4771
callVec_Person (m...  21.5650  32614.1521  0.0007  0.9995
callVec_Person (l...  21.6985  32614.1521  0.0007  0.9995
      callVec_Police  20.6004  32614.1521  0.0006  0.9995
   callVec_Other Frs  20.8927  32614.1521  0.0006  0.9995
callVec_Person (r...  22.2337  32614.1522  0.0007  0.9995
   callVec_Ambulance  21.4983  32614.1522  0.0007  0.9995
   callVec_Not Known  -3.4161 357614.2975  0.0000  1.0000
propertyVec_Dwelling  -0.7497      1.4258 -0.5258  0.5990
 propertyVec_Outdoor  -1.4950      1.4245 -1.0495  0.2939
propertyVec_Non R...  -1.6538      1.4277 -1.1584  0.2467
propertyVec_Outdo...  -2.1807      1.4295 -1.5255  0.1271
propertyVec_Road ...  -0.5467      1.4325 -0.3817  0.7027
propertyVec_Other...  -1.0217      1.4957 -0.6831  0.4945
serviceVec_Other ...   0.9945      0.1600  6.2153  0.0000
serviceVec_Animal...   1.4172      0.1602  8.8450  0.0000
serviceVec_Animal...   1.4412      0.1765  8.1644  0.0000

(Dispersion parameter for binomial family taken to be 1.0000)
    Null deviance: 8123.3546 on 5840 degrees of freedom
Residual deviance: 7534.9047 on 5840 degrees of freedom
AIC: 7574.9047
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get model output</span>
<span class="n">model_output</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">rescue_cat_final</span><span class="p">)</span>

<span class="c1"># Get feature names from the model output metadata</span>
<span class="c1"># Numeric and binary (categorical) metadata are accessed separately</span>
<span class="n">numeric_metadata</span> <span class="o">=</span> <span class="n">model_output</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;features&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">schema</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ml_attr&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;attrs&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;numeric&#39;</span><span class="p">)</span>
<span class="n">binary_metadata</span> <span class="o">=</span> <span class="n">model_output</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;features&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">schema</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ml_attr&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;attrs&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;binary&#39;</span><span class="p">)</span>

<span class="c1"># Merge the numeric and binary metadata lists to get all the feature names</span>
<span class="n">merge_list</span> <span class="o">=</span> <span class="n">numeric_metadata</span> <span class="o">+</span> <span class="n">binary_metadata</span>

<span class="c1"># Convert the feature name list to a Pandas dataframe</span>
<span class="n">full_summary</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">merge_list</span><span class="p">)</span>

<span class="c1"># Get the regression coefficients from the model</span>
<span class="n">full_summary</span><span class="p">[</span><span class="s1">&#39;coefficients&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">coefficients</span>

<span class="c1"># The intercept coefficient needs to be added in separately since it is not part of the features metadata</span>
<span class="c1"># Define a new row for the intercept coefficient and get value from model</span>
<span class="n">intercept</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="s1">&#39;intercept&#39;</span><span class="p">,</span> <span class="s1">&#39;coefficients&#39;</span><span class="p">:</span><span class="n">model</span><span class="o">.</span><span class="n">intercept</span><span class="p">},</span> <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="c1"># Add new row to the top of the full_summary dataframe</span>
<span class="n">full_summary</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">intercept</span><span class="p">,</span><span class="n">full_summary</span><span class="o">.</span><span class="n">loc</span><span class="p">[:]])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Add standard errors, t-values and p-values from summary into the full_summary dataframe:</span>
<span class="n">full_summary</span><span class="p">[</span><span class="s1">&#39;std_error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">coefficientStandardErrors</span>
<span class="n">full_summary</span><span class="p">[</span><span class="s1">&#39;tvalues&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">tValues</span>
<span class="n">full_summary</span><span class="p">[</span><span class="s1">&#39;pvalues&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">pValues</span>

<span class="c1"># Manually calculate upper and lower confidence bounds and add into dataframe</span>
<span class="n">full_summary</span><span class="p">[</span><span class="s1">&#39;upper_ci&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">full_summary</span><span class="p">[</span><span class="s1">&#39;coefficients&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.96</span><span class="o">*</span><span class="n">full_summary</span><span class="p">[</span><span class="s1">&#39;std_error&#39;</span><span class="p">])</span>
<span class="n">full_summary</span><span class="p">[</span><span class="s1">&#39;lower_ci&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">full_summary</span><span class="p">[</span><span class="s1">&#39;coefficients&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="mf">1.96</span><span class="o">*</span><span class="n">full_summary</span><span class="p">[</span><span class="s1">&#39;std_error&#39;</span><span class="p">])</span>

<span class="c1"># View final model summary</span>
<span class="n">full_summary</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style>
    .dataframe thead tr:only-child th {
        text-align: right;
    }

    .dataframe thead th {
        text-align: left;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>coefficients</th>
      <th>idx</th>
      <th>name</th>
      <th>std_error</th>
      <th>tvalues</th>
      <th>pvalues</th>
      <th>upper_ci</th>
      <th>lower_ci</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>-20.763158</td>
      <td>NaN</td>
      <td>intercept</td>
      <td>0.274393</td>
      <td>-2.232780</td>
      <td>2.556342e-02</td>
      <td>-20.225347</td>
      <td>-21.300969</td>
    </tr>
    <tr>
      <th>1</th>
      <td>-0.612660</td>
      <td>0.0</td>
      <td>engine_count</td>
      <td>0.060947</td>
      <td>-0.416007</td>
      <td>6.774046e-01</td>
      <td>-0.493203</td>
      <td>-0.732116</td>
    </tr>
    <tr>
      <th>2</th>
      <td>-0.025354</td>
      <td>1.0</td>
      <td>job_hours</td>
      <td>0.000985</td>
      <td>-0.711028</td>
      <td>4.770669e-01</td>
      <td>-0.023424</td>
      <td>-0.027285</td>
    </tr>
    <tr>
      <th>3</th>
      <td>-0.000700</td>
      <td>2.0</td>
      <td>hourly_cost</td>
      <td>32614.152138</td>
      <td>0.000661</td>
      <td>9.994724e-01</td>
      <td>63923.737491</td>
      <td>-63923.738891</td>
    </tr>
    <tr>
      <th>4</th>
      <td>21.564985</td>
      <td>3.0</td>
      <td>callVec_Person (mobile)</td>
      <td>32614.152138</td>
      <td>0.000665</td>
      <td>9.994692e-01</td>
      <td>63945.303176</td>
      <td>-63902.173206</td>
    </tr>
    <tr>
      <th>5</th>
      <td>21.698456</td>
      <td>4.0</td>
      <td>callVec_Person (land Line)</td>
      <td>32614.152139</td>
      <td>0.000632</td>
      <td>9.994960e-01</td>
      <td>63945.436648</td>
      <td>-63902.039737</td>
    </tr>
    <tr>
      <th>6</th>
      <td>20.600364</td>
      <td>5.0</td>
      <td>callVec_Police</td>
      <td>32614.152140</td>
      <td>0.000641</td>
      <td>9.994889e-01</td>
      <td>63944.338559</td>
      <td>-63903.137831</td>
    </tr>
    <tr>
      <th>7</th>
      <td>20.892710</td>
      <td>6.0</td>
      <td>callVec_Other Frs</td>
      <td>32614.152176</td>
      <td>0.000682</td>
      <td>9.994561e-01</td>
      <td>63944.630974</td>
      <td>-63902.845555</td>
    </tr>
    <tr>
      <th>8</th>
      <td>22.233733</td>
      <td>7.0</td>
      <td>callVec_Person (running Call)</td>
      <td>32614.152169</td>
      <td>0.000659</td>
      <td>9.994741e-01</td>
      <td>63945.971985</td>
      <td>-63901.504518</td>
    </tr>
    <tr>
      <th>9</th>
      <td>21.498271</td>
      <td>8.0</td>
      <td>callVec_Ambulance</td>
      <td>357614.297510</td>
      <td>-0.000010</td>
      <td>9.999924e-01</td>
      <td>700945.521390</td>
      <td>-700902.524848</td>
    </tr>
    <tr>
      <th>10</th>
      <td>-3.416074</td>
      <td>9.0</td>
      <td>callVec_Not Known</td>
      <td>1.425841</td>
      <td>-0.525817</td>
      <td>5.990154e-01</td>
      <td>-0.621427</td>
      <td>-6.210722</td>
    </tr>
    <tr>
      <th>11</th>
      <td>-0.749731</td>
      <td>10.0</td>
      <td>propertyVec_Dwelling</td>
      <td>1.424476</td>
      <td>-1.049523</td>
      <td>2.939375e-01</td>
      <td>2.042241</td>
      <td>-3.541704</td>
    </tr>
    <tr>
      <th>12</th>
      <td>-1.495020</td>
      <td>11.0</td>
      <td>propertyVec_Outdoor</td>
      <td>1.427681</td>
      <td>-1.158371</td>
      <td>2.467126e-01</td>
      <td>1.303235</td>
      <td>-4.293276</td>
    </tr>
    <tr>
      <th>13</th>
      <td>-1.653785</td>
      <td>12.0</td>
      <td>propertyVec_Non Residential</td>
      <td>1.429492</td>
      <td>-1.525492</td>
      <td>1.271363e-01</td>
      <td>1.148019</td>
      <td>-4.455589</td>
    </tr>
    <tr>
      <th>14</th>
      <td>-2.180679</td>
      <td>13.0</td>
      <td>propertyVec_Outdoor Structure</td>
      <td>1.432491</td>
      <td>-0.381677</td>
      <td>7.027010e-01</td>
      <td>0.627003</td>
      <td>-4.988361</td>
    </tr>
    <tr>
      <th>15</th>
      <td>-0.546749</td>
      <td>14.0</td>
      <td>propertyVec_Road Vehicle</td>
      <td>1.495729</td>
      <td>-0.683103</td>
      <td>4.945420e-01</td>
      <td>2.384880</td>
      <td>-3.478377</td>
    </tr>
    <tr>
      <th>16</th>
      <td>-1.021736</td>
      <td>15.0</td>
      <td>propertyVec_Other Residential</td>
      <td>0.160008</td>
      <td>6.215336</td>
      <td>5.121503e-10</td>
      <td>-0.708120</td>
      <td>-1.335352</td>
    </tr>
    <tr>
      <th>17</th>
      <td>0.994505</td>
      <td>16.0</td>
      <td>serviceVec_Other Animal Assistance</td>
      <td>0.160229</td>
      <td>8.844992</td>
      <td>0.000000e+00</td>
      <td>1.308554</td>
      <td>0.680455</td>
    </tr>
    <tr>
      <th>18</th>
      <td>1.417228</td>
      <td>17.0</td>
      <td>serviceVec_Animal Rescue From Height</td>
      <td>0.176525</td>
      <td>8.164413</td>
      <td>4.440892e-16</td>
      <td>1.763218</td>
      <td>1.071239</td>
    </tr>
    <tr>
      <th>19</th>
      <td>1.441225</td>
      <td>18.0</td>
      <td>serviceVec_Animal Rescue From Below Ground</td>
      <td>32614.152172</td>
      <td>-0.000637</td>
      <td>9.994920e-01</td>
      <td>63925.179482</td>
      <td>-63922.297031</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span> 
<span class="c1"># Add the `typeofincident` categorical column into analysis </span>
<span class="c1"># Setup column indexing</span>
<span class="n">incidentIdx</span> <span class="o">=</span> <span class="n">StringIndexer</span><span class="p">(</span><span class="n">inputCol</span><span class="o">=</span><span class="s1">&#39;typeofincident&#39;</span><span class="p">,</span>
                               <span class="n">outputCol</span><span class="o">=</span><span class="s1">&#39;incidentIndex&#39;</span><span class="p">)</span>

<span class="c1"># Call the string indexer </span>
<span class="n">rescue_cat_singular_indexed</span> <span class="o">=</span> <span class="n">incidentIdx</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">rescue_cat_indexed</span><span class="p">)</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">rescue_cat_indexed</span><span class="p">)</span>

<span class="c1"># Setup one-hot encoding</span>
<span class="n">encoder_singular</span> <span class="o">=</span> <span class="n">OneHotEncoderEstimator</span><span class="p">(</span><span class="n">inputCols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;incidentIndex&#39;</span><span class="p">],</span> 
                                 <span class="n">outputCols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;incidentVec&#39;</span><span class="p">])</span>
                      
<span class="c1"># The following returns an error &quot;The input column incidentIndex should have at least two distinct values&quot;:</span>
<span class="n">rescue_cat_singular_ohe</span> <span class="o">=</span> <span class="n">encoder_singular</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">rescue_cat_singular_indexed</span><span class="p">)</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">rescue_cat_singular_indexed</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span>---------------------------------------------------------------------------
Py4JJavaError                             Traceback (most recent call last)
/opt/cloudera/parcels/CDH/lib/spark/python/pyspark/sql/utils.py in deco(*a, **kw)
     62         try:
---&gt; 63             return f(*a, **kw)
     64         except py4j.protocol.Py4JJavaError as e:

/usr/local/lib/python3.6/dist-packages/py4j/protocol.py in get_return_value(answer, gateway_client, target_id, name)
    327                     &quot;An error occurred while calling {0}{1}{2}.\n&quot;.
--&gt; 328                     format(target_id, &quot;.&quot;, name), value)
    329             else:

Py4JJavaError: An error occurred while calling o616.fit.
: java.lang.IllegalArgumentException: requirement failed: The input column incidentIndex should have at least two distinct values.
	at scala.Predef$.require(Predef.scala:224)
	at org.apache.spark.ml.feature.OneHotEncoderCommon$$anonfun$9.apply(OneHotEncoderEstimator.scala:456)
	at org.apache.spark.ml.feature.OneHotEncoderCommon$$anonfun$9.apply(OneHotEncoderEstimator.scala:454)
	at scala.Option.map(Option.scala:146)
	at org.apache.spark.ml.feature.OneHotEncoderCommon$.transformOutputColumnSchema(OneHotEncoderEstimator.scala:454)
	at org.apache.spark.ml.feature.OneHotEncoderBase$$anonfun$3.apply(OneHotEncoderEstimator.scala:89)
	at org.apache.spark.ml.feature.OneHotEncoderBase$$anonfun$3.apply(OneHotEncoderEstimator.scala:88)
	at scala.collection.TraversableLike$$anonfun$map$1.apply(TraversableLike.scala:234)
	at scala.collection.TraversableLike$$anonfun$map$1.apply(TraversableLike.scala:234)
	at scala.collection.IndexedSeqOptimized$class.foreach(IndexedSeqOptimized.scala:33)
	at scala.collection.mutable.ArrayOps$ofRef.foreach(ArrayOps.scala:186)
	at scala.collection.TraversableLike$class.map(TraversableLike.scala:234)
	at scala.collection.mutable.ArrayOps$ofRef.map(ArrayOps.scala:186)
	at org.apache.spark.ml.feature.OneHotEncoderBase$class.validateAndTransformSchema(OneHotEncoderEstimator.scala:88)
	at org.apache.spark.ml.feature.OneHotEncoderEstimator.validateAndTransformSchema(OneHotEncoderEstimator.scala:120)
	at org.apache.spark.ml.feature.OneHotEncoderEstimator.transformSchema(OneHotEncoderEstimator.scala:145)
	at org.apache.spark.ml.feature.OneHotEncoderEstimator.fit(OneHotEncoderEstimator.scala:151)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:498)
	at py4j.reflection.MethodInvoker.invoke(MethodInvoker.java:244)
	at py4j.reflection.ReflectionEngine.invoke(ReflectionEngine.java:357)
	at py4j.Gateway.invoke(Gateway.java:282)
	at py4j.commands.AbstractCommand.invokeMethod(AbstractCommand.java:132)
	at py4j.commands.CallCommand.execute(CallCommand.java:79)
	at py4j.GatewayConnection.run(GatewayConnection.java:238)
	at java.lang.Thread.run(Thread.java:745)


During handling of the above exception, another exception occurred:

IllegalArgumentException                  Traceback (most recent call last)
&lt;ipython-input-12-acc43cba2921&gt; in &lt;module&gt;()
     13 
     14 # The following returns an error &quot;The input column incidentIndex should have at least two distinct values&quot;:
---&gt; 15 rescue_cat_singular_ohe = encoder_singular.fit(rescue_cat_singular_indexed).transform(rescue_cat_singular_indexed)
     16 

/opt/cloudera/parcels/CDH/lib/spark/python/pyspark/ml/base.py in fit(self, dataset, params)
    130                 return self.copy(params)._fit(dataset)
    131             else:
--&gt; 132                 return self._fit(dataset)
    133         else:
    134             raise ValueError(&quot;Params must be either a param map or a list/tuple of param maps, &quot;

/opt/cloudera/parcels/CDH/lib/spark/python/pyspark/ml/wrapper.py in _fit(self, dataset)
    293 
    294     def _fit(self, dataset):
--&gt; 295         java_model = self._fit_java(dataset)
    296         model = self._create_model(java_model)
    297         return self._copyValues(model)

/opt/cloudera/parcels/CDH/lib/spark/python/pyspark/ml/wrapper.py in _fit_java(self, dataset)
    290         &quot;&quot;&quot;
    291         self._transfer_params_to_java()
--&gt; 292         return self._java_obj.fit(dataset._jdf)
    293 
    294     def _fit(self, dataset):

/usr/local/lib/python3.6/dist-packages/py4j/java_gateway.py in __call__(self, *args)
   1255         answer = self.gateway_client.send_command(command)
   1256         return_value = get_return_value(
-&gt; 1257             answer, self.gateway_client, self.target_id, self.name)
   1258 
   1259         for temp_arg in temp_args:

/opt/cloudera/parcels/CDH/lib/spark/python/pyspark/sql/utils.py in deco(*a, **kw)
     77                 raise QueryExecutionException(s.split(&#39;: &#39;, 1)[1], stackTrace)
     78             if s.startswith(&#39;java.lang.IllegalArgumentException: &#39;):
---&gt; 79                 raise IllegalArgumentException(s.split(&#39;: &#39;, 1)[1], stackTrace)
     80             raise
     81     return deco

IllegalArgumentException: &#39;requirement failed: The input column incidentIndex should have at least two distinct values.&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Convert typeofincident column into numeric value</span>
<span class="n">rescue_cat_singular</span> <span class="o">=</span> <span class="n">rescue_cat_ohe</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;typeofincident&#39;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;typeofincident&#39;</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;Special Service&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                               <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

<span class="c1"># Setup the vectorassembler to include this variable in the features column</span>
<span class="n">assembler</span> <span class="o">=</span> <span class="n">VectorAssembler</span><span class="p">(</span><span class="n">inputCols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;typeofincident&#39;</span><span class="p">,</span> <span class="s1">&#39;engine_count&#39;</span><span class="p">,</span> <span class="s1">&#39;job_hours&#39;</span><span class="p">,</span> <span class="s1">&#39;hourly_cost&#39;</span><span class="p">,</span> 
                                       <span class="s1">&#39;callVec&#39;</span><span class="p">,</span> <span class="s1">&#39;propertyVec&#39;</span><span class="p">,</span> <span class="s1">&#39;serviceVec&#39;</span><span class="p">],</span> 
                           <span class="n">outputCol</span> <span class="o">=</span> <span class="s2">&quot;features&quot;</span><span class="p">)</span>

<span class="n">rescue_cat_vectorised_sing</span> <span class="o">=</span> <span class="n">assembler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">rescue_cat_singular</span><span class="p">)</span>


<span class="n">rescue_cat_final_sing</span> <span class="o">=</span> <span class="n">rescue_cat_vectorised_sing</span><span class="o">.</span><span class="n">withColumnRenamed</span><span class="p">(</span><span class="s2">&quot;is_cat&quot;</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="s2">&quot;features&quot;</span><span class="p">)</span>

<span class="c1"># Run the model</span>
<span class="n">model_sing</span> <span class="o">=</span> <span class="n">glr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">rescue_cat_final_sing</span><span class="p">)</span>

<span class="c1"># Return model summary (will give an error)</span>
<span class="n">summary_sing</span> <span class="o">=</span> <span class="n">model_sing</span><span class="o">.</span><span class="n">summary</span>

<span class="n">summary_sing</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">Py4JJavaError</span><span class="g g-Whitespace">                             </span>Traceback (most recent call last)
<span class="nn">/usr/local/lib/python3.6/dist-packages/IPython/core/formatters.py</span> in <span class="ni">__call__</span><span class="nt">(self, obj)</span>
<span class="g g-Whitespace">    </span><span class="mi">670</span>                 <span class="n">type_pprinters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">type_printers</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">671</span>                 <span class="n">deferred_pprinters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">deferred_printers</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">672</span>             <span class="n">printer</span><span class="o">.</span><span class="n">pretty</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">673</span>             <span class="n">printer</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">674</span>             <span class="k">return</span> <span class="n">stream</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>

<span class="nn">/usr/local/lib/python3.6/dist-packages/IPython/lib/pretty.py</span> in <span class="ni">pretty</span><span class="nt">(self, obj)</span>
<span class="g g-Whitespace">    </span><span class="mi">381</span>                             <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">meth</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">382</span>                                 <span class="k">return</span> <span class="n">meth</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">cycle</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">383</span>             <span class="k">return</span> <span class="n">_default_pprint</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">cycle</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">384</span>         <span class="k">finally</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">385</span>             <span class="bp">self</span><span class="o">.</span><span class="n">end_group</span><span class="p">()</span>

<span class="nn">/usr/local/lib/python3.6/dist-packages/IPython/lib/pretty.py</span> in <span class="ni">_default_pprint</span><span class="nt">(obj, p, cycle)</span>
<span class="g g-Whitespace">    </span><span class="mi">501</span>     <span class="k">if</span> <span class="n">_safe_getattr</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="s1">&#39;__repr__&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_baseclass_reprs</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">502</span>         <span class="c1"># A user-provided repr. Find newlines and replace them with p.break_()</span>
<span class="ne">--&gt; </span><span class="mi">503</span>         <span class="n">_repr_pprint</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">cycle</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">504</span>         <span class="k">return</span>
<span class="g g-Whitespace">    </span><span class="mi">505</span>     <span class="n">p</span><span class="o">.</span><span class="n">begin_group</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">)</span>

<span class="nn">/usr/local/lib/python3.6/dist-packages/IPython/lib/pretty.py</span> in <span class="ni">_repr_pprint</span><span class="nt">(obj, p, cycle)</span>
<span class="g g-Whitespace">    </span><span class="mi">699</span><span class="w">     </span><span class="sd">&quot;&quot;&quot;A pprint that just redirects to the normal repr function.&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">700</span>     <span class="c1"># Find newlines and replace them with p.break_()</span>
<span class="ne">--&gt; </span><span class="mi">701</span>     <span class="n">output</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">702</span>     <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">output_line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()):</span>
<span class="g g-Whitespace">    </span><span class="mi">703</span>         <span class="k">if</span> <span class="n">idx</span><span class="p">:</span>

<span class="nn">/opt/cloudera/parcels/CDH/lib/spark/python/pyspark/ml/regression.py</span> in <span class="ni">__repr__</span><span class="nt">(self)</span>
<span class="g g-Whitespace">   </span><span class="mi">1842</span> 
<span class="g g-Whitespace">   </span><span class="mi">1843</span>     <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="ne">-&gt; </span><span class="mi">1844</span>         <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_java</span><span class="p">(</span><span class="s2">&quot;toString&quot;</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1845</span> 
<span class="g g-Whitespace">   </span><span class="mi">1846</span> 

<span class="nn">/opt/cloudera/parcels/CDH/lib/spark/python/pyspark/ml/wrapper.py</span> in <span class="ni">_call_java</span><span class="nt">(self, name, *args)</span>
<span class="g g-Whitespace">     </span><span class="mi">53</span>         <span class="n">sc</span> <span class="o">=</span> <span class="n">SparkContext</span><span class="o">.</span><span class="n">_active_spark_context</span>
<span class="g g-Whitespace">     </span><span class="mi">54</span>         <span class="n">java_args</span> <span class="o">=</span> <span class="p">[</span><span class="n">_py2java</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]</span>
<span class="ne">---&gt; </span><span class="mi">55</span>         <span class="k">return</span> <span class="n">_java2py</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">m</span><span class="p">(</span><span class="o">*</span><span class="n">java_args</span><span class="p">))</span>
<span class="g g-Whitespace">     </span><span class="mi">56</span> 
<span class="g g-Whitespace">     </span><span class="mi">57</span>     <span class="nd">@staticmethod</span>

<span class="nn">/usr/local/lib/python3.6/dist-packages/py4j/java_gateway.py</span> in <span class="ni">__call__</span><span class="nt">(self, *args)</span>
<span class="g g-Whitespace">   </span><span class="mi">1255</span>         <span class="n">answer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gateway_client</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1256</span>         <span class="n">return_value</span> <span class="o">=</span> <span class="n">get_return_value</span><span class="p">(</span>
<span class="ne">-&gt; </span><span class="mi">1257</span>             <span class="n">answer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gateway_client</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1258</span> 
<span class="g g-Whitespace">   </span><span class="mi">1259</span>         <span class="k">for</span> <span class="n">temp_arg</span> <span class="ow">in</span> <span class="n">temp_args</span><span class="p">:</span>

<span class="nn">/opt/cloudera/parcels/CDH/lib/spark/python/pyspark/sql/utils.py</span> in <span class="ni">deco</span><span class="nt">(*a, **kw)</span>
<span class="g g-Whitespace">     </span><span class="mi">61</span>     <span class="k">def</span> <span class="nf">deco</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
<span class="g g-Whitespace">     </span><span class="mi">62</span>         <span class="k">try</span><span class="p">:</span>
<span class="ne">---&gt; </span><span class="mi">63</span>             <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">64</span>         <span class="k">except</span> <span class="n">py4j</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">Py4JJavaError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="g g-Whitespace">     </span><span class="mi">65</span>             <span class="n">s</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">java_exception</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span>

<span class="nn">/usr/local/lib/python3.6/dist-packages/py4j/protocol.py</span> in <span class="ni">get_return_value</span><span class="nt">(answer, gateway_client, target_id, name)</span>
<span class="g g-Whitespace">    </span><span class="mi">326</span>                 <span class="k">raise</span> <span class="n">Py4JJavaError</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">327</span>                     <span class="s2">&quot;An error occurred while calling </span><span class="si">{0}{1}{2}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span>
<span class="ne">--&gt; </span><span class="mi">328</span>                     <span class="nb">format</span><span class="p">(</span><span class="n">target_id</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span> <span class="n">value</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">329</span>             <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">330</span>                 <span class="k">raise</span> <span class="n">Py4JError</span><span class="p">(</span>

<span class="ne">Py4JJavaError</span>: An error occurred while calling o735.toString.
<span class="p">:</span> <span class="n">java</span><span class="o">.</span><span class="n">lang</span><span class="o">.</span><span class="n">UnsupportedOperationException</span><span class="p">:</span> <span class="n">No</span> <span class="n">summary</span> <span class="n">available</span> <span class="k">for</span> <span class="n">this</span> <span class="n">GeneralizedLinearRegressionModel</span>
	<span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="n">apache</span><span class="o">.</span><span class="n">spark</span><span class="o">.</span><span class="n">ml</span><span class="o">.</span><span class="n">regression</span><span class="o">.</span><span class="n">GeneralizedLinearRegressionTrainingSummary</span><span class="o">.</span><span class="n">toString</span><span class="p">(</span><span class="n">GeneralizedLinearRegression</span><span class="o">.</span><span class="n">scala</span><span class="p">:</span><span class="mi">1571</span><span class="p">)</span>
	<span class="n">at</span> <span class="n">sun</span><span class="o">.</span><span class="n">reflect</span><span class="o">.</span><span class="n">NativeMethodAccessorImpl</span><span class="o">.</span><span class="n">invoke0</span><span class="p">(</span><span class="n">Native</span> <span class="n">Method</span><span class="p">)</span>
	<span class="n">at</span> <span class="n">sun</span><span class="o">.</span><span class="n">reflect</span><span class="o">.</span><span class="n">NativeMethodAccessorImpl</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">NativeMethodAccessorImpl</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">62</span><span class="p">)</span>
	<span class="n">at</span> <span class="n">sun</span><span class="o">.</span><span class="n">reflect</span><span class="o">.</span><span class="n">DelegatingMethodAccessorImpl</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">DelegatingMethodAccessorImpl</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">43</span><span class="p">)</span>
	<span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="n">lang</span><span class="o">.</span><span class="n">reflect</span><span class="o">.</span><span class="n">Method</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">Method</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">498</span><span class="p">)</span>
	<span class="n">at</span> <span class="n">py4j</span><span class="o">.</span><span class="n">reflection</span><span class="o">.</span><span class="n">MethodInvoker</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">MethodInvoker</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">244</span><span class="p">)</span>
	<span class="n">at</span> <span class="n">py4j</span><span class="o">.</span><span class="n">reflection</span><span class="o">.</span><span class="n">ReflectionEngine</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">ReflectionEngine</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">357</span><span class="p">)</span>
	<span class="n">at</span> <span class="n">py4j</span><span class="o">.</span><span class="n">Gateway</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">Gateway</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">282</span><span class="p">)</span>
	<span class="n">at</span> <span class="n">py4j</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">AbstractCommand</span><span class="o">.</span><span class="n">invokeMethod</span><span class="p">(</span><span class="n">AbstractCommand</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">132</span><span class="p">)</span>
	<span class="n">at</span> <span class="n">py4j</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">CallCommand</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">CallCommand</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">79</span><span class="p">)</span>
	<span class="n">at</span> <span class="n">py4j</span><span class="o">.</span><span class="n">GatewayConnection</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">GatewayConnection</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">238</span><span class="p">)</span>
	<span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="n">lang</span><span class="o">.</span><span class="n">Thread</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">Thread</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">745</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rescue_cat</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&quot;specialservicetypecategory&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>+-------------------------------+-----+
|specialservicetypecategory     |count|
+-------------------------------+-----+
|Animal Rescue From Water       |343  |
|Animal Rescue From Below Ground|593  |
|Animal Rescue From Height      |2123 |
|Other Animal Assistance        |2801 |
+-------------------------------+-----+
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Add &quot;000_&quot; prefix to selected reference categories</span>

<span class="n">rescue_cat_reindex</span> <span class="o">=</span> <span class="p">(</span><span class="n">rescue_cat</span>
                      <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;specialservicetypecategory&#39;</span><span class="p">,</span> 
                                       <span class="n">F</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;specialservicetypecategory&#39;</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;Other Animal Assistance&quot;</span><span class="p">,</span> <span class="s2">&quot;000_Other Animal Assistance&quot;</span><span class="p">)</span>
                                       <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;specialservicetypecategory&#39;</span><span class="p">)))</span>
                      <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;originofcall&#39;</span><span class="p">,</span> 
                                       <span class="n">F</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;originofcall&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;Person (mobile)&quot;</span><span class="p">,</span> <span class="s2">&quot;000_Person (mobile)&quot;</span><span class="p">)</span>
                                       <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;originofcall&#39;</span><span class="p">)))</span>
                      <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;propertycategory&#39;</span><span class="p">,</span> 
                                       <span class="n">F</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;propertycategory&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;Dwelling&quot;</span><span class="p">,</span> <span class="s2">&quot;000_Dwelling&quot;</span><span class="p">)</span>
                                       <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;propertycategory&#39;</span><span class="p">))))</span>

<span class="c1"># Check prefix additions </span>
<span class="n">rescue_cat_reindex</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;specialservicetypecategory&#39;</span><span class="p">,</span> <span class="s1">&#39;originofcall&#39;</span><span class="p">,</span> <span class="s1">&#39;propertycategory&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>

<span class="c1"># Use stringOrderType argument of StringIndexer</span>

<span class="c1"># Re-indexing the specialservicetypecategory column</span>
<span class="n">serviceIdx</span> <span class="o">=</span> <span class="n">StringIndexer</span><span class="p">(</span><span class="n">inputCol</span><span class="o">=</span><span class="s1">&#39;specialservicetypecategory&#39;</span><span class="p">,</span>
                               <span class="n">outputCol</span><span class="o">=</span><span class="s1">&#39;serviceIndex&#39;</span><span class="p">,</span> 
                               <span class="n">stringOrderType</span> <span class="o">=</span> <span class="s2">&quot;alphabetDesc&quot;</span><span class="p">)</span>

<span class="c1"># Indexing the originofcallcolumn</span>
<span class="n">callIdx</span> <span class="o">=</span> <span class="n">StringIndexer</span><span class="p">(</span><span class="n">inputCol</span><span class="o">=</span><span class="s1">&#39;originofcall&#39;</span><span class="p">,</span>
                               <span class="n">outputCol</span><span class="o">=</span><span class="s1">&#39;callIndex&#39;</span><span class="p">,</span>
                               <span class="n">stringOrderType</span> <span class="o">=</span> <span class="s2">&quot;alphabetDesc&quot;</span><span class="p">)</span>

<span class="c1"># Indexing the propertycategory column</span>
<span class="n">propertyIdx</span> <span class="o">=</span> <span class="n">StringIndexer</span><span class="p">(</span><span class="n">inputCol</span><span class="o">=</span><span class="s1">&#39;propertycategory&#39;</span><span class="p">,</span>
                               <span class="n">outputCol</span><span class="o">=</span><span class="s1">&#39;propertyIndex&#39;</span><span class="p">,</span> 
                               <span class="n">stringOrderType</span> <span class="o">=</span> <span class="s2">&quot;alphabetDesc&quot;</span><span class="p">)</span>

<span class="c1"># Call indexing for each column one by one</span>

<span class="n">rescue_cat_indexed</span> <span class="o">=</span> <span class="n">serviceIdx</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">rescue_cat_reindex</span><span class="p">)</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">rescue_cat_reindex</span><span class="p">)</span>
<span class="n">rescue_cat_indexed</span> <span class="o">=</span> <span class="n">callIdx</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">rescue_cat_indexed</span><span class="p">)</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">rescue_cat_indexed</span><span class="p">)</span>
<span class="n">rescue_cat_indexed</span> <span class="o">=</span> <span class="n">propertyIdx</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">rescue_cat_indexed</span><span class="p">)</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">rescue_cat_indexed</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>+--------------------------+-------------------+-----------------+
|specialservicetypecategory|       originofcall| propertycategory|
+--------------------------+-------------------+-----------------+
|      000_Other Animal ...| Person (land Line)|     000_Dwelling|
|      000_Other Animal ...| Person (land Line)|Outdoor Structure|
|      Animal Rescue Fro...|000_Person (mobile)|Outdoor Structure|
|      Animal Rescue Fro...|000_Person (mobile)|  Non Residential|
|      000_Other Animal ...|000_Person (mobile)|     000_Dwelling|
|      000_Other Animal ...| Person (land Line)|     000_Dwelling|
|      000_Other Animal ...| Person (land Line)|          Outdoor|
|      Animal Rescue Fro...|000_Person (mobile)|          Outdoor|
|      Animal Rescue Fro...| Person (land Line)|     000_Dwelling|
|      Animal Rescue Fro...|000_Person (mobile)|          Outdoor|
|      Animal Rescue Fro...| Person (land Line)|          Outdoor|
|      Animal Rescue Fro...|000_Person (mobile)|          Outdoor|
|      000_Other Animal ...|000_Person (mobile)|     Road Vehicle|
|      000_Other Animal ...| Person (land Line)|  Non Residential|
|      Animal Rescue Fro...| Person (land Line)|          Outdoor|
|      Animal Rescue Fro...| Person (land Line)|          Outdoor|
|      Animal Rescue Fro...| Person (land Line)|          Outdoor|
|      Animal Rescue Fro...|          Ambulance|          Outdoor|
|      Animal Rescue Fro...| Person (land Line)|          Outdoor|
|      000_Other Animal ...| Person (land Line)|          Outdoor|
+--------------------------+-------------------+-----------------+
only showing top 20 rows
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Encode re-indexed columns</span>
<span class="n">encoder</span> <span class="o">=</span> <span class="n">OneHotEncoderEstimator</span><span class="p">(</span><span class="n">inputCols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;serviceIndex&#39;</span><span class="p">,</span> <span class="s1">&#39;callIndex&#39;</span><span class="p">,</span> <span class="s1">&#39;propertyIndex&#39;</span><span class="p">],</span> 
                                 <span class="n">outputCols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;serviceVec&#39;</span><span class="p">,</span> <span class="s1">&#39;callVec&#39;</span><span class="p">,</span> <span class="s1">&#39;propertyVec&#39;</span><span class="p">])</span>

<span class="n">rescue_cat_ohe</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">rescue_cat_indexed</span><span class="p">)</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">rescue_cat_indexed</span><span class="p">)</span>


<span class="c1"># Vectorize all our predictors into a new column called &quot;features&quot; </span>

<span class="n">assembler</span> <span class="o">=</span> <span class="n">VectorAssembler</span><span class="p">(</span><span class="n">inputCols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;engine_count&#39;</span><span class="p">,</span> <span class="s1">&#39;job_hours&#39;</span><span class="p">,</span> <span class="s1">&#39;hourly_cost&#39;</span><span class="p">,</span> 
                                       <span class="s1">&#39;callVec&#39;</span><span class="p">,</span> <span class="s1">&#39;propertyVec&#39;</span><span class="p">,</span> <span class="s1">&#39;serviceVec&#39;</span><span class="p">],</span> 
                           <span class="n">outputCol</span> <span class="o">=</span> <span class="s2">&quot;features&quot;</span><span class="p">)</span>

<span class="n">rescue_cat_vectorised</span> <span class="o">=</span> <span class="n">assembler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">rescue_cat_ohe</span><span class="p">)</span>

<span class="c1"># Rename target variable &quot;is_cat&quot; to &quot;label&quot; ready to run regression model</span>
<span class="n">rescue_cat_final</span> <span class="o">=</span> <span class="n">rescue_cat_vectorised</span><span class="o">.</span><span class="n">withColumnRenamed</span><span class="p">(</span><span class="s2">&quot;is_cat&quot;</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="s2">&quot;features&quot;</span><span class="p">)</span>

<span class="c1"># Run the model again</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">glr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">rescue_cat_final</span><span class="p">)</span>

<span class="c1"># Show summary</span>
<span class="n">model</span><span class="o">.</span><span class="n">summary</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Coefficients:
             Feature Estimate   Std Error  T Value P Value
         (Intercept)   1.0466      0.3855   2.7150  0.0066
        engine_count  -0.6127      0.2744  -2.2328  0.0256
           job_hours  -0.0254      0.0609  -0.4160  0.6774
         hourly_cost  -0.0007      0.0010  -0.7110  0.4771
      callVec_Police  -0.9646      0.2259  -4.2704  0.0000
callVec_Person (r...   0.6687      1.5616   0.4282  0.6685
callVec_Person (l...   0.1335      0.0573   2.3311  0.0197
   callVec_Other Frs  -0.6723      0.3661  -1.8365  0.0663
   callVec_Not Known -24.9811 356123.9993  -0.0001  0.9999
  callVec_Coastguard -26.0473 356123.9993  -0.0001  0.9999
   callVec_Ambulance  -0.0667      1.4188  -0.0470  0.9625
propertyVec_Road ...   0.2030      0.1470   1.3807  0.1674
propertyVec_Outdo...  -1.4309      0.1159 -12.3498  0.0000
 propertyVec_Outdoor  -0.7453      0.0680 -10.9546  0.0000
propertyVec_Other...  -0.2720      0.4562  -0.5962  0.5511
propertyVec_Non R...  -0.9041      0.0922  -9.8075  0.0000
    propertyVec_Boat   0.7497      1.4258   0.5258  0.5990
serviceVec_Animal...  -0.9945      0.1600  -6.2153  0.0000
serviceVec_Animal...   0.4227      0.0614   6.8856  0.0000
serviceVec_Animal...   0.4467      0.0959   4.6581  0.0000

(Dispersion parameter for binomial family taken to be 1.0000)
    Null deviance: 8123.3546 on 5840 degrees of freedom
Residual deviance: 7534.9047 on 5840 degrees of freedom
AIC: 7574.9047
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.ml.stat</span> <span class="kn">import</span> <span class="n">Correlation</span>

<span class="c1"># Select feature column vector</span>
<span class="n">features_vector</span> <span class="o">=</span> <span class="n">rescue_cat_final</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;features&quot;</span><span class="p">)</span>

<span class="c1"># Generate correlation matrix</span>
<span class="n">matrix</span> <span class="o">=</span> <span class="n">Correlation</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">features_vector</span><span class="p">,</span> <span class="s2">&quot;features&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># Convert matrix into a useful format</span>
<span class="n">corr_matrix</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">toArray</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> 

<span class="c1"># Get list of features to assign to matrix columns and indices</span>
<span class="n">features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">merge_list</span><span class="p">)[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

<span class="c1"># Final correlation matrix</span>
<span class="n">corr_matrix_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">corr_matrix</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">features</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">features</span><span class="p">)</span> 

<span class="n">corr_matrix_df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style>
    .dataframe thead tr:only-child th {
        text-align: right;
    }

    .dataframe thead th {
        text-align: left;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>engine_count</th>
      <th>job_hours</th>
      <th>hourly_cost</th>
      <th>callVec_Person (mobile)</th>
      <th>callVec_Person (land Line)</th>
      <th>callVec_Police</th>
      <th>callVec_Other Frs</th>
      <th>callVec_Person (running Call)</th>
      <th>callVec_Ambulance</th>
      <th>callVec_Not Known</th>
      <th>propertyVec_Dwelling</th>
      <th>propertyVec_Outdoor</th>
      <th>propertyVec_Non Residential</th>
      <th>propertyVec_Outdoor Structure</th>
      <th>propertyVec_Road Vehicle</th>
      <th>propertyVec_Other Residential</th>
      <th>serviceVec_Other Animal Assistance</th>
      <th>serviceVec_Animal Rescue From Height</th>
      <th>serviceVec_Animal Rescue From Below Ground</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>engine_count</th>
      <td>1.000000</td>
      <td>0.665043</td>
      <td>-0.014307</td>
      <td>0.049797</td>
      <td>-0.002593</td>
      <td>-0.042509</td>
      <td>0.058198</td>
      <td>-0.001834</td>
      <td>-0.001834</td>
      <td>-0.002593</td>
      <td>0.010865</td>
      <td>-0.028092</td>
      <td>0.133052</td>
      <td>-0.008213</td>
      <td>-0.030875</td>
      <td>-0.002593</td>
      <td>0.235154</td>
      <td>-0.069015</td>
      <td>-0.029857</td>
    </tr>
    <tr>
      <th>job_hours</th>
      <td>0.665043</td>
      <td>1.000000</td>
      <td>-0.002139</td>
      <td>0.066634</td>
      <td>0.022691</td>
      <td>-0.048369</td>
      <td>0.077129</td>
      <td>0.035761</td>
      <td>-0.003674</td>
      <td>-0.005197</td>
      <td>0.012760</td>
      <td>-0.032097</td>
      <td>0.159524</td>
      <td>0.005622</td>
      <td>-0.013365</td>
      <td>0.022691</td>
      <td>0.182220</td>
      <td>-0.076956</td>
      <td>-0.005555</td>
    </tr>
    <tr>
      <th>hourly_cost</th>
      <td>-0.014307</td>
      <td>-0.002139</td>
      <td>1.000000</td>
      <td>-0.091829</td>
      <td>-0.018839</td>
      <td>-0.161395</td>
      <td>-0.056116</td>
      <td>0.000235</td>
      <td>-0.013320</td>
      <td>-0.009254</td>
      <td>0.038299</td>
      <td>0.001970</td>
      <td>-0.067821</td>
      <td>-0.010384</td>
      <td>0.019469</td>
      <td>0.002249</td>
      <td>-0.099933</td>
      <td>-0.025820</td>
      <td>-0.099316</td>
    </tr>
    <tr>
      <th>callVec_Person (mobile)</th>
      <td>0.049797</td>
      <td>0.066634</td>
      <td>-0.091829</td>
      <td>1.000000</td>
      <td>-0.002772</td>
      <td>-0.139063</td>
      <td>-0.013345</td>
      <td>-0.001960</td>
      <td>-0.001960</td>
      <td>-0.002772</td>
      <td>0.025817</td>
      <td>0.005902</td>
      <td>0.064985</td>
      <td>0.011162</td>
      <td>-0.016936</td>
      <td>-0.002772</td>
      <td>0.096359</td>
      <td>-0.050171</td>
      <td>-0.011778</td>
    </tr>
    <tr>
      <th>callVec_Person (land Line)</th>
      <td>-0.002593</td>
      <td>0.022691</td>
      <td>-0.018839</td>
      <td>-0.002772</td>
      <td>1.000000</td>
      <td>-0.017127</td>
      <td>-0.001644</td>
      <td>-0.000241</td>
      <td>-0.000241</td>
      <td>-0.000341</td>
      <td>-0.003632</td>
      <td>-0.005258</td>
      <td>0.009122</td>
      <td>-0.001081</td>
      <td>-0.006304</td>
      <td>-0.000341</td>
      <td>0.034749</td>
      <td>-0.013927</td>
      <td>-0.006200</td>
    </tr>
    <tr>
      <th>callVec_Police</th>
      <td>-0.042509</td>
      <td>-0.048369</td>
      <td>-0.161395</td>
      <td>-0.139063</td>
      <td>-0.017127</td>
      <td>1.000000</td>
      <td>-0.082447</td>
      <td>-0.012109</td>
      <td>-0.012109</td>
      <td>-0.017127</td>
      <td>-0.064641</td>
      <td>-0.053138</td>
      <td>-0.028732</td>
      <td>0.039660</td>
      <td>0.034325</td>
      <td>0.001404</td>
      <td>-0.085306</td>
      <td>0.130976</td>
      <td>-0.018198</td>
    </tr>
    <tr>
      <th>callVec_Other Frs</th>
      <td>0.058198</td>
      <td>0.077129</td>
      <td>-0.056116</td>
      <td>-0.013345</td>
      <td>-0.001644</td>
      <td>-0.082447</td>
      <td>1.000000</td>
      <td>-0.001162</td>
      <td>-0.001162</td>
      <td>-0.001644</td>
      <td>-0.017484</td>
      <td>-0.025312</td>
      <td>0.069788</td>
      <td>-0.005205</td>
      <td>0.013944</td>
      <td>-0.001644</td>
      <td>0.084906</td>
      <td>-0.030837</td>
      <td>-0.010611</td>
    </tr>
    <tr>
      <th>callVec_Person (running Call)</th>
      <td>-0.001834</td>
      <td>0.035761</td>
      <td>0.000235</td>
      <td>-0.001960</td>
      <td>-0.000241</td>
      <td>-0.012109</td>
      <td>-0.001162</td>
      <td>1.000000</td>
      <td>-0.000171</td>
      <td>-0.000241</td>
      <td>-0.002568</td>
      <td>-0.003718</td>
      <td>0.021019</td>
      <td>-0.000765</td>
      <td>-0.004457</td>
      <td>-0.000241</td>
      <td>0.052395</td>
      <td>-0.009847</td>
      <td>-0.004384</td>
    </tr>
    <tr>
      <th>callVec_Ambulance</th>
      <td>-0.001834</td>
      <td>-0.003674</td>
      <td>-0.013320</td>
      <td>-0.001960</td>
      <td>-0.000241</td>
      <td>-0.012109</td>
      <td>-0.001162</td>
      <td>-0.000171</td>
      <td>1.000000</td>
      <td>-0.000241</td>
      <td>-0.002568</td>
      <td>-0.003718</td>
      <td>0.021019</td>
      <td>-0.000765</td>
      <td>-0.004457</td>
      <td>-0.000241</td>
      <td>-0.003257</td>
      <td>-0.009847</td>
      <td>-0.004384</td>
    </tr>
    <tr>
      <th>callVec_Not Known</th>
      <td>-0.002593</td>
      <td>-0.005197</td>
      <td>-0.009254</td>
      <td>-0.002772</td>
      <td>-0.000341</td>
      <td>-0.017127</td>
      <td>-0.001644</td>
      <td>-0.000241</td>
      <td>-0.000241</td>
      <td>1.000000</td>
      <td>-0.003632</td>
      <td>-0.005258</td>
      <td>0.009122</td>
      <td>-0.001081</td>
      <td>-0.006304</td>
      <td>-0.000341</td>
      <td>-0.004607</td>
      <td>-0.013927</td>
      <td>0.024434</td>
    </tr>
    <tr>
      <th>propertyVec_Dwelling</th>
      <td>0.010865</td>
      <td>0.012760</td>
      <td>0.038299</td>
      <td>0.025817</td>
      <td>-0.003632</td>
      <td>-0.064641</td>
      <td>-0.017484</td>
      <td>-0.002568</td>
      <td>-0.002568</td>
      <td>-0.003632</td>
      <td>1.000000</td>
      <td>-0.055938</td>
      <td>-0.122177</td>
      <td>-0.011503</td>
      <td>-0.067065</td>
      <td>-0.003632</td>
      <td>-0.045171</td>
      <td>-0.140654</td>
      <td>-0.051007</td>
    </tr>
    <tr>
      <th>propertyVec_Outdoor</th>
      <td>-0.028092</td>
      <td>-0.032097</td>
      <td>0.001970</td>
      <td>0.005902</td>
      <td>-0.005258</td>
      <td>-0.053138</td>
      <td>-0.025312</td>
      <td>-0.003718</td>
      <td>-0.003718</td>
      <td>-0.005258</td>
      <td>-0.055938</td>
      <td>1.000000</td>
      <td>-0.176876</td>
      <td>-0.016653</td>
      <td>-0.097090</td>
      <td>-0.005258</td>
      <td>-0.043342</td>
      <td>-0.040518</td>
      <td>0.016283</td>
    </tr>
    <tr>
      <th>propertyVec_Non Residential</th>
      <td>0.133052</td>
      <td>0.159524</td>
      <td>-0.067821</td>
      <td>0.064985</td>
      <td>0.009122</td>
      <td>-0.028732</td>
      <td>0.069788</td>
      <td>0.021019</td>
      <td>0.021019</td>
      <td>0.009122</td>
      <td>-0.122177</td>
      <td>-0.176876</td>
      <td>1.000000</td>
      <td>-0.036374</td>
      <td>-0.212060</td>
      <td>-0.011485</td>
      <td>0.337926</td>
      <td>0.008224</td>
      <td>-0.048275</td>
    </tr>
    <tr>
      <th>propertyVec_Outdoor Structure</th>
      <td>-0.008213</td>
      <td>0.005622</td>
      <td>-0.010384</td>
      <td>0.011162</td>
      <td>-0.001081</td>
      <td>0.039660</td>
      <td>-0.005205</td>
      <td>-0.000765</td>
      <td>-0.000765</td>
      <td>-0.001081</td>
      <td>-0.011503</td>
      <td>-0.016653</td>
      <td>-0.036374</td>
      <td>1.000000</td>
      <td>-0.019966</td>
      <td>-0.001081</td>
      <td>-0.014592</td>
      <td>0.004592</td>
      <td>-0.000232</td>
    </tr>
    <tr>
      <th>propertyVec_Road Vehicle</th>
      <td>-0.030875</td>
      <td>-0.013365</td>
      <td>0.019469</td>
      <td>-0.016936</td>
      <td>-0.006304</td>
      <td>0.034325</td>
      <td>0.013944</td>
      <td>-0.004457</td>
      <td>-0.004457</td>
      <td>-0.006304</td>
      <td>-0.067065</td>
      <td>-0.097090</td>
      <td>-0.212060</td>
      <td>-0.019966</td>
      <td>1.000000</td>
      <td>-0.006304</td>
      <td>-0.075555</td>
      <td>0.049539</td>
      <td>-0.014497</td>
    </tr>
    <tr>
      <th>propertyVec_Other Residential</th>
      <td>-0.002593</td>
      <td>0.022691</td>
      <td>0.002249</td>
      <td>-0.002772</td>
      <td>-0.000341</td>
      <td>0.001404</td>
      <td>-0.001644</td>
      <td>-0.000241</td>
      <td>-0.000241</td>
      <td>-0.000341</td>
      <td>-0.003632</td>
      <td>-0.005258</td>
      <td>-0.011485</td>
      <td>-0.001081</td>
      <td>-0.006304</td>
      <td>1.000000</td>
      <td>0.074105</td>
      <td>-0.013927</td>
      <td>-0.006200</td>
    </tr>
    <tr>
      <th>serviceVec_Other Animal Assistance</th>
      <td>0.235154</td>
      <td>0.182220</td>
      <td>-0.099933</td>
      <td>0.096359</td>
      <td>0.034749</td>
      <td>-0.085306</td>
      <td>0.084906</td>
      <td>0.052395</td>
      <td>-0.003257</td>
      <td>-0.004607</td>
      <td>-0.045171</td>
      <td>-0.043342</td>
      <td>0.337926</td>
      <td>-0.014592</td>
      <td>-0.075555</td>
      <td>0.074105</td>
      <td>1.000000</td>
      <td>-0.187936</td>
      <td>-0.083665</td>
    </tr>
    <tr>
      <th>serviceVec_Animal Rescue From Height</th>
      <td>-0.069015</td>
      <td>-0.076956</td>
      <td>-0.025820</td>
      <td>-0.050171</td>
      <td>-0.013927</td>
      <td>0.130976</td>
      <td>-0.030837</td>
      <td>-0.009847</td>
      <td>-0.009847</td>
      <td>-0.013927</td>
      <td>-0.140654</td>
      <td>-0.040518</td>
      <td>0.008224</td>
      <td>0.004592</td>
      <td>0.049539</td>
      <td>-0.013927</td>
      <td>-0.187936</td>
      <td>1.000000</td>
      <td>-0.252906</td>
    </tr>
    <tr>
      <th>serviceVec_Animal Rescue From Below Ground</th>
      <td>-0.029857</td>
      <td>-0.005555</td>
      <td>-0.099316</td>
      <td>-0.011778</td>
      <td>-0.006200</td>
      <td>-0.018198</td>
      <td>-0.010611</td>
      <td>-0.004384</td>
      <td>-0.004384</td>
      <td>0.024434</td>
      <td>-0.051007</td>
      <td>0.016283</td>
      <td>-0.048275</td>
      <td>-0.000232</td>
      <td>-0.014497</td>
      <td>-0.006200</td>
      <td>-0.083665</td>
      <td>-0.252906</td>
      <td>1.000000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rescue_cat</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;job_hours&quot;</span><span class="p">,</span> <span class="s2">&quot;hourly_cost&quot;</span><span class="p">,</span> <span class="s2">&quot;total_cost&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s2">&quot;job_hours&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span><span class="o">.</span><span class="n">toPandas</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style>
    .dataframe thead tr:only-child th {
        text-align: right;
    }

    .dataframe thead th {
        text-align: left;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>job_hours</th>
      <th>hourly_cost</th>
      <th>total_cost</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>12.0</td>
      <td>326.0</td>
      <td>3912.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>12.0</td>
      <td>290.0</td>
      <td>3480.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>10.0</td>
      <td>298.0</td>
      <td>2980.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>9.0</td>
      <td>260.0</td>
      <td>2340.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>9.0</td>
      <td>260.0</td>
      <td>2340.0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>9.0</td>
      <td>260.0</td>
      <td>2340.0</td>
    </tr>
    <tr>
      <th>6</th>
      <td>9.0</td>
      <td>295.0</td>
      <td>2655.0</td>
    </tr>
    <tr>
      <th>7</th>
      <td>8.0</td>
      <td>260.0</td>
      <td>2080.0</td>
    </tr>
    <tr>
      <th>8</th>
      <td>8.0</td>
      <td>333.0</td>
      <td>2664.0</td>
    </tr>
    <tr>
      <th>9</th>
      <td>7.0</td>
      <td>328.0</td>
      <td>2296.0</td>
    </tr>
    <tr>
      <th>10</th>
      <td>7.0</td>
      <td>260.0</td>
      <td>1820.0</td>
    </tr>
    <tr>
      <th>11</th>
      <td>7.0</td>
      <td>290.0</td>
      <td>2030.0</td>
    </tr>
    <tr>
      <th>12</th>
      <td>7.0</td>
      <td>260.0</td>
      <td>1820.0</td>
    </tr>
    <tr>
      <th>13</th>
      <td>7.0</td>
      <td>290.0</td>
      <td>2030.0</td>
    </tr>
    <tr>
      <th>14</th>
      <td>7.0</td>
      <td>295.0</td>
      <td>2065.0</td>
    </tr>
    <tr>
      <th>15</th>
      <td>7.0</td>
      <td>326.0</td>
      <td>2282.0</td>
    </tr>
    <tr>
      <th>16</th>
      <td>6.0</td>
      <td>298.0</td>
      <td>1788.0</td>
    </tr>
    <tr>
      <th>17</th>
      <td>6.0</td>
      <td>260.0</td>
      <td>1560.0</td>
    </tr>
    <tr>
      <th>18</th>
      <td>6.0</td>
      <td>333.0</td>
      <td>1998.0</td>
    </tr>
    <tr>
      <th>19</th>
      <td>6.0</td>
      <td>260.0</td>
      <td>1560.0</td>
    </tr>
    <tr>
      <th>20</th>
      <td>6.0</td>
      <td>298.0</td>
      <td>1788.0</td>
    </tr>
    <tr>
      <th>21</th>
      <td>5.0</td>
      <td>260.0</td>
      <td>1300.0</td>
    </tr>
    <tr>
      <th>22</th>
      <td>5.0</td>
      <td>260.0</td>
      <td>1300.0</td>
    </tr>
    <tr>
      <th>23</th>
      <td>5.0</td>
      <td>260.0</td>
      <td>1300.0</td>
    </tr>
    <tr>
      <th>24</th>
      <td>5.0</td>
      <td>260.0</td>
      <td>1300.0</td>
    </tr>
    <tr>
      <th>25</th>
      <td>5.0</td>
      <td>260.0</td>
      <td>1300.0</td>
    </tr>
    <tr>
      <th>26</th>
      <td>5.0</td>
      <td>255.0</td>
      <td>1275.0</td>
    </tr>
    <tr>
      <th>27</th>
      <td>5.0</td>
      <td>260.0</td>
      <td>1300.0</td>
    </tr>
    <tr>
      <th>28</th>
      <td>5.0</td>
      <td>260.0</td>
      <td>1300.0</td>
    </tr>
    <tr>
      <th>29</th>
      <td>5.0</td>
      <td>260.0</td>
      <td>1300.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.ml</span> <span class="kn">import</span> <span class="n">Pipeline</span>

<span class="c1"># Rename &quot;is_cat&quot; to &quot;label&quot; before setting up pipeline stages</span>
<span class="n">rescue_cat_reindex</span> <span class="o">=</span> <span class="n">rescue_cat_reindex</span><span class="o">.</span><span class="n">withColumnRenamed</span><span class="p">(</span><span class="s2">&quot;is_cat&quot;</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">)</span>

<span class="c1"># 1. Indexing the specialservicetypecategory column</span>
<span class="n">serviceIdx</span> <span class="o">=</span> <span class="n">StringIndexer</span><span class="p">(</span><span class="n">inputCol</span><span class="o">=</span><span class="s1">&#39;specialservicetypecategory&#39;</span><span class="p">,</span>
                               <span class="n">outputCol</span><span class="o">=</span><span class="s1">&#39;serviceIndex&#39;</span><span class="p">,</span> 
                               <span class="n">stringOrderType</span> <span class="o">=</span> <span class="s2">&quot;alphabetDesc&quot;</span><span class="p">)</span>

<span class="c1"># 2. Indexing the originofcall column</span>
<span class="n">callIdx</span> <span class="o">=</span> <span class="n">StringIndexer</span><span class="p">(</span><span class="n">inputCol</span><span class="o">=</span><span class="s1">&#39;originofcall&#39;</span><span class="p">,</span>
                               <span class="n">outputCol</span><span class="o">=</span><span class="s1">&#39;callIndex&#39;</span><span class="p">,</span>
                               <span class="n">stringOrderType</span> <span class="o">=</span> <span class="s2">&quot;alphabetDesc&quot;</span><span class="p">)</span>

<span class="c1"># 3. Indexing the propertycategory column</span>
<span class="n">propertyIdx</span> <span class="o">=</span> <span class="n">StringIndexer</span><span class="p">(</span><span class="n">inputCol</span><span class="o">=</span><span class="s1">&#39;propertycategory&#39;</span><span class="p">,</span>
                               <span class="n">outputCol</span><span class="o">=</span><span class="s1">&#39;propertyIndex&#39;</span><span class="p">,</span> 
                               <span class="n">stringOrderType</span> <span class="o">=</span> <span class="s2">&quot;alphabetDesc&quot;</span><span class="p">)</span>

<span class="c1"># 4. One-hot encoding</span>
<span class="n">encoder</span> <span class="o">=</span> <span class="n">OneHotEncoderEstimator</span><span class="p">(</span><span class="n">inputCols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;serviceIndex&#39;</span><span class="p">,</span> <span class="s1">&#39;callIndex&#39;</span><span class="p">,</span> <span class="s1">&#39;propertyIndex&#39;</span><span class="p">],</span> 
                                 <span class="n">outputCols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;serviceVec&#39;</span><span class="p">,</span> <span class="s1">&#39;callVec&#39;</span><span class="p">,</span> <span class="s1">&#39;propertyVec&#39;</span><span class="p">])</span>

<span class="c1"># 5. Vector assembler</span>
<span class="n">assembler</span> <span class="o">=</span> <span class="n">VectorAssembler</span><span class="p">(</span><span class="n">inputCols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;engine_count&#39;</span><span class="p">,</span> <span class="s1">&#39;hourly_cost&#39;</span><span class="p">,</span> 
                                       <span class="s1">&#39;callVec&#39;</span><span class="p">,</span> <span class="s1">&#39;propertyVec&#39;</span><span class="p">,</span> <span class="s1">&#39;serviceVec&#39;</span><span class="p">],</span> 
                           <span class="n">outputCol</span> <span class="o">=</span> <span class="s2">&quot;features&quot;</span><span class="p">)</span>

<span class="c1"># 6. Regression model</span>
<span class="n">glr</span> <span class="o">=</span> <span class="n">GeneralizedLinearRegression</span><span class="p">(</span><span class="n">family</span><span class="o">=</span><span class="s2">&quot;binomial&quot;</span><span class="p">,</span> <span class="n">link</span><span class="o">=</span><span class="s2">&quot;logit&quot;</span><span class="p">)</span>

<span class="c1"># Creating the pipeline</span>
<span class="n">pipe</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">stages</span><span class="o">=</span><span class="p">[</span><span class="n">serviceIdx</span><span class="p">,</span> <span class="n">callIdx</span><span class="p">,</span> <span class="n">propertyIdx</span><span class="p">,</span>
                        <span class="n">encoder</span><span class="p">,</span> <span class="n">assembler</span><span class="p">,</span> <span class="n">glr</span><span class="p">])</span>
                        
<span class="c1"># View the pipeline stages</span>
<span class="n">pipe</span><span class="o">.</span><span class="n">getStages</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[StringIndexer_345e883be5cb,
 StringIndexer_b5e8c260abe3,
 StringIndexer_d82908c4b741,
 OneHotEncoderEstimator_97de31f05d35,
 VectorAssembler_4832dfca75f0,
 GeneralizedLinearRegression_5c5176783b95]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fit_model</span> <span class="o">=</span> <span class="n">pipe</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">rescue_cat_reindex</span><span class="p">)</span>

<span class="c1"># Save model results</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">fit_model</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">rescue_cat_reindex</span><span class="p">)</span>
  
<span class="c1"># Showing the results</span>
<span class="n">results</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>+---------------+------------+---------+-----------+----------+-------------------+-----------------+--------------------------+-----------------+-----+------------+---------+-------------+-------------+-------------+-------------+--------------------+-------------------+
| typeofincident|engine_count|job_hours|hourly_cost|total_cost|       originofcall| propertycategory|specialservicetypecategory|incident_duration|label|serviceIndex|callIndex|propertyIndex|   serviceVec|      callVec|  propertyVec|            features|         prediction|
+---------------+------------+---------+-----------+----------+-------------------+-----------------+--------------------------+-----------------+-----+------------+---------+-------------+-------------+-------------+-------------+--------------------+-------------------+
|Special Service|         1.0|      2.0|      255.0|     510.0| Person (land Line)|     000_Dwelling|      000_Other Animal ...|              2.0|    0|         3.0|      2.0|          6.0|    (3,[],[])|(7,[2],[1.0])|    (6,[],[])|(18,[0,1,4],[1.0,...| 0.5894610744218675|
|Special Service|         1.0|      1.0|      255.0|     255.0| Person (land Line)|Outdoor Structure|      000_Other Animal ...|              1.0|    0|         3.0|      2.0|          1.0|    (3,[],[])|(7,[2],[1.0])|(6,[1],[1.0])|(18,[0,1,4,10],[1...|0.25554017373668975|
|Special Service|         1.0|      1.0|      255.0|     255.0|000_Person (mobile)|Outdoor Structure|      Animal Rescue Fro...|              1.0|    0|         2.0|      7.0|          1.0|(3,[2],[1.0])|    (7,[],[])|(6,[1],[1.0])|(18,[0,1,10,17],[...| 0.3192243289078657|
|Special Service|         1.0|      1.0|      255.0|     255.0|000_Person (mobile)|  Non Residential|      Animal Rescue Fro...|              1.0|    0|         0.0|      7.0|          4.0|(3,[0],[1.0])|    (7,[],[])|(6,[4],[1.0])|(18,[0,1,13,15],[...|0.15813259621260162|
|Special Service|         1.0|      1.0|      255.0|     255.0|000_Person (mobile)|     000_Dwelling|      000_Other Animal ...|              1.0|    0|         3.0|      7.0|          6.0|    (3,[],[])|    (7,[],[])|    (6,[],[])|(18,[0,1],[1.0,25...| 0.5567343685929764|
|Special Service|         1.0|      1.0|      255.0|     255.0| Person (land Line)|     000_Dwelling|      000_Other Animal ...|              1.0|    0|         3.0|      2.0|          6.0|    (3,[],[])|(7,[2],[1.0])|    (6,[],[])|(18,[0,1,4],[1.0,...| 0.5894610744218675|
|Special Service|         1.0|      1.0|      255.0|     255.0| Person (land Line)|          Outdoor|      000_Other Animal ...|              1.0|    0|         3.0|      2.0|          2.0|    (3,[],[])|(7,[2],[1.0])|(6,[2],[1.0])|(18,[0,1,4,11],[1...| 0.4045698158989755|
|Special Service|         1.0|      1.0|      255.0|     255.0|000_Person (mobile)|          Outdoor|      Animal Rescue Fro...|              1.0|    0|         0.0|      7.0|          2.0|(3,[0],[1.0])|    (7,[],[])|(6,[2],[1.0])|(18,[0,1,11,15],[...|0.18021255178563678|
|Special Service|         1.0|      1.0|      255.0|     255.0| Person (land Line)|     000_Dwelling|      Animal Rescue Fro...|              1.0|    0|         1.0|      2.0|          6.0|(3,[1],[1.0])|(7,[2],[1.0])|    (6,[],[])|(18,[0,1,4,16],[1...| 0.6868021275237571|
|Special Service|         1.0|      1.0|      255.0|     255.0|000_Person (mobile)|          Outdoor|      Animal Rescue Fro...|              1.0|    0|         0.0|      7.0|          2.0|(3,[0],[1.0])|    (7,[],[])|(6,[2],[1.0])|(18,[0,1,11,15],[...|0.18021255178563678|
|Special Service|         1.0|      1.0|      255.0|     255.0| Person (land Line)|          Outdoor|      Animal Rescue Fro...|              1.0|    1|         1.0|      2.0|          2.0|(3,[1],[1.0])|(7,[2],[1.0])|(6,[2],[1.0])|(18,[0,1,4,11,16]...| 0.5092522675498667|
|Special Service|         1.0|      2.0|      255.0|     510.0|000_Person (mobile)|          Outdoor|      Animal Rescue Fro...|              2.0|    0|         0.0|      7.0|          2.0|(3,[0],[1.0])|    (7,[],[])|(6,[2],[1.0])|(18,[0,1,11,15],[...|0.18021255178563678|
|Special Service|         1.0|      1.0|      255.0|     255.0|000_Person (mobile)|     Road Vehicle|      000_Other Animal ...|              1.0|    0|         3.0|      7.0|          0.0|    (3,[],[])|    (7,[],[])|(6,[0],[1.0])|(18,[0,1,9],[1.0,...| 0.6057759661527091|
|Special Service|         1.0|      1.0|      255.0|     255.0| Person (land Line)|  Non Residential|      000_Other Animal ...|              1.0|    0|         3.0|      2.0|          4.0|    (3,[],[])|(7,[2],[1.0])|(6,[4],[1.0])|(18,[0,1,4,13],[1...|0.36731791129839464|
|Special Service|         1.0|      1.0|      255.0|     255.0| Person (land Line)|          Outdoor|      Animal Rescue Fro...|              1.0|    1|         1.0|      2.0|          2.0|(3,[1],[1.0])|(7,[2],[1.0])|(6,[2],[1.0])|(18,[0,1,4,11,16]...| 0.5092522675498667|
|Special Service|         1.0|      1.0|      255.0|     255.0| Person (land Line)|          Outdoor|      Animal Rescue Fro...|              1.0|    1|         1.0|      2.0|          2.0|(3,[1],[1.0])|(7,[2],[1.0])|(6,[2],[1.0])|(18,[0,1,4,11,16]...| 0.5092522675498667|
|Special Service|         1.0|      1.0|      255.0|     255.0| Person (land Line)|          Outdoor|      Animal Rescue Fro...|              1.0|    1|         1.0|      2.0|          2.0|(3,[1],[1.0])|(7,[2],[1.0])|(6,[2],[1.0])|(18,[0,1,4,11,16]...| 0.5092522675498667|
|Special Service|         1.0|      1.0|      255.0|     255.0|          Ambulance|          Outdoor|      Animal Rescue Fro...|              1.0|    0|         2.0|      6.0|          2.0|(3,[2],[1.0])|(7,[6],[1.0])|(6,[2],[1.0])|(18,[0,1,8,11,17]...|0.46578196889199663|
|Special Service|         1.0|      1.0|      255.0|     255.0| Person (land Line)|          Outdoor|      Animal Rescue Fro...|              1.0|    0|         1.0|      2.0|          2.0|(3,[1],[1.0])|(7,[2],[1.0])|(6,[2],[1.0])|(18,[0,1,4,11,16]...| 0.5092522675498667|
|Special Service|         1.0|      1.0|      255.0|     255.0| Person (land Line)|          Outdoor|      000_Other Animal ...|              1.0|    0|         3.0|      2.0|          2.0|    (3,[],[])|(7,[2],[1.0])|(6,[2],[1.0])|(18,[0,1,4,11],[1...| 0.4045698158989755|
+---------------+------------+---------+-----------+----------+-------------------+-----------------+--------------------------+-----------------+-----+------------+---------+-------------+-------------+-------------+-------------+--------------------+-------------------+
only showing top 20 rows
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get coefficients summary table</span>
<span class="n">summary</span> <span class="o">=</span> <span class="n">fit_model</span><span class="o">.</span><span class="n">stages</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">summary</span>

<span class="n">summary</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Coefficients:
             Feature Estimate   Std Error  T Value P Value
         (Intercept)   1.0885      0.3722   2.9246  0.0034
        engine_count  -0.6804      0.2214  -3.0729  0.0021
         hourly_cost  -0.0007      0.0010  -0.7175  0.4730
      callVec_Police  -0.9668      0.2257  -4.2829  0.0000
callVec_Person (r...   0.6470      1.5530   0.4166  0.6770
callVec_Person (l...   0.1338      0.0572   2.3375  0.0194
   callVec_Other Frs  -0.6789      0.3657  -1.8565  0.0634
   callVec_Not Known -25.0264 356123.9993  -0.0001  0.9999
  callVec_Coastguard -26.0423 356123.9993  -0.0001  0.9999
   callVec_Ambulance  -0.0626      1.4188  -0.0441  0.9648
propertyVec_Road ...   0.2017      0.1470   1.3720  0.1701
propertyVec_Outdo...  -1.4310      0.1159 -12.3504  0.0000
 propertyVec_Outdoor  -0.7482      0.0677 -11.0556  0.0000
propertyVec_Other...  -0.2765      0.4561  -0.6062  0.5444
propertyVec_Non R...  -0.9055      0.0921  -9.8298  0.0000
    propertyVec_Boat   0.7267      1.4248   0.5100  0.6100
serviceVec_Animal...  -0.9946      0.1600  -6.2167  0.0000
serviceVec_Animal...   0.4235      0.0614   6.9004  0.0000
serviceVec_Animal...   0.4458      0.0959   4.6498  0.0000

(Dispersion parameter for binomial family taken to be 1.0000)
    Null deviance: 8123.3546 on 5841 degrees of freedom
Residual deviance: 7535.0784 on 5841 degrees of freedom
AIC: 7573.0784
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Save pipeline</span>

<span class="n">pipe</span><span class="o">.</span><span class="n">write</span><span class="p">()</span><span class="o">.</span><span class="n">overwrite</span><span class="p">()</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;rescue_pipeline&quot;</span><span class="p">)</span>

<span class="c1"># Save the pipeline model</span>

<span class="n">fit_model</span><span class="o">.</span><span class="n">write</span><span class="p">()</span><span class="o">.</span><span class="n">overwrite</span><span class="p">()</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;rescue_model&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load saved pipeline</span>
<span class="n">reloaded_pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;rescue_pipeline&quot;</span><span class="p">)</span>

<span class="c1"># Re-fit to a subset of rescue data as an example of how pipelines can be re-used</span>
<span class="n">new_model</span> <span class="o">=</span> <span class="n">reloaded_pipeline</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">rescue_cat_reindex</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">withReplacement</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">fraction</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">seed</span> <span class="o">=</span> <span class="mi">99</span><span class="p">))</span>
                      
<span class="c1"># View new model summary</span>
<span class="n">new_model</span><span class="o">.</span><span class="n">stages</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">summary</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Coefficients:
             Feature Estimate   Std Error T Value P Value
         (Intercept)   2.9173      1.2388  2.3549  0.0185
        engine_count  -0.7009      0.7351 -0.9534  0.3404
         hourly_cost  -0.0063      0.0033 -1.9205  0.0548
      callVec_Police  -0.4627      0.5684 -0.8140  0.4156
callVec_Person (l...   0.3852      0.1876  2.0531  0.0401
   callVec_Other Frs  -0.6854      0.7712 -0.8887  0.3742
propertyVec_Road ...   0.2272      0.5093  0.4460  0.6556
propertyVec_Outdo...  -1.3168      0.3752 -3.5100  0.0004
 propertyVec_Outdoor  -0.8949      0.2167 -4.1300  0.0000
propertyVec_Other...  25.6083 356121.6985  0.0001  0.9999
propertyVec_Non R...  -1.2404      0.3110 -3.9886  0.0001
serviceVec_Animal...  -1.1309      0.5072 -2.2296  0.0258
serviceVec_Animal...   0.2916      0.1982  1.4714  0.1412
serviceVec_Animal...  -0.0509      0.2914 -0.1748  0.8613

(Dispersion parameter for binomial family taken to be 1.0000)
    Null deviance: 816.4533 on 577 degrees of freedom
Residual deviance: 745.7134 on 577 degrees of freedom
AIC: 773.7134
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Close the spark session</span>
<span class="n">spark</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./raw-notebooks/logistic-regression"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="simple visible nav section-nav flex-column">
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Analysis Standards and Pipelines in Quality and Improvement, Office for National Statistics
</p>

  </div>
  
  <div class="footer-item">
    

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=5b4479735964841361fd"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>