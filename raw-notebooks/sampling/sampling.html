

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Sampling: an overview &#8212; Spark at the ONS</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=5b4479735964841361fd" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=5b4479735964841361fd" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/accessibility.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=5b4479735964841361fd" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd" />
  <script src="../../_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=5b4479735964841361fd"></script>

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-95MGHSRD0S"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-95MGHSRD0S');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'raw-notebooks/sampling/sampling';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/logo.png" class="logo__image only-light" alt="Spark at the ONS - Home"/>
    <script>document.write(`<img src="../../_static/logo.png" class="logo__image only-dark" alt="Spark at the ONS - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../intro.html">
                    Introduction
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Spark overview</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../spark-overview/spark-start.html">Getting Started with Spark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-overview/when-to-use-spark.html">When To Use Spark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-overview/spark-session-guidance.html">Guidance on Spark Sessions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-overview/example-spark-sessions.html">Example Spark Sessions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-overview/spark-defaults.html">Configuration Hierarchy and <code class="docutils literal notranslate"><span class="pre">spark-defaults.conf</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-overview/data-types.html">Data Types in Spark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-overview/creating-dataframes.html">Creating DataFrames Manually</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-overview/reading-and-writing-data-spark.html">Reading and Writing Data in Spark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-overview/data-storage.html">Data Storage</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction to PySpark</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../pyspark-intro/pyspark-intro.html">Introduction to PySpark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyspark-intro/returning-data.html">Returning Data from Cluster to Driver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyspark-intro/f-col.html">Reference columns by name: <code class="docutils literal notranslate"><span class="pre">F.col()</span></code></a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction to sparklyr</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../sparklyr-intro/sparklyr-intro.html">Introduction to sparklyr</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sparklyr-intro/sparklyr-functions.html">Using Spark functions in sparklyr</a></li>

</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Spark functions</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../spark-functions/union-dataframes-with-different-columns.html">Union two DataFrames with different columns</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-functions/padding.html">Add leading zeros with <code class="docutils literal notranslate"><span class="pre">lpad()</span></code></a></li>

<li class="toctree-l1"><a class="reference internal" href="../../spark-functions/sampling.html">Sampling: an overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-functions/pivot-tables.html">Pivot tables in Spark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-functions/rounding.html">Rounding differences in Python, R and Spark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-functions/window-functions.html">Window Functions in Spark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-functions/cross-joins.html">Cross Joins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-functions/arrays.html">Arrays Functions in PySpark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-functions/date-functions.html">Date functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-functions/writing-data.html">Writing Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-functions/job-description-notebook.html">Set Spark Job Description</a></li>




<li class="toctree-l1"><a class="reference internal" href="../../spark-functions/median.html">Median in Spark</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Understanding and Optimising Spark</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../spark-concepts/optimisation-tips.html">Ideas for optimising Spark code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-concepts/spark-application-and-ui.html">Spark Application and UI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-concepts/groups-not-loops.html">Groups not Loops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-concepts/shuffling.html">Shuffling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-concepts/join-concepts.html">Optimising Joins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-concepts/salted-joins.html">Salted Joins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-concepts/partitions.html">Managing Partitions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-concepts/persistence.html">Persisting in Spark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-concepts/cache.html">Caching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-concepts/checkpoint-staging.html">Checkpoints and Staging Tables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-concepts/garbage-collection.html">Garbage Collection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-concepts/df-order.html">Spark DataFrames Are Not Ordered</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-concepts/exercises.html">Exercises</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Analysis in Spark</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../spark-analysis/big-data-workflow.html">Big data workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-analysis/interpolation.html">Interpolation in Spark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-analysis/logistic-regression.html">Logistic Regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-analysis/visualisation.html">Spark and Visualisation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-analysis/flags.html">Flags in Spark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-analysis/bin-continuous-variable.html">Data binning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spark-analysis/cramer_v.html">Calculating Cramér’s V from a Spark DataFrame</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Testing and Debugging</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../testing-debugging/spark-errors.html">Understanding and Handling Spark Errors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing-debugging/unit-testing.html">Unit Testing in Spark</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Ancillary Topics</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../ancillary-topics/module-imports.html">Naming Conflicts in Module Imports</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ancillary-topics/pydoop.html">Pydoop: HDFS to pandas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ancillary-topics/creating-a-SQL-view-in-HDFS.html">Creating a SQL view in HDFS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ancillary-topics/pandas-udfs.html">Pandas UDFs</a></li>
</ul>

        </div>
    </nav></div>
            <div class="bd-sidebar__bottom">
                <!-- To handle the deprecated key -->
                
                <div class="navbar_extra_footer">
                <div>
        <p>Book version 2022.6</p>
    </div>
    
                </div>
                
            </div>
        </div>
        <div id="rtd-footer-container"></div>
    </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/best-practice-and-impact/ons-spark" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/best-practice-and-impact/ons-spark/issues/new?title=Issue%20on%20page%20%2Fraw-notebooks/sampling/sampling.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/raw-notebooks/sampling/sampling.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Sampling: an overview</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-spark-session-and-loading-data">Creating spark session and loading data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sampling-sample-and-sdf-sample">Sampling: <code class="docutils literal notranslate"><span class="pre">.sample()</span></code> and <code class="docutils literal notranslate"><span class="pre">sdf_sample()</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sampling-without-replacement">Sampling without replacement</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#does-sample-preserve-the-distribution-regardless-of-partitions">Does <code class="docutils literal notranslate"><span class="pre">.sample()</span></code> preserve the distribution, regardless of partitions?</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sampling-with-replacement">Sampling with Replacement</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#stratified-samples-sampleby">Stratified samples: <code class="docutils literal notranslate"><span class="pre">.sampleBy()</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#an-example-using-the-skewed-dataset">An example using the skewed dataset:</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#information-on-alternate-sampling-methods">Information on alternate sampling methods</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#more-details-on-sampling">More details on sampling</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#returning-an-exact-sample">Returning an exact sample</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#returning-an-exact-sample-stratified-sampling">Returning an exact sample - Stratified Sampling</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#simplifying-the-required-sample-column">Simplifying the required sample column</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#partitioning">Partitioning</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sampling-consistently-by-filtering-the-data">Sampling consistently by filtering the data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#splitting-a-df-randomsplit-and-sdf-random-split">Splitting a DF: <code class="docutils literal notranslate"><span class="pre">.randomSplit()</span></code> and <code class="docutils literal notranslate"><span class="pre">sdf_random_split()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#splitting-via-monotonically-increasing-id-or-sdf-with-unique-id">Splitting via <code class="docutils literal notranslate"><span class="pre">monotonically_increasing_id()</span></code> or <code class="docutils literal notranslate"><span class="pre">sdf_with_unique_id()</span></code></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#further-resources">Further Resources</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section id="sampling-an-overview">
<h1>Sampling: an overview<a class="headerlink" href="#sampling-an-overview" title="Permalink to this heading">#</a></h1>
<p>Sampling is something that you may want to do during development or initial analysis of data, as with a smaller amount of data your code will run faster and requires less memory to process.</p>
<p>There are many different ways that a dataframe can be sampled, the two main types covered in this page are:</p>
<ol class="arabic simple">
<li><p><strong>simple random sampling</strong>: <a class="reference external" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.DataFrame.sample.html"><code class="docutils literal notranslate"><span class="pre">.sample()</span></code></a> in Pyspark and <a class="reference external" href="https://spark.rstudio.com/packages/sparklyr/latest/reference/sdf_sample.html"><code class="docutils literal notranslate"><span class="pre">sdf_sample()</span></code></a> in SparklyR and</p></li>
<li><p><strong>stratified sampling</strong>: <a class="reference external" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.DataFrame.sampleBy.html"><code class="docutils literal notranslate"><span class="pre">.sampleBy()</span></code></a> in Pyspark. There is currently no way to do stratified sampling in SparklyR when using version 2.4.0 (spark vesion &gt; 3.0.0 is required).</p></li>
</ol>
<p>Although, these two methods are the focus of this page there are numerous methods that can be used for sampling that will not be covered here, such as systematic sampling and cluster sampling.</p>
<p>Both <code class="docutils literal notranslate"><span class="pre">.sample()</span></code> and <code class="docutils literal notranslate"><span class="pre">.sampleBy()</span></code> in Pyspark use the same base functions for sampling with and without replacement. For sampling without replacement PySpark implements a uniform sampling method using random number generation. A row will be added to the sample if the randomly generated number is smaller than the fraction input and each row has an equal probability of being sampled. Whereas for sampling with replacement numbers are generated from a Poisson sample. A link to the alogirithm breakdown can be found <a class="reference external" href="https://github.com/apache/spark/blob/master/python/pyspark/rddsampler.py">here</a>.</p>
<p>It is important to note that sampling in Spark returns an approximate fraction of the data, rather than an exact one. The reason for this is explained in the <span class="xref myst">sample</span> section.</p>
<section id="creating-spark-session-and-loading-data">
<h2>Creating spark session and loading data<a class="headerlink" href="#creating-spark-session-and-loading-data" title="Permalink to this heading">#</a></h2>
<p>First, set up the Spark session, read the Animal Rescue data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span><span class="p">,</span> <span class="n">functions</span> <span class="k">as</span> <span class="n">F</span>

<span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">master</span><span class="p">(</span><span class="s2">&quot;local[2]&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&quot;sampling&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;../../../config.yaml&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    
<span class="n">rescue_path</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;rescue_path_csv&quot;</span><span class="p">]</span>
<span class="c1"># rescue_path = &quot;../../data/animal_rescue.csv&quot;</span>
<span class="n">rescue</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">csv</span><span class="p">(</span><span class="n">rescue_path</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inferSchema</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">rescue</span> <span class="o">=</span> <span class="n">rescue</span><span class="o">.</span><span class="n">withColumnRenamed</span><span class="p">(</span><span class="s1">&#39;AnimalGroupParent&#39;</span><span class="p">,</span><span class="s1">&#39;animal_type&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">library</span><span class="p">(</span><span class="n">sparklyr</span><span class="p">)</span>

<span class="n">default_config</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">spark_config</span><span class="p">()</span>

<span class="n">sc</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">spark_connect</span><span class="p">(</span>
<span class="w">    </span><span class="n">master</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;local[2]&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="n">app_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;sampling&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">default_config</span><span class="p">)</span>

<span class="n">config</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">yaml</span><span class="o">::</span><span class="nf">yaml.load_file</span><span class="p">(</span><span class="s">&quot;ons-spark/config.yaml&quot;</span><span class="p">)</span>

<span class="n">rescue</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">spark_read_csv</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="o">$</span><span class="n">rescue_path_csv</span><span class="p">,</span><span class="w"> </span><span class="n">header</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">infer_schema</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span>
<span class="n">rescue</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rescue</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">mutate</span><span class="p">(</span><span class="n">animal_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AnimalGroupParent</span><span class="p">)</span>
<span class="n">rescue</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">select</span><span class="p">(</span><span class="n">rescue</span><span class="p">,</span><span class="o">-</span><span class="n">AnimalGroupParent</span><span class="p">)</span>
</pre></div>
</div>
<p>To fully test how Spark sampling functions are impacted by partitions we will also make use of a skewed dataframe.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">skewed_df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="mf">1e6</span><span class="p">)</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;skew_col&quot;</span><span class="p">,</span><span class="n">F</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">)</span>
                                        <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">)</span>
                                        <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">)</span>
                                        <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">100000</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">)</span>
                                        <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="s1">&#39;E&#39;</span><span class="p">)</span>
                                        <span class="p">)</span>

<span class="n">skewed_df</span> <span class="o">=</span> <span class="n">skewed_df</span><span class="o">.</span><span class="n">repartition</span><span class="p">(</span><span class="s1">&#39;skew_col&#39;</span><span class="p">)</span>

<span class="n">skewed_df</span><span class="o">.</span><span class="n">rdd</span><span class="o">.</span><span class="n">getNumPartitions</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>200
</pre></div>
</div>
</div>
</div>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">skewed_df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">sdf_seq</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span><span class="n">from</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1e6</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">          </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">mutate</span><span class="p">(</span><span class="n">skew_col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">case_when</span><span class="p">(</span>
<span class="w">          </span><span class="n">id</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="s">&#39;A&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="n">id</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="m">1000</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="s">&#39;B&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="n">id</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="m">10000</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="s">&#39;C&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="n">id</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="m">100000</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="s">&#39;D&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="n">.default</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#39;E&#39;</span><span class="p">))</span>

<span class="n">skewed_df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">skewed_df</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">sdf_repartition</span><span class="p">(</span><span class="n">partition_by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#39;skew_col&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="sampling-sample-and-sdf-sample">
<h2>Sampling: <code class="docutils literal notranslate"><span class="pre">.sample()</span></code> and <code class="docutils literal notranslate"><span class="pre">sdf_sample()</span></code><a class="headerlink" href="#sampling-sample-and-sdf-sample" title="Permalink to this heading">#</a></h2>
<p>By using <code class="docutils literal notranslate"><span class="pre">.sample()</span></code> in Pyspark and <code class="docutils literal notranslate"><span class="pre">sdf_sample()</span></code> in SparklyR you take a sampled subset of the original dataframe by setting a <code class="docutils literal notranslate"><span class="pre">seed</span></code>, a <code class="docutils literal notranslate"><span class="pre">fraction</span></code> and whether replacement is required. For the latter argument, in PySpark you use <code class="docutils literal notranslate"><span class="pre">withReplacement</span> <span class="pre">=</span></code>, if this is not set then the default answer is <code class="docutils literal notranslate"><span class="pre">False</span></code>, on the other hand in SparklyR you use <code class="docutils literal notranslate"><span class="pre">replacement</span> <span class="pre">=</span></code> and if not set the default answer = <code class="docutils literal notranslate"><span class="pre">True</span></code>. For both functions, <code class="docutils literal notranslate"><span class="pre">seed</span></code> is an optional argument which defaults to a random seed. The <code class="docutils literal notranslate"><span class="pre">fraction</span></code> however is compulsory and must be a value betwen 0.0 and 1.0; so, if we want to obtain a 20% sample we would use <code class="docutils literal notranslate"><span class="pre">fraction</span> <span class="pre">=</span> <span class="pre">0.2</span></code>.</p>
<p>For these two functions it is advised to specify the arguments explicitly. One reason being that in Pyspark <code class="docutils literal notranslate"><span class="pre">fraction</span></code> must come after <code class="docutils literal notranslate"><span class="pre">withReplacement</span></code> whereas when you use <code class="docutils literal notranslate"><span class="pre">sdf_sample()</span></code> in SparklyR <code class="docutils literal notranslate"><span class="pre">fraction</span></code> must be listed first. If you use both languages it is easy to make this mistake.</p>
<p>From the <a class="reference external" href="https://spark.apache.org/docs/3.1.2/api/python/reference/api/pyspark.sql.DataFrame.sample.html">PySpark documentation</a>, we see that a uniform sampling method is used for <code class="docutils literal notranslate"><span class="pre">.sample()</span></code>. Here each each row is equally likely to be sampled.
We should check that this is indeed occuring for an evenly distrubuted dataframe across a number of partitions (<code class="docutils literal notranslate"><span class="pre">rescue</span></code>) and a skewed dataset (<code class="docutils literal notranslate"><span class="pre">skew_df</span></code>). As both <code class="docutils literal notranslate"><span class="pre">.sample</span></code> and <code class="docutils literal notranslate"><span class="pre">sdf_sample()</span></code> implement uniform sampling, an <em>approximate</em> sample is returned, so you will get either slightly more or less than the specified fraction you originally input.</p>
<section id="sampling-without-replacement">
<h3>Sampling without replacement<a class="headerlink" href="#sampling-without-replacement" title="Permalink to this heading">#</a></h3>
<p>We will perform checks on the <code class="docutils literal notranslate"><span class="pre">.sample()</span></code> function to determine how this will impact our skewed distribution. We will also check how the partitions impact the end distribution.</p>
<p>First we will compare the distrubution of our skewed dataset before our sampling.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rescue_sample</span> <span class="o">=</span> <span class="n">rescue</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">withReplacement</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total rows in original DF:&#39;</span><span class="p">,</span><span class="n">rescue</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total rows in sampled DF:&#39;</span><span class="p">,</span><span class="n">rescue_sample</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Fraction of rows sampled&#39;</span><span class="p">,</span><span class="n">rescue_sample</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">/</span><span class="n">rescue</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Total rows in original DF: 5898
Total rows in sampled DF: 548
Fraction of rows sampled 0.0929128518141743
</pre></div>
</div>
</div>
</div>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">rescue_sample</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rescue</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">sdf_sample</span><span class="p">(</span><span class="n">fraction</span><span class="o">=</span><span class="m">0.1</span><span class="p">,</span><span class="w"> </span><span class="n">replacement</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">)</span>
<span class="n">rescue_sample</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">sdf_nrow</span><span class="p">()</span>

<span class="nf">print</span><span class="p">(</span><span class="nf">paste0</span><span class="p">(</span><span class="s">&quot;Total rows in original DF: &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">sdf_nrow</span><span class="p">(</span><span class="n">rescue</span><span class="p">)))</span>
<span class="nf">print</span><span class="p">(</span><span class="nf">paste0</span><span class="p">(</span><span class="s">&quot;Total rows in sampled DF: &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">sdf_nrow</span><span class="p">(</span><span class="n">rescue_sample</span><span class="p">)))</span>
<span class="nf">print</span><span class="p">(</span><span class="nf">paste0</span><span class="p">(</span><span class="s">&quot;Fraction of rows sampled: &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">sdf_nrow</span><span class="p">(</span><span class="n">rescue_sample</span><span class="p">)</span><span class="o">/</span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">sdf_nrow</span><span class="p">(</span><span class="n">rescue</span><span class="p">)))</span>
</pre></div>
</div>
<p>You can also set a seed, in a similar way to how random numbers generators work. This enables replication, which is useful in Spark given that the DataFrame will otherwise be re-sampled every time an action is called.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rescue_sample_seed_1</span> <span class="o">=</span> <span class="n">rescue</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">withReplacement</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">fraction</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                      <span class="n">seed</span><span class="o">=</span><span class="mi">99</span><span class="p">)</span>

<span class="n">rescue_sample_seed_2</span> <span class="o">=</span> <span class="n">rescue</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">withReplacement</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">fraction</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                      <span class="n">seed</span><span class="o">=</span><span class="mi">99</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Seed 1 count: </span><span class="si">{</span><span class="n">rescue_sample_seed_1</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Seed 2 count: </span><span class="si">{</span><span class="n">rescue_sample_seed_2</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Seed 1 count: 593
Seed 2 count: 593
</pre></div>
</div>
</div>
</div>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">rescue_sample_seed_1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rescue</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">sdf_sample</span><span class="p">(</span><span class="n">fraction</span><span class="o">=</span><span class="m">0.1</span><span class="p">,</span><span class="w"> </span><span class="n">seed</span><span class="o">=</span><span class="m">99</span><span class="p">)</span>
<span class="n">rescue_sample_seed_2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rescue</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">sdf_sample</span><span class="p">(</span><span class="n">fraction</span><span class="o">=</span><span class="m">0.1</span><span class="p">,</span><span class="w"> </span><span class="n">seed</span><span class="o">=</span><span class="m">99</span><span class="p">)</span>

<span class="nf">print</span><span class="p">(</span><span class="nf">paste0</span><span class="p">(</span><span class="s">&quot;Seed 1 count: &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">rescue_sample_seed_1</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">sdf_nrow</span><span class="p">()))</span>
<span class="nf">print</span><span class="p">(</span><span class="nf">paste0</span><span class="p">(</span><span class="s">&quot;Seed 2 count: &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">rescue_sample_seed_2</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">sdf_nrow</span><span class="p">()))</span>
</pre></div>
</div>
<p>We can see that both samples have returned the same number of rows due to the identical seed.</p>
<p>Another way of replicating results is with <a class="reference external" href="https://best-practice-and-impact.github.io/ons-spark/spark-concepts/cache.html#persist">persisting</a>. <a class="reference external" href="https://best-practice-and-impact.github.io/ons-spark/spark-concepts/cache.html">Caching</a> or <a class="reference external" href="https://best-practice-and-impact.github.io/ons-spark/spark-concepts/checkpoint-staging.html#checkpoint">checkpointing</a> the DataFrame will avoid recalculation of the DF within the same Spark session. Writing out the DF to a Hive table or parquet enables it to be used in subsequent Spark sessions. See the chapter on persisting for more detail.</p>
</section>
<section id="does-sample-preserve-the-distribution-regardless-of-partitions">
<h3>Does <code class="docutils literal notranslate"><span class="pre">.sample()</span></code> preserve the distribution, regardless of partitions?<a class="headerlink" href="#does-sample-preserve-the-distribution-regardless-of-partitions" title="Permalink to this heading">#</a></h3>
<p>We also wish to perform checks on the <code class="docutils literal notranslate"><span class="pre">.sample()</span></code> function to determine how this will be impacted when the original dataframe has a large skew across partitions.
Additionally we will verify that the original distribution is preserved when sampling without replacement.
First we group the data by <code class="docutils literal notranslate"><span class="pre">skew_col</span></code> and caclulate how much of the dataframe each column represents.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">skewed_df</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s1">&#39;skew_col&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;skew_col&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;row_count&#39;</span><span class="p">))</span>
    <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;percentage_of_dataframe&#39;</span><span class="p">,</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;row_count&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">skewed_df</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
    <span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s1">&#39;skew_col&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">show</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>+--------+---------+-----------------------+
|skew_col|row_count|percentage_of_dataframe|
+--------+---------+-----------------------+
|       A|      100|                   0.01|
|       B|      900|                   0.09|
|       C|     9000|     0.8999999999999999|
|       D|    90000|                    9.0|
|       E|   900000|                   90.0|
+--------+---------+-----------------------+
</pre></div>
</div>
</div>
</div>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">n_rows</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">skewed_df</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">sdf_nrow</span><span class="p">()</span>
<span class="n">skewed_df</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">        </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">group_by</span><span class="p">(</span><span class="n">skew_col</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">        </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">count</span><span class="p">(</span><span class="n">skew_col</span><span class="p">,</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#39;row_count&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">        </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">mutate</span><span class="p">(</span><span class="n">percentage_of_dataframe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">row_count</span><span class="o">/</span><span class="n">n_rows</span><span class="o">*</span><span class="m">100</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">        </span><span class="nf">sdf_sort</span><span class="p">(</span><span class="s">&#39;skew_col&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>As expected group <code class="docutils literal notranslate"><span class="pre">E</span></code> makes up 90% of the dataframe.
Now we will sample 10% of the dataframe and assess the distribution of the sampled dataframe.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">skewed_sample</span> <span class="o">=</span> <span class="n">skewed_df</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">fraction</span><span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">withReplacement</span><span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

<span class="p">(</span><span class="n">skewed_sample</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s1">&#39;skew_col&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;skew_col&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;row_count&#39;</span><span class="p">))</span>
    <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;percentage_of_dataframe&#39;</span><span class="p">,</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;row_count&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">skewed_sample</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
    <span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s1">&#39;skew_col&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">show</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>+--------+---------+-----------------------+
|skew_col|row_count|percentage_of_dataframe|
+--------+---------+-----------------------+
|       A|       10|   0.010004301849795413|
|       B|       91|    0.09103914683313824|
|       C|      886|     0.8863811438918736|
|       D|     8984|        8.9878647818562|
|       E|    89986|        90.024710625569|
+--------+---------+-----------------------+
</pre></div>
</div>
</div>
</div>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">skewed_sample</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">skewed_df</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">sdf_sample</span><span class="p">(</span><span class="n">fraction</span><span class="o">=</span><span class="w"> </span><span class="m">0.1</span><span class="p">,</span><span class="w"> </span><span class="n">replacement</span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span>

<span class="n">n_rows_sample</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">skewed_sample</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">sdf_nrow</span><span class="p">()</span>

<span class="n">skewed_sample</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">        </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">group_by</span><span class="p">(</span><span class="n">skew_col</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">        </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">count</span><span class="p">(</span><span class="n">skew_col</span><span class="p">,</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#39;row_count&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">        </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">mutate</span><span class="p">(</span><span class="n">percentage_of_dataframe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">row_count</span><span class="o">/</span><span class="n">n_rows_sample</span><span class="o">*</span><span class="m">100</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">        </span><span class="nf">sdf_sort</span><span class="p">(</span><span class="s">&#39;skew_col&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>From the above example, it looks like the original distribution is preserved.
We will now re-run the above sampling, but we first repartition our skewed dataframe.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">equal_partitions_df</span> <span class="o">=</span> <span class="n">skewed_df</span><span class="o">.</span><span class="n">repartition</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>

<span class="n">equal_partitions_sample</span> <span class="o">=</span> <span class="n">equal_partitions_df</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">fraction</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">withReplacement</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="p">(</span><span class="n">equal_partitions_sample</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s1">&#39;skew_col&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;skew_col&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;row_count&#39;</span><span class="p">))</span>
    <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;percentage_of_dataframe&#39;</span><span class="p">,</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;row_count&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">equal_partitions_sample</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
    <span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s1">&#39;skew_col&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">show</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>+--------+---------+-----------------------+
|skew_col|row_count|percentage_of_dataframe|
+--------+---------+-----------------------+
|       A|       14|   0.014039028499227854|
|       B|       75|    0.07520908124586351|
|       C|      895|     0.8974950362006376|
|       D|     8936|       8.96091133350715|
|       E|    89802|      90.05234552054712|
+--------+---------+-----------------------+
</pre></div>
</div>
</div>
</div>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">equal_partitions_df</span><span class="w">  </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">skewed_df</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">sdf_repartition</span><span class="p">(</span><span class="m">20</span><span class="p">)</span>

<span class="n">equal_partitions_sample</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">equal_partitions_df</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">sdf_sample</span><span class="p">(</span><span class="n">fraction</span><span class="o">=</span><span class="w"> </span><span class="m">0.1</span><span class="p">,</span><span class="w"> </span><span class="n">replacement</span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span>

<span class="n">n_rows_sample_equal</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">equal_partitions_sample</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">sdf_nrow</span><span class="p">()</span>

<span class="n">equal_partitions_sample</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">        </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">group_by</span><span class="p">(</span><span class="n">skew_col</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">        </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">count</span><span class="p">(</span><span class="n">skew_col</span><span class="p">,</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#39;row_count&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">        </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">mutate</span><span class="p">(</span><span class="n">percentage_of_dataframe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">row_count</span><span class="o">/</span><span class="n">n_rows_sample_equal</span><span class="o">*</span><span class="m">100</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">        </span><span class="nf">sdf_sort</span><span class="p">(</span><span class="s">&#39;skew_col&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>From the above examples we can see that we get similar samples regardless of how the data is partitioned, where each row within the dataframe is equally likely to be added to the sample.
Although one sample has been shown here, this has been tested using multiple random samples.</p>
</section>
<section id="sampling-with-replacement">
<h3>Sampling with Replacement<a class="headerlink" href="#sampling-with-replacement" title="Permalink to this heading">#</a></h3>
<p>We have constructed a small example for sampling with replacement. Here we count the number of times the unique <code class="docutils literal notranslate"><span class="pre">IncidentNumber</span></code> occurs within the sampled dataframe.
This will show how many times each <code class="docutils literal notranslate"><span class="pre">IncidentNumber</span></code> occurs within the sample, verifiying we are sampling with replacement as these rows have been sampled multiple times.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">replacement_sample</span> <span class="o">=</span> <span class="n">rescue</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">fraction</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">withReplacement</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">seed</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span>

<span class="p">(</span><span class="n">replacement_sample</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s1">&#39;IncidentNumber&#39;</span><span class="p">)</span>
                     <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;IncidentNumber&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">))</span>
                     <span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">,</span><span class="n">ascending</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
                     <span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>+---------------+-----+
| IncidentNumber|count|
+---------------+-----+
|       70935101|    2|
|       15682091|    2|
|133403-01102016|    2|
|       40271121|    2|
|       63575131|    2|
+---------------+-----+
only showing top 5 rows
</pre></div>
</div>
</div>
</div>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">replacement_sample</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rescue</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">sdf_sample</span><span class="p">(</span><span class="n">fraction</span><span class="o">=</span><span class="m">0.1</span><span class="p">,</span><span class="w"> </span><span class="n">replacement</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">seed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">20</span><span class="p">)</span>
<span class="n">replacement_sample</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">sdf_nrow</span><span class="p">()</span>

<span class="n">replacement_sample</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">    </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">group_by</span><span class="p">(</span><span class="n">IncidentNumber</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">    </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">count</span><span class="p">(</span><span class="n">IncidentNumber</span><span class="p">)</span><span class="o">%&gt;%</span>
<span class="w">    </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">arrange</span><span class="p">(</span><span class="nf">desc</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
</pre></div>
</div>
<p>The above examples show that a number of rows occur twice within the sample. While we have not presented the details here, sampling with replacement does still preserve the partitions and original distribution of the original dataframe as shown above for sampling without replacement.</p>
</section>
</section>
<section id="stratified-samples-sampleby">
<h2>Stratified samples: <code class="docutils literal notranslate"><span class="pre">.sampleBy()</span></code><a class="headerlink" href="#stratified-samples-sampleby" title="Permalink to this heading">#</a></h2>
<p>A stratified sample can be taken with <a class="reference external" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.DataFrame.sampleby.html"><code class="docutils literal notranslate"><span class="pre">.sampleBy()</span></code></a> in PySpark. This takes a column, <code class="docutils literal notranslate"><span class="pre">col</span></code>, to sample by, and a dictionary of weights, <code class="docutils literal notranslate"><span class="pre">fractions</span></code>.</p>
<p>In common with other sampling methods this does not return an exact proportion and you can also optionally set a seed.</p>
<p>Note that there is no native sparklyr implementation for stratified sampling, although there is a method for weighted sampling, <a class="reference external" href="https://spark.rstudio.com/packages/sparklyr/latest/reference/sdf_weighted_sample.html"><code class="docutils literal notranslate"><span class="pre">sdf_weighted_sample()</span></code></a>.</p>
<p>In PySpark, to return <span class="math notranslate nohighlight">\(5\%\)</span> of cats, <span class="math notranslate nohighlight">\(10\%\)</span> of dogs and <span class="math notranslate nohighlight">\(50\%\)</span> of hamsters:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">weights</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Cat&quot;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span> <span class="s2">&quot;Dog&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s2">&quot;Hamster&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">}</span>
<span class="n">stratified_sample</span> <span class="o">=</span> <span class="n">rescue</span><span class="o">.</span><span class="n">sampleBy</span><span class="p">(</span><span class="s2">&quot;animal_type&quot;</span><span class="p">,</span> <span class="n">fractions</span><span class="o">=</span><span class="n">weights</span><span class="p">)</span>
<span class="n">stratified_sample_count</span> <span class="o">=</span> <span class="p">(</span><span class="n">stratified_sample</span>
                           <span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&quot;animal_type&quot;</span><span class="p">)</span>
                           <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;animal_type&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;row_count&quot;</span><span class="p">))</span>
                           <span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s2">&quot;animal_type&quot;</span><span class="p">))</span>
<span class="n">stratified_sample_count</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>+-----------+---------+
|animal_type|row_count|
+-----------+---------+
|        Cat|      140|
|        Dog|      120|
|    Hamster|        7|
+-----------+---------+
</pre></div>
</div>
</div>
</div>
<p>We can quickly compare the number of rows for each animal to the expected to confirm that they are approximately equal:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">weights_df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span> <span class="n">schema</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;animal_type&quot;</span><span class="p">,</span> <span class="s2">&quot;weight&quot;</span><span class="p">])</span>

<span class="p">(</span><span class="n">rescue</span>
    <span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&quot;animal_type&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">weights_df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;animal_type&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;expected_rows&quot;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;weight&quot;</span><span class="p">),</span> <span class="mi">0</span><span class="p">))</span>
    <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stratified_sample_count</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;animal_type&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s2">&quot;animal_type&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>+-----------+-----+------+-------------+---------+
|animal_type|count|weight|expected_rows|row_count|
+-----------+-----+------+-------------+---------+
|        Cat| 2909|  0.05|        145.0|      140|
|        Dog| 1008|   0.1|        101.0|      120|
|    Hamster|   14|   0.5|          7.0|        7|
+-----------+-----+------+-------------+---------+
</pre></div>
</div>
</div>
</div>
<section id="an-example-using-the-skewed-dataset">
<h3>An example using the skewed dataset:<a class="headerlink" href="#an-example-using-the-skewed-dataset" title="Permalink to this heading">#</a></h3>
<p>Using <code class="docutils literal notranslate"><span class="pre">.sampleBy()</span></code> to sample a skewed dataset is perhaps better than using <code class="docutils literal notranslate"><span class="pre">.sample()</span></code> as you can specify the fractions of each strata within your sample to ensure that the strata in the sample are representative of the overall population.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sk_weights</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;A&quot;</span><span class="p">:</span><span class="mf">0.2</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">:</span><span class="mf">0.1</span><span class="p">,</span> <span class="s2">&quot;E&quot;</span><span class="p">:</span><span class="mf">0.3</span><span class="p">}</span>
<span class="n">stratified_sk_sample</span> <span class="o">=</span> <span class="n">skewed_df</span><span class="o">.</span><span class="n">sampleBy</span><span class="p">(</span><span class="s2">&quot;skew_col&quot;</span><span class="p">,</span> <span class="n">fractions</span><span class="o">=</span><span class="n">sk_weights</span><span class="p">)</span>

<span class="p">(</span><span class="n">stratified_sk_sample</span>
    <span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s1">&#39;skew_col&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;skew_col&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;row_count&#39;</span><span class="p">))</span>
    <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;percentage_of_dataframe&#39;</span><span class="p">,</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;row_count&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">stratified_sk_sample</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
    <span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s1">&#39;skew_col&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>+--------+---------+-----------------------+
|skew_col|row_count|percentage_of_dataframe|
+--------+---------+-----------------------+
|       A|       19|   0.006711883566482973|
|       B|       94|    0.03320616080259997|
|       C|     4507|     1.5921294333757243|
|       D|     8999|      3.178960011304225|
|       E|   269461|      95.18899251095097|
+--------+---------+-----------------------+
</pre></div>
</div>
</div>
</div>
<p><strong>Conclusion</strong>: the .sampleBy() function will produce similar results independant of partitions!</p>
</section>
</section>
<section id="information-on-alternate-sampling-methods">
<h2>Information on alternate sampling methods<a class="headerlink" href="#information-on-alternate-sampling-methods" title="Permalink to this heading">#</a></h2>
</section>
<section id="more-details-on-sampling">
<h2>More details on sampling<a class="headerlink" href="#more-details-on-sampling" title="Permalink to this heading">#</a></h2>
<p>The following section gives more detail on sampling and how it is processed on the Spark cluster. It is not compulsory reading, but may be of interest to some Spark users.</p>
<section id="returning-an-exact-sample">
<h3>Returning an exact sample<a class="headerlink" href="#returning-an-exact-sample" title="Permalink to this heading">#</a></h3>
<p>We have demonstrated above that <code class="docutils literal notranslate"><span class="pre">.sample()</span></code>/<code class="docutils literal notranslate"><span class="pre">sdf_sample()</span></code> return an approximate fraction, not an exact one. This is because every row is independently assigned a probability equal to the <code class="docutils literal notranslate"><span class="pre">fraction</span></code> of being included in the sample, e.g. with <code class="docutils literal notranslate"><span class="pre">fraction=0.2</span></code> every row has a <span class="math notranslate nohighlight">\(20\%\)</span> probability of being in the sample. The number of rows returned in the sample therefore follows the binomial distribution.</p>
<p>The advantage of the sample being calculated in this way is that it is processed as a <em>narrow transformation</em>, which is more efficient than a <em>wide transformation</em>.</p>
<p>To return an exact sample, one method is to calculate how many rows are required in the sample, create a new column of random numbers and sort by it, and use <a class="reference external" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.DataFrame.limit.html"><code class="docutils literal notranslate"><span class="pre">.limit()</span></code></a> in PySpark or <a class="reference external" href="https://stat.ethz.ch/R-manual/R-devel/library/utils/html/head.html"><code class="docutils literal notranslate"><span class="pre">head()</span></code></a> in sparklyr. This requires an action and a wide transformation, and so will take longer to process than using <code class="docutils literal notranslate"><span class="pre">.sample()</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fraction</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">row_count</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">rescue</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">*</span> <span class="n">fraction</span><span class="p">)</span>
<span class="n">row_count</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>590
</pre></div>
</div>
</div>
</div>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">fraction</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">0.1</span>
<span class="n">row_count</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">round</span><span class="p">(</span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">sdf_nrow</span><span class="p">(</span><span class="n">rescue</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">fraction</span><span class="p">)</span>
<span class="n">row_count</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rescue</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;rand_no&quot;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">rand</span><span class="p">())</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s2">&quot;rand_no&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">row_count</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;rand_no&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>590
</pre></div>
</div>
</div>
</div>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">rescue</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">    </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">mutate</span><span class="p">(</span><span class="n">rand_no</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">rand</span><span class="p">())</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">    </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">arrange</span><span class="p">(</span><span class="n">rand_no</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">    </span><span class="nf">head</span><span class="p">(</span><span class="n">row_count</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">    </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">select</span><span class="p">(</span><span class="n">rand_no</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">    </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">sdf_nrow</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="returning-an-exact-sample-stratified-sampling">
<h3>Returning an exact sample - Stratified Sampling<a class="headerlink" href="#returning-an-exact-sample-stratified-sampling" title="Permalink to this heading">#</a></h3>
<p>If you are wishing to use a form of stratified sampling where an exact number of samples are needed per strata, this can be implemented using a window function in either PySpark or SparklyR. More details and examples using window functions can be found in the <a class="reference external" href="https://best-practice-and-impact.github.io/ons-spark/spark-functions/window-functions.html">window function page</a>. We found that the simplest way of returning an exact number of samples per strata is to create a column for each strata with the number of samples required. To simplify this example we have reduced the number of animals in the <code class="docutils literal notranslate"><span class="pre">animal_type</span></code> column to 5: Bird; Cat; Dog; Fox; and Other.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Preprocessing to simplify the number of animals in the `animal_type` column</span>
<span class="n">simplified_animal_types</span> <span class="o">=</span> <span class="n">rescue</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;animal_type&#39;</span><span class="p">,</span><span class="n">F</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="o">~</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;animal_type&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;Cat&#39;</span><span class="p">,</span><span class="s1">&#39;Bird&#39;</span><span class="p">,</span><span class="s1">&#39;Dog&#39;</span><span class="p">,</span><span class="s1">&#39;Fox&#39;</span><span class="p">]),</span><span class="s1">&#39;Other&#39;</span><span class="p">)</span>
                                              <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;animal_type&#39;</span><span class="p">)))</span>

<span class="c1"># Counting the number of animals in each group</span>
<span class="n">simplified_animal_types</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s1">&#39;animal_type&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;animal_type&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">,</span><span class="n">ascending</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>+-----------+-----+
|animal_type|count|
+-----------+-----+
|        Cat| 2909|
|       Bird| 1100|
|        Dog| 1008|
|      Other|  643|
|        Fox|  238|
+-----------+-----+
</pre></div>
</div>
</div>
</div>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Preprocessing to simplify the number of animals in the `animal_type` column</span>
<span class="n">simplified_animal_types</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rescue</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">mutate</span><span class="p">(</span><span class="n">animal_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">case_when</span><span class="p">(</span>
<span class="w">                                                        </span><span class="o">!</span><span class="n">animal_type</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&#39;Cat&#39;</span><span class="p">,</span><span class="s">&#39;Bird&#39;</span><span class="p">,</span><span class="s">&#39;Dog&#39;</span><span class="p">,</span><span class="s">&#39;Fox&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="s">&#39;Other&#39;</span><span class="p">,</span>
<span class="w">                                                        </span><span class="n">.default</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">animal_type</span><span class="p">))</span>

<span class="c1"># Counting the number of animals in each group</span>
<span class="n">simplified_animal_types</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">        </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">group_by</span><span class="p">(</span><span class="n">animal_type</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">        </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">count</span><span class="p">(</span><span class="n">animal_type</span><span class="p">,</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#39;row_count&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">        </span><span class="nf">sdf_sort</span><span class="p">(</span><span class="s">&#39;animal_type&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Next we create our column which has the required number of samples per strata. This can be done simply using <code class="docutils literal notranslate"><span class="pre">F.when</span></code> statements. This may not be viable when sampling across a lot of variables as a <code class="docutils literal notranslate"><span class="pre">when</span></code> statement is needed for each distinct value. An alternate method can be done using UDFs or a mapping function (An example of this can be found further down the page in the <span class="xref myst">Simplifying the required sample column</span> section). The efficiency of these methods has not been thoroughly tested for large datasets and a large number of strata, but we expect that UDFs would be less efficient vs Pyspark mappings and therefore mappings are the recommended method. For more information on UDFs and their efficiency, see the <span class="xref myst">Pandas UDFs</span> page. Alongside the <code class="docutils literal notranslate"><span class="pre">sample_size</span></code> column, we will also give each row a randomly generated number from a uniform distribution which is used to order the rows per strata.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a sample_size column for each strata </span>
<span class="n">simplified_animal_types</span> <span class="o">=</span> <span class="p">(</span><span class="n">simplified_animal_types</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;sample_size&#39;</span><span class="p">,</span><span class="n">F</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;animal_type&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;Bird&#39;</span><span class="p">,</span><span class="mi">15</span><span class="p">)</span>
                                                <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;animal_type&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;Cat&#39;</span><span class="p">,</span><span class="mi">20</span><span class="p">)</span>
                                                <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;animal_type&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;Dog&#39;</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
                                                <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;animal_type&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;Fox&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                                                <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;animal_type&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;Other&#39;</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
                                                <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
                                                <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;random_number&#39;</span><span class="p">,</span><span class="n">F</span><span class="o">.</span><span class="n">rand</span><span class="p">())</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">simplified_animal_types</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">simplified_animal_types</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span>
<span class="w">                            </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">mutate</span><span class="p">(</span><span class="n">sample_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">case_when</span><span class="p">(</span>
<span class="w">                                            </span><span class="n">animal_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&#39;Bird&#39;</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="m">15</span><span class="p">,</span>
<span class="w">                                            </span><span class="n">animal_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&#39;Cat&#39;</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="m">20</span><span class="p">,</span>
<span class="w">                                            </span><span class="n">animal_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&#39;Dog&#39;</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="m">10</span><span class="p">,</span>
<span class="w">                                            </span><span class="n">animal_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&#39;Fox&#39;</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="m">2</span><span class="p">,</span>
<span class="w">                                            </span><span class="n">animal_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&#39;Other&#39;</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="m">5</span><span class="p">,</span>
<span class="w">                                            </span><span class="n">.default</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">                            </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">mutate</span><span class="p">(</span><span class="n">random_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">rand</span><span class="p">())</span>
</pre></div>
</div>
<p>Using a window function, we create a column <code class="docutils literal notranslate"><span class="pre">strata_rank</span></code> which will rank each of the random numbers from <code class="docutils literal notranslate"><span class="pre">random_number</span></code> column in order. From this, we create a final column <code class="docutils literal notranslate"><span class="pre">sampled</span></code> which will contain a <code class="docutils literal notranslate"><span class="pre">1</span></code> if the ranked value of a random number is less than or equal to the required sample size for each strata. Otherwise it will contain a <code class="docutils literal notranslate"><span class="pre">0</span></code>. To obtain our final sample, we simply filter on the <code class="docutils literal notranslate"><span class="pre">sampled</span></code> column and extract all rows where this equals <code class="docutils literal notranslate"><span class="pre">1</span></code>. We can check the number of entries per sample by using a aggregating function (<code class="docutils literal notranslate"><span class="pre">agg</span></code>) and a <code class="docutils literal notranslate"><span class="pre">groupBy</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.sql.window</span> <span class="kn">import</span> <span class="n">Window</span>
<span class="c1"># use Window function to rank based on size of random number</span>
<span class="n">simplified_animal_types</span> <span class="o">=</span> <span class="n">simplified_animal_types</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;strata_rank&quot;</span><span class="p">,</span><span class="n">F</span><span class="o">.</span><span class="n">rank</span><span class="p">()</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">Window</span><span class="o">.</span><span class="n">partitionBy</span><span class="p">(</span><span class="s1">&#39;animal_type&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s1">&#39;random_number&#39;</span><span class="p">)))</span>
<span class="c1"># Set sampled column to 1 if rank is lower than sample_size, 0 otherwise</span>
<span class="n">simplified_animal_types</span> <span class="o">=</span> <span class="p">(</span><span class="n">simplified_animal_types</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;sampled&#39;</span><span class="p">,</span><span class="n">F</span><span class="o">.</span><span class="n">when</span><span class="p">((</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;strata_rank&#39;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;sample_size&#39;</span><span class="p">)),</span> <span class="mi">1</span><span class="p">)</span>
                                    <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span>
 
<span class="c1"># Take our sample by filtering where `sampled` is 1</span>
<span class="n">sample</span> <span class="o">=</span> <span class="n">simplified_animal_types</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;sampled&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
<span class="c1"># Count rows in sample</span>
<span class="n">sample</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s1">&#39;animal_type&#39;</span><span class="p">,</span><span class="s1">&#39;sample_size&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;animal_type&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">,</span><span class="n">ascending</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>+-----------+-----------+-----+
|animal_type|sample_size|count|
+-----------+-----------+-----+
|        Cat|         20|   20|
|       Bird|         15|   15|
|        Dog|         10|   10|
|      Other|          5|    5|
|        Fox|          2|    2|
+-----------+-----------+-----+
</pre></div>
</div>
</div>
</div>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">simplified_animal_types</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">simplified_animal_types</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span>
<span class="w">              </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">group_by</span><span class="p">(</span><span class="n">animal_type</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">              </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">mutate</span><span class="p">(</span><span class="n">strata_rank</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">rank</span><span class="p">(</span><span class="nf">desc</span><span class="p">(</span><span class="n">random_number</span><span class="p">)))</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">              </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">ungroup</span><span class="p">()</span>

<span class="n">simplified_animal_types</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">simplified_animal_types</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">mutate</span><span class="p">(</span><span class="n">sampled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">case_when</span><span class="p">(</span>
<span class="w">              </span><span class="n">strata_rank</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">sample_size</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="m">1</span><span class="p">,</span>
<span class="w">              </span><span class="n">.default</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">))</span>

<span class="n">sampled</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">simplified_animal_types</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">filter</span><span class="p">(</span><span class="n">sampled</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">1</span><span class="p">)</span>

<span class="n">sampled</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">        </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">group_by</span><span class="p">(</span><span class="n">animal_type</span><span class="p">,</span><span class="n">sample_size</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">        </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">count</span><span class="p">(</span><span class="n">animal_type</span><span class="p">,</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#39;row_count&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">        </span><span class="nf">sdf_sort</span><span class="p">(</span><span class="s">&#39;animal_type&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>It should be pointed out that using a Window function and partitioning by a strata can lead to issues in datasets which have large skews. If one strata is significantly larger than others, this could also cause memory overflow issues on the executors resulting in spark sessions crashing. For more info see the <span class="xref myst">partitioning page</span>.</p>
<section id="simplifying-the-required-sample-column">
<h4>Simplifying the required sample column<a class="headerlink" href="#simplifying-the-required-sample-column" title="Permalink to this heading">#</a></h4>
<p>We can simplify the creation of the required sample column by using dictionaries (python) or a dataframe and parse expressions (R). This does require the use of the <code class="docutils literal notranslate"><span class="pre">itertools</span></code> package and <code class="docutils literal notranslate"><span class="pre">chain()</span></code> function to map the values within the column for python. A similar work around is also possible in R by using <code class="docutils literal notranslate"><span class="pre">dplyr::tibble()</span></code> and <code class="docutils literal notranslate"><span class="pre">parse_exprs()</span></code>. Both methods can be used to easily set the <code class="docutils literal notranslate"><span class="pre">sample_size</span></code> column when dealing with a large number of strata.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">chain</span>
<span class="c1"># Create dictionary</span>
<span class="n">strata_dictionary</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Bird&#39;</span><span class="p">:</span><span class="mi">15</span><span class="p">,</span> <span class="s1">&#39;Cat&#39;</span><span class="p">:</span><span class="mi">20</span><span class="p">,</span> <span class="s1">&#39;Dog&#39;</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;Fox&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;Other&#39;</span><span class="p">:</span><span class="mi">5</span><span class="p">}</span>


<span class="n">mapping_example</span> <span class="o">=</span> <span class="n">rescue</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;animal_type&#39;</span><span class="p">,</span><span class="n">F</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="o">~</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;animal_type&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;Cat&#39;</span><span class="p">,</span><span class="s1">&#39;Bird&#39;</span><span class="p">,</span><span class="s1">&#39;Dog&#39;</span><span class="p">,</span><span class="s1">&#39;Fox&#39;</span><span class="p">]),</span><span class="s1">&#39;Other&#39;</span><span class="p">)</span>
                                              <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;animal_type&#39;</span><span class="p">)))</span>

<span class="n">mapping_expression</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">create_map</span><span class="p">([</span><span class="n">F</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="n">strata_dictionary</span><span class="o">.</span><span class="n">items</span><span class="p">())])</span> 
<span class="n">mapping_example</span> <span class="o">=</span> <span class="n">mapping_example</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;sample_size&quot;</span><span class="p">,</span> 
              <span class="n">mapping_expression</span><span class="p">[</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;animal_type&quot;</span><span class="p">)])</span>

<span class="n">mapping_example</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s1">&#39;animal_type&#39;</span><span class="p">,</span><span class="s1">&#39;sample_size&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;animal_type&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s1">&#39;animal_type&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>+-----------+-----------+-----+
|animal_type|sample_size|count|
+-----------+-----------+-----+
|       Bird|         15| 1100|
|        Cat|         20| 2909|
|        Dog|         10| 1008|
|        Fox|          2|  238|
|      Other|          5|  643|
+-----------+-----------+-----+
</pre></div>
</div>
</div>
</div>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create our reference dataframe</span>
<span class="n">strata_reference</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">tibble</span><span class="p">(</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;Bird&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Dog&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Cat&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Fox&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Other&quot;</span><span class="p">),</span>
<span class="w">                                </span><span class="n">sample_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">105</span><span class="p">,</span><span class="w"> </span><span class="m">20</span><span class="p">,</span><span class="w"> </span><span class="m">20</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">5</span><span class="p">))</span>

<span class="c1"># Generate sample_size column</span>
<span class="n">tibble_example</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rescue</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">mutate</span><span class="p">(</span><span class="n">animal_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">case_when</span><span class="p">(</span>
<span class="w">                                                        </span><span class="o">!</span><span class="n">animal_type</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&#39;Cat&#39;</span><span class="p">,</span><span class="s">&#39;Bird&#39;</span><span class="p">,</span><span class="s">&#39;Dog&#39;</span><span class="p">,</span><span class="s">&#39;Fox&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="s">&#39;Other&#39;</span><span class="p">,</span>
<span class="w">                                                        </span><span class="n">.default</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">animal_type</span><span class="p">))</span>

<span class="n">tibble_example</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">tibble_example</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span>
<span class="w">                        </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">mutate</span><span class="p">(</span><span class="n">sample_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">case_when</span><span class="p">(</span><span class="o">!!!</span><span class="n">rlang</span><span class="o">::</span><span class="nf">parse_exprs</span><span class="p">(</span><span class="nf">paste0</span><span class="p">(</span><span class="s">&quot;animal_type == \&quot;&quot;</span><span class="p">,</span>
<span class="w">                                                                    </span><span class="n">strata_reference</span><span class="o">$</span><span class="n">type</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                                                    </span><span class="s">&quot;\&quot; ~ &quot;</span><span class="p">,</span>
<span class="w">                                                                    </span><span class="n">strata_reference</span><span class="o">$</span><span class="n">sample_size</span><span class="p">,</span>
<span class="w">                                                                    </span><span class="n">collapse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">))))</span>

<span class="c1"># Check sample size column has been generated correcty</span>
<span class="n">tibble_example</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span>
<span class="w">            </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">group_by</span><span class="p">(</span><span class="n">animal_type</span><span class="p">,</span><span class="n">sample_size</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">            </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">count</span><span class="p">(</span><span class="n">animal_type</span><span class="p">,</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#39;row_count&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">            </span><span class="nf">sdf_sort</span><span class="p">(</span><span class="s">&#39;animal_type&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="partitioning">
<h3>Partitioning<a class="headerlink" href="#partitioning" title="Permalink to this heading">#</a></h3>
<p>Even though your sample DF will be smaller than the original DF the number of partitions will remain the same. For example, by default your original DF will have 200 partitions, but your sample DF may only be a 10 % fraction of the original DF and therefore does not need to be partitioned in 200 parts. Too many partitions can be expensive for Spark as it causes excessive overhead for managing smaller tasks; please see our page on <a class="reference external" href="https://best-practice-and-impact.github.io/ons-spark/spark-concepts/partitions.html">partitions</a> for more information.</p>
<p>To reduce the number of partitions in your sample you can use .coalesce() in PySpark or sdf_coalesce() in SparklyR. An example of reducing partitions to 20 in PySpark is given here: <code class="docutils literal notranslate"><span class="pre">df.sample(fraction=0.1).coalesce(20)</span></code>.</p>
</section>
<section id="sampling-consistently-by-filtering-the-data">
<h3>Sampling consistently by filtering the data<a class="headerlink" href="#sampling-consistently-by-filtering-the-data" title="Permalink to this heading">#</a></h3>
<p>If the primary reason for using sampling is to process less data during development then an alternative is to filter the data and specify a condition which gives approximately the desired number of rows. This will give consistent results, which may or may not be desirable. For instance, in the Animal Rescue data we could use two years data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rescue</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;CalYear&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="mi">2012</span><span class="p">,</span> <span class="mi">2017</span><span class="p">))</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1142
</pre></div>
</div>
</div>
</div>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">rescue</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">    </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">filter</span><span class="p">(</span><span class="n">CalYear</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">2012</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">CalYear</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">2017</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">    </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">sdf_nrow</span><span class="p">()</span>
</pre></div>
</div>
<p>The disadvantage of this method is that you may have data quality issues in the original DF that will not be encountered, whereas these may be discovered with <code class="docutils literal notranslate"><span class="pre">.sample()</span></code>. Using unit testing and test driven development can mitigate the risk of these issues.</p>
</section>
<section id="splitting-a-df-randomsplit-and-sdf-random-split">
<h3>Splitting a DF: <code class="docutils literal notranslate"><span class="pre">.randomSplit()</span></code> and <code class="docutils literal notranslate"><span class="pre">sdf_random_split()</span></code><a class="headerlink" href="#splitting-a-df-randomsplit-and-sdf-random-split" title="Permalink to this heading">#</a></h3>
<p>Every row in the DF will be allocated to one of the split DFs. In common with the other sampling methods the exact size of each split may vary. An optional seed can also be set.</p>
<p>For instance, to split the animal rescue data into three DFs with a weighting of <span class="math notranslate nohighlight">\(50\%\)</span>, <span class="math notranslate nohighlight">\(40\%\)</span> and <span class="math notranslate nohighlight">\(10\%\)</span> in PySpark:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">split1</span><span class="p">,</span> <span class="n">split2</span><span class="p">,</span> <span class="n">split3</span> <span class="o">=</span> <span class="n">rescue</span><span class="o">.</span><span class="n">randomSplit</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Split1: </span><span class="si">{</span><span class="n">split1</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Split2: </span><span class="si">{</span><span class="n">split2</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Split3: </span><span class="si">{</span><span class="n">split3</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Split1: 2897
Split2: 2400
Split3: 601
</pre></div>
</div>
</div>
</div>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">splits</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rescue</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">sdf_random_split</span><span class="p">(</span>
<span class="w">    </span><span class="n">split1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.5</span><span class="p">,</span>
<span class="w">    </span><span class="n">split2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.4</span><span class="p">,</span>
<span class="w">    </span><span class="n">split3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.1</span><span class="p">)</span>

<span class="nf">print</span><span class="p">(</span><span class="nf">paste0</span><span class="p">(</span><span class="s">&quot;Split1: &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">sdf_nrow</span><span class="p">(</span><span class="n">splits</span><span class="o">$</span><span class="n">split1</span><span class="p">)))</span>
<span class="nf">print</span><span class="p">(</span><span class="nf">paste0</span><span class="p">(</span><span class="s">&quot;Split2: &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">sdf_nrow</span><span class="p">(</span><span class="n">splits</span><span class="o">$</span><span class="n">split2</span><span class="p">)))</span>
<span class="nf">print</span><span class="p">(</span><span class="nf">paste0</span><span class="p">(</span><span class="s">&quot;Split3: &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">sdf_nrow</span><span class="p">(</span><span class="n">splits</span><span class="o">$</span><span class="n">split3</span><span class="p">)))</span>
</pre></div>
</div>
<p>Check that the count of the splits equals the total row count:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DF count: </span><span class="si">{</span><span class="n">rescue</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Split count total: </span><span class="si">{</span><span class="n">split1</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">split2</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">split3</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DF count: 5898
Split count total: 5898
</pre></div>
</div>
</div>
</div>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">print</span><span class="p">(</span><span class="nf">paste0</span><span class="p">(</span><span class="s">&quot;DF count: &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">sdf_nrow</span><span class="p">(</span><span class="n">rescue</span><span class="p">)))</span>
<span class="nf">print</span><span class="p">(</span><span class="nf">paste0</span><span class="p">(</span><span class="s">&quot;Split count total: &quot;</span><span class="p">,</span>
<span class="w">             </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">sdf_nrow</span><span class="p">(</span><span class="n">splits</span><span class="o">$</span><span class="n">split1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">             </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">sdf_nrow</span><span class="p">(</span><span class="n">splits</span><span class="o">$</span><span class="n">split2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">             </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">sdf_nrow</span><span class="p">(</span><span class="n">splits</span><span class="o">$</span><span class="n">split3</span><span class="p">)))</span>
</pre></div>
</div>
</section>
<section id="splitting-via-monotonically-increasing-id-or-sdf-with-unique-id">
<h3>Splitting via <code class="docutils literal notranslate"><span class="pre">monotonically_increasing_id()</span></code> or <code class="docutils literal notranslate"><span class="pre">sdf_with_unique_id()</span></code><a class="headerlink" href="#splitting-via-monotonically-increasing-id-or-sdf-with-unique-id" title="Permalink to this heading">#</a></h3>
<p>Finally we will cover an alternate method of splitting a dataframe by using the <code class="docutils literal notranslate"><span class="pre">monotonically_increasing_id()</span></code> Pyspark function or <code class="docutils literal notranslate"><span class="pre">sdf_with_unique_id()</span></code> SparklyR function.
This will add a unique id number to each row which is larger than the previous id.
Within a partition, rows will be numbered sequentially starting at 0 for the first row in the first partition, with large increases in row id occuring between partitions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rescue_id</span> <span class="o">=</span> <span class="n">rescue</span><span class="o">.</span><span class="n">repartition</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>

<span class="n">rescue_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">rescue_id</span>
             <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;row_id&#39;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">monotonically_increasing_id</span><span class="p">())</span>
             <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;group_number&#39;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;row_id&#39;</span><span class="p">)</span><span class="o">%</span><span class="k">3</span>)
<span class="p">)</span>

<span class="n">rescue_subsample_1</span> <span class="o">=</span> <span class="n">rescue_id</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;group_number&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">rescue_subsample_2</span> <span class="o">=</span> <span class="n">rescue_id</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;group_number&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">rescue_subsample_3</span> <span class="o">=</span> <span class="n">rescue_id</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;group_number&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">rescue_subsample_1</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
    <span class="n">rescue_subsample_2</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
    <span class="n">rescue_subsample_3</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1966 1966 1966
</pre></div>
</div>
</div>
</div>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">rescue_id</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rescue</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">sdf_repartition</span><span class="p">(</span><span class="m">20</span><span class="p">)</span>

<span class="n">rescue_id</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rescue_id</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">                  </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">sdf_with_unique_id</span><span class="p">(</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;id&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">                  </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">mutate</span><span class="p">(</span><span class="n">group_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">id</span><span class="o">%%</span><span class="m">3</span><span class="p">)</span>

<span class="n">rescue_subsample_1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rescue_id</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="nf">filter</span><span class="p">(</span><span class="n">group_number</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="p">)</span>
<span class="n">rescue_subsample_2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rescue_id</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="nf">filter</span><span class="p">(</span><span class="n">group_number</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">1</span><span class="p">)</span>
<span class="n">rescue_subsample_3</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rescue_id</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="nf">filter</span><span class="p">(</span><span class="n">group_number</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">2</span><span class="p">)</span>

<span class="nf">cat</span><span class="p">(</span><span class="n">rescue_subsample_1</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">sdf_nrow</span><span class="p">(),</span>
<span class="n">rescue_subsample_2</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">sdf_nrow</span><span class="p">(),</span>
<span class="n">rescue_subsample_3</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">sparklyr</span><span class="o">::</span><span class="nf">sdf_nrow</span><span class="p">())</span>
</pre></div>
</div>
</section>
</section>
<section id="further-resources">
<h2>Further Resources<a class="headerlink" href="#further-resources" title="Permalink to this heading">#</a></h2>
<p>Spark at the ONS Articles:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://best-practice-and-impact.github.io/ons-spark/spark-concepts/persistence.html">Persisting in Spark</a></p></li>
<li><p><a class="reference external" href="https://best-practice-and-impact.github.io/ons-spark/spark-concepts/cache.html">Caching</a></p></li>
<li><p><a class="reference external" href="https://best-practice-and-impact.github.io/ons-spark/spark-concepts/checkpoint-staging.html#checkpoint">Checkpoint</a></p></li>
<li><p><a class="reference external" href="https://best-practice-and-impact.github.io/ons-spark/spark-concepts/partitions.html">Partitions</a></p></li>
<li><p><span class="xref myst">Pandas UDFs</span></p></li>
</ul>
<p>PySpark Documentation:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.DataFrame.sample.html"><code class="docutils literal notranslate"><span class="pre">.sample()</span></code></a></p></li>
<li><p><a class="reference external" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.DataFrame.limit.html"><code class="docutils literal notranslate"><span class="pre">.limit()</span></code></a></p></li>
<li><p><a class="reference external" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.DataFrame.coalesce.html"><code class="docutils literal notranslate"><span class="pre">.coalesce()</span></code></a></p></li>
<li><p><a class="reference external" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.DataFrame.randomSplit.html"><code class="docutils literal notranslate"><span class="pre">.randomSplit()</span></code></a></p></li>
<li><p><a class="reference external" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.DataFrame.sampleBy.html"><code class="docutils literal notranslate"><span class="pre">.sampleBy()</span></code></a></p></li>
<li><p><a class="reference external" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.functions.monotonically_increasing_id.html"><code class="docutils literal notranslate"><span class="pre">.monotonically_increasing_id()</span></code></a></p></li>
</ul>
<p>sparklyr Documentation:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://spark.rstudio.com/packages/sparklyr/latest/reference/sdf_sample.html"><code class="docutils literal notranslate"><span class="pre">sdf_sample()</span></code></a></p></li>
<li><p><a class="reference external" href="https://spark.rstudio.com/packages/sparklyr/latest/reference/sdf_coalesce.html"><code class="docutils literal notranslate"><span class="pre">sdf_coalesce()</span></code></a></p></li>
<li><p><a class="reference external" href="https://spark.rstudio.com/packages/sparklyr/latest/reference/sdf_random_split.html"><code class="docutils literal notranslate"><span class="pre">sdf_random_split()</span></code></a></p></li>
<li><p><a class="reference external" href="https://spark.rstudio.com/packages/sparklyr/latest/reference/sdf_weighted_sample.html"><code class="docutils literal notranslate"><span class="pre">sdf_weighted_sample()</span></code></a></p></li>
<li><p><a class="reference external" href="https://spark.rstudio.com/packages/sparklyr/latest/reference/sdf_with_unique_id.html#sdf_with_unique_id"><code class="docutils literal notranslate"><span class="pre">sdf_with_unique_id()</span></code></a></p></li>
</ul>
<p>R Documentation:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://stat.ethz.ch/R-manual/R-devel/library/utils/html/head.html"><code class="docutils literal notranslate"><span class="pre">head()</span></code></a></p></li>
</ul>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./raw-notebooks/sampling"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-spark-session-and-loading-data">Creating spark session and loading data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sampling-sample-and-sdf-sample">Sampling: <code class="docutils literal notranslate"><span class="pre">.sample()</span></code> and <code class="docutils literal notranslate"><span class="pre">sdf_sample()</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sampling-without-replacement">Sampling without replacement</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#does-sample-preserve-the-distribution-regardless-of-partitions">Does <code class="docutils literal notranslate"><span class="pre">.sample()</span></code> preserve the distribution, regardless of partitions?</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sampling-with-replacement">Sampling with Replacement</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#stratified-samples-sampleby">Stratified samples: <code class="docutils literal notranslate"><span class="pre">.sampleBy()</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#an-example-using-the-skewed-dataset">An example using the skewed dataset:</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#information-on-alternate-sampling-methods">Information on alternate sampling methods</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#more-details-on-sampling">More details on sampling</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#returning-an-exact-sample">Returning an exact sample</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#returning-an-exact-sample-stratified-sampling">Returning an exact sample - Stratified Sampling</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#simplifying-the-required-sample-column">Simplifying the required sample column</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#partitioning">Partitioning</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sampling-consistently-by-filtering-the-data">Sampling consistently by filtering the data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#splitting-a-df-randomsplit-and-sdf-random-split">Splitting a DF: <code class="docutils literal notranslate"><span class="pre">.randomSplit()</span></code> and <code class="docutils literal notranslate"><span class="pre">sdf_random_split()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#splitting-via-monotonically-increasing-id-or-sdf-with-unique-id">Splitting via <code class="docutils literal notranslate"><span class="pre">monotonically_increasing_id()</span></code> or <code class="docutils literal notranslate"><span class="pre">sdf_with_unique_id()</span></code></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#further-resources">Further Resources</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Analysis Standards and Pipelines in Quality and Improvement, Office for National Statistics
</p>

  </div>
  
  <div class="footer-item">
    

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=5b4479735964841361fd"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>