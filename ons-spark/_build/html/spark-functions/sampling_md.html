
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Sampling (.md version) &#8212; Spark at the ONS</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet">
  <link href="../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Sampling (code tabs version)" href="sampling_tabs.html" />
    <link rel="prev" title="Sampling: .sample() and sdf_sample()" href="sampling.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Spark at the ONS</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../intro.html">
   Introduction
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Template pages
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../templates/markdown.html">
   Markdown Files
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../templates/notebooks.html">
   Content with notebooks
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Spark overview
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../spark-overview/spark-session-guidance.html">
   Spark Sessions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../spark-overview/example-spark-sessions.html">
   Example Spark Sessions
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Spark functions
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="union_dataframes_with_different_columns.html">
   Union two DataFrames with different columns
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="sampling.html">
   Sampling:
   <code class="docutils literal notranslate">
    <span class="pre">
     .sample()
    </span>
   </code>
   and
   <code class="docutils literal notranslate">
    <span class="pre">
     sdf_sample()
    </span>
   </code>
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Sampling (.md version)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="sampling_tabs.html">
   Sampling (code tabs version)
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/spark-functions/sampling_md.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/robertswh/Spark at the ONS"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/robertswh/Spark at the ONS/issues/new?title=Issue%20on%20page%20%2Fspark-functions/sampling_md.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#pyspark-example-sample">
   PySpark example:
   <code class="docutils literal notranslate">
    <span class="pre">
     .sample()
    </span>
   </code>
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#r-example-sdf-sample">
   R Example:
   <code class="docutils literal notranslate">
    <span class="pre">
     sdf_sample()
    </span>
   </code>
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#more-details-on-sampling">
   More details on sampling
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#returning-an-exact-sample">
     Returning an exact sample
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#partitioning">
     Partitioning
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#sampling-consistently-by-filtering-the-data">
     Sampling consistently by filtering the data
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#other-sampling-functions">
   Other sampling functions
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#splitting-a-df-randomsplit-and-sdf-random-split">
     Splitting a DF:
     <code class="docutils literal notranslate">
      <span class="pre">
       .randomSplit()
      </span>
     </code>
     and
     <code class="docutils literal notranslate">
      <span class="pre">
       sdf_random_split()
      </span>
     </code>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#stratified-samples-sampleby">
     Stratified samples:
     <code class="docutils literal notranslate">
      <span class="pre">
       .sampleBy()
      </span>
     </code>
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#further-resources">
   Further Resources
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <section id="sampling-md-version">
<h1>Sampling (.md version)<a class="headerlink" href="#sampling-md-version" title="Permalink to this headline">¶</a></h1>
<p>Sampling: <code class="docutils literal notranslate"><span class="pre">.sample()</span></code> and <code class="docutils literal notranslate"><span class="pre">sdf_sample()</span></code></p>
<p>You can take a sample of a DataFrame with <a class="reference external" href="https://spark.apache.org/docs/2.4.0/api/python/pyspark.sql.html#pyspark.sql.DataFrame.sample"><code class="docutils literal notranslate"><span class="pre">.sample()</span></code></a> in PySpark or <a class="reference external" href="https://spark.rstudio.com/reference/sdf_sample.html"><code class="docutils literal notranslate"><span class="pre">sdf_sample()</span></code></a> in sparklyr. This is something that you may want to do during development or initial analysis of data, as with a smaller amount of data your code will run faster and requires less memory to process.</p>
<p>It is important to note that sampling in Spark returns an approximate fraction of the data, rather than an exact one. The reason for this is explained in the <a class="reference external" href="#returning-an-exact-sample">Returning an exact sample</a> section.</p>
<section id="pyspark-example-sample">
<h2>PySpark example: <code class="docutils literal notranslate"><span class="pre">.sample()</span></code><a class="headerlink" href="#pyspark-example-sample" title="Permalink to this headline">¶</a></h2>
<p>First, set up the Spark session, read the Animal Rescue data, and then get the row count:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span><span class="p">,</span> <span class="n">functions</span> <span class="k">as</span> <span class="n">F</span>

<span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">master</span><span class="p">(</span><span class="s2">&quot;local[2]&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&quot;sampling&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>

<span class="n">data_path</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;file:///{os.getcwd()}/../data/animal_rescue.parquet&quot;</span>

<span class="n">rescue</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">parquet</span><span class="p">(</span><span class="n">data_path</span><span class="p">)</span>

<span class="n">rescue</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">5898</span>
</pre></div>
</div>
<p>To use <code class="docutils literal notranslate"><span class="pre">.sample()</span></code>, set the <code class="docutils literal notranslate"><span class="pre">fraction</span></code>, which is between 0 and 1. So if we want a <span class="math notranslate nohighlight">\(20\%\)</span> sample, use <code class="docutils literal notranslate"><span class="pre">fraction=0.2</span></code>. Note that this will give an <em>approximate</em> sample and so you will likely get slightly more or fewer rows than you expect.</p>
<p>You can select to sample with replacement by setting <code class="docutils literal notranslate"><span class="pre">withReplacement=True</span></code>, which is set to <code class="docutils literal notranslate"><span class="pre">False</span></code> by default.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rescue_sample</span> <span class="o">=</span> <span class="n">rescue</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">withReplacement</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">rescue_sample</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">594</span>
</pre></div>
</div>
<p>You can also set a seed, in a similar way to how random numbers generators work. This enables replication, which is useful in Spark given that the DataFrame will be otherwise be re-sampled every time an action is called.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rescue_sample_seed_1</span> <span class="o">=</span> <span class="n">rescue</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">withReplacement</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                      <span class="n">fraction</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                      <span class="n">seed</span><span class="o">=</span><span class="mi">99</span><span class="p">)</span>

<span class="n">rescue_sample_seed_2</span> <span class="o">=</span> <span class="n">rescue</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">withReplacement</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                      <span class="n">fraction</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                      <span class="n">seed</span><span class="o">=</span><span class="mi">99</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Seed 1 count: {rescue_sample_seed_1.count()}&quot;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Seed 2 count: {rescue_sample_seed_1.count()}&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Seed</span> <span class="mi">1</span> <span class="n">count</span><span class="p">:</span> <span class="mi">589</span>
<span class="n">Seed</span> <span class="mi">2</span> <span class="n">count</span><span class="p">:</span> <span class="mi">589</span>
</pre></div>
</div>
<p>We can see that both samples have returned the same number of rows due to the identical seed.</p>
<p>Another way of replicating results is with persisting. Caching or checkpointing the DataFrame will avoid recalculation of the DF within the same Spark session. Writing out the DF to a Hive table or parquet enables it to be used in subsequent Spark sessions. See the chapter on persisting for more detail.</p>
</section>
<section id="r-example-sdf-sample">
<h2>R Example: <code class="docutils literal notranslate"><span class="pre">sdf_sample()</span></code><a class="headerlink" href="#r-example-sdf-sample" title="Permalink to this headline">¶</a></h2>
<p>In sparklyr, you can use <code class="docutils literal notranslate"><span class="pre">sdf_sample()</span></code>. The <code class="docutils literal notranslate"><span class="pre">fraction</span></code>, <code class="docutils literal notranslate"><span class="pre">seed</span></code> and <code class="docutils literal notranslate"><span class="pre">replacement</span></code> (with a slight name variation) arguments work in the same way as <code class="docutils literal notranslate"><span class="pre">.sample()</span></code>. Note that the arguments are in a different default order, which is often more useful in sparklyr as <code class="docutils literal notranslate"><span class="pre">fraction</span></code> is always used whereas <code class="docutils literal notranslate"><span class="pre">replacement=TRUE</span></code> is less common.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">rescue_sample</span> <span class="o">&lt;-</span> <span class="n">rescue</span> <span class="o">%&gt;%</span> <span class="n">sparklyr</span><span class="o">::</span><span class="nf">sdf_sample</span><span class="p">(</span><span class="n">fraction</span><span class="o">=</span><span class="m">0.1</span><span class="p">,</span> <span class="n">replacement</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="m">99</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="more-details-on-sampling">
<h2>More details on sampling<a class="headerlink" href="#more-details-on-sampling" title="Permalink to this headline">¶</a></h2>
<p>The following section gives more detail on sampling and how it is processed on the Spark cluster. is not compulsory reading, but may be of interest to some Spark users.</p>
<section id="returning-an-exact-sample">
<h3>Returning an exact sample<a class="headerlink" href="#returning-an-exact-sample" title="Permalink to this headline">¶</a></h3>
<p>We have demonstrated above that <code class="docutils literal notranslate"><span class="pre">.sample()</span></code> returns an approximate fraction, not an exact one. This is because every row is independently assigned a probability equal to <code class="docutils literal notranslate"><span class="pre">fraction</span></code> of being included in the sample, e.g. with <code class="docutils literal notranslate"><span class="pre">fraction=0.2</span></code> every row has a <span class="math notranslate nohighlight">\(20\%\)</span> probability of being in the sample. The number of rows returned in the sample therefore follows the binomial distribution.</p>
<p>The advantage of the sample being calculated in this way is that it is processed as a <em>narrow transformation</em>, which is more efficient than a <em>wide transformation</em>.</p>
<p>To return an exact sample, one method is to calculate how many rows are required in the sample, create a new column of random numbers and sort by it, and use <code class="docutils literal notranslate"><span class="pre">.limit()</span></code>. This requires an action and a wide transformation, and so will take longer to process than using <code class="docutils literal notranslate"><span class="pre">.sample()</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fraction</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">row_count</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">rescue</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">*</span> <span class="n">fraction</span><span class="p">)</span>
<span class="n">row_count</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">590</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rescue</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;rand_no&quot;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">rand</span><span class="p">())</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s2">&quot;rand_no&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">row_count</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;rand_no&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">590</span>
</pre></div>
</div>
</section>
<section id="partitioning">
<h3>Partitioning<a class="headerlink" href="#partitioning" title="Permalink to this headline">¶</a></h3>
<p>The number of partitions will remain the same when sampling, even though the DataFrame will be smaller. If you are taking a small fraction of the data then your DataFrame may have too many partitions. You can use <a class="reference external" href="https://spark.apache.org/docs/2.4.0/api/python/pyspark.sql.html#pyspark.sql.functions.coalesce"><code class="docutils literal notranslate"><span class="pre">.coalesce()</span></code></a> in PySpark or <a class="reference external" href="https://spark.rstudio.com/reference/sdf_coalesce.html"><code class="docutils literal notranslate"><span class="pre">sdf_coalesce()</span></code></a> in sparklyr to reduce the number of partitions, e.g. if your original DF had <span class="math notranslate nohighlight">\(200\)</span> partitions and you take a <span class="math notranslate nohighlight">\(10\%\)</span> sample, you can reduce the number of partitions to <span class="math notranslate nohighlight">\(20\)</span> with <code class="docutils literal notranslate"><span class="pre">df.sample(fraction=0.1).coalesce(20)</span></code>.</p>
</section>
<section id="sampling-consistently-by-filtering-the-data">
<h3>Sampling consistently by filtering the data<a class="headerlink" href="#sampling-consistently-by-filtering-the-data" title="Permalink to this headline">¶</a></h3>
<p>If the primary reason for using sampling is to process less data during development then an alternative is to filter the data and specify a condition which gives approximately the desired number of rows. This will give consistent results, which may or may not be desirable. For instance, in the Animal Rescue data we could use two years data:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rescue</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;CalYear&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="mi">2012</span><span class="p">,</span> <span class="mi">2017</span><span class="p">))</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">1142</span>
</pre></div>
</div>
<p>The disadvantage of this method is that you may have data quality issues in the original DF that will not be encountered, whereas these may be discovered with <code class="docutils literal notranslate"><span class="pre">.sample()</span></code>. Using unit testing and test driven development can mitigate the risk of these issues.</p>
</section>
</section>
<section id="other-sampling-functions">
<h2>Other sampling functions<a class="headerlink" href="#other-sampling-functions" title="Permalink to this headline">¶</a></h2>
<p>This section briefly discusses similar functions to <code class="docutils literal notranslate"><span class="pre">.sample()</span></code> and <code class="docutils literal notranslate"><span class="pre">sdf_sample()</span></code>.</p>
<section id="splitting-a-df-randomsplit-and-sdf-random-split">
<h3>Splitting a DF: <code class="docutils literal notranslate"><span class="pre">.randomSplit()</span></code> and <code class="docutils literal notranslate"><span class="pre">sdf_random_split()</span></code><a class="headerlink" href="#splitting-a-df-randomsplit-and-sdf-random-split" title="Permalink to this headline">¶</a></h3>
<p>You can split a DF into two or more DFs with <a class="reference external" href="https://spark.apache.org/docs/2.4.0/api/python/pyspark.sql.html#pyspark.sql.DataFrame.randomSplit"><code class="docutils literal notranslate"><span class="pre">.randomSplit()</span></code></a> in PySpark and <a class="reference external" href="https://spark.rstudio.com/reference/sdf_random_split.html"><code class="docutils literal notranslate"><span class="pre">sdf_random_split()</span></code></a> in sparklyr. This is common when using machine learning, to generate training and test datasets.</p>
<p>Every row in the DF will be allocated to one of the split DFs. In common with the other sampling methods the exact size of each split may vary. An optional seed can also be set.</p>
<p>For instance, to split the animal rescue data into three DFs with a weighting of <span class="math notranslate nohighlight">\(50\%\)</span>, <span class="math notranslate nohighlight">\(40\%\)</span> and <span class="math notranslate nohighlight">\(10\%\)</span> in PySpark:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">split1</span><span class="p">,</span> <span class="n">split2</span><span class="p">,</span> <span class="n">split3</span> <span class="o">=</span> <span class="n">rescue</span><span class="o">.</span><span class="n">randomSplit</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">])</span>

<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Split1: {split1.count()}&quot;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Split2: {split2.count()}&quot;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Split3: {split3.count()}&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Split1</span><span class="p">:</span> <span class="mi">2930</span>
<span class="n">Split2</span><span class="p">:</span> <span class="mi">2367</span>
<span class="n">Split3</span><span class="p">:</span> <span class="mi">601</span>
</pre></div>
</div>
<p>Check that the count of the splits equals the total row count:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;DF count: {rescue.count()}&quot;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Split count total: {split1.count() + split2.count() + split3.count()}&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">DF</span> <span class="n">count</span><span class="p">:</span> <span class="mi">5898</span>
<span class="n">Split</span> <span class="n">count</span> <span class="n">total</span><span class="p">:</span> <span class="mi">5898</span>
</pre></div>
</div>
</section>
<section id="stratified-samples-sampleby">
<h3>Stratified samples: <code class="docutils literal notranslate"><span class="pre">.sampleBy()</span></code><a class="headerlink" href="#stratified-samples-sampleby" title="Permalink to this headline">¶</a></h3>
<p>A stratified sample can be taken with <a class="reference external" href="https://spark.apache.org/docs/2.4.0/api/python/pyspark.sql.html#pyspark.sql.DataFrame.sampleBy"><code class="docutils literal notranslate"><span class="pre">.sampleBy()</span></code></a> in PySpark. This takes a column, <code class="docutils literal notranslate"><span class="pre">col</span></code>, to sample by, and a dictionary of weights, <code class="docutils literal notranslate"><span class="pre">fractions</span></code>.</p>
<p>In common with other sampling methods this does not return an exact proportion and you can also optionally set a seed.</p>
<p>Note that there is no native sparklyr implementation for stratified sampling, although there is a method for weighted sampling, <a class="reference external" href="https://spark.rstudio.com/reference/sdf_weighted_sample.html"><code class="docutils literal notranslate"><span class="pre">sdf_weighted_sample()</span></code></a>.</p>
<p>In PySpark, to return <span class="math notranslate nohighlight">\(5\%\)</span> of cats, <span class="math notranslate nohighlight">\(10\%\)</span> of dogs and <span class="math notranslate nohighlight">\(50\%\)</span> of hamsters:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">weights</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Cat&quot;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span> <span class="s2">&quot;Dog&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s2">&quot;Hamster&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">}</span>
<span class="n">stratified_sample</span> <span class="o">=</span> <span class="n">rescue</span><span class="o">.</span><span class="n">sampleBy</span><span class="p">(</span><span class="s2">&quot;AnimalGroupParent&quot;</span><span class="p">,</span> <span class="n">fractions</span><span class="o">=</span><span class="n">weights</span><span class="p">)</span>
<span class="n">stratified_sample_count</span> <span class="o">=</span> <span class="p">(</span><span class="n">stratified_sample</span>
                           <span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&quot;AnimalGroupParent&quot;</span><span class="p">)</span>
                           <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;AnimalGroupParent&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;row_count&quot;</span><span class="p">))</span>
                           <span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s2">&quot;AnimalGroupParent&quot;</span><span class="p">))</span>
<span class="n">stratified_sample_count</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">+-----------------+---------+</span>
<span class="o">|</span><span class="n">AnimalGroupParent</span><span class="o">|</span><span class="n">row_count</span><span class="o">|</span>
<span class="o">+-----------------+---------+</span>
<span class="o">|</span>              <span class="n">Cat</span><span class="o">|</span>      <span class="mi">141</span><span class="o">|</span>
<span class="o">|</span>              <span class="n">Dog</span><span class="o">|</span>      <span class="mi">107</span><span class="o">|</span>
<span class="o">|</span>          <span class="n">Hamster</span><span class="o">|</span>        <span class="mi">7</span><span class="o">|</span>
<span class="o">+-----------------+---------+</span>
</pre></div>
</div>
<p>We can quickly compare the number of rows for each animal to the expected to confirm that they are approximately equal:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">weights_df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span> <span class="n">schema</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;AnimalGroupParent&quot;</span><span class="p">,</span> <span class="s2">&quot;weight&quot;</span><span class="p">])</span>

<span class="p">(</span><span class="n">rescue</span>
    <span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&quot;AnimalGroupParent&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">weights_df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;AnimalGroupParent&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;expected_rows&quot;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;weight&quot;</span><span class="p">),</span> <span class="mi">0</span><span class="p">))</span>
    <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stratified_sample_count</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;AnimalGroupParent&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s2">&quot;AnimalGroupParent&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">+-----------------+-----+------+-------------+---------+</span>
<span class="o">|</span><span class="n">AnimalGroupParent</span><span class="o">|</span><span class="n">count</span><span class="o">|</span><span class="n">weight</span><span class="o">|</span><span class="n">expected_rows</span><span class="o">|</span><span class="n">row_count</span><span class="o">|</span>
<span class="o">+-----------------+-----+------+-------------+---------+</span>
<span class="o">|</span>              <span class="n">Cat</span><span class="o">|</span> <span class="mi">2909</span><span class="o">|</span>  <span class="mf">0.05</span><span class="o">|</span>        <span class="mf">145.0</span><span class="o">|</span>      <span class="mi">141</span><span class="o">|</span>
<span class="o">|</span>              <span class="n">Dog</span><span class="o">|</span> <span class="mi">1008</span><span class="o">|</span>   <span class="mf">0.1</span><span class="o">|</span>        <span class="mf">101.0</span><span class="o">|</span>      <span class="mi">107</span><span class="o">|</span>
<span class="o">|</span>          <span class="n">Hamster</span><span class="o">|</span>   <span class="mi">14</span><span class="o">|</span>   <span class="mf">0.5</span><span class="o">|</span>          <span class="mf">7.0</span><span class="o">|</span>        <span class="mi">7</span><span class="o">|</span>
<span class="o">+-----------------+-----+------+-------------+---------+</span>
</pre></div>
</div>
</section>
</section>
<section id="further-resources">
<h2>Further Resources<a class="headerlink" href="#further-resources" title="Permalink to this headline">¶</a></h2>
<p>PySpark Documentation:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://spark.apache.org/docs/2.4.0/api/python/pyspark.sql.html#pyspark.sql.DataFrame.sample"><code class="docutils literal notranslate"><span class="pre">.sample()</span></code></a></p></li>
<li><p><a class="reference external" href="https://spark.apache.org/docs/2.4.0/api/python/pyspark.sql.html#pyspark.sql.functions.coalesce"><code class="docutils literal notranslate"><span class="pre">.coalesce()</span></code></a></p></li>
<li><p><a class="reference external" href="https://spark.apache.org/docs/2.4.0/api/python/pyspark.sql.html#pyspark.sql.DataFrame.randomSplit"><code class="docutils literal notranslate"><span class="pre">.randomSplit()</span></code></a></p></li>
<li><p><a class="reference external" href="https://spark.apache.org/docs/2.4.0/api/python/pyspark.sql.html#pyspark.sql.DataFrame.sampleBy"><code class="docutils literal notranslate"><span class="pre">.sampleBy()</span></code></a></p></li>
</ul>
<p>sparklyr Documentation:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://spark.rstudio.com/reference/sdf_sample.html"><code class="docutils literal notranslate"><span class="pre">sdf_sample()</span></code></a></p></li>
<li><p><a class="reference external" href="https://spark.rstudio.com/reference/sdf_coalesce.html"><code class="docutils literal notranslate"><span class="pre">sdf_coalesce()</span></code></a></p></li>
<li><p><a class="reference external" href="https://spark.rstudio.com/reference/sdf_random_split.html"><code class="docutils literal notranslate"><span class="pre">sdf_random_split()</span></code></a></p></li>
<li><p><a class="reference external" href="https://spark.rstudio.com/reference/sdf_weighted_sample.html"><code class="docutils literal notranslate"><span class="pre">sdf_weighted_sample()</span></code></a></p></li>
</ul>
<p>Spark in ONS material:</p>
<ul class="simple">
<li><p>Wide and narrow transformations</p></li>
<li><p>Persisting in Spark</p></li>
<li><p>Filtering data</p></li>
<li><p>Unit testing in Spark</p></li>
</ul>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./spark-functions"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
            <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="sampling.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Sampling: <code class="docutils literal notranslate"><span class="pre">.sample()</span></code> and <code class="docutils literal notranslate"><span class="pre">sdf_sample()</span></code></p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="sampling_tabs.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Sampling (code tabs version)</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By Wil Roberts & Adrian Prince<br/>
        
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>